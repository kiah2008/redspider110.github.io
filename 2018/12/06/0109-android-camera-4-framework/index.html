<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Android,Camera,">










<meta name="description" content="Camera Framework 分析，本文主要介绍 Camera API2 相关。">
<meta name="keywords" content="Android,Camera">
<meta property="og:type" content="article">
<meta property="og:title" content="Camera Framework 分析">
<meta property="og:url" content="http://redspider110.github.io/2018/12/06/0109-android-camera-4-framework/index.html">
<meta property="og:site_name" content="Earth Guardian">
<meta property="og:description" content="Camera Framework 分析，本文主要介绍 Camera API2 相关。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0109-android-camera-4-framework-CameraService-addService.png">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0109-android-camera-4-framework-CameraService-init.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0109-android-camera-4-framework-Camera2-open.png">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0109-android-camera-4-framework-Camera2-open-CameraService_connectDevice.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0109-android-camera-4-framework-CameraService-addService-CameraDevice_createCaptureSession.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0109-android-camera-4-framework-CameraDevice_createCaptureRequest.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0109-android-camera-4-framework-CameraCaptureSession_setRepeatingRequest.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0109-android-camera-framework-CameraServiceProxy-addService.png">
<meta property="og:updated_time" content="2019-09-18T09:30:13.387Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Camera Framework 分析">
<meta name="twitter:description" content="Camera Framework 分析，本文主要介绍 Camera API2 相关。">
<meta name="twitter:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0109-android-camera-4-framework-CameraService-addService.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://redspider110.github.io/2018/12/06/0109-android-camera-4-framework/">





  <title>Camera Framework 分析 | Earth Guardian</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?faa79b658398065f8158bf82b6221b6d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Earth Guardian</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">You are not LATE!You are not EARLY!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://redspider110.github.io/2018/12/06/0109-android-camera-4-framework/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="redspider110">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Earth Guardian">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Camera Framework 分析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-06T09:00:00+08:00">
                2018-12-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-eye"></i> 阅读次数
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><code>Camera Framework</code> 分析，本文主要介绍 <code>Camera API2</code> 相关。  </p>
<a id="more"></a>

<h2 id="类文件速查表"><a href="#类文件速查表" class="headerlink" title="类文件速查表"></a>类文件速查表</h2><h3 id="类文件目录"><a href="#类文件目录" class="headerlink" title="类文件目录"></a>类文件目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. Framework Java API1:frameworks/base/core/java/android/hardware/Camera.java</span><br><span class="line">2. Framework Java API2:frameworks/base/core/java/android/hardware/camera2</span><br><span class="line">3. Framework JNI: frameworks/base/core/jni/</span><br><span class="line">4. AIDL: frameworks/av/camera/aidl</span><br><span class="line">5. Framework Native: frameworks/av/camera </span><br><span class="line">6. Framework Service: frameworks/av/services/camera/libcameraservice</span><br></pre></td></tr></table></figure>

<h3 id="JNI-相关"><a href="#JNI-相关" class="headerlink" title="JNI 相关"></a><code>JNI</code> 相关</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// frameworks/base/core/jni</span><br><span class="line">./android_hardware_camera2_legacy_LegacyCameraDevice.cpp</span><br><span class="line">./android_hardware_Camera.cpp</span><br><span class="line">./android/graphics/Camera.cpp</span><br><span class="line">./include/android_runtime/android_hardware_camera2_CameraMetadata.h</span><br><span class="line">./android_hardware_camera2_DngCreator.cpp</span><br><span class="line">./android_hardware_camera2_CameraMetadata.cpp</span><br><span class="line">./android_hardware_camera2_legacy_PerfMeasurement.cpp</span><br></pre></td></tr></table></figure>

<p><code>API 1</code> 中，使用 <code>jni</code> 通过 <code>Binder</code> 机制和 <code>CameraService</code> 通信。<br><code>API 2</code> 中，直接在 <code>CameraManager.java</code> 中通过 <code>Binder</code> 机制和 <code>CameraService</code> 通信。  </p>
<h2 id="AIDL-相关"><a href="#AIDL-相关" class="headerlink" title="AIDL 相关"></a><code>AIDL</code> 相关</h2><p><code>Framework Camere AIDL</code> 是 <code>Camera</code> 中客户端和服务端跨进程通信时使用的 <code>AIDL</code> 文件，代码都在 <code>frameworks/av/camera/</code> 目录下，其中 <code>aidl</code> 文件一共有 16 个：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">xmt@server005:~/frameworks/av/camera/aidl/android/hardware$ tree</span><br><span class="line">.</span><br><span class="line">├── camera2</span><br><span class="line">│   ├── CaptureRequest.aidl</span><br><span class="line">│   ├── ICameraDeviceCallbacks.aidl</span><br><span class="line">│   ├── ICameraDeviceUser.aidl</span><br><span class="line">│   ├── impl</span><br><span class="line">│   │   ├── CameraMetadataNative.aidl</span><br><span class="line">│   │   └── CaptureResultExtras.aidl</span><br><span class="line">│   ├── params</span><br><span class="line">│   │   ├── OutputConfiguration.aidl</span><br><span class="line">│   │   ├── VendorTagDescriptor.aidl</span><br><span class="line">│   │   └── VendorTagDescriptorCache.aidl</span><br><span class="line">│   └── utils</span><br><span class="line">│       └── SubmitInfo.aidl</span><br><span class="line">├── CameraInfo.aidl</span><br><span class="line">├── CameraStatus.aidl</span><br><span class="line">├── ICamera.aidl</span><br><span class="line">├── ICameraClient.aidl</span><br><span class="line">├── ICameraService.aidl</span><br><span class="line">├── ICameraServiceListener.aidl</span><br><span class="line">└── ICameraServiceProxy.aidl</span><br><span class="line"></span><br><span class="line">4 directories, 16 files</span><br></pre></td></tr></table></figure>

<p><code>frameworks/av/camera/aidl/</code> 目录下的 <code>aidl</code> 文件有两种类型：  </p>
<ul>
<li>作为 <code>Binder</code> 中的 <code>IInterface</code> 跨进程通信中能提供的方法  </li>
<li>作为 <code>Binder</code> 中的 <code>parcelable</code> 跨进程通信数据传输的数据结构  </li>
</ul>
<p>很容易从名字上区分这两种类型的文件，<code>IInterface</code> 类型的文件都是以 <code>I</code> 开头的，比如：<code>ICameraService.aidl, ICameraDeviceUser.aidl</code> 等。不管是哪种类型的 <code>aidl</code> 文件，它们都会生成对应的 <code>.java, .h, .cpp</code> 文件，分别供 <code>Java</code> 层和 <code>CPP</code> 层调用。  </p>
<h3 id="IInterface-类型文件"><a href="#IInterface-类型文件" class="headerlink" title="IInterface 类型文件"></a><code>IInterface</code> 类型文件</h3><p><code>IInterface</code> 类型文件一共有 7 个，它们的 <code>.java, .h, .cpp</code> 文件，绝大部分都是自动生成的。  </p>
<p><code>Java</code> 文件是在 <code>frameworks/base/Android.mk</code> 中定义规则，在编译时自动生成：  </p>
<figure class="highlight mk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// frameworks/base/Android.mk</span><br><span class="line">LOCAL_SRC_FILES += \</span><br><span class="line">    ...</span><br><span class="line">    ../av/camera/aidl/android/hardware/ICameraService.aidl \</span><br><span class="line">    ../av/camera/aidl/android/hardware/ICameraServiceListener.aidl \</span><br><span class="line">    ../av/camera/aidl/android/hardware/ICameraServiceProxy.aidl \</span><br><span class="line">    ../av/camera/aidl/android/hardware/ICamera.aidl \</span><br><span class="line">    ../av/camera/aidl/android/hardware/ICameraClient.aidl \</span><br><span class="line">    ../av/camera/aidl/android/hardware/camera2/ICameraDeviceUser.aidl \</span><br><span class="line">    ../av/camera/aidl/android/hardware/camera2/ICameraDeviceCallbacks.aidl \</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>在 <code>out/target/common/obj/JAVA_LIBRARIES/framework_intermediates/dotdot/</code> 目录下生成对应的 <code>Java</code> 文件：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// out/target/common/obj/JAVA_LIBRARIES/framework_intermediates/dotdot/</span><br><span class="line">av/camera/aidl/android/hardware/ICameraService.java</span><br><span class="line">av/camera/aidl/android/hardware/ICameraServiceListener.java</span><br><span class="line">av/camera/aidl/android/hardware/ICameraServiceProxy.java</span><br><span class="line">av/camera/aidl/android/hardware/ICamera.java</span><br><span class="line">av/camera/aidl/android/hardware/ICameraClient.java</span><br><span class="line">av/camera/aidl/android/hardware/camera2/ICameraDeviceUser.java</span><br><span class="line">av/camera/aidl/android/hardware/camera2/ICameraDeviceCallbacks.java</span><br></pre></td></tr></table></figure>

<p><code>.h, .cpp</code> 文件中，<code>ICamera.aidl, ICameraClient.aidl</code> 两个文件是直接以代码形式手动实现的：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 1. ICameraClient.aidl</span><br><span class="line">frameworks/av/camera/aidl/android/hardware/ICameraClient.aidl</span><br><span class="line">frameworks/av/camera/include/camera/android/hardware/ICameraClient.h</span><br><span class="line">frameworks/av/camera/ICameraClient.cpp</span><br><span class="line"></span><br><span class="line">// 2. ICamera.aidl</span><br><span class="line">frameworks/av/camera/aidl/android/hardware/ICamera.aidl</span><br><span class="line">frameworks/av/camera/include/camera/android/hardware/ICamera.h</span><br><span class="line">frameworks/av/camera/ICamera.cpp</span><br></pre></td></tr></table></figure>

<p>其他 5 个 <code>aidl</code> 文件是在 <code>frameworks/av/camera/Android.bp</code> 中定义规则，编译时自动生成对应的 <code>.h, .cpp</code> 文件：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// frameworks/av/camera/Android.bp</span><br><span class="line">cc_library_shared &#123;</span><br><span class="line">    name: &quot;libcamera_client&quot;,</span><br><span class="line"></span><br><span class="line">    aidl: &#123;</span><br><span class="line">        export_aidl_headers: true,</span><br><span class="line">        local_include_dirs: [&quot;aidl&quot;],</span><br><span class="line">        include_dirs: [</span><br><span class="line">            &quot;frameworks/native/aidl/gui&quot;,</span><br><span class="line">        ],</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    srcs: [</span><br><span class="line">        // AIDL files for camera interfaces</span><br><span class="line">        // The headers for these interfaces will be </span><br><span class="line">        // available to any modules that</span><br><span class="line">        // include libcamera_client, at the path &quot;aidl/package/path/BnFoo.h&quot;</span><br><span class="line">        &quot;aidl/android/hardware/ICameraService.aidl&quot;,</span><br><span class="line">        &quot;aidl/android/hardware/ICameraServiceListener.aidl&quot;,</span><br><span class="line">        &quot;aidl/android/hardware/ICameraServiceProxy.aidl&quot;,</span><br><span class="line">        &quot;aidl/android/hardware/camera2/ICameraDeviceCallbacks.aidl&quot;,</span><br><span class="line">        &quot;aidl/android/hardware/camera2/ICameraDeviceUser.aidl&quot;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        // Source for camera interface parcelables, </span><br><span class="line">        // and manually-written interfaces</span><br><span class="line">        &quot;Camera.cpp&quot;,</span><br><span class="line">        &quot;CameraMetadata.cpp&quot;,</span><br><span class="line">        &quot;CameraParameters.cpp&quot;,</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>out/soong/.intermediates/frameworks/av/camera/libcamera_client/</code> 目录下生成对应的 <code>.h, .cpp</code> 文件，通常在该目录下会同时生成 32 和 64 位两套代码，但实际两份代码是一样的，这里选取 64 位的：  </p>
<ul>
<li>64 位：<code>android_arm64_armv8-a_shared_core</code>  </li>
<li>32 位：<code>android_arm_armv7-a-neon_cortex-a53_shared_core</code>  </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// 目录 out/soong/.intermediates/frameworks/av/camera/libcamera_client</span><br><span class="line">// 64 位 android_arm64_armv8-a_shared_core/gen/aidl/</span><br><span class="line">android/hardware/ICameraService.h</span><br><span class="line">android/hardware/BnCameraService.h</span><br><span class="line">frameworks/av/camera/aidl/android/hardware/ICameraService.cpp</span><br><span class="line"></span><br><span class="line">android/hardware/ICameraServiceListener.h</span><br><span class="line">android/hardware/BnCameraServiceListener.h</span><br><span class="line">frameworks/av/camera/aidl/android/hardware/ICameraServiceListener.cpp</span><br><span class="line"></span><br><span class="line">android/hardware/ICameraServiceProxy.h</span><br><span class="line">android/hardware/BnCameraServiceProxy.h</span><br><span class="line">frameworks/av/camera/aidl/android/hardware/ICameraServiceProxy.cpp</span><br><span class="line"></span><br><span class="line">android/hardware/camera2/ICameraDeviceUser.h</span><br><span class="line">android/hardware/camera2/BnCameraDeviceUser.h</span><br><span class="line">frameworks/av/camera/aidl/android/hardware/camera2/ICameraDeviceUser.cpp</span><br><span class="line"></span><br><span class="line">android/hardware/camera2/ICameraDeviceCallbacks.h</span><br><span class="line">android/hardware/camera2/BnCameraDeviceCallbacks.h</span><br><span class="line">frameworks/av/camera/aidl/android/hardware/camera2/ICameraDeviceCallbacks.cpp</span><br></pre></td></tr></table></figure>

<h3 id="parcelable-类型文件"><a href="#parcelable-类型文件" class="headerlink" title="parcelable 类型文件"></a><code>parcelable</code> 类型文件</h3><p><code>parcelable</code> 类型文件一共有 9 个，它们都是手动编写的代码。  </p>
<p><code>Java</code> 文件目录为 <code>frameworks/base/core/java/android/hardware/</code> ：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// frameworks/base/core/java/android/hardware/</span><br><span class="line">camera2/CaptureRequest.java</span><br><span class="line">camera2/impl/CameraMetadataNative.java</span><br><span class="line">camera2/impl/CaptureResultExtras.java</span><br><span class="line">camera2/params/OutputConfiguration.java</span><br><span class="line">camera2/params/VendorTagDescriptor.java</span><br><span class="line">camera2/params/VendorTagDescriptorCache.java</span><br><span class="line">camera2/utils/SubmitInfo.java</span><br><span class="line">CameraInfo.java</span><br><span class="line">CameraStatus.java</span><br></pre></td></tr></table></figure>

<p><code>.h, .cpp</code> 文件并不一定是和 <code>aidl</code> 文件名称一一对应的，而是在 <code>aidl</code> 文件中定义的，比如 <code>CameraStatus.aidl</code> 定义如下：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">package android.hardware;</span><br><span class="line"></span><br><span class="line">/** @hide */</span><br><span class="line">parcelable CameraStatus cpp_header &quot;camera/CameraBase.h&quot;;</span><br></pre></td></tr></table></figure>

<p><code>parcelable</code> 类型的 <code>aidl</code> 文件对应的 <code>.h, .cpp</code> 文件目录为 <code>frameworks/av/camera</code> ，对应关系整理如下：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// .h, .cpp 文件目录 frameworks/av/camera</span><br><span class="line">// CaptureRequest.aidl</span><br><span class="line">include/camera/camera2/CaptureRequest.h</span><br><span class="line">camera2/CaptureRequest.cpp</span><br><span class="line"></span><br><span class="line">// CameraMetadataNative.aidl</span><br><span class="line">include/camera/CameraMetadata.h</span><br><span class="line">CameraMetadata.cpp</span><br><span class="line"></span><br><span class="line">// CaptureResultExtras.aidl</span><br><span class="line">include/camera/CaptureResult.h</span><br><span class="line">CaptureResult.cpp</span><br><span class="line"></span><br><span class="line">// OutputConfiguration.aidl</span><br><span class="line">include/camera/camera2/OutputConfiguration.h</span><br><span class="line">camera2/OutputConfiguration.cpp</span><br><span class="line"></span><br><span class="line">// VendorTagDescriptor.aidl 和 VendorTagDescriptorCache.aidl</span><br><span class="line">include/camera/VendorTagDescriptor.h</span><br><span class="line">VendorTagDescriptor.cpp</span><br><span class="line"></span><br><span class="line">// SubmitInfo.aidl</span><br><span class="line">include/camera/camera2/SubmitInfo.h</span><br><span class="line">camera2/SubmitInfo.cpp</span><br><span class="line"></span><br><span class="line">// CameraInfo.aidl 和 CameraStatus.aidl</span><br><span class="line">include/camera/CameraBase.h</span><br><span class="line">CameraBase.cpp</span><br></pre></td></tr></table></figure>

<h3 id="ICameraService-相关"><a href="#ICameraService-相关" class="headerlink" title="ICameraService 相关"></a><code>ICameraService</code> 相关</h3><p>分为客户端向服务端的请求 <code>ICameraService.aidl</code> 和客户端监听服务端的变化 <code>ICameraServiceListener.aidl</code> 。这两个 <code>AIDL</code> 是在 <code>CameraService.cpp</code> 中实现对应功能的。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. ICameraService.aidl</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ICameraService</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> CAMERA_TYPE_BACKWARD_COMPATIBLE = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> CAMERA_TYPE_ALL = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回指定类型的相机设备数量</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getNumberOfCameras</span><span class="params">(<span class="keyword">int</span> type)</span></span>;</span><br><span class="line">    <span class="comment">// 根据 id 返回当前相机设备信息</span></span><br><span class="line">    <span class="function">CameraInfo <span class="title">getCameraInfo</span><span class="params">(<span class="keyword">int</span> cameraId)</span></span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> CAMERA_HAL_API_VERSION_UNSPECIFIED = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// api1 + hal1</span></span><br><span class="line">    <span class="function">ICamera <span class="title">connect</span><span class="params">(ICameraClient client,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> cameraId,</span></span></span><br><span class="line"><span class="function"><span class="params">            String opPackageName,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> clientUid, <span class="keyword">int</span> clientPid)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// api2 + hal3</span></span><br><span class="line">    <span class="function">ICameraDeviceUser <span class="title">connectDevice</span><span class="params">(ICameraDeviceCallbacks callbacks,</span></span></span><br><span class="line"><span class="function"><span class="params">            String cameraId,</span></span></span><br><span class="line"><span class="function"><span class="params">            String opPackageName,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> clientUid)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// api1 + 指定 hal 版本（通常为 hal1）</span></span><br><span class="line">    <span class="function">ICamera <span class="title">connectLegacy</span><span class="params">(ICameraClient client,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> cameraId,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> halVersion,</span></span></span><br><span class="line"><span class="function"><span class="params">            String opPackageName,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> clientUid)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加和移除 ICameraServiceListener 监听</span></span><br><span class="line">    CameraStatus[] addListener(ICameraServiceListener listener);</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">removeListener</span><span class="params">(ICameraServiceListener listener)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据 id 返回相机支持的属性</span></span><br><span class="line">    <span class="function">CameraMetadataNative <span class="title">getCameraCharacteristics</span><span class="params">(String cameraId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 vendor tag </span></span><br><span class="line">    <span class="function">VendorTagDescriptor <span class="title">getCameraVendorTagDescriptor</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">VendorTagDescriptorCache <span class="title">getCameraVendorTagCache</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// camera api 1 获取参数信息</span></span><br><span class="line">    <span class="function">String <span class="title">getLegacyParameters</span><span class="params">(<span class="keyword">int</span> cameraId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> API_VERSION_1 = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> API_VERSION_2 = <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// 指定 id 支持的 API 版本</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">supportsCameraApi</span><span class="params">(String cameraId, <span class="keyword">int</span> apiVersion)</span></span>;</span><br><span class="line">    <span class="comment">// 指定 id 设置手电筒模式</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setTorchMode</span><span class="params">(String cameraId, <span class="keyword">boolean</span> enabled, </span></span></span><br><span class="line"><span class="function"><span class="params">        IBinder clientBinder)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 服务端向系统打印系统消息</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> EVENT_NONE = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> EVENT_USER_SWITCHED = <span class="number">1</span>;</span><br><span class="line">    <span class="function">oneway <span class="keyword">void</span> <span class="title">notifySystemEvent</span><span class="params">(<span class="keyword">int</span> eventId, in <span class="keyword">int</span>[] args)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. ICameraServiceListener.aidl</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ICameraServiceListener</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> STATUS_NOT_PRESENT      = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> STATUS_PRESENT          = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> STATUS_ENUMERATING      = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> STATUS_NOT_AVAILABLE    = -<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> STATUS_UNKNOWN          = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 相机设备状态变化事件</span></span><br><span class="line">    <span class="function">oneway <span class="keyword">void</span> <span class="title">onStatusChanged</span><span class="params">(<span class="keyword">int</span> status, String cameraId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> TORCH_STATUS_NOT_AVAILABLE = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> TORCH_STATUS_AVAILABLE_OFF = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> TORCH_STATUS_AVAILABLE_ON  = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> TORCH_STATUS_UNKNOWN = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 手电筒状态变化事件</span></span><br><span class="line">    <span class="function">oneway <span class="keyword">void</span> <span class="title">onTorchStatusChanged</span><span class="params">(<span class="keyword">int</span> status, String cameraId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ICameraServiceProxy-aidl-文件"><a href="#ICameraServiceProxy-aidl-文件" class="headerlink" title="ICameraServiceProxy.aidl 文件"></a><code>ICameraServiceProxy.aidl</code> 文件</h3><p><code>CameraServiceProxy</code> 服务是在 <code>Java</code> 层注册的：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ICameraServiceProxy</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// CameraService 向代理服务发送消息，通知用户更新</span></span><br><span class="line">    <span class="function">oneway <span class="keyword">void</span> <span class="title">pingForUserUpdate</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> CAMERA_STATE_OPEN = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> CAMERA_STATE_ACTIVE = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> CAMERA_STATE_IDLE = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> CAMERA_STATE_CLOSED = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> CAMERA_FACING_BACK = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> CAMERA_FACING_FRONT = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> CAMERA_FACING_EXTERNAL = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CameraService 向代理服务发送消息，通知相机设备状态更新</span></span><br><span class="line">    <span class="function">oneway <span class="keyword">void</span> <span class="title">notifyCameraState</span><span class="params">(String cameraId, <span class="keyword">int</span> facing, </span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> newCameraState, String clientName)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ICamera-相关"><a href="#ICamera-相关" class="headerlink" title="ICamera 相关"></a><code>ICamera</code> 相关</h3><p><code>Camera API1</code> 才会使用到，分为 <code>ICamera.aidl, ICameraClient.aidl</code><br>它们的代码是手动实现的，参考：<code>CameraClient.h/cpp, Camera.h/cpp</code>  </p>
<h3 id="ICameraDevice-相关"><a href="#ICameraDevice-相关" class="headerlink" title="ICameraDevice 相关"></a><code>ICameraDevice</code> 相关</h3><p><code>Camera API2</code> 才会使用到，分为客户端向服务端的请求 <code>ICameraDeviceUser.aidl</code> 和服务端发给客户端的回调 <code>ICameraDeviceCallbacks.aidl</code> 。<br>表示相机设备具备的能力，能够提供的函数；这两个 <code>AIDL</code> 是在 <code>CameraDeviceClient</code> 中实现对应功能的。    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. ICameraDeviceUser.aidl </span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ICameraDeviceUser</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">disconnect</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> NO_IN_FLIGHT_REPEATING_FRAMES = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 向设备提交捕获请求</span></span><br><span class="line">    <span class="function">SubmitInfo <span class="title">submitRequest</span><span class="params">(in CaptureRequest request, <span class="keyword">boolean</span> streaming)</span></span>;</span><br><span class="line">    <span class="function">SubmitInfo <span class="title">submitRequestList</span><span class="params">(in CaptureRequest[] requestList, </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> streaming)</span></span>;</span><br><span class="line">    <span class="comment">// 取消置顶 id 的重复请求，并返回上次请求的帧 id</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">cancelRequest</span><span class="params">(<span class="keyword">int</span> requestId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> NORMAL_MODE = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> CONSTRAINED_HIGH_SPEED_MODE = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> VENDOR_MODE_START = <span class="number">0x8000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在流处理前执行配置请求</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">beginConfigure</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 根据指定输出配置，创建流</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">createStream</span><span class="params">(in OutputConfiguration outputConfiguration)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">endConfigure</span><span class="params">(<span class="keyword">int</span> operatingMode)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deleteStream</span><span class="params">(<span class="keyword">int</span> streamId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建输入流，返回流 id</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">createInputStream</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height, <span class="keyword">int</span> format)</span></span>;</span><br><span class="line">    <span class="comment">// 返回输入流的 Surface</span></span><br><span class="line">    <span class="function">Surface <span class="title">getInputSurface</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Keep in sync with public API in</span></span><br><span class="line">    <span class="comment">// frameworks/base/core/java/android/hardware/camera2/CameraDevice.java</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> TEMPLATE_PREVIEW = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> TEMPLATE_STILL_CAPTURE = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> TEMPLATE_RECORD = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> TEMPLATE_VIDEO_SNAPSHOT = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> TEMPLATE_ZERO_SHUTTER_LAG = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> TEMPLATE_MANUAL = <span class="number">6</span>;</span><br><span class="line">    <span class="comment">// 根据模板创建默认请求，返回相机参数信息</span></span><br><span class="line">    <span class="function">CameraMetadataNative <span class="title">createDefaultRequest</span><span class="params">(<span class="keyword">int</span> templateId)</span></span>;</span><br><span class="line">    <span class="comment">// 获取相机参数信息</span></span><br><span class="line">    <span class="function">CameraMetadataNative <span class="title">getCameraInfo</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">waitUntilIdle</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">flush</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">prepare</span><span class="params">(<span class="keyword">int</span> streamId)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">tearDown</span><span class="params">(<span class="keyword">int</span> streamId)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">prepare2</span><span class="params">(<span class="keyword">int</span> maxCount, <span class="keyword">int</span> streamId)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">finalizeOutputConfigurations</span><span class="params">(<span class="keyword">int</span> streamId, </span></span></span><br><span class="line"><span class="function"><span class="params">        in OutputConfiguration outputConfiguration)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. ICameraDeviceCallbacks.aidl</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ICameraDeviceCallbacks</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function">oneway <span class="keyword">void</span> <span class="title">onDeviceError</span><span class="params">(<span class="keyword">int</span> errorCode, </span></span></span><br><span class="line"><span class="function"><span class="params">        in CaptureResultExtras resultExtras)</span></span>;</span><br><span class="line">    <span class="function">oneway <span class="keyword">void</span> <span class="title">onDeviceIdle</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">oneway <span class="keyword">void</span> <span class="title">onCaptureStarted</span><span class="params">(in CaptureResultExtras resultExtras, </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">long</span> timestamp)</span></span>;</span><br><span class="line">    <span class="function">oneway <span class="keyword">void</span> <span class="title">onResultReceived</span><span class="params">(in CameraMetadataNative result,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 in CaptureResultExtras resultExtras)</span></span>;</span><br><span class="line">    <span class="function">oneway <span class="keyword">void</span> <span class="title">onPrepared</span><span class="params">(<span class="keyword">int</span> streamId)</span></span>;</span><br><span class="line">    <span class="comment">// 重复请求引起的错误回调</span></span><br><span class="line">    <span class="function">oneway <span class="keyword">void</span> <span class="title">onRepeatingRequestError</span><span class="params">(in <span class="keyword">long</span> lastFrameNumber,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        in <span class="keyword">int</span> repeatingRequestId)</span></span>;</span><br><span class="line">    <span class="function">oneway <span class="keyword">void</span> <span class="title">onRequestQueueEmpty</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Services-目录下的文件介绍"><a href="#Services-目录下的文件介绍" class="headerlink" title="Services 目录下的文件介绍"></a><code>Services</code> 目录下的文件介绍</h2><p><code>frameworks/av/services/camera/libcameraservice</code><br><code>AOSP</code> 中这个目录下是 87 个文件，而 <code>Qcom</code> 的基线中增加了 27 个文件，分别为 <code>api1/qticlient2</code> 目录下的 25 个文件，以及 <code>QTICamera2Client.cpp, QTICamera2Client.h</code> 两个文件。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── Android.mk</span><br><span class="line">├── api1</span><br><span class="line">│   ├── client2</span><br><span class="line">│   └── qticlient2</span><br><span class="line">├── api2</span><br><span class="line">├── CameraFlashlight.cpp</span><br><span class="line">├── CameraFlashlight.h</span><br><span class="line">├── CameraService.cpp</span><br><span class="line">├── CameraService.h</span><br><span class="line">├── common</span><br><span class="line">├── device1</span><br><span class="line">├── device3</span><br><span class="line">├── gui</span><br><span class="line">├── MODULE_LICENSE_APACHE2</span><br><span class="line">├── NOTICE</span><br><span class="line">├── tests</span><br><span class="line">└── utils</span><br></pre></td></tr></table></figure>

<p>从目录结构上可以看出，<code>API1/2</code> 和 <code>HAL1/3</code> 就是在这一层体现的。  </p>
<h3 id="API1-API2"><a href="#API1-API2" class="headerlink" title="API1/API2"></a><code>API1/API2</code></h3><p><code>APP Java</code> 客户端调用服务端方法时，<code>Camera API1/2</code> 接口对应功能都是在 <code>CameraService</code> 中实现的，而这里的 <code>API1/2</code> 目录对应的就是对上层不同版本接口的处理。  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">api1</span><br><span class="line">├── Camera2Client.cpp</span><br><span class="line">├── Camera2Client.h</span><br><span class="line">├── CameraClient.cpp</span><br><span class="line">├── CameraClient.h</span><br><span class="line">├── client2</span><br><span class="line">│   ├── CallbackProcessor.cpp</span><br><span class="line">│   ├── CallbackProcessor.h</span><br><span class="line">│   ├── Camera2Heap.h</span><br><span class="line">│   ├── CaptureSequencer.cpp</span><br><span class="line">│   ├── CaptureSequencer.h</span><br><span class="line">│   ├── FrameProcessor.cpp</span><br><span class="line">│   ├── FrameProcessor.h</span><br><span class="line">│   ├── JpegCompressor.cpp</span><br><span class="line">│   ├── JpegCompressor.h</span><br><span class="line">│   ├── JpegProcessor.cpp</span><br><span class="line">│   ├── JpegProcessor.h</span><br><span class="line">│   ├── Parameters.cpp</span><br><span class="line">│   ├── Parameters.h</span><br><span class="line">│   ├── StreamingProcessor.cpp</span><br><span class="line">│   ├── StreamingProcessor.h</span><br><span class="line">│   ├── ZslProcessor.cpp</span><br><span class="line">│   └── ZslProcessor.h</span><br><span class="line">├── QTICamera2Client.cpp</span><br><span class="line">├── QTICamera2Client.h</span><br><span class="line">└── qticlient2</span><br><span class="line">    ├── CallbackProcessor.cpp</span><br><span class="line">    ├── CallbackProcessor.h</span><br><span class="line">    ├── Camera2Heap.h</span><br><span class="line">    ├── CaptureSequencer.cpp</span><br><span class="line">    ├── CaptureSequencer.h</span><br><span class="line">    ├── FrameProcessor.cpp</span><br><span class="line">    ├── FrameProcessor.h</span><br><span class="line">    ├── JpegCompressor.cpp</span><br><span class="line">    ├── JpegCompressor.h</span><br><span class="line">    ├── JpegProcessor.cpp</span><br><span class="line">    ├── JpegProcessor.h</span><br><span class="line">    ├── Parameters.cpp</span><br><span class="line">    ├── Parameters.h</span><br><span class="line">    ├── QTICaptureSequencer.cpp</span><br><span class="line">    ├── QTICaptureSequencer.h</span><br><span class="line">    ├── QTIFrameProcessor.cpp</span><br><span class="line">    ├── QTIFrameProcessor.h</span><br><span class="line">    ├── QTIParameters.cpp</span><br><span class="line">    ├── QTIParameters.h</span><br><span class="line">    ├── RawProcessor.cpp</span><br><span class="line">    ├── RawProcessor.h</span><br><span class="line">    ├── StreamingProcessor.cpp</span><br><span class="line">    ├── StreamingProcessor.h</span><br><span class="line">    ├── ZslProcessor.cpp</span><br><span class="line">    └── ZslProcessor.h</span><br><span class="line">api2</span><br><span class="line">├── CameraDeviceClient.cpp</span><br><span class="line">└── CameraDeviceClient.h</span><br></pre></td></tr></table></figure>

<p><code>BasicClient</code> 有三个重要的子类：  </p>
<ul>
<li><code>CameraClient</code><br>如果平台仅支持 <code>HAL 1</code>，即 <code>CAMERA_DEVICE_API_VERSION_1_0</code> ；使用 <code>API 1/2 + HAL 1</code> 都会对应该客户端。  </li>
<li><code>Camera2Client</code><br>如果平台支持 <code>HAL 3</code> ，即 <code>CAMERA_DEVICE_API_VERSION_3_0</code> 及以上版本；使用 <code>API 1 + HAL 3</code> 对应的客户端。<code>Camera2Client</code> 会将 <code>API1</code> 中的接口转换为 <code>API2</code> 中对应的功能。  </li>
<li><code>CameraDeviceClient</code><br>如果平台支持 <code>HAL 3</code> ，使用 <code>API 2 + HAL 3</code> 对应的客户端。  </li>
</ul>
<p>平台仅支持 <code>HAL 1</code> 时，<code>API 2</code> 在 <code>openCamera</code> 时，通过 <code>CameraDeviceUserShim</code> 将 <code>API 2</code> 转换为 <code>API 1</code> ，即 <code>HAL 1 + API 1</code> 向下发起请求。<br><code>LegacyCameraDevice</code> 会将 <code>CAMERA API2</code> 转换为 <code>CAMERA API1</code> ，而 <code>CameraDeviceUserShim</code> 封装了 <code>LegacyCameraDevice</code> 。  </p>
<h3 id="QTICamera2Client"><a href="#QTICamera2Client" class="headerlink" title="QTICamera2Client"></a><code>QTICamera2Client</code></h3><p><code>Qcom</code> 的基线中增加了 27 个文件，分别为 <code>api1/qticlient2</code> 目录下的 25 个文件，以及 <code>QTICamera2Client.cpp, QTICamera2Client.h</code> 两个文件。<br>而 <code>QTICamera2Client</code> 是高通针对 <code>API1</code> 做的优化？在什么情况下会转换为 <code>QTICamera2Client</code> 呢？看如下源码：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. Camera2Client.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Camera2Client</span> :</span></span><br><span class="line">        <span class="keyword">public</span> Camera2ClientBase&lt;CameraService::Client&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_QTI_CAMERA2CLIENT</span></span><br><span class="line"><span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">QTICamera2Client</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_QTI_CAMERA2CLIENT</span></span><br><span class="line">    sp&lt;camera2::RawProcessor&gt; mRawProcessor;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_QTI_CAMERA2CLIENT</span></span><br><span class="line">    sp&lt;QTICamera2Client&gt; mQTICamera2Client;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. Camera2Client.cpp</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> TProviderPtr&gt;</span><br><span class="line"><span class="keyword">status_t</span> Camera2Client::initializeImpl(TProviderPtr providerPtr)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_QTI_CAMERA2CLIENT</span></span><br><span class="line">    mQTICamera2Client = <span class="keyword">new</span> QTICamera2Client(<span class="keyword">this</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_QTI_CAMERA2CLIENT</span></span><br><span class="line">    mRawProcessor = <span class="keyword">new</span> RawProcessor(<span class="keyword">this</span>, mCaptureSequencer);</span><br><span class="line">    threadName = String8::format(<span class="string">"C2-%d-RawProc"</span>, mCameraId);</span><br><span class="line">    mRawProcessor-&gt;run(threadName.<span class="built_in">string</span>());</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>QTICamera2Client</code> 是高通对 <code>API 1</code> 中 <code>Camera2Client</code> 做的一层封装，添加了部分功能，主要是向上提供 <code>raw</code> 数据。  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. QTICamera2Client.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QTICamera2Client</span>:</span> <span class="keyword">public</span> <span class="keyword">virtual</span> RefBase&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    wp&lt;Camera2Client&gt; mParentClient;</span><br><span class="line">    <span class="keyword">status_t</span> stopPreviewExtn();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    QTICamera2Client(sp&lt;Camera2Client&gt; client);</span><br><span class="line">    ~QTICamera2Client();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. QTICamera2Client.cpp</span></span><br><span class="line">QTICamera2Client::QTICamera2Client(sp&lt;Camera2Client&gt; client):</span><br><span class="line">        mParentClient(client) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="device1-device3"><a href="#device1-device3" class="headerlink" title="device1/device3"></a><code>device1/device3</code></h3><p><code>device1/device3</code> 可以理解为 <code>Framework</code> 层对应 <code>HAL</code> 层的 <code>HAL 1/3</code> 。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">device1</span><br><span class="line">├── CameraHardwareInterface.cpp</span><br><span class="line">└── CameraHardwareInterface.h</span><br><span class="line">device3</span><br><span class="line">├── Camera3BufferManager.cpp</span><br><span class="line">├── Camera3BufferManager.h</span><br><span class="line">├── Camera3Device.cpp</span><br><span class="line">├── Camera3Device.h</span><br><span class="line">├── Camera3DummyStream.cpp</span><br><span class="line">├── Camera3DummyStream.h</span><br><span class="line">├── Camera3InputStream.cpp</span><br><span class="line">├── Camera3InputStream.h</span><br><span class="line">├── Camera3IOStreamBase.cpp</span><br><span class="line">├── Camera3IOStreamBase.h</span><br><span class="line">├── Camera3OutputStream.cpp</span><br><span class="line">├── Camera3OutputStream.h</span><br><span class="line">├── Camera3OutputStreamInterface.h</span><br><span class="line">├── Camera3SharedOutputStream.cpp</span><br><span class="line">├── Camera3SharedOutputStream.h</span><br><span class="line">├── Camera3StreamBufferFreedListener.h</span><br><span class="line">├── Camera3StreamBufferListener.h</span><br><span class="line">├── Camera3Stream.cpp</span><br><span class="line">├── Camera3Stream.h</span><br><span class="line">├── Camera3StreamInterface.h</span><br><span class="line">├── Camera3StreamSplitter.cpp</span><br><span class="line">├── Camera3StreamSplitter.h</span><br><span class="line">├── StatusTracker.cpp</span><br><span class="line">└── StatusTracker.h</span><br></pre></td></tr></table></figure>

<ul>
<li><code>API1/device1/HAL1</code> 的连接过程  </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// API1: CameraClient.h</span><br><span class="line">sp&lt;CameraHardwareInterface&gt;     mHardware;</span><br><span class="line">// device1: CameraHardwareInterface.h</span><br><span class="line">sp&lt;hardware::camera::device::V1_0::ICameraDevice&gt; mHidlDevice;</span><br><span class="line">// 这里的 ICameraDevice 即为 HAL1</span><br></pre></td></tr></table></figure>

<p><code>API1</code> 的客户端 <code>CameraClient</code> 对应的 <code>device1: CameraHardwareInterface</code>，而它直接包含了 <code>HAL1</code> 中 <code>ICameraDevice</code> 。  </p>
<ul>
<li><code>API1/3/device3/HAL3</code> 的连接过程  <figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// API1: Camera2Client.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Camera2Client</span> :</span></span><br><span class="line">    <span class="keyword">public</span> Camera2ClientBase&lt;CameraService::Client&gt;&#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// API2: CameraDeviceClient.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CameraDeviceClient</span> :</span></span><br><span class="line">    <span class="keyword">public</span> Camera2ClientBase&lt;CameraDeviceClientBase&gt;,</span><br><span class="line">    <span class="keyword">public</span> camera2::FrameProcessorBase::FilteredListener&#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Camera2ClientBase.h</span></span><br><span class="line">sp&lt;CameraDeviceBase&gt;  mDevice;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Camera2ClientBase.cpp</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TClientBase&gt;</span><br><span class="line">Camera2ClientBase&lt;TClientBase&gt;::Camera2ClientBase(</span><br><span class="line">    <span class="keyword">const</span> sp&lt;CameraService&gt;&amp; cameraService,</span><br><span class="line">    <span class="keyword">const</span> sp&lt;TCamCallbacks&gt;&amp; remoteCallback,</span><br><span class="line">    <span class="keyword">const</span> String16&amp; clientPackageName,</span><br><span class="line">    <span class="keyword">const</span> String8&amp; cameraId,</span><br><span class="line">    <span class="keyword">int</span> cameraFacing,</span><br><span class="line">    <span class="keyword">int</span> clientPid,</span><br><span class="line">    <span class="keyword">uid_t</span> clientUid,</span><br><span class="line">    <span class="keyword">int</span> servicePid):</span><br><span class="line">    TClientBase(cameraService, remoteCallback, clientPackageName,</span><br><span class="line">            cameraId, cameraFacing, clientPid, clientUid, servicePid),</span><br><span class="line">    mSharedCameraCallbacks(remoteCallback),</span><br><span class="line">    mDeviceVersion(cameraService-&gt;getDeviceVersion(</span><br><span class="line">            TClientBase::mCameraIdStr)),</span><br><span class="line">    mDeviceActive(<span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    mInitialClientPid = clientPid;</span><br><span class="line">    <span class="comment">// 只要是 HAL3 ，则 device 都是对应的 Camera3Device</span></span><br><span class="line">    mDevice = <span class="keyword">new</span> Camera3Device(cameraId);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>从源码可以看出，不管是 <code>API1/2</code> ，只要是 <code>HAL 3</code> ，<code>Camera2Client, CameraDeviceClient</code> 两个客户端对应的都是 <code>device3: Camera3Device</code> 。  </p>
<p><code>Camera3Device::HalInterface</code> 内部类，用于和 <code>HAL</code> 层通信，实现了 <code>HAL</code> 层 <code>ICameraDeviceSession.hal</code> 部分代码：  </p>
<figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Camera3Device.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Camera3Device</span> :</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">HalInterface</span> :</span> <span class="keyword">public</span> camera3::Camera3StreamBufferFreedListener &#123;</span><br><span class="line">      <span class="keyword">public</span>:</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// Calls into the HAL interface</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Caller takes ownership of requestTemplate</span></span><br><span class="line">        <span class="keyword">status_t</span> constructDefaultRequestSettings(</span><br><span class="line">                <span class="keyword">camera3_request_template_t</span> templateId,</span><br><span class="line">                <span class="comment">/*out*/</span> <span class="keyword">camera_metadata_t</span> **requestTemplate);</span><br><span class="line">        <span class="keyword">status_t</span> configureStreams(</span><br><span class="line">            <span class="comment">/*inout*/</span> camera3_stream_configuration *config);</span><br><span class="line">        <span class="keyword">status_t</span> processCaptureRequest(<span class="keyword">camera3_capture_request_t</span> *request);</span><br><span class="line">        <span class="keyword">status_t</span> flush();</span><br><span class="line">        <span class="keyword">status_t</span> close();</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="cameraserver-进程"><a href="#cameraserver-进程" class="headerlink" title="cameraserver 进程"></a><code>cameraserver</code> 进程</h2><p><code>cameraserver</code> 进程的源码在 <code>frameworks/av/camera/cameraserver</code> 目录下，该目录只有三个文件：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── Android.mk              </span><br><span class="line">├── cameraserver.rc         // rc 文件</span><br><span class="line">└── main_cameraserver.cpp   // 主进程</span><br></pre></td></tr></table></figure>

<p><code>cameraserver</code> 进程在启动时，做了三件事：  </p>
<ul>
<li>设置 <code>Socket</code> 通信时，对端关闭读取时进程不退出，返回错误信息（<code>Socket</code> 用在了哪？）  </li>
<li><code>HIDL</code> 通信初始化  </li>
<li><code>Native Binder</code> 初始化，<code>CameraService</code> 向 <code>service_manager</code> 注册服务  </li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/av/camera/cameraserver/main_cameraserver.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc __unused, <span class="keyword">char</span>** argv __unused)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 1. Socket 通信时，对端关闭读取时进程不退出，返回错误信息</span></span><br><span class="line">    signal(SIGPIPE, SIG_IGN);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. HIDL 通信初始化</span></span><br><span class="line">    <span class="comment">// Set 3 threads for HIDL calls</span></span><br><span class="line">    hardware::configureRpcThreadpool(<span class="number">3</span>, <span class="comment">/*willjoin*/</span> <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. Native Binder 初始化，CameraService 是具体的服务</span></span><br><span class="line">    sp&lt;ProcessState&gt; proc(ProcessState::self());</span><br><span class="line">    sp&lt;IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line">    ALOGI(<span class="string">"ServiceManager: %p"</span>, sm.get());</span><br><span class="line">    CameraService::instantiate();</span><br><span class="line">    ProcessState::self()-&gt;startThreadPool();</span><br><span class="line">    IPCThreadState::self()-&gt;joinThreadPool();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// init 进程启动名字为 cameraserver 的进程及对应路径</span><br><span class="line">service cameraserver /system/bin/cameraserver</span><br><span class="line">    // class 表示类别，同一类别的进程同时启动</span><br><span class="line">    class main</span><br><span class="line">    // 用户名</span><br><span class="line">    user cameraserver</span><br><span class="line">    // 分组</span><br><span class="line">    group audio camera input drmrpc</span><br><span class="line">    ioprio rt 4</span><br><span class="line">    writepid /dev/cpuset/camera-daemon/tasks /dev/stune/top-app/tasks</span><br></pre></td></tr></table></figure>

<p><code>CameraService</code> 启动服务注册流程图：<br><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0109-android-camera-4-framework-CameraService-addService.png" alt="0109-android-camera-4-framework-CameraService-addService.png"></p>
<h2 id="CameraService-服务"><a href="#CameraService-服务" class="headerlink" title="CameraService 服务"></a><code>CameraService</code> 服务</h2><p><code>CameraService</code> 服务的名称为：<code>media.camera</code> ，主要有两个功能：  </p>
<ul>
<li>作为服务端<br>实现 <code>AIDL</code> 对应功能，当 <code>API1/2</code> 客户端发出请求后，作为服务端响应并处理这些功能。  </li>
<li>作为客户端<br>实现 <code>HIDL</code> 回调，用于响应 <code>HAL</code> 层发回的回调。并且通过 <code>CameraProviderManager</code> 和 <code>HAL</code> 层实现双向通信。  </li>
</ul>
<h3 id="服务名称"><a href="#服务名称" class="headerlink" title="服务名称"></a>服务名称</h3><p><code>CameraService</code> 继承了 <code>BinderService&lt;CameraService&gt;</code> ，将 <code>CameraService::instantiate();</code> 代码展开：  </p>
<figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BinderService.h</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> SERVICE&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BinderService</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">static</span> status_t <span class="title">publish</span><span class="params">(<span class="keyword">bool</span> allowIsolated = <span class="literal">false</span>)</span> </span>&#123;</span><br><span class="line">        sp&lt;IServiceManager&gt; sm(defaultServiceManager());</span><br><span class="line">        <span class="keyword">return</span> sm-&gt;addService(</span><br><span class="line">                String16(SERVICE::getServiceName()),</span><br><span class="line">                <span class="keyword">new</span> SERVICE(), allowIsolated);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">instantiate</span><span class="params">()</span> </span>&#123; publish(); &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IServiceManager.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IServiceManager</span> :</span> <span class="keyword">public</span> IInterface</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> status_t <span class="title">addService</span><span class="params">( <span class="keyword">const</span> String16&amp; name,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; service,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">bool</span> allowIsolated = <span class="literal">false</span>)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CameraService.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CameraService</span> :</span></span><br><span class="line">    <span class="keyword">public</span> BinderService&lt;CameraService&gt;,</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> ::android::hardware::BnCameraService,</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> IBinder::DeathRecipient,</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">camera_module_callbacks_t</span>,</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> CameraProviderManager::StatusListener</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Implementation of BinderService&lt;T&gt;</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">char</span> <span class="keyword">const</span>* <span class="title">getServiceName</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">"media.camera"</span>; &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从继承关系及 <code>CameraService.h</code> 源码，<code>getServiceName</code> 设置了 <code>CameraService</code> 服务的名称为 <code>media.camera</code> 。  </p>
<h3 id="注册流程图"><a href="#注册流程图" class="headerlink" title="注册流程图"></a>注册流程图</h3><p><a href="https://upload-images.jianshu.io/upload_images/606437-391f5324221572ec.jpg" target="_blank" rel="noopener">CameraService 注册流程，查看原图</a>  </p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0109-android-camera-4-framework-CameraService-init.jpg" alt="0109-android-camera-4-framework-CameraService-init.jpg"></p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p>先来看 <code>CameraService.h</code> 头文件相关定义：  </p>
<figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraService.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CameraService</span> :</span></span><br><span class="line">    <span class="keyword">public</span> BinderService&lt;CameraService&gt;,</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> ::android::hardware::BnCameraService,</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> IBinder::DeathRecipient,</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">camera_module_callbacks_t</span>,</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> CameraProviderManager::StatusListener</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">char</span> <span class="keyword">const</span>* <span class="title">getServiceName</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">"media.camera"</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>BinderService</code><br>继承了 <code>BinderService</code> ，用于注册服务。服务名称为 <code>media.camera</code> 。 </li>
<li><code>camera_module_callbacks_t</code><br>继承了 <code>camera_module_callbacks_t</code> ，它是在 <code>HAL</code> 中定义的，用于 <code>HAL</code> 向 <code>Framework</code> 发送通知。  </li>
<li><code>StatusListener</code><br>继承了 <code>StatusListener</code> ，它是在 <code>CameraProviderManager.h</code> 中定义的，用于 <code>CameraProviderManager</code> 向 <code>CameraService</code> 发送通知。  </li>
</ul>
<p>现在查看 <code>CameraService</code> 的构造方法，因为在注册服务时 <code>BinderService</code> 会对 <code>CameraService</code> 强指针引用，所以会调用对应函数 <code>onFirstRef</code> ：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraService.cpp</span></span><br><span class="line">CameraService::CameraService() :</span><br><span class="line">        mEventLog(DEFAULT_EVENT_LOG_LENGTH),</span><br><span class="line">        mNumberOfCameras(<span class="number">0</span>), mNumberOfNormalCameras(<span class="number">0</span>),</span><br><span class="line">        mSoundRef(<span class="number">0</span>), mInitialized(<span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="comment">// camera_module_callbacks_t 结构体的函数指针赋值</span></span><br><span class="line">    <span class="keyword">this</span>-&gt;camera_device_status_change = </span><br><span class="line">        android::camera_device_status_change;</span><br><span class="line">    <span class="keyword">this</span>-&gt;torch_mode_status_change = android::torch_mode_status_change;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> CameraService::onFirstRef()</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function">BatteryNotifier&amp; <span class="title">notifier</span><span class="params">(BatteryNotifier::getInstance())</span></span>;</span><br><span class="line">    notifier.noteResetCamera();</span><br><span class="line">    notifier.noteResetFlashlight();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> res = INVALID_OPERATION;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实例化 CameraProviderManager ，并连接 Hardware</span></span><br><span class="line">    res = enumerateProviders();</span><br><span class="line">    <span class="keyword">if</span> (res == OK) &#123;</span><br><span class="line">        mInitialized = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CameraServiceProxy 服务是 Java 代码注册的</span></span><br><span class="line">    <span class="comment">// 但是 CameraService 启动时间很早，CameraServiceProxy 可能还并没有注册</span></span><br><span class="line">    <span class="comment">// 实际调试结果也是，这段代码实际不会调用 CameraServiceProxy 对应方法</span></span><br><span class="line">    CameraService::pingCameraServiceProxy();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造函数中非常简单，仅仅是将 <code>camera_module_callbacks_t</code> 结构体的函数指针赋值；在 <code>onFirstRef</code> 中，主要通过 <code>enumerateProviders</code> 来实例化对应的 <code>CameraProviderManager</code> 并连接 <code>HAL</code> ，最后去 <code>ping</code> 一次 <code>CameraServiceProxy</code> 代理服务，实际上是 <code>ping</code> 不通的，因为 <code>CameraService.cpp</code> 一定是比 <code>CameraServiceProxy.java</code> 启动的早。  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraService.cpp</span></span><br><span class="line"><span class="keyword">status_t</span> CameraService::enumerateProviders() &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 实例化 CameraProviderManager</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">nullptr</span> == mCameraProviderManager.get()) &#123;</span><br><span class="line">        mCameraProviderManager = <span class="keyword">new</span> CameraProviderManager();</span><br><span class="line">        res = mCameraProviderManager-&gt;initialize(<span class="keyword">this</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mNumberOfCameras = mCameraProviderManager-&gt;getCameraCount();</span><br><span class="line">    mNumberOfNormalCameras =</span><br><span class="line">            mCameraProviderManager-&gt;getAPI1CompatibleCameraCount();</span><br><span class="line">    mCameraProviderManager-&gt;setUpVendorTags();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">nullptr</span> == mFlashlight.get()) &#123;</span><br><span class="line">        mFlashlight = <span class="keyword">new</span> CameraFlashlight(mCameraProviderManager, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    res = mFlashlight-&gt;findFlashUnits();</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; cameraId : mCameraProviderManager-&gt;getCameraDeviceIds())&#123;</span><br><span class="line">        ...</span><br><span class="line">        onDeviceStatusChanged(id8, CameraDeviceStatus::PRESENT);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果 <code>mCameraProviderManager</code> 为空，则实例化并调用 <code>initialize</code> ；接着实例化 <code>CameraFlashlight</code> ；先看头文件 <code>CameraProviderManager.h</code> 中定义的几个重要数据结构和函数：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraProviderManager.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CameraProviderManager</span> :</span> </span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">public</span> hidl::manager::V1_0::IServiceNotification &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 定义纯虚函数</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ServiceInteractionProxy</span> &#123;</span></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">registerForNotifications</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;serviceName,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">const</span> sp&lt;hidl::manager::V1_0::IServiceNotification&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">                &amp;notification)</span> </span>= <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">virtual</span> sp&lt;hardware::camera::provider::V2_4::ICameraProvider&gt; </span><br><span class="line">                getService(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;serviceName) = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">virtual</span> ~ServiceInteractionProxy() &#123;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用 ICameraProvider 实现这些方法</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">HardwareServiceInteractionProxy</span> :</span> </span><br><span class="line">            <span class="keyword">public</span> ServiceInteractionProxy &#123;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">registerForNotifications</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;serviceName,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">const</span> sp&lt;hidl::manager::V1_0::IServiceNotification&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">                &amp;notification)</span> override </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> hardware::camera::provider::V2_4::</span><br><span class="line">                    ICameraProvider::registerForNotifications(</span><br><span class="line">                    serviceName, notification);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">virtual</span> sp&lt;hardware::camera::provider::V2_4::ICameraProvider&gt;</span><br><span class="line">                getService(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;serviceName) override &#123;</span><br><span class="line">            <span class="keyword">return</span> hardware::camera::provider::V2_4::</span><br><span class="line">                    ICameraProvider::getService(serviceName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">StatusListener</span> :</span> <span class="keyword">virtual</span> <span class="keyword">public</span> RefBase &#123;</span><br><span class="line">        ~StatusListener() &#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onDeviceStatusChanged</span><span class="params">(<span class="keyword">const</span> String8 &amp;cameraId,</span></span></span><br><span class="line"><span class="function"><span class="params">                hardware::camera::common::V1_0::CameraDeviceStatus </span></span></span><br><span class="line"><span class="function"><span class="params">                newStatus)</span> </span>= <span class="number">0</span>;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onTorchStatusChanged</span><span class="params">(<span class="keyword">const</span> String8 &amp;cameraId,</span></span></span><br><span class="line"><span class="function"><span class="params">                hardware::camera::common::V1_0::TorchModeStatus </span></span></span><br><span class="line"><span class="function"><span class="params">                newStatus)</span> </span>= <span class="number">0</span>;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onNewProviderRegistered</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> hardware::Return&lt;<span class="keyword">void</span>&gt; onRegistration(</span><br><span class="line">            <span class="keyword">const</span> hardware::hidl_string&amp; fqName,</span><br><span class="line">            <span class="keyword">const</span> hardware::hidl_string&amp; name,</span><br><span class="line">            <span class="keyword">bool</span> preexisting) override;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> initialize(wp&lt;StatusListener&gt; listener,</span><br><span class="line">            ServiceInteractionProxy *proxy </span><br><span class="line">            = &amp;sHardwareServiceInteractionProxy);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">static</span> HardwareServiceInteractionProxy sHardwareServiceInteractionProxy;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ServiceInteractionProxy</code><br>定义了几个纯虚函数，用于向 <code>HAL</code> 系统服务中注册 <code>registerForNotifications</code> 监听 <code>ICameraProvider.hal</code> 的消息；<code>getService</code> 返回 <code>ICameraProvider</code> 的实例。  </li>
<li><code>HardwareServiceInteractionProxy</code><br><code>ServiceInteractionProxy</code> 的实现结构体，具体调用 <code>ICameraProvider</code> 对应的 <code>registerForNotifications, getService</code> ；也就是 <code>CameraProviderManager</code> 持有 <code>ICameraProvider</code> 的远程实例。  </li>
<li><code>onRegistration</code><br><code>registerForNotifications</code> 的回调函数，注册成功后回调。  </li>
<li><code>StatusListener</code><br>状态监听接口，这些接口是在 <code>CameraService</code> 中实现的；用于 <code>CameraProviderManager</code> 回调 <code>CameraService</code> 。  </li>
<li><code>sHardwareServiceInteractionProxy</code><br>静态变量，是初始化 <code>initialize</code> 函数形参 <code>ServiceInteractionProxy</code> 的默认值。  </li>
</ul>
<p>从 <code>CameraService</code> 中调用 <code>CameraProviderManager::initialize</code> 时，传入的是 <code>CameraService</code> 的实例，仅仅一个参数，所以 <code>ServiceInteractionProxy</code> 使用的是默认的 <code>sHardwareServiceInteractionProxy</code> 实例。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// CameraProviderManager.cpp</span><br><span class="line">// 实例化 HAL 代理</span><br><span class="line">CameraProviderManager::HardwareServiceInteractionProxy</span><br><span class="line">CameraProviderManager::sHardwareServiceInteractionProxy&#123;&#125;;</span><br><span class="line"></span><br><span class="line">status_t CameraProviderManager::initialize(</span><br><span class="line">        wp&lt;CameraProviderManager::StatusListener&gt; listener,</span><br><span class="line">        ServiceInteractionProxy* proxy) &#123;</span><br><span class="line">    ...</span><br><span class="line">    mListener = listener;</span><br><span class="line">    mServiceProxy = proxy;</span><br><span class="line"></span><br><span class="line">    bool success = mServiceProxy-&gt;registerForNotifications(</span><br><span class="line">        /* instance name, empty means no filter */ &quot;&quot;,</span><br><span class="line">        this);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    addProviderLocked(kLegacyProviderName, /*expected*/ false);</span><br><span class="line">    return OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CameraProviderManager::initialize</code> 中主要是初始化赋值 <code>mListener, mServiceProxy</code> ，并通过 <code>sHardwareServiceInteractionProxy-&gt;registerForNotifications</code> 向 <code>HIDL</code> 服务管理注册了自己，最后调用 <code>addProviderLocked</code> 。  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraProviderManager.cpp</span></span><br><span class="line"><span class="keyword">status_t</span> CameraProviderManager::addProviderLocked(</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; newProvider, <span class="keyword">bool</span> expected) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; providerInfo : mProviders) &#123;</span><br><span class="line">        <span class="keyword">if</span> (providerInfo-&gt;mProviderName == newProvider) &#123;</span><br><span class="line">            ALOGW(...);</span><br><span class="line">            <span class="keyword">return</span> ALREADY_EXISTS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// HIDL 通信，通过 ICameraProvider 和 HAL 层通信</span></span><br><span class="line">    sp&lt;provider::V2_4::ICameraProvider&gt; interface;</span><br><span class="line">    interface = mServiceProxy-&gt;getService(newProvider);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (interface == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;ProviderInfo&gt; providerInfo =</span><br><span class="line">            <span class="keyword">new</span> ProviderInfo(newProvider, interface, <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">status_t</span> res = providerInfo-&gt;initialize();</span><br><span class="line">    <span class="keyword">if</span> (res != OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mProviders.push_back(providerInfo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>addProviderLocked</code> 中有如下信息：  </p>
<ul>
<li>通过代理获取 <code>ICameraProvider</code> 实例，用于和 <code>HAL</code> 通信  </li>
<li>新建 <code>ProviderInfo</code> 并初始化，保存 <code>ICameraProvider</code> 实例  </li>
<li><code>mProviders</code> 保存所有的 <code>ProviderInfo</code> （实测只有一个实例元素，名称为 <code>legacy/0</code>）  </li>
</ul>
<figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraProviderManager.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ProviderInfo</span> :</span></span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">public</span> </span><br><span class="line">        hardware::camera::provider::V2_4::ICameraProviderCallback,</span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">public</span> hardware::hidl_death_recipient</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> mProviderName;</span><br><span class="line">    <span class="keyword">const</span> sp&lt;hardware::camera::provider::V2_4::ICameraProvider&gt; </span><br><span class="line">        mInterface;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">metadata_vendor_id_t</span> mProviderTagid;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ProviderInfo</code> 继承了 <code>ICameraProviderCallback, hidl_death_recipient</code> ，它会处理来着 <code>ICameraProvider</code> 的回调。  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraProviderManager.cpp</span></span><br><span class="line">CameraProviderManager::ProviderInfo::ProviderInfo(</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;providerName,</span><br><span class="line">        sp&lt;provider::V2_4::ICameraProvider&gt;&amp; interface,</span><br><span class="line">        CameraProviderManager *manager) :</span><br><span class="line">        mProviderName(providerName),</span><br><span class="line">        mInterface(interface),</span><br><span class="line">        mProviderTagid(generateVendorTagId(providerName)),</span><br><span class="line">        mUniqueDeviceCount(<span class="number">0</span>),</span><br><span class="line">        mManager(manager) &#123;</span><br><span class="line">    (<span class="keyword">void</span>) mManager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> CameraProviderManager::ProviderInfo::initialize() &#123;</span><br><span class="line">    <span class="keyword">status_t</span> res = parseProviderName(mProviderName, &amp;mType, &amp;mId);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 设置回调</span></span><br><span class="line">    hardware::Return&lt;Status&gt; status = mInterface-&gt;setCallback(<span class="keyword">this</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// HIDL 连接</span></span><br><span class="line">    hardware::Return&lt;<span class="keyword">bool</span>&gt; linked = </span><br><span class="line">        mInterface-&gt;linkToDeath(<span class="keyword">this</span>, <span class="comment">/*cookie*/</span> mId);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Get initial list of camera devices, if any</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; devices;</span><br><span class="line">    <span class="comment">// 获取 CameraIdList ，实际是获取的一组设备名</span></span><br><span class="line">    hardware::Return&lt;<span class="keyword">void</span>&gt; ret = </span><br><span class="line">        mInterface-&gt;getCameraIdList([&amp;status, &amp;devices](</span><br><span class="line">            Status idStatus,</span><br><span class="line">            <span class="keyword">const</span> hardware::hidl_vec&lt;hardware::hidl_string&gt;&amp; </span><br><span class="line">                cameraDeviceNames) &#123;</span><br><span class="line">        status = idStatus;</span><br><span class="line">        <span class="keyword">if</span> (status == Status::OK) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; cameraDeviceNames.size(); i++) &#123;</span><br><span class="line">                devices.push_back(cameraDeviceNames[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; &#125;);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; device : devices) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> id;</span><br><span class="line">        <span class="comment">// 添加从 HAL 返回的每个设备名</span></span><br><span class="line">        <span class="keyword">status_t</span> res = addDevice(device,</span><br><span class="line">            hardware::camera::common::V1_0::CameraDeviceStatus::PRESENT,</span><br><span class="line">            &amp;id);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ProviderInfo::initialize</code> 初始化，主要是从 <code>HAL</code> 获取设备名后，添加具体的设备信息。  </p>
<figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraProviderManager.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DeviceInfo</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> mName;  <span class="comment">// Full instance name</span></span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> mId;    <span class="comment">// ID section of full name</span></span><br><span class="line">    <span class="keyword">const</span> hardware::hidl_version mVersion;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">metadata_vendor_id_t</span> mProviderTagid;</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">bool</span> mHasFlashUnit;</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">InterfaceT</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="title">static</span> <span class="title">status_t</span> <span class="title">setTorchMode</span>(<span class="title">InterfaceT</span>&amp; <span class="title">interface</span>, <span class="title">bool</span> <span class="title">enabled</span>);</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HALv1-specific camera fields, including the actual device interface</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DeviceInfo1</span> :</span> <span class="keyword">public</span> DeviceInfo &#123;</span><br><span class="line">    <span class="keyword">typedef</span> hardware::camera::device::V1_0::ICameraDevice InterfaceT;</span><br><span class="line">    <span class="keyword">const</span> sp&lt;InterfaceT&gt; mInterface;</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    CameraParameters2 mDefaultParameters;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HALv3-specific camera fields, including the actual device interface</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DeviceInfo3</span> :</span> <span class="keyword">public</span> DeviceInfo &#123;</span><br><span class="line">    <span class="keyword">typedef</span> hardware::camera::device::V3_2::ICameraDevice InterfaceT;</span><br><span class="line">    <span class="keyword">const</span> sp&lt;InterfaceT&gt; mInterface;</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    CameraMetadata mCameraCharacteristics;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>头文件中可以看出，<code>DeviceInfo</code> 有两个子类，分别对应 <code>HAL 1</code> 和 <code>HAL 3</code> ，并将具体的 <code>ICameraDevice</code> 版本保存到 <code>mInterface</code> 中；所以设备添加时也会根据不同版本分别添加：    </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraProviderManager.cpp</span></span><br><span class="line"><span class="keyword">status_t</span> CameraProviderManager::ProviderInfo::addDevice(</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name,</span><br><span class="line">        CameraDeviceStatus initialStatus, </span><br><span class="line">        <span class="comment">/*out*/</span> <span class="built_in">std</span>::<span class="built_in">string</span>* parsedId) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">status_t</span> res = parseDeviceName(name, &amp;major, &amp;minor, &amp;type, &amp;id);</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;DeviceInfo&gt; deviceInfo;</span><br><span class="line">    <span class="keyword">switch</span> (major) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            deviceInfo = initializeDeviceInfo&lt;DeviceInfo1&gt;(</span><br><span class="line">                name, mProviderTagid, id, minor);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            deviceInfo = initializeDeviceInfo&lt;DeviceInfo3&gt;(</span><br><span class="line">                name, mProviderTagid, id, minor);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            ALOGE(...);</span><br><span class="line">            <span class="keyword">return</span> BAD_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">DeviceInfoT</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">std</span>:</span>:<span class="built_in">unique_ptr</span>&lt;CameraProviderManager::ProviderInfo::DeviceInfo&gt;</span><br><span class="line">    CameraProviderManager::ProviderInfo::initializeDeviceInfo(</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;name, <span class="keyword">const</span> <span class="keyword">metadata_vendor_id_t</span> tagId,</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;id, <span class="keyword">uint16_t</span> minorVersion) <span class="keyword">const</span> &#123;</span><br><span class="line">    Status status;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> cameraInterface =</span><br><span class="line">            getDeviceInterface&lt;<span class="keyword">typename</span> DeviceInfoT::InterfaceT&gt;(name);</span><br><span class="line">    <span class="keyword">if</span> (cameraInterface == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    CameraResourceCost resourceCost;</span><br><span class="line">    cameraInterface-&gt;getResourceCost([&amp;status, &amp;resourceCost](</span><br><span class="line">        Status s, CameraResourceCost cost) &#123;</span><br><span class="line">                status = s;</span><br><span class="line">                resourceCost = cost;</span><br><span class="line">            &#125;);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;DeviceInfo&gt;(</span><br><span class="line">        <span class="keyword">new</span> DeviceInfoT(name, tagId, id, minorVersion, resourceCost,</span><br><span class="line">                cameraInterface));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据传入的 <code>deviceName</code> 解析版本号、类型、设备 <code>Id</code> （前后摄），并根据 <code>major</code> 版本号（表示 <code>HAL 1</code> 或者 <code>HAL 3</code>） 分别初始化对应的 <code>DeviceInfo</code> ；在 <code>initializeDeviceInfo</code> 中通过 <code>getDeviceInterface</code> 获取对应的 <code>ICameraDevice</code> 版本，在对应版本 <code>DeviceInfo</code> 实例化时保存；也就是将 <code>DeviceInfo</code> 和 <code>HAL</code> 层的 <code>ICameraDevice</code> 绑定。  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraProviderManager.cpp</span></span><br><span class="line">CameraProviderManager::ProviderInfo::DeviceInfo3::DeviceInfo3(</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name,</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">metadata_vendor_id_t</span> tagId, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;id,</span><br><span class="line">        <span class="keyword">uint16_t</span> minorVersion,</span><br><span class="line">        <span class="keyword">const</span> CameraResourceCost&amp; resourceCost,</span><br><span class="line">        sp&lt;InterfaceT&gt; interface) :</span><br><span class="line">        DeviceInfo(name, tagId, id, </span><br><span class="line">            hardware::hidl_version&#123;<span class="number">3</span>, minorVersion&#125;, resourceCost),</span><br><span class="line">        mInterface(interface) &#123;</span><br><span class="line">    <span class="comment">// Get camera characteristics and initialize flash unit availability</span></span><br><span class="line">    Status status;</span><br><span class="line">    hardware::Return&lt;<span class="keyword">void</span>&gt; ret;</span><br><span class="line">    <span class="comment">// 获取 Camera 设备配置信息</span></span><br><span class="line">    ret = mInterface-&gt;getCameraCharacteristics([&amp;status, <span class="keyword">this</span>](Status s,</span><br><span class="line">                device::V3_2::CameraMetadata metadata) &#123;</span><br><span class="line">            status = s;</span><br><span class="line">            <span class="keyword">if</span> (s == Status::OK) &#123;</span><br><span class="line">                <span class="keyword">camera_metadata_t</span> *buffer =</span><br><span class="line">                    <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">camera_metadata_t</span>*&gt;(metadata.data());</span><br><span class="line">                <span class="keyword">size_t</span> expectedSize = metadata.size();</span><br><span class="line">                <span class="keyword">int</span> res = validate_camera_metadata_structure(buffer, </span><br><span class="line">                    &amp;expectedSize);</span><br><span class="line">                <span class="keyword">if</span> (res==OK||res==CAMERA_METADATA_VALIDATION_SHIFTED) &#123;</span><br><span class="line">                    set_camera_metadata_vendor_id(buffer, mProviderTagid);</span><br><span class="line">                    mCameraCharacteristics = buffer;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ALOGE(...);</span><br><span class="line">                    status = Status::INTERNAL_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    ...</span><br><span class="line">    camera_metadata_entry flashAvailable =</span><br><span class="line">            mCameraCharacteristics.find(ANDROID_FLASH_INFO_AVAILABLE);</span><br><span class="line">    <span class="keyword">if</span> (flashAvailable.count == <span class="number">1</span> &amp;&amp;</span><br><span class="line">            flashAvailable.data.u8[<span class="number">0</span>] == ANDROID_FLASH_INFO_AVAILABLE_TRUE) &#123;</span><br><span class="line">        mHasFlashUnit = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mHasFlashUnit = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里分析的是 <code>DeviceInfo3</code> 的构造函数，它会向 <code>HAL</code> 层请求当前设备的配置信息，并保存 <code>mCameraCharacteristics</code> ，后续查看属性时都会通过这个变量查询。<br><code>CameraService::enumerateProviders</code> 中，首先新建并初始化 <code>CameraProviderManager</code> ，其持有和 <code>HAL</code> 通信的实例；接着新建并初始化 <code>CameraFlashlight</code> ，用于控制闪光灯。先看头文件：  </p>
<figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraFlashlight.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlashControlBase</span> :</span> <span class="keyword">public</span> <span class="keyword">virtual</span> VirtualLightRefBase &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> status_t <span class="title">hasFlashUnit</span><span class="params">(<span class="keyword">const</span> String8&amp; cameraId,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">bool</span> *hasFlash)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> status_t <span class="title">setTorchMode</span><span class="params">(<span class="keyword">const</span> String8&amp; cameraId,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">bool</span> enabled)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HAL 3 闪光灯控制</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProviderFlashControl</span> :</span> <span class="keyword">public</span> FlashControlBase &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// FlashControlBase</span></span><br><span class="line">    <span class="keyword">status_t</span> hasFlashUnit(<span class="keyword">const</span> String8&amp; cameraId, <span class="keyword">bool</span> *hasFlash);</span><br><span class="line">    <span class="keyword">status_t</span> setTorchMode(<span class="keyword">const</span> String8&amp; cameraId, <span class="keyword">bool</span> enabled);</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    sp&lt;CameraProviderManager&gt; mProviderManager;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HAL 1 闪光灯控制，通过 CameraHardwareInterface 向下调用</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CameraHardwareInterfaceFlashControl</span> :</span> <span class="keyword">public</span> FlashControlBase &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// FlashControlBase</span></span><br><span class="line">    <span class="keyword">status_t</span> setTorchMode(<span class="keyword">const</span> String8&amp; cameraId, <span class="keyword">bool</span> enabled);</span><br><span class="line">    <span class="keyword">status_t</span> hasFlashUnit(<span class="keyword">const</span> String8&amp; cameraId, <span class="keyword">bool</span> *hasFlash);</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    sp&lt;CameraProviderManager&gt; mProviderManager;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">camera_module_callbacks_t</span> *mCallbacks;</span><br><span class="line">    sp&lt;CameraHardwareInterface&gt; mDevice;</span><br><span class="line">    String8 mCameraId;</span><br><span class="line">    CameraParameters mParameters;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CameraFlashlight</span> :</span> <span class="keyword">public</span> <span class="keyword">virtual</span> VirtualLightRefBase &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">hasFlashUnit</span><span class="params">(<span class="keyword">const</span> String8&amp; cameraId)</span></span>;</span><br><span class="line">    <span class="keyword">status_t</span> setTorchMode(<span class="keyword">const</span> String8&amp; cameraId, <span class="keyword">bool</span> enabled);</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    sp&lt;FlashControlBase&gt; mFlashControl;</span><br><span class="line">    sp&lt;CameraProviderManager&gt; mProviderManager;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">camera_module_callbacks_t</span> *mCallbacks;</span><br></pre></td></tr></table></figure>

<p>头文件定义的几个信息：  </p>
<ul>
<li><code>CameraHardwareInterfaceFlashControl</code><br><code>HAL 1</code> 闪光灯控制类，通过 <code>CameraHardwareInterface</code> 向下调用。  </li>
<li><code>ProviderFlashControl</code><br><code>HAL 3</code> 闪光灯控制类。  </li>
<li><code>FlashControlBase</code><br>基类。  </li>
<li><code>CameraProviderManager</code><br>主要用于 <code>ProviderFlashControl</code> 向下发送信息。  </li>
<li><code>camera_module_callbacks_t</code><br><code>HAL</code> 层的回调。  </li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraFlashlight.cpp</span></span><br><span class="line">CameraFlashlight::CameraFlashlight(</span><br><span class="line">        sp&lt;CameraProviderManager&gt; providerManager,</span><br><span class="line">        <span class="keyword">camera_module_callbacks_t</span>* callbacks) :</span><br><span class="line">        mProviderManager(providerManager),</span><br><span class="line">        mCallbacks(callbacks),</span><br><span class="line">        mFlashlightMapInitialized(<span class="literal">false</span>) &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> CameraFlashlight::findFlashUnits() &#123;</span><br><span class="line">    ...</span><br><span class="line">    mFlashControl.clear();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;id : cameraIds) &#123;</span><br><span class="line">        <span class="keyword">ssize_t</span> index = mHasFlashlightMap.indexOfKey(id);</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> &lt;= index) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">bool</span> hasFlash = <span class="literal">false</span>;</span><br><span class="line">        res = createFlashlightControl(id);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> CameraFlashlight::createFlashlightControl(</span><br><span class="line">        <span class="keyword">const</span> String8&amp; cameraId) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (mProviderManager-&gt;supportSetTorchMode(cameraId.<span class="built_in">string</span>())) &#123;</span><br><span class="line">        mFlashControl = <span class="keyword">new</span> ProviderFlashControl(mProviderManager);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Only HAL1 devices do not support setTorchMode</span></span><br><span class="line">        mFlashControl =</span><br><span class="line">            <span class="keyword">new</span> CameraHardwareInterfaceFlashControl(mProviderManager,</span><br><span class="line">            *mCallbacks);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CameraFlashlight</code> 的构造函数仅仅初始化了几个本地变量，<code>CameraService</code> 中调用 <code>CameraFlashlight::findFlashUnits</code> 时，会根据 <code>HAL 1/3</code> 分别来创建对应的闪光灯控制类。至此整个 <code>CameraService</code> 注册流程结束。  </p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p><code>CameraService</code> 初始化和注册流程中，实例化了两个对象：  </p>
<ul>
<li><code>CameraProviderManager mCameraProviderManager</code> 对象  </li>
<li><code>Flashlight mFlashlight</code> 对象  </li>
</ul>
<p><code>CameraProviderManager</code> 初始化完后：  </p>
<ul>
<li><code>mProviders</code> 保存了 <code>ProviderInfo</code> 对象；并关联了 <code>ICameraProvider</code> ，用于和 <code>HAL</code> 通信  </li>
<li><code>ProviderInfo</code> 中 <code>mDevices</code> 保存了所有的 <code>DeviceInfo1, DeviceInfo3</code> 设备信息，并关联 <code>ICameraDevice</code> 实例，用于直接通信  </li>
<li><code>DeviceInfo1</code> 中保存了 <code>CameraParameters2 mDefaultParameters</code> 参数信息  </li>
<li><code>DeviceInfo3</code> 中保存了 <code>CameraMetadata mCameraCharacteristics</code> 参数信息  </li>
</ul>
<p><code>CameraFlashlight</code> 新建和初始化后：  </p>
<ul>
<li>如果是 <code>HAL 1</code> 会实例化控制类 <code>CameraHardwareInterfaceFlashControl</code>  </li>
<li>如果是 <code>HAL 3</code> 会实例化控制类 <code>ProviderFlashControl</code>  </li>
</ul>
<h2 id="Camera-Open-流程"><a href="#Camera-Open-流程" class="headerlink" title="Camera Open 流程"></a><code>Camera Open</code> 流程</h2><h3 id="API"><a href="#API" class="headerlink" title="API"></a><code>API</code></h3><p><code>Camera API 2</code> 开启摄像头设备时，通过 <code>CameraManager.openCamera</code> 来打开：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraManager.java</span></span><br><span class="line"><span class="meta">@RequiresPermission</span>(android.Manifest.permission.CAMERA)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openCamera</span><span class="params">(@NonNull String cameraId,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull <span class="keyword">final</span> CameraDevice.StateCallback callback,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable Handler handler)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line"></span><br><span class="line">    openCameraForUid(cameraId, callback, handler, USE_CALLING_UID);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>String cameraId</code><br>表示前后摄的 <code>ID</code> ，通常 0 表示后摄。  </li>
<li><code>CameraDevice.StateCallback callback</code><br>打开设备时，状态回调接口。  </li>
<li><code>Handler handler</code><br>表示回调接口在哪个线程执行。  </li>
</ul>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>打开一个设备，在回调中保存 <code>CameraDevice</code> ：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">CameraDevice.StateCallback mCameraDeviceStateCallback </span><br><span class="line">        = <span class="keyword">new</span> CameraDevice.StateCallback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpened</span><span class="params">(@NonNull CameraDevice camera)</span> </span>&#123;</span><br><span class="line">        mCameraDevice = camera;</span><br><span class="line">        <span class="comment">//createCameraCaptureSession();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDisconnected</span><span class="params">(@NonNull CameraDevice camera)</span> </span>&#123;</span><br><span class="line">        camera.close();</span><br><span class="line">        mCameraDevice = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(@NonNull CameraDevice camera, <span class="keyword">int</span> error)</span> </span>&#123;</span><br><span class="line">        camera.close();</span><br><span class="line">        mCameraDevice = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    mCameraManager.openCamera(mCameraId, mCameraDeviceStateCallback,</span><br><span class="line">            mBackHandler);</span><br><span class="line">&#125; <span class="keyword">catch</span> (CameraAccessException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CameraDevice-StateCallback-接口"><a href="#CameraDevice-StateCallback-接口" class="headerlink" title="CameraDevice.StateCallback 接口"></a><code>CameraDevice.StateCallback</code> 接口</h3><p>在打开设备时，会传入 <code>StateCallback</code> 回调接口，它有四个方法，都是在 <code>CameraDeviceImpl</code> 中回调的：  </p>
<ul>
<li><code>onOpened</code><br>在 <code>CameraManager.openCameraDeviceUserAsync</code> 方法中，<code>CameraDeviceImpl.setRemoteDevice(cameraUser);</code> 会触发 <code>StateCallback.onOpened</code> 回调。  </li>
<li><code>onClosed</code><br><code>CameraDevice.close</code> 是在 <code>CameraDeviceImpl.close</code> 中实现的，同时会触发 <code>StateCallback.onClosed</code> 回调。  </li>
<li><code>onDisconnected</code><br><code>CameraDeviceImpl.setRemoteDevice(cameraUser);</code> 中如果远程连接断开，或者 <code>ICameraDeviceCallbacks.onDeviceError</code> 返回了 <code>ERROR_CAMERA_DISCONNECTED</code> 错误码，都会触发 <code>StateCallback.onDisconnected</code> 回调。  </li>
<li><code>onError</code><br>在 <code>Binder</code> 通信中绑定失败 <code>binderDied</code> ，<code>setRemoteFailure</code> 以及 <code>ICameraDeviceCallbacks.onDeviceError</code> 返回了 <code>ERROR_CAMERA_DEVICE/ERROR_CAMERA_SERVICE</code> 错误码，都会触发 <code>StateCallback.onError</code> 回调。  </li>
</ul>
<p>在设备打开时，会通过 <code>StateCallback</code> 回调返回打开状态，从代码可以看出，只要 <code>ICameraService.connectDevice</code> 成功后，直接调用 <code>CameraDeviceImpl.setRemoteDevice(cameraUser);</code> 来触发 <code>StateCallback.onOpened</code> ，表示设备打开成功。<br><code>StateCallback</code> 是 <code>Java</code> 接口，它的 <code>onDisconnected, onError</code> 两个回调方法，需要真实的与物理设备交互；所以需要通过 <code>ICameraDeviceCallbacks.aidl</code> 从 <code>Framework Service</code> 中获取真实的信息回调。  </p>
<h3 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h3><p><code>Camera API 2</code> 开启相机设备流程图：  </p>
<ul>
<li><a href="https://upload-images.jianshu.io/upload_images/606437-94d691a3936a3843.png" target="_blank" rel="noopener">打开设备，查看原图</a>  </li>
</ul>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0109-android-camera-4-framework-Camera2-open.png" alt="0109-android-camera-4-framework-Camera2-open.png"></p>
<ul>
<li><a href="https://upload-images.jianshu.io/upload_images/606437-ea3d916f2b16b876.jpg" target="_blank" rel="noopener">连接设备，查看原图</a>  </li>
</ul>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0109-android-camera-4-framework-Camera2-open-CameraService_connectDevice.jpg" alt="0109-android-camera-4-framework-Camera2-open-CameraService_connectDevice.jpg"></p>
<h3 id="源码分析-1"><a href="#源码分析-1" class="headerlink" title="源码分析"></a>源码分析</h3><p>通过 <code>CameraManager.openCamera</code> 打开设备，我们重点分析如下代码，代码执行路径为 ：<br><code>openCamera -&gt; openCameraForUid -&gt; openCameraDeviceUserAsync</code>   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraManager.java</span></span><br><span class="line"><span class="meta">@RequiresPermission</span>(android.Manifest.permission.CAMERA)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openCamera</span><span class="params">(@NonNull String cameraId,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull <span class="keyword">final</span> CameraDevice.StateCallback callback, </span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable Handler handler)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line"></span><br><span class="line">    openCameraForUid(cameraId, callback, handler, USE_CALLING_UID);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> CameraDevice <span class="title">openCameraDeviceUserAsync</span><span class="params">(String cameraId,</span></span></span><br><span class="line"><span class="function"><span class="params">        CameraDevice.StateCallback callback, </span></span></span><br><span class="line"><span class="function"><span class="params">        Handler handler, <span class="keyword">final</span> <span class="keyword">int</span> uid)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line">    CameraCharacteristics characteristics = </span><br><span class="line">        getCameraCharacteristics(cameraId);</span><br><span class="line">    CameraDevice device = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        ICameraDeviceUser cameraUser = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 新建 CameraDeviceImpl 实例</span></span><br><span class="line">        android.hardware.camera2.impl.CameraDeviceImpl deviceImpl =</span><br><span class="line">                <span class="keyword">new</span> android.hardware.camera2.impl.CameraDeviceImpl(</span><br><span class="line">                    cameraId,</span><br><span class="line">                    callback,</span><br><span class="line">                    handler,</span><br><span class="line">                    characteristics,</span><br><span class="line">                    mContext.getApplicationInfo().targetSdkVersion);</span><br><span class="line">        <span class="comment">// 获取 ICameraDeviceCallbacks 回调</span></span><br><span class="line">        ICameraDeviceCallbacks callbacks = deviceImpl.getCallbacks();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (supportsCamera2ApiLocked(cameraId)) &#123;</span><br><span class="line">                <span class="comment">// Use cameraservice's cameradeviceclient </span></span><br><span class="line">                <span class="comment">// implementation for HAL3.2+ devices</span></span><br><span class="line">                ICameraService cameraService = </span><br><span class="line">                    CameraManagerGlobal.get().getCameraService();</span><br><span class="line">                <span class="keyword">if</span> (cameraService == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ServiceSpecificException(...);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 连接设备，并获取 ICameraDeviceUser</span></span><br><span class="line">                cameraUser = cameraService.connectDevice(callbacks,</span><br><span class="line">                        cameraId, mContext.getOpPackageName(), uid);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Use legacy camera implementation for HAL1 devices</span></span><br><span class="line">                <span class="keyword">int</span> id;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    id = Integer.parseInt(cameraId);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(...);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Log.i(TAG, <span class="string">"Using legacy camera HAL."</span>);</span><br><span class="line">                cameraUser = </span><br><span class="line">                    CameraDeviceUserShim.connectBinderShim(callbacks, id);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ServiceSpecificException e) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 关联 CameraDeviceImpl 和 ICameraDeviceUser ，方便直接通信</span></span><br><span class="line">        deviceImpl.setRemoteDevice(cameraUser);</span><br><span class="line">        device = deviceImpl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> device;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CameraDeviceImpl.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRemoteDevice</span><span class="params">(ICameraDeviceUser remoteDevice)</span> </span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(mInterfaceLock) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 新建包装类，包装接口并处理对应访问异常</span></span><br><span class="line">        mRemoteDevice = <span class="keyword">new</span> ICameraDeviceUserWrapper(remoteDevice);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面展示的 <code>API</code> 部分代码中可以看出：  </p>
<ul>
<li>支持 <code>API 2</code><br>如果系统开启了 <code>HAL 3</code> ，则支持 <code>API 2</code> ；此时通过 <code>ICameraService</code> 访问服务。  </li>
<li>不支持 <code>API 2</code><br>如果系统仅支持 <code>HAL 1</code> ，则 <code>API 2</code> 需要通过 <code>CameraDeviceUserShim</code> 转换为对应的 <code>API 1 + HAL 1</code> 来实现对应功能。<code>CameraDeviceUserShim</code> 是 <code>ICameraDeviceUser</code> 的实现类；整个 <code>frameworks/base/core/java/android/hardware/camera2/legacy</code> 目录下的代码都是为了实现这个转换功能。  </li>
</ul>
<p>整个打开设备的动作有如下功能：  </p>
<ul>
<li>新建了 <code>CameraDeviceImpl</code> 实例，它是 <code>CameraDevice</code> 的实现类  </li>
<li><code>CameraManager</code> 通过 <code>CameraService.connectDevice</code> 连接设备，获取到 <code>ICameraDeviceUser, ICameraDeviceCallbacks</code> 对象，它们用于后续 <code>CameraDeviceImpl.java</code> 和 <code>CameraDeviceClient.cpp</code> 绑定通信  </li>
<li>新建 <code>ICameraDeviceUserWrapper</code> 实例，它是对 <code>ICameraDeviceUser</code> 的包装类，捕获并处理远程访问异常等  </li>
</ul>
<p>这里需要重点分析 <code>connectDevice</code> ：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraService.cpp</span></span><br><span class="line">Status CameraService::connectDevice(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;hardware::camera2::ICameraDeviceCallbacks&gt;&amp; cameraCb,</span><br><span class="line">        <span class="keyword">const</span> String16&amp; cameraId,</span><br><span class="line">        <span class="keyword">const</span> String16&amp; clientPackageName,</span><br><span class="line">        <span class="keyword">int</span> clientUid,</span><br><span class="line">        <span class="comment">/*out*/</span></span><br><span class="line">        sp&lt;hardware::camera2::ICameraDeviceUser&gt;* device) &#123;</span><br><span class="line"></span><br><span class="line">    ATRACE_CALL();</span><br><span class="line">    Status ret = Status::ok();</span><br><span class="line">    String8 id = String8(cameraId);</span><br><span class="line">    sp&lt;CameraDeviceClient&gt; client = <span class="literal">nullptr</span>;</span><br><span class="line">    ret = connectHelper&lt;hardware::camera2::ICameraDeviceCallbacks,</span><br><span class="line">            CameraDeviceClient&gt;(cameraCb, id,</span><br><span class="line">            CAMERA_HAL_API_VERSION_UNSPECIFIED, clientPackageName,</span><br><span class="line">            clientUid, USE_CALLING_PID, API_2,</span><br><span class="line">            <span class="comment">/*legacyMode*/</span> <span class="literal">false</span>, <span class="comment">/*shimUpdateOnly*/</span> <span class="literal">false</span>,</span><br><span class="line">            <span class="comment">/*out*/</span>client);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    *device = client;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">CALLBACK</span>, <span class="title">class</span> <span class="title">CLIENT</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">Status</span> <span class="title">CameraService</span>:</span>:connectHelper(<span class="keyword">const</span> sp&lt;CALLBACK&gt;&amp; cameraCb,</span><br><span class="line">        <span class="keyword">const</span> String8&amp; cameraId, <span class="keyword">int</span> halVersion,</span><br><span class="line">        <span class="keyword">const</span> String16&amp; clientPackageName, <span class="keyword">int</span> clientUid, <span class="keyword">int</span> clientPid,</span><br><span class="line">        apiLevel effectiveApiLevel, <span class="keyword">bool</span> legacyMode, <span class="keyword">bool</span> shimUpdateOnly,</span><br><span class="line">        <span class="comment">/*out*/</span>sp&lt;CLIENT&gt;&amp; device) &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#123;</span><br><span class="line">        sp&lt;BasicClient&gt; tmp = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="keyword">if</span>(!(ret = makeClient(<span class="keyword">this</span>, cameraCb, clientPackageName, </span><br><span class="line">                cameraId, facing, clientPid, clientUid, getpid(),</span><br><span class="line">                legacyMode, halVersion, deviceVersion, effectiveApiLevel,</span><br><span class="line">                <span class="comment">/*out*/</span>&amp;tmp)).isOk()) &#123;</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        err = client-&gt;initialize(mCameraProviderManager);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (shimUpdateOnly) &#123;</span><br><span class="line">            mServiceLock.unlock();</span><br><span class="line">            client-&gt;disconnect();</span><br><span class="line">            mServiceLock.lock();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Otherwise, add client to active clients list</span></span><br><span class="line">            finishConnectLocked(client, partial);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="comment">// lock is destroyed, allow further connect calls</span></span><br><span class="line"></span><br><span class="line">    device = client;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CameraService::connectDevice</code> 函数调用了模板函数 <code>connectHelper</code> ，而该模板主要的两个功能就是：<code>makeClient</code> 新建客户端，<code>initialize</code> 初始化客户端。  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">Status CameraService::makeClient(<span class="keyword">const</span> sp&lt;CameraService&gt;&amp; cameraService,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;IInterface&gt;&amp; cameraCb, <span class="keyword">const</span> String16&amp; packageName,</span><br><span class="line">        <span class="keyword">const</span> String8&amp; cameraId, <span class="keyword">int</span> facing, <span class="keyword">int</span> clientPid, </span><br><span class="line">        <span class="keyword">uid_t</span> clientUid, <span class="keyword">int</span> servicePid, <span class="keyword">bool</span> legacyMode,</span><br><span class="line">        <span class="keyword">int</span> halVersion, <span class="keyword">int</span> deviceVersion, apiLevel effectiveApiLevel,</span><br><span class="line">        <span class="comment">/*out*/</span>sp&lt;BasicClient&gt;* client) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (halVersion &lt; <span class="number">0</span> || halVersion == deviceVersion) &#123;</span><br><span class="line">        <span class="keyword">switch</span>(deviceVersion) &#123;</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_1_0:</span><br><span class="line">            <span class="keyword">if</span> (effectiveApiLevel == API_1) &#123;  <span class="comment">// Camera1 API route</span></span><br><span class="line">                sp&lt;ICameraClient&gt; tmp = </span><br><span class="line">                    <span class="keyword">static_cast</span>&lt;ICameraClient*&gt;(cameraCb.get());</span><br><span class="line">                *client = <span class="keyword">new</span> CameraClient(cameraService, tmp, </span><br><span class="line">                    packageName, cameraIdToInt(cameraId), facing, </span><br><span class="line">                    clientPid, clientUid, getpid(), legacyMode);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// Camera2 API route</span></span><br><span class="line">                ALOGW(<span class="string">"Camera using old HAL version: %d"</span>, deviceVersion);</span><br><span class="line">                <span class="keyword">return</span> STATUS_ERROR_FMT(...);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_3_0:</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_3_1:</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_3_2:</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_3_3:</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_3_4:</span><br><span class="line">            <span class="keyword">if</span> (effectiveApiLevel == API_1) &#123; <span class="comment">// Camera1 API route</span></span><br><span class="line">                sp&lt;ICameraClient&gt; tmp = </span><br><span class="line">                    <span class="keyword">static_cast</span>&lt;ICameraClient*&gt;(cameraCb.get());</span><br><span class="line">                *client = <span class="keyword">new</span> Camera2Client(cameraService, tmp, </span><br><span class="line">                    packageName, cameraIdToInt(cameraId), facing,</span><br><span class="line">                    clientPid, clientUid, servicePid, legacyMode);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// Camera2 API route</span></span><br><span class="line">                sp&lt;hardware::camera2::ICameraDeviceCallbacks&gt; tmp =</span><br><span class="line">                        <span class="keyword">static_cast</span>&lt;hardware::camera2::</span><br><span class="line">                            ICameraDeviceCallbacks*&gt;(cameraCb.get());</span><br><span class="line">                *client = <span class="keyword">new</span> CameraDeviceClient(cameraService, tmp, </span><br><span class="line">                    packageName, cameraId, facing, clientPid,</span><br><span class="line">                    clientUid, servicePid);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// Should not be reachable</span></span><br><span class="line">            ALOGE(<span class="string">"Unknown camera device HAL version:%d"</span>, deviceVersion);</span><br><span class="line">            <span class="keyword">return</span> STATUS_ERROR_FMT(...);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (deviceVersion &gt; CAMERA_DEVICE_API_VERSION_1_0 &amp;&amp;</span><br><span class="line">            halVersion == CAMERA_DEVICE_API_VERSION_1_0) &#123;</span><br><span class="line">            sp&lt;ICameraClient&gt; tmp = </span><br><span class="line">                <span class="keyword">static_cast</span>&lt;ICameraClient*&gt;(cameraCb.get());</span><br><span class="line">            *client = <span class="keyword">new</span> CameraClient(cameraService, tmp, packageName,</span><br><span class="line">                cameraIdToInt(cameraId), facing, clientPid, </span><br><span class="line">                clientUid, servicePid, legacyMode);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ALOGE(<span class="string">"Invalid camera HAL version .."</span>);</span><br><span class="line">            <span class="keyword">return</span> STATUS_ERROR_FMT(...;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Status::ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>makeClient</code> 主要是根据 <code>device, HAL</code> 版本和调用 <code>API</code> 的版本来创建对应的客户端：  </p>
<ul>
<li><code>HAL 1 + API 1</code> ：新建 <code>CameraClient</code>  </li>
<li><code>HAL 1 + API 2</code> ：不支持  </li>
<li><code>HAL 3 + API 1</code> ：新建 <code>Camera2Client</code>  </li>
<li><code>HAL 3 + API 2</code> ：新建 <code>CameraDeviceClient</code>  </li>
</ul>
<p>这里的三个变量 <code>effectiveApiLevel, legacyMode=0, halVersion</code> ，主要是有三个连接函数决定： <code>connect, connectLegacy, connectDevice</code> ，其中 <code>connectLegacy</code> 可以指定 <code>HAL</code> 版本（来决定到底使用哪个 <code>client</code>）：  </p>
<ul>
<li>使用系统自带相机<br><code>effectiveApiLevel=1, legacyMode=1, halVersion=256(HAL 1)</code> ，系统自带应用使用的是 <code>connectLegacy</code> 。   </li>
<li>使用标准 <code>API2</code> 接口<br><code>effectiveApiLevel=2, legacyMode=0, halVersion=-1</code> ，其中 -1 表示 <code>CAMERA_HAL_API_VERSION_UNSPECIFIED</code> 。  </li>
</ul>
<p>所谓的 <code>HAL</code> 版本，实际指的就是 <code>Device</code> 的版本：其中 <code>HAL 1</code> 对应 <code>CAMERA_DEVICE_API_VERSION_1_0</code> ；<code>HAL 3</code> 对应的是 <code>CAMERA_DEVICE_API_VERSION_3_0</code> 及以上版本。而 <code>HAL 2</code> 和 <code>CAMERA_DEVICE_API_VERSION_2_0</code> 已经废弃。<br>因为手机平台使用 <code>HAL 3</code> 时，为了满足部分应用中使用了 <code>API 1</code> 的接口，常常需要兼容 <code>HAL 1</code>，所以支持 <code>HAL 3</code> 即意味着同时会支持 <code>HAL 1</code> 。  </p>
<p>这里流程跟踪的是新建 <code>CameraDeviceClient</code> ，先看头文件：  </p>
<figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraService.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasicClient</span> :</span> <span class="keyword">public</span> <span class="keyword">virtual</span> RefBase &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> status_t <span class="title">initialize</span><span class="params">(sp&lt;CameraProviderManager&gt; manager)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">OpsCallback</span> :</span> <span class="keyword">public</span> BnAppOpsCallback &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">explicit</span> <span class="title">OpsCallback</span><span class="params">(wp&lt;BasicClient&gt; client)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">opChanged</span><span class="params">(<span class="keyword">int32_t</span> op, <span class="keyword">const</span> String16&amp; packageName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        wp&lt;BasicClient&gt; mClient;</span><br><span class="line"></span><br><span class="line">    &#125;; <span class="comment">// class OpsCallback</span></span><br><span class="line"></span><br><span class="line">    sp&lt;OpsCallback&gt; mOpsCallback;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Camera3Device.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Camera3Device</span> :</span></span><br><span class="line">    <span class="keyword">public</span> CameraDeviceBase,</span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">public</span> hardware::camera::device::V3_2::ICameraDeviceCallback,</span><br><span class="line">    <span class="keyword">private</span> camera3_callback_ops </span><br><span class="line">&#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Camera2ClientBase.h</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TClientBase&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Camera2ClientBase</span> :</span></span><br><span class="line">        <span class="keyword">public</span> TClientBase,</span><br><span class="line">        <span class="keyword">public</span> CameraDeviceBase::NotificationListener</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> TClientBase::TCamCallbacks TCamCallbacks;</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="comment">// 实例为 Camera3Device</span></span><br><span class="line">    sp&lt;CameraDeviceBase&gt;  mDevice;</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> TProviderPtr&gt;</span><br><span class="line">    <span class="keyword">status_t</span>              initializeImpl(TProviderPtr providerPtr);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CameraDeviceClient.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CameraDeviceClientBase</span> :</span></span><br><span class="line">         <span class="keyword">public</span> CameraService::BasicClient,</span><br><span class="line">         <span class="keyword">public</span> hardware::camera2::BnCameraDeviceUser</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">typedef</span> hardware::camera2::ICameraDeviceCallbacks TCamCallbacks;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    CameraDeviceClientBase(<span class="keyword">const</span> sp&lt;CameraService&gt;&amp; cameraService,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;hardware::camera2::ICameraDeviceCallbacks&gt;&amp; </span><br><span class="line">            remoteCallback,</span><br><span class="line">        <span class="keyword">const</span> String16&amp; clientPackageName,</span><br><span class="line">        <span class="keyword">const</span> String8&amp; cameraId,</span><br><span class="line">        <span class="keyword">int</span> cameraFacing,</span><br><span class="line">        <span class="keyword">int</span> clientPid,</span><br><span class="line">        <span class="keyword">uid_t</span> clientUid,</span><br><span class="line">        <span class="keyword">int</span> servicePid);</span><br><span class="line"></span><br><span class="line">    sp&lt;hardware::camera2::ICameraDeviceCallbacks&gt; mRemoteCallback;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CameraDeviceClient</span> :</span></span><br><span class="line">        <span class="keyword">public</span> Camera2ClientBase&lt;CameraDeviceClientBase&gt;,</span><br><span class="line">        <span class="keyword">public</span> camera2::FrameProcessorBase::FilteredListener</span><br><span class="line">&#123;...&#125;</span><br></pre></td></tr></table></figure>

<p>从类图结构来看：<code>BasicClient</code> 是三个客户端 <code>CameraClient, Camera2Client, CameraDeviceClient</code> 的基类；而 <code>Camera2ClientBase</code> 中的变量 <code>CameraDeviceBase</code> 实际的子类是 <code>Camera3Device</code> 。来看构造函数的流程：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraDeviceClient.cpp</span></span><br><span class="line">CameraDeviceClient::CameraDeviceClient(</span><br><span class="line">    <span class="keyword">const</span> sp&lt;CameraService&gt;&amp; cameraService,</span><br><span class="line">    <span class="keyword">const</span> sp&lt;hardware::camera2::ICameraDeviceCallbacks&gt;&amp; remoteCallback,</span><br><span class="line">    <span class="keyword">const</span> String16&amp; clientPackageName,</span><br><span class="line">    <span class="keyword">const</span> String8&amp; cameraId,</span><br><span class="line">    <span class="keyword">int</span> cameraFacing,</span><br><span class="line">    <span class="keyword">int</span> clientPid,</span><br><span class="line">    <span class="keyword">uid_t</span> clientUid,</span><br><span class="line">    <span class="keyword">int</span> servicePid) :</span><br><span class="line">    Camera2ClientBase(cameraService, remoteCallback, clientPackageName,</span><br><span class="line">            cameraId, cameraFacing, clientPid, clientUid, servicePid),</span><br><span class="line">    mInputStream(),</span><br><span class="line">    mStreamingRequestId(REQUEST_ID_NONE),</span><br><span class="line">    mRequestIdCounter(<span class="number">0</span>),</span><br><span class="line">    mPrivilegedClient(<span class="literal">false</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Camera2ClientBase.cpp</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TClientBase&gt;</span><br><span class="line">Camera2ClientBase&lt;TClientBase&gt;::Camera2ClientBase(</span><br><span class="line">    <span class="keyword">const</span> sp&lt;CameraService&gt;&amp; cameraService,</span><br><span class="line">    <span class="keyword">const</span> sp&lt;TCamCallbacks&gt;&amp; remoteCallback,</span><br><span class="line">    <span class="keyword">const</span> String16&amp; clientPackageName,</span><br><span class="line">    <span class="keyword">const</span> String8&amp; cameraId,</span><br><span class="line">    <span class="keyword">int</span> cameraFacing,</span><br><span class="line">    <span class="keyword">int</span> clientPid,</span><br><span class="line">    <span class="keyword">uid_t</span> clientUid,</span><br><span class="line">    <span class="keyword">int</span> servicePid):</span><br><span class="line">    TClientBase(cameraService, remoteCallback, clientPackageName,</span><br><span class="line">            cameraId, cameraFacing, clientPid, clientUid, servicePid),</span><br><span class="line">    mSharedCameraCallbacks(remoteCallback),</span><br><span class="line">    mDeviceVersion(cameraService-&gt;getDeviceVersion(</span><br><span class="line">        TClientBase::mCameraIdStr)),</span><br><span class="line">    mDeviceActive(<span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 实例化 Camera3Device</span></span><br><span class="line">    mDevice = <span class="keyword">new</span> Camera3Device(cameraId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CameraDeviceClient.cpp</span></span><br><span class="line">CameraDeviceClientBase::CameraDeviceClientBase(</span><br><span class="line">    <span class="keyword">const</span> sp&lt;CameraService&gt;&amp; cameraService,</span><br><span class="line">    <span class="keyword">const</span> sp&lt;hardware::camera2::ICameraDeviceCallbacks&gt;&amp; remoteCallback,</span><br><span class="line">    <span class="keyword">const</span> String16&amp; clientPackageName,</span><br><span class="line">    <span class="keyword">const</span> String8&amp; cameraId,</span><br><span class="line">    <span class="keyword">int</span> cameraFacing,</span><br><span class="line">    <span class="keyword">int</span> clientPid,</span><br><span class="line">    <span class="keyword">uid_t</span> clientUid,</span><br><span class="line">    <span class="keyword">int</span> servicePid) :</span><br><span class="line">    BasicClient(cameraService,</span><br><span class="line">            IInterface::asBinder(remoteCallback),</span><br><span class="line">            clientPackageName,</span><br><span class="line">            cameraId,</span><br><span class="line">            cameraFacing,</span><br><span class="line">            clientPid,</span><br><span class="line">            clientUid,</span><br><span class="line">            servicePid),</span><br><span class="line">    mRemoteCallback(remoteCallback) &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CameraService.cpp</span></span><br><span class="line">CameraService::BasicClient::BasicClient(</span><br><span class="line">    <span class="keyword">const</span> sp&lt;CameraService&gt;&amp; cameraService,</span><br><span class="line">    <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; remoteCallback,</span><br><span class="line">    <span class="keyword">const</span> String16&amp; clientPackageName,</span><br><span class="line">    <span class="keyword">const</span> String8&amp; cameraIdStr, <span class="keyword">int</span> cameraFacing,</span><br><span class="line">    <span class="keyword">int</span> clientPid, <span class="keyword">uid_t</span> clientUid,</span><br><span class="line">    <span class="keyword">int</span> servicePid):</span><br><span class="line">    mCameraIdStr(cameraIdStr), mCameraFacing(cameraFacing),</span><br><span class="line">    mClientPackageName(clientPackageName), </span><br><span class="line">    mClientPid(clientPid), mClientUid(clientUid),</span><br><span class="line">    mServicePid(servicePid),</span><br><span class="line">    mDisconnected(<span class="literal">false</span>),</span><br><span class="line">    mRemoteBinder(remoteCallback)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据类继承关系，一条链路实例化各个子类，最终会新建 <code>Camera3Device</code> 实例。<code>makeClient</code> 新建完客户端后，调用客户端的初始化：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraDeviceClient.cpp</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> TProviderPtr&gt;</span><br><span class="line"><span class="keyword">status_t</span> CameraDeviceClient::initializeImpl(TProviderPtr providerPtr) &#123;</span><br><span class="line">    ...</span><br><span class="line">    res = Camera2ClientBase::initialize(providerPtr);</span><br><span class="line">    ...</span><br><span class="line">    String8 threadName;</span><br><span class="line">    mFrameProcessor = <span class="keyword">new</span> FrameProcessorBase(mDevice);</span><br><span class="line">    threadName = String8::format(<span class="string">"CDU-%s-FrameProc"</span>, </span><br><span class="line">        mCameraIdStr.<span class="built_in">string</span>());</span><br><span class="line">    mFrameProcessor-&gt;run(threadName.<span class="built_in">string</span>());</span><br><span class="line"></span><br><span class="line">    mFrameProcessor-&gt;registerListener(FRAME_PROCESSOR_LISTENER_MIN_ID,</span><br><span class="line">                                      FRAME_PROCESSOR_LISTENER_MAX_ID,</span><br><span class="line">                                      <span class="comment">/*listener*/</span><span class="keyword">this</span>,</span><br><span class="line">                                      <span class="comment">/*sendPartials*/</span><span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CameraDeviceClient::initializeImpl</code> 是一个模板函数，主要有两个功能：调用 <code>Camera2ClientBase</code> 及其父类初始化；新建 <code>FrameProcessorBase</code> 实例，它主要功能是在发出预览、拍照、录像请求后，<code>HAL</code> 层向 <code>Framework</code> 层返回结果的回调类，后面讲预览流程时会详细分析。  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Camera2ClientBase.cpp</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TClientBase&gt;</span><br><span class="line"><span class="keyword">status_t</span> Camera2ClientBase&lt;TClientBase&gt;::initialize(</span><br><span class="line">    sp&lt;CameraProviderManager&gt; manager) &#123;</span><br><span class="line">    <span class="keyword">return</span> initializeImpl(manager);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TClientBase&gt;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TProviderPtr&gt;</span><br><span class="line"><span class="keyword">status_t</span> Camera2ClientBase&lt;TClientBase&gt;::initializeImpl(</span><br><span class="line">    TProviderPtr providerPtr) &#123;</span><br><span class="line">    ...</span><br><span class="line">    res = mDevice-&gt;initialize(providerPtr);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Camera2ClientBase::initialize</code> 也是一个模板函数，最终会调用 <code>Camera3Device</code> 的初始化：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Camera3Device.cpp</span></span><br><span class="line"><span class="keyword">status_t</span> Camera3Device::initialize(sp&lt;CameraProviderManager&gt; manager) &#123;</span><br><span class="line">    ...</span><br><span class="line">    sp&lt;ICameraDeviceSession&gt; session;</span><br><span class="line">    <span class="comment">// 打开会话，获取 ICameraDeviceSession</span></span><br><span class="line">    <span class="keyword">status_t</span> res = manager-&gt;openSession(mId.<span class="built_in">string</span>(), <span class="keyword">this</span>,</span><br><span class="line">            <span class="comment">/*out*/</span> &amp;session);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 获取当前设备的配置信息，并保存到 CameraMetadata mDeviceInfo</span></span><br><span class="line">    res = manager-&gt;getCameraCharacteristics(mId.<span class="built_in">string</span>(), &amp;mDeviceInfo);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 通过 ICameraDeviceSession 获取请求队列</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;RequestMetadataQueue&gt; <span class="built_in">queue</span>;</span><br><span class="line">    <span class="keyword">auto</span> requestQueueRet = session-&gt;getCaptureRequestMetadataQueue(</span><br><span class="line">        [&amp;<span class="built_in">queue</span>](<span class="keyword">const</span> <span class="keyword">auto</span>&amp; descriptor) &#123;</span><br><span class="line">            <span class="built_in">queue</span> = <span class="built_in">std</span>::make_shared&lt;RequestMetadataQueue&gt;(descriptor);</span><br><span class="line">            ...</span><br><span class="line">        &#125;);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 通过 ICameraDeviceSession 获取结果队列</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;ResultMetadataQueue&gt;&amp; resQueue=mResultMetadataQueue;</span><br><span class="line">    <span class="keyword">auto</span> resultQueueRet = session-&gt;getCaptureResultMetadataQueue(</span><br><span class="line">        [&amp;resQueue](<span class="keyword">const</span> <span class="keyword">auto</span>&amp; descriptor) &#123;</span><br><span class="line">            resQueue=<span class="built_in">std</span>::make_unique&lt;ResultMetadataQueue&gt;(descriptor);</span><br><span class="line">            ...</span><br><span class="line">        &#125;);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 新建 HalInterface 实例，并绑定 ICameraDeviceSession 以及请求队列</span></span><br><span class="line">    mInterface = <span class="keyword">new</span> HalInterface(session, <span class="built_in">queue</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> initializeCommonLocked();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Camera3Device::initialize</code> 初始化中，重点实现的功能为打开物理设备，并获取 <code>ICameraDeviceSession</code> 用于后续直接和 <code>HAL</code> 通信，并通过它从 <code>HAL</code> 获取请求队列和结果队列；最后新建 <code>HalInterface</code> 实例，并将 <code>ICameraDeviceSession</code> 保存并绑定。  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraProviderManager.cpp</span></span><br><span class="line"><span class="keyword">status_t</span> CameraProviderManager::openSession(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;id,</span><br><span class="line">    <span class="keyword">const</span> sp&lt;hardware::camera::device::V3_2::ICameraDeviceCallback&gt;&amp;</span><br><span class="line">    callback, <span class="comment">/*out*/</span></span><br><span class="line">    sp&lt;hardware::camera::device::V3_2::ICameraDeviceSession&gt; *session)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; lock(mInterfaceMutex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> deviceInfo = findDeviceInfoLocked(id,</span><br><span class="line">            <span class="comment">/*minVersion*/</span> &#123;<span class="number">3</span>,<span class="number">0</span>&#125;, <span class="comment">/*maxVersion*/</span> &#123;<span class="number">4</span>,<span class="number">0</span>&#125;);</span><br><span class="line">    <span class="keyword">if</span> (deviceInfo == <span class="literal">nullptr</span>) <span class="keyword">return</span> NAME_NOT_FOUND;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">auto</span> *deviceInfo3=<span class="keyword">static_cast</span>&lt;ProviderInfo::DeviceInfo3*&gt;(deviceInfo);</span><br><span class="line"></span><br><span class="line">    Status status;</span><br><span class="line">    hardware::Return&lt;<span class="keyword">void</span>&gt; ret;</span><br><span class="line">    <span class="comment">// 向 HAL 打开设备，并返回 ICameraDeviceSession</span></span><br><span class="line">    ret = deviceInfo3-&gt;mInterface-&gt;open(callback, </span><br><span class="line">        [&amp;status, &amp;session] (Status s, </span><br><span class="line">        <span class="keyword">const</span> sp&lt;device::V3_2::ICameraDeviceSession&gt;&amp; cameraSession) &#123;</span><br><span class="line">            status = s;</span><br><span class="line">            <span class="keyword">if</span> (status == Status::OK) &#123;</span><br><span class="line">                *session = cameraSession;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CameraProviderManager::openSession</code> 打开设备时，会向 <code>HAL</code> 打开设备，将 <code>ICameraDeviceCallback</code> 传入 <code>HAL</code> 并获取 <code>ICameraDeviceSession</code> 实例。接着看 <code>Camera3Device::initializeCommonLocked</code> ：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Camera3Device.cpp</span></span><br><span class="line"><span class="keyword">status_t</span> Camera3Device::initializeCommonLocked() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Start up status tracker thread */</span></span><br><span class="line">    mStatusTracker = <span class="keyword">new</span> StatusTracker(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">status_t</span> res = mStatusTracker-&gt;run(</span><br><span class="line">        String8::format(<span class="string">"C3Dev-%s-Status"</span>, mId.<span class="built_in">string</span>()).<span class="built_in">string</span>());</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Register in-flight map to the status tracker */</span></span><br><span class="line">    mInFlightStatusId = mStatusTracker-&gt;addComponent();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Create buffer manager */</span></span><br><span class="line">    mBufferManager = <span class="keyword">new</span> Camera3BufferManager();</span><br><span class="line"></span><br><span class="line">    mTagMonitor.initialize(mVendorTagId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Start up request queue thread */</span></span><br><span class="line">    mRequestThread = <span class="keyword">new</span> RequestThread(<span class="keyword">this</span>, mStatusTracker, mInterface);</span><br><span class="line">    res = mRequestThread-&gt;run(</span><br><span class="line">        String8::format(<span class="string">"C3Dev-%s-ReqQueue"</span>, mId.<span class="built_in">string</span>()).<span class="built_in">string</span>());</span><br><span class="line">    ...</span><br><span class="line">    mPreparerThread = <span class="keyword">new</span> PreparerThread();</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>initializeCommonLocked</code> 中新建了很多实例：  </p>
<ul>
<li><code>StatusTracker</code> ：状态跟踪线程  </li>
<li><code>Camera3BufferManager</code> ：输出流的图形缓冲区管理，比如 <code>Camera3OutputStream</code> 的管理  </li>
<li><code>TagMonitor</code> ：相机元数据 <code>metadata</code> 的监视器，比如 <code>3A</code> 信息等  </li>
<li><code>RequestThread</code> ：请求线程，比如拍照、录像、预览的数据请求  </li>
<li><code>PreparerThread</code> ：监测数据已经准备好流的线程  </li>
</ul>
<h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h3><p>以上流程图都是基于 <code>API 2 + HAL 3</code>，当 <code>Camera Open</code> 流程结束后：  </p>
<ul>
<li>客户端调用 <code>API</code> 时，得到了 <code>CameraDevice</code> 的实例，并将 <code>ICameraDeviceUser</code> 和 <code>CameraDeviceImpl</code> 绑定  </li>
<li>根据 <code>HAL 1/3</code> 生成了对应的 <code>Device</code> 客户端，当前生成的是 <code>CameraDeviceClient</code> 实例  </li>
<li><code>Camera3Device</code> 在初始化时，调用 <code>CameraProviderManager.openSession</code> ，它会通过 <code>HIDL</code> 通知 <code>HAL</code> 层打开摄像头物理设备；打开成功会 <code>Camera3Device::HalInterface</code> 和 <code>ICameraDeviceSession</code> 实例绑定  </li>
<li>新建 <code>RequestThread</code> 对象，后台运行线程，用于监听 <code>API</code> 发起的请求 <code>CaptureRequest</code> ：预览、拍照、录像等  </li>
<li>新建 <code>FrameProcessorBase</code> 对象，后台运行线程，用于监听 <code>HAL</code> 返回的请求结果 <code>CaptureResult</code>  </li>
</ul>
<blockquote>
<p>打开设备时，实际上 <code>Framework, HAL</code> 已经创建好会话 <code>ICameraDeviceSession</code> ；而下面分析的 <code>API</code> 创建会话流程，实际是根据不同需求（预览、拍照、录像）来创建和配置输出流。  </p>
</blockquote>
<h2 id="创建会话流程"><a href="#创建会话流程" class="headerlink" title="创建会话流程"></a>创建会话流程</h2><h3 id="API-1"><a href="#API-1" class="headerlink" title="API"></a><code>API</code></h3><p>在打开设备后，获取到了 <code>CameraDevice</code> 的实例，通过它来创建会话 <code>Session</code> ：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraDevice.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">createCaptureSession</span><span class="params">(@NonNull List&lt;Surface&gt; outputs,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull CameraCaptureSession.StateCallback callback, </span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable Handler handler)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> CameraAccessException</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>List&lt;Surface&gt; outputs</code><br>表示有多少个输出流，通常为预览流和拍照/录像，两个输出流。  </li>
<li><code>CameraCaptureSession.StateCallback callback</code><br>创建会话状态回调。  </li>
<li><code>Handler handler</code><br>回调方法使用哪个线程响应，如果为 <code>null</code> 表示当前线程。  </li>
</ul>
<p><code>API</code> 创建会话过程源码分析：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraDeviceImpl.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createCaptureSession</span><span class="params">(List&lt;Surface&gt; outputs,</span></span></span><br><span class="line"><span class="function"><span class="params">        CameraCaptureSession.StateCallback callback, Handler handler)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line">    <span class="comment">// 将 Surface 转换为 OutputConfiguration</span></span><br><span class="line">    List&lt;OutputConfiguration&gt; outConfigurations = </span><br><span class="line">        <span class="keyword">new</span> ArrayList&lt;&gt;(outputs.size());</span><br><span class="line">    <span class="keyword">for</span> (Surface surface : outputs) &#123;</span><br><span class="line">        outConfigurations.add(<span class="keyword">new</span> OutputConfiguration(surface));</span><br><span class="line">    &#125;</span><br><span class="line">    createCaptureSessionInternal(<span class="keyword">null</span>, outConfigurations, callback, </span><br><span class="line">            handler, ICameraDeviceUser.NORMAL_MODE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createCaptureSessionInternal</span><span class="params">(InputConfiguration inputConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;OutputConfiguration&gt; outputConfigurations,</span></span></span><br><span class="line"><span class="function"><span class="params">        CameraCaptureSession.StateCallback callback, Handler handler,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> operatingMode)</span> <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 创建会话时，输入 Surface 为空</span></span><br><span class="line">    Surface input = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// configure streams and then block until IDLE</span></span><br><span class="line">        <span class="comment">// 向 Framework, HAL 发送信息，配置设备</span></span><br><span class="line">        configureSuccess = configureStreamsChecked(inputConfig, </span><br><span class="line">            outputConfigurations, operatingMode);</span><br><span class="line">        <span class="keyword">if</span> (configureSuccess == <span class="keyword">true</span> &amp;&amp; inputConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">            input = mRemoteDevice.getInputSurface();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CameraAccessException e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    CameraCaptureSessionCore newSession = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 根据模式来实例化对应的 Session</span></span><br><span class="line">    <span class="keyword">if</span> (isConstrainedHighSpeed) &#123;</span><br><span class="line">        newSession = <span class="keyword">new</span> CameraConstrainedHighSpeedCaptureSessionImpl(</span><br><span class="line">            mNextSessionId++, callback, handler, <span class="keyword">this</span>, </span><br><span class="line">            mDeviceHandler, configureSuccess, mCharacteristics);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 假设实例化 CameraCaptureSessionImpl</span></span><br><span class="line">        newSession = <span class="keyword">new</span> CameraCaptureSessionImpl(mNextSessionId++, </span><br><span class="line">            input, callback, handler, <span class="keyword">this</span>, </span><br><span class="line">            mDeviceHandler, configureSuccess);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mCurrentSession = newSession;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>将 <code>List&lt;Surface&gt;</code> 转换为 <code>List&lt;OutputConfiguration&gt;</code>  </li>
<li><code>createCaptureSession</code> 创建会话时，输入 <code>Surface, InputConfiguration</code> 都为空，即只有输出流  </li>
<li>根据 <code>isConstrainedHighSpeed</code> 来创建 <code>CameraCaptureSession</code> 实例；如果支持高速模式，则创建 <code>CameraConstrainedHighSpeedCaptureSessionImpl</code> 实例；否则创建普通 <code>CameraCaptureSessionImpl</code> 实例  </li>
</ul>
<h3 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h3><p>创建预览 <code>mTextureSurface</code> 和拍照 <code>ImageReader.getSurface</code> 两个输出流的会话，使用当前线程处理回调接口：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mCameraDevice.createCaptureSession(</span><br><span class="line">    Arrays.asList(mTextureSurface, mImageReader.getSurface()), </span><br><span class="line">    <span class="keyword">new</span> CameraCaptureSession.StateCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConfigured</span><span class="params">(@NonNull CameraCaptureSession session)</span> </span>&#123;</span><br><span class="line">            Log.d(TAG, <span class="string">"onConfigured: "</span>);</span><br><span class="line">            mCameraCaptureSession = session;</span><br><span class="line">            preview();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConfigureFailed</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull CameraCaptureSession session)</span> </span>&#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"onConfigureFailed: "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="keyword">null</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (CameraAccessException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CameraCaptureSession-StateCallback-回调"><a href="#CameraCaptureSession-StateCallback-回调" class="headerlink" title="CameraCaptureSession.StateCallback 回调"></a><code>CameraCaptureSession.StateCallback</code> 回调</h3><p><code>CameraCaptureSession.StateCallback</code> 回调用来处理 <code>createCaptureSession</code> 创建会话过程中出现的各种状态，比如创建成功、失败等，这些回调处理直接在 <code>API Java</code> 层实现的；回调接口中会获取到 <code>CameraCaptureSession</code> 实例。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">StateCallback</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onConfigured</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull CameraCaptureSession session)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onConfigureFailed</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull CameraCaptureSession session)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReady</span><span class="params">(@NonNull CameraCaptureSession session)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// default empty implementation</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActive</span><span class="params">(@NonNull CameraCaptureSession session)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// default empty implementation</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCaptureQueueEmpty</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull CameraCaptureSession session)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// default empty implementation</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClosed</span><span class="params">(@NonNull CameraCaptureSession session)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// default empty implementation</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfacePrepared</span><span class="params">(@NonNull CameraCaptureSession session,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull Surface surface)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// default empty implementation</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>createCaptureSession</code> 创建会话时，会创建 <code>CameraCaptureSessionImpl</code> 实例，而 <code>CameraCaptureSession.StateCallback</code> 接口的回调都是在 <code>CameraCaptureSessionImpl</code> 中实现的：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraCaptureSessionImpl.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CameraCaptureSessionImpl</span> <span class="keyword">extends</span> <span class="title">CameraCaptureSession</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">CameraCaptureSessionCore</span> </span>&#123;</span><br><span class="line">    CameraCaptureSessionImpl(<span class="keyword">int</span> id, Surface input,</span><br><span class="line">            CameraCaptureSession.StateCallback callback,</span><br><span class="line">            Handler stateHandler,</span><br><span class="line">            android.hardware.camera2.impl.CameraDeviceImpl deviceImpl,</span><br><span class="line">            Handler deviceStateHandler, <span class="keyword">boolean</span> configureSuccess) &#123;</span><br><span class="line">        ...</span><br><span class="line">        mStateCallback = </span><br><span class="line">            createUserStateCallbackProxy(mStateHandler, callback);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 根据传入的参数，响应 CameraCaptureSession.StateCallback 回调</span></span><br><span class="line">        <span class="keyword">if</span> (configureSuccess) &#123;</span><br><span class="line">            mStateCallback.onConfigured(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) Log.v(...);</span><br><span class="line">            mConfigureSuccess = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mStateCallback.onConfigureFailed(<span class="keyword">this</span>);</span><br><span class="line">            mClosed = <span class="keyword">true</span>; </span><br><span class="line">            Log.e(...);</span><br><span class="line">            mConfigureSuccess = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 用户指定并传入的回调实现及对应线程</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CameraCaptureSession.StateCallback mStateCallback;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Handler mStateHandler;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> StateCallback <span class="title">createUserStateCallbackProxy</span><span class="params">(Handler handler,</span></span></span><br><span class="line"><span class="function"><span class="params">        StateCallback callback)</span> </span>&#123;</span><br><span class="line">        InvokeDispatcher&lt;StateCallback&gt; userCallbackSink </span><br><span class="line">            = <span class="keyword">new</span> InvokeDispatcher&lt;&gt;(callback);</span><br><span class="line">        HandlerDispatcher&lt;StateCallback&gt; handlerPassthrough =</span><br><span class="line">                <span class="keyword">new</span> HandlerDispatcher&lt;&gt;(userCallbackSink, handler);</span><br><span class="line">        <span class="comment">// 创建代理类</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CallbackProxies.SessionStateCallbackProxy(</span><br><span class="line">            handlerPassthrough);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用户指定的 <code>StateCallback</code> 传入后，在方法 <code>createUserStateCallbackProxy</code> 中，通过 <code>CallbackProxies</code> 重新生成一个代理 <code>mStateCallback</code> 对象，通过反射的方式，完成所有回调响应过程。  </p>
<ul>
<li>如果 <code>configureStreamsChecked</code> 创建 <code>Stream</code> 成功，则响应回调 <code>mStateCallback.onConfigured</code>  </li>
<li>如果失败则响应 <code>mStateCallback.onConfigureFailed</code> ，其他场景会产生剩余的回调  </li>
</ul>
<p>动态代理类 <code>CallbackProxies</code> 源码注释（<code>JDK</code> 中的动态代理只支持接口 <code>interface</code>，对于抽象类只能自己实现了）：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Proxy out invocations to the camera2 API callbacks into </span></span><br><span class="line"><span class="comment"> * a &#123;<span class="doctag">@link</span> Dispatchable&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Since abstract classes do not support Java's dynamic &#123;<span class="doctag">@code</span> Proxy&#125;,</span></span><br><span class="line"><span class="comment"> * we have to to use our own proxy mechanism.&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CallbackProxies</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="流程图-1"><a href="#流程图-1" class="headerlink" title="流程图"></a>流程图</h3><p><a href="https://upload-images.jianshu.io/upload_images/606437-fa47e3f3f3c7dc76.jpg" target="_blank" rel="noopener">创建会话流程，查看原图</a>  </p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0109-android-camera-4-framework-CameraService-addService-CameraDevice_createCaptureSession.jpg" alt="0109-android-camera-4-framework-CameraService-addService-CameraDevice_createCaptureSession.jpg"></p>
<h3 id="源码分析-2"><a href="#源码分析-2" class="headerlink" title="源码分析"></a>源码分析</h3><p><code>API</code> 中创建捕获会话 <code>createCaptureSession</code> 时，<code>CameraDeviceImpl.configureStreamsChecked</code> 源码中可以看到；<code>CameraDeviceImpl</code> 是通过 <code>ICameraDeviceUser</code> 来向 <code>Framework, HAL</code> 层发送配置信息的：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraDeviceImpl.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">configureStreamsChecked</span><span class="params">(InputConfiguration inputConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;OutputConfiguration&gt; outputs, <span class="keyword">int</span> operatingMode)</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// createCaptureSession 时，imputConfig 为空</span></span><br><span class="line">    checkInputConfiguration(inputConfig);</span><br><span class="line">    <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">synchronized</span>(mInterfaceLock) &#123;</span><br><span class="line">        ...</span><br><span class="line">        mDeviceHandler.post(mCallOnBusy);</span><br><span class="line">        stopRepeating();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            waitUntilIdle();</span><br><span class="line">            mRemoteDevice.beginConfigure();</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// Delete all streams first (to free up HW resources)</span></span><br><span class="line">            <span class="keyword">for</span> (Integer streamId : deleteList) &#123;</span><br><span class="line">                mRemoteDevice.deleteStream(streamId);</span><br><span class="line">                mConfiguredOutputs.delete(streamId);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add all new streams</span></span><br><span class="line">            <span class="keyword">for</span> (OutputConfiguration outConfig : outputs) &#123;</span><br><span class="line">                <span class="keyword">if</span> (addSet.contains(outConfig)) &#123;</span><br><span class="line">                    <span class="keyword">int</span> streamId = mRemoteDevice.createStream(outConfig);</span><br><span class="line">                    mConfiguredOutputs.put(streamId, outConfig);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            operatingMode = (operatingMode | (customOpMode &lt;&lt; <span class="number">16</span>));</span><br><span class="line">            mRemoteDevice.endConfigure(operatingMode);</span><br><span class="line"></span><br><span class="line">            success = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (...)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>configureStreamsChecked</code> 配置流有三个主要过程：<code>beginConfigure, createStream, endConfigure</code> ，都是通过 <code>ICameraDeviceUser</code> 向下发送信息。 <code>native</code> 代码中由 <code>CameraDeviceClient.cpp</code> 实现了 <code>ICameraDeviceUser</code> 中的所有功能，这里重点分析 <code>createStream</code> 函数：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraDeviceClient.cpp</span></span><br><span class="line">binder::Status CameraDeviceClient::createStream(</span><br><span class="line">        <span class="keyword">const</span> hardware::camera2::params::OutputConfiguration </span><br><span class="line">        &amp;outputConfiguration,</span><br><span class="line">        <span class="comment">/*out*/</span><span class="keyword">int32_t</span>* newStreamId) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 获取 IGraphicBufferProducer 的个数</span></span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;sp&lt;IGraphicBufferProducer&gt;&gt;&amp; bufferProducers =</span><br><span class="line">            outputConfiguration.getGraphicBufferProducers();</span><br><span class="line">    <span class="keyword">size_t</span> numBufferProducers = bufferProducers.size();</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;sp&lt;Surface&gt;&gt; surfaces;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;sp&lt;IBinder&gt;&gt; binders;</span><br><span class="line">    ...</span><br><span class="line">    OutputStreamInfo streamInfo;</span><br><span class="line">    <span class="keyword">bool</span> isStreamInfoValid = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; bufferProducer : bufferProducers) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 创建 Native Surface</span></span><br><span class="line">        sp&lt;Surface&gt; surface;</span><br><span class="line">        res = createSurfaceFromGbp(streamInfo, isStreamInfoValid, </span><br><span class="line">            surface, bufferProducer);</span><br><span class="line">        <span class="keyword">if</span> (!res.isOk())</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        ...</span><br><span class="line">        binders.push_back(IInterface::asBinder(bufferProducer));</span><br><span class="line">        surfaces.push_back(surface);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> streamId = camera3::CAMERA3_STREAM_ID_INVALID;</span><br><span class="line">    <span class="comment">// 调用 Camera3Device 创建流</span></span><br><span class="line">    err = mDevice-&gt;createStream(surfaces, deferredConsumer, </span><br><span class="line">            streamInfo.width, streamInfo.height, </span><br><span class="line">            streamInfo.format, streamInfo.dataSpace,</span><br><span class="line">            <span class="keyword">static_cast</span>&lt;<span class="keyword">camera3_stream_rotation_t</span>&gt;(</span><br><span class="line">                outputConfiguration.getRotation()),</span><br><span class="line">            &amp;streamId, outputConfiguration.getSurfaceSetID(), isShared);</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        mStreamInfoMap[streamId] = streamInfo;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// Set transform flags to ensure preview to be rotated correctly.</span></span><br><span class="line">        res = setStreamTransformLocked(streamId);</span><br><span class="line">        *newStreamId = streamId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CameraDeviceClient.createStream</code> 中，将 <code>API</code> 传入的 <code>OutputConfiguration</code> 数据，转换成 <code>native Surface, OutputStreamInfo</code> ；根据 <code>OutputConfiguration</code> 中 <code>IGraphicBufferProducer</code> 的个数创建对应的 <code>native Surface</code> ，并最终通过设备来创建流。  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">binder::Status CameraDeviceClient::createSurfaceFromGbp(</span><br><span class="line">        OutputStreamInfo&amp; streamInfo, <span class="keyword">bool</span> isStreamInfoValid,</span><br><span class="line">        sp&lt;Surface&gt;&amp; surface, <span class="keyword">const</span> sp&lt;IGraphicBufferProducer&gt;&amp; gbp) &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 根据 IGraphicBufferProducer 创建 Surface</span></span><br><span class="line">    surface = <span class="keyword">new</span> Surface(gbp, useAsync);</span><br><span class="line">    ANativeWindow *anw = surface.get();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> width, height, format;</span><br><span class="line">    android_dataspace dataSpace;</span><br><span class="line">    <span class="comment">// 查询对应的长、宽、格式、数据空间</span></span><br><span class="line">    <span class="keyword">if</span> ((err = anw-&gt;query(anw, NATIVE_WINDOW_WIDTH, &amp;width)) != OK) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((err = anw-&gt;query(anw, NATIVE_WINDOW_HEIGHT, &amp;height)) != OK) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((err = anw-&gt;query(anw, NATIVE_WINDOW_FORMAT, &amp;format)) != OK) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((err = anw-&gt;query(anw, NATIVE_WINDOW_DEFAULT_DATASPACE,</span><br><span class="line">            <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">int</span>*&gt;(&amp;dataSpace))) != OK) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 赋值给输出流</span></span><br><span class="line">    <span class="keyword">if</span> (!isStreamInfoValid) &#123;</span><br><span class="line">        streamInfo.width = width;</span><br><span class="line">        streamInfo.height = height;</span><br><span class="line">        streamInfo.format = format;</span><br><span class="line">        streamInfo.dataSpace = dataSpace;</span><br><span class="line">        streamInfo.consumerUsage = consumerUsage;</span><br><span class="line">        <span class="keyword">return</span> binder::Status::ok();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的 <code>NATIVE_WINDOW_FORMAT</code> 格式代表着不同流的类型，在 <code>system\core\libsystem\include\system\graphics-base.h</code> 文件中定义：  </p>
<figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">    HAL_PIXEL_FORMAT_RGBA_8888 = <span class="number">1</span>,</span><br><span class="line">    HAL_PIXEL_FORMAT_RGBX_8888 = <span class="number">2</span>,</span><br><span class="line">    HAL_PIXEL_FORMAT_RGB_888 = <span class="number">3</span>,</span><br><span class="line">    HAL_PIXEL_FORMAT_RGB_565 = <span class="number">4</span>,</span><br><span class="line">    HAL_PIXEL_FORMAT_BGRA_8888 = <span class="number">5</span>,</span><br><span class="line">    HAL_PIXEL_FORMAT_RGBA_1010102 = <span class="number">43</span>, <span class="comment">// 0x2B</span></span><br><span class="line">    HAL_PIXEL_FORMAT_RGBA_FP16 = <span class="number">22</span>, <span class="comment">// 0x16</span></span><br><span class="line">    HAL_PIXEL_FORMAT_YV12 = <span class="number">842094169</span>, <span class="comment">// 0x32315659</span></span><br><span class="line">    HAL_PIXEL_FORMAT_Y8 = <span class="number">538982489</span>, <span class="comment">// 0x20203859</span></span><br><span class="line">    HAL_PIXEL_FORMAT_Y16 = <span class="number">540422489</span>, <span class="comment">// 0x20363159</span></span><br><span class="line">    HAL_PIXEL_FORMAT_RAW16 = <span class="number">32</span>, <span class="comment">// 0x20</span></span><br><span class="line">    HAL_PIXEL_FORMAT_RAW10 = <span class="number">37</span>, <span class="comment">// 0x25</span></span><br><span class="line">    HAL_PIXEL_FORMAT_RAW12 = <span class="number">38</span>, <span class="comment">// 0x26</span></span><br><span class="line">    HAL_PIXEL_FORMAT_RAW_OPAQUE = <span class="number">36</span>, <span class="comment">// 0x24</span></span><br><span class="line">    HAL_PIXEL_FORMAT_BLOB = <span class="number">33</span>, <span class="comment">// 0x21</span></span><br><span class="line">    HAL_PIXEL_FORMAT_IMPLEMENTATION_DEFINED = <span class="number">34</span>, <span class="comment">// 0x22</span></span><br><span class="line">    HAL_PIXEL_FORMAT_YCBCR_420_888 = <span class="number">35</span>, <span class="comment">// 0x23</span></span><br><span class="line">    HAL_PIXEL_FORMAT_YCBCR_422_888 = <span class="number">39</span>, <span class="comment">// 0x27</span></span><br><span class="line">    HAL_PIXEL_FORMAT_YCBCR_444_888 = <span class="number">40</span>, <span class="comment">// 0x28</span></span><br><span class="line">    HAL_PIXEL_FORMAT_FLEX_RGB_888 = <span class="number">41</span>, <span class="comment">// 0x29</span></span><br><span class="line">    HAL_PIXEL_FORMAT_FLEX_RGBA_8888 = <span class="number">42</span>, <span class="comment">// 0x2A</span></span><br><span class="line">    HAL_PIXEL_FORMAT_YCBCR_422_SP = <span class="number">16</span>, <span class="comment">// 0x10</span></span><br><span class="line">    HAL_PIXEL_FORMAT_YCRCB_420_SP = <span class="number">17</span>, <span class="comment">// 0x11</span></span><br><span class="line">    HAL_PIXEL_FORMAT_YCBCR_422_I = <span class="number">20</span>, <span class="comment">// 0x14</span></span><br><span class="line">    HAL_PIXEL_FORMAT_JPEG = <span class="number">256</span>, <span class="comment">// 0x100</span></span><br><span class="line">&#125; <span class="keyword">android_pixel_format_t</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>HAL_PIXEL_FORMAT_BLOB</code> 拍照流<br>值为 33 ，通常对应 <code>mImageReader.getSurface()</code>  </li>
<li><code>HAL_PIXEL_FORMAT_IMPLEMENTATION_DEFINED</code> 预览和录像流<br>值为 34 ，通常对应预览 <code>new Surface(mTextureView.getSurfaceTexture())</code> 和录像 <code>mMediaRecorder.getSurface</code> 。  </li>
</ul>
<p><code>CameraDeviceClient::createStream</code> 最终会调用 <code>Camera3Device::createStream</code> ，它会根据 <code>NATIVE_WINDOW_FORMAT</code> 格式创建不同配置的流：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Camera3Device.cpp</span></span><br><span class="line"><span class="keyword">status_t</span> Camera3Device::createStream(</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;sp&lt;Surface&gt;&gt;&amp; consumers,</span><br><span class="line">        <span class="keyword">bool</span> hasDeferredConsumer, <span class="keyword">uint32_t</span> width, <span class="keyword">uint32_t</span> height, </span><br><span class="line">        <span class="keyword">int</span> format, android_dataspace dataSpace, </span><br><span class="line">        <span class="keyword">camera3_stream_rotation_t</span> rotation, <span class="keyword">int</span> *id,</span><br><span class="line">        <span class="keyword">int</span> streamSetId, <span class="keyword">bool</span> isShared, <span class="keyword">uint64_t</span> consumerUsage) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 拍照流</span></span><br><span class="line">    <span class="keyword">if</span> (format == HAL_PIXEL_FORMAT_BLOB) &#123;</span><br><span class="line">        <span class="keyword">ssize_t</span> blobBufferSize;</span><br><span class="line">        <span class="keyword">if</span> (dataSpace != HAL_DATASPACE_DEPTH) &#123;</span><br><span class="line">            blobBufferSize = getJpegBufferSize(width, height);</span><br><span class="line">            <span class="keyword">if</span> (blobBufferSize &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                SET_ERR_L(...);</span><br><span class="line">                <span class="keyword">return</span> BAD_VALUE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            blobBufferSize = getPointCloudBufferSize();</span><br><span class="line">            <span class="keyword">if</span> (blobBufferSize &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                SET_ERR_L(...);</span><br><span class="line">                <span class="keyword">return</span> BAD_VALUE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        newStream = <span class="keyword">new</span> Camera3OutputStream(mNextStreamId, consumers[<span class="number">0</span>],</span><br><span class="line">                width, height, blobBufferSize, format, dataSpace, </span><br><span class="line">                rotation, mTimestampOffset, streamSetId);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (format == HAL_PIXEL_FORMAT_RAW_OPAQUE) &#123;</span><br><span class="line">        <span class="keyword">ssize_t</span> rawOpaqueBufferSize = </span><br><span class="line">            getRawOpaqueBufferSize(width, height);</span><br><span class="line">        <span class="keyword">if</span> (rawOpaqueBufferSize &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            SET_ERR_L(...);</span><br><span class="line">            <span class="keyword">return</span> BAD_VALUE;</span><br><span class="line">        &#125;</span><br><span class="line">        newStream = <span class="keyword">new</span> Camera3OutputStream(mNextStreamId, consumers[<span class="number">0</span>],</span><br><span class="line">                width, height, rawOpaqueBufferSize, format, dataSpace, </span><br><span class="line">                rotation, mTimestampOffset, streamSetId);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        newStream = <span class="keyword">new</span> Camera3OutputStream(mNextStreamId, consumers[<span class="number">0</span>],</span><br><span class="line">                width, height, format, dataSpace, rotation,</span><br><span class="line">                mTimestampOffset, streamSetId);</span><br><span class="line">    &#125;</span><br><span class="line">    newStream-&gt;setStatusTracker(mStatusTracker);</span><br><span class="line">    newStream-&gt;setBufferManager(mBufferManager);</span><br><span class="line"></span><br><span class="line">    res = mOutputStreams.add(mNextStreamId, newStream);</span><br><span class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        SET_ERR_L(...);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *id = mNextStreamId++;</span><br><span class="line">    mNeedConfig = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    ALOGV(<span class="string">"Camera %s: Created new stream"</span>, mId.<span class="built_in">string</span>());</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：每配置一个输出 <code>Surface</code> ，都会创建对应的输出流 <code>Camera3OutputStream</code> ，这是一个 <code>for</code> 循环过程。<br>在 <code>API</code> 调用过程中，<code>CameraDeviceImpl.configureStreamsChecked</code> 的第三步为 <code>endConfigure</code>，而 <code>CameraDeviceClient::endConfigure</code> 代码流程如下：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraDeviceClient.cpp</span></span><br><span class="line">binder::Status CameraDeviceClient::endConfigure(<span class="keyword">int</span> operatingMode) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">status_t</span> err = mDevice-&gt;configureStreams(operatingMode);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它的主要作用就是通过 <code>Camera3Device</code> 来配置流，<code>configureStreamsLocked</code> 配置流主要有三个过程：<code>startConfiguration, configureStreams, endConfigure</code> ：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Camera3Device.cpp</span></span><br><span class="line"><span class="keyword">status_t</span> Camera3Device::configureStreams(<span class="keyword">int</span> operatingMode) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> configureStreamsLocked(operatingMode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> Camera3Device::configureStreamsLocked(<span class="keyword">int</span> operatingMode) &#123;</span><br><span class="line">    ...</span><br><span class="line">    camera3_stream_configuration config;</span><br><span class="line">    config.operation_mode = mOperatingMode;</span><br><span class="line">    config.num_streams = (mInputStream != <span class="literal">NULL</span>) + mOutputStreams.size();</span><br><span class="line"></span><br><span class="line">    Vector&lt;<span class="keyword">camera3_stream_t</span>*&gt; streams;</span><br><span class="line">    streams.setCapacity(config.num_streams);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mInputStream != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">camera3_stream_t</span> *inputStream;</span><br><span class="line">        inputStream = mInputStream-&gt;startConfiguration();</span><br><span class="line">        <span class="keyword">if</span> (inputStream == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            CLOGE(<span class="string">"Can't start input stream configuration"</span>);</span><br><span class="line">            cancelStreamsConfigurationLocked();</span><br><span class="line">            <span class="keyword">return</span> INVALID_OPERATION;</span><br><span class="line">        &#125;</span><br><span class="line">        streams.add(inputStream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mOutputStreams.size(); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mOutputStreams[i].get() ==</span><br><span class="line">            <span class="keyword">static_cast</span>&lt;Camera3StreamInterface*&gt;(mInputStream.get())) &#123;</span><br><span class="line"></span><br><span class="line">            config.num_streams--;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">camera3_stream_t</span> *outputStream;</span><br><span class="line">      outputStream = mOutputStreams.editValueAt(i)-&gt;startConfiguration();</span><br><span class="line">        <span class="keyword">if</span> (outputStream == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            CLOGE(<span class="string">"Can't start output stream configuration"</span>);</span><br><span class="line">            cancelStreamsConfigurationLocked();</span><br><span class="line">            <span class="keyword">return</span> INVALID_OPERATION;</span><br><span class="line">        &#125;</span><br><span class="line">        streams.add(outputStream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    config.streams = streams.editArray();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do the HAL configuration; will potentially touch stream</span></span><br><span class="line">    <span class="comment">// max_buffers, usage, priv fields.</span></span><br><span class="line">    <span class="comment">// 向 HAL 层发送配置信息</span></span><br><span class="line">    res = mInterface-&gt;configureStreams(&amp;config);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (mInputStream != <span class="literal">NULL</span> &amp;&amp; mInputStream-&gt;isConfiguring()) &#123;</span><br><span class="line">        res = mInputStream-&gt;finishConfiguration();</span><br><span class="line">        <span class="keyword">if</span> (res != OK) &#123;</span><br><span class="line">            CLOGE(<span class="string">"Can't finish configuring input stream %d: %s (%d)"</span>,</span><br><span class="line">                    mInputStream-&gt;getId(), strerror(-res), res);</span><br><span class="line">            cancelStreamsConfigurationLocked();</span><br><span class="line">            <span class="keyword">return</span> BAD_VALUE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mOutputStreams.size(); i++) &#123;</span><br><span class="line">        sp&lt;Camera3OutputStreamInterface&gt; outputStream =</span><br><span class="line">            mOutputStreams.editValueAt(i);</span><br><span class="line">        <span class="keyword">if</span> (outputStream-&gt;isConfiguring() &amp;&amp; </span><br><span class="line">            !outputStream-&gt;isConsumerConfigurationDeferred()) &#123;</span><br><span class="line">            res = outputStream-&gt;finishConfiguration();</span><br><span class="line">            <span class="keyword">if</span> (res != OK) &#123;</span><br><span class="line">                CLOGE(...);</span><br><span class="line">                cancelStreamsConfigurationLocked();</span><br><span class="line">                <span class="keyword">return</span> BAD_VALUE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终通过 <code>Camera3Device::HalInterface::configureStreams</code> 向 <code>HAL</code> 层发起配置信息：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Camera3Device.cpp</span></span><br><span class="line"><span class="keyword">status_t</span> Camera3Device::HalInterface::configureStreams(</span><br><span class="line">    camera3_stream_configuration *config) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Invoke configureStreams</span></span><br><span class="line"></span><br><span class="line">    device::V3_3::HalStreamConfiguration finalConfiguration;</span><br><span class="line">    common::V1_0::Status status;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// See if we have v3.3 HAL</span></span><br><span class="line">    sp&lt;device::V3_3::ICameraDeviceSession&gt; hidlSession_3_3;</span><br><span class="line">    <span class="keyword">auto</span> castResult = </span><br><span class="line">        device::V3_3::ICameraDeviceSession::castFrom(mHidlSession);</span><br><span class="line">    <span class="keyword">if</span> (castResult.isOk()) &#123;</span><br><span class="line">        hidlSession_3_3 = castResult;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ALOGE(...);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (hidlSession_3_3 != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="comment">// We do; use v3.3 for the call</span></span><br><span class="line">        ALOGV(<span class="string">"%s: v3.3 device found"</span>, __FUNCTION__);</span><br><span class="line">        <span class="keyword">auto</span> err = hidlSession_3_3-&gt;configureStreams_3_3(</span><br><span class="line">            requestedConfiguration,</span><br><span class="line">            [&amp;status, &amp;finalConfiguration]</span><br><span class="line">            (common::V1_0::Status s, <span class="keyword">const</span> </span><br><span class="line">                device::V3_3::HalStreamConfiguration&amp; halConfiguration) &#123;</span><br><span class="line">                finalConfiguration = halConfiguration;</span><br><span class="line">                status = s;</span><br><span class="line">            &#125;);</span><br><span class="line">        <span class="keyword">if</span> (!err.isOk()) &#123;</span><br><span class="line">            ALOGE(...);</span><br><span class="line">            <span class="keyword">return</span> DEAD_OBJECT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// We don't; use v3.2 call and </span></span><br><span class="line">        <span class="comment">// construct a v3.3 HalStreamConfiguration</span></span><br><span class="line">        ALOGV(<span class="string">"%s: v3.2 device found"</span>, __FUNCTION__);</span><br><span class="line">        HalStreamConfiguration finalConfiguration_3_2;</span><br><span class="line">        <span class="keyword">auto</span> err = mHidlSession-&gt;configureStreams(requestedConfiguration,</span><br><span class="line">                [&amp;status, &amp;finalConfiguration_3_2]</span><br><span class="line">                (common::V1_0::Status s, <span class="keyword">const</span> </span><br><span class="line">                    HalStreamConfiguration&amp; halConfiguration) &#123;</span><br><span class="line">                    finalConfiguration_3_2 = halConfiguration;</span><br><span class="line">                    status = s;</span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="keyword">if</span> (!err.isOk()) &#123;</span><br><span class="line">            ALOGE(...);</span><br><span class="line">            <span class="keyword">return</span> DEAD_OBJECT;</span><br><span class="line">        &#125;</span><br><span class="line">        finalConfiguration.streams.resize(</span><br><span class="line">            finalConfiguration_3_2.streams.size());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i&lt;finalConfiguration_3_2.streams.size(); i++)&#123;</span><br><span class="line">            finalConfiguration.streams[i].v3_2 = </span><br><span class="line">                finalConfiguration_3_2.streams[i];</span><br><span class="line">            finalConfiguration.streams[i].overrideDataSpace =</span><br><span class="line">                    requestedConfiguration.streams[i].dataSpace;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里需要注意的是 <code>HAL 3.3, 3.2</code> 的配置是有区别的；执行完配置后，<code>Camera3Stream::finishConfiguration</code> 结束配置：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Camera3Stream.cpp</span></span><br><span class="line"><span class="keyword">status_t</span> Camera3Stream::finishConfiguration() &#123;</span><br><span class="line">    ....</span><br><span class="line">    res = configureQueueLocked();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Camera3OutputStream.cpp</span></span><br><span class="line"><span class="keyword">status_t</span> Camera3OutputStream::configureConsumerQueueLocked() &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Configure consumer-side ANativeWindow interface. </span></span><br><span class="line">    <span class="comment">// to notify buffer manager (if it is used) of the returned buffers.</span></span><br><span class="line">    res = mConsumer-&gt;connect(NATIVE_WINDOW_API_CAMERA,</span><br><span class="line">            <span class="comment">/*listener*/</span>mBufferReleasedListener,</span><br><span class="line">            <span class="comment">/*reportBufferRemoval*/</span><span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (res != OK) &#123;</span><br><span class="line">        ALOGE(...);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mConsumerName = mConsumer-&gt;getConsumerName();</span><br><span class="line"></span><br><span class="line">    res = native_window_set_usage(mConsumer.get(), mUsage);</span><br><span class="line">    <span class="keyword">if</span> (res != OK) &#123;</span><br><span class="line">        ALOGE(...);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    res = native_window_set_scaling_mode(mConsumer.get(),</span><br><span class="line">            NATIVE_WINDOW_SCALING_MODE_SCALE_TO_WINDOW);</span><br><span class="line">    <span class="keyword">if</span> (res != OK) &#123;</span><br><span class="line">        ALOGE(...);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里 <code>mConsumer</code> 是 <code>native Surface</code>，也就是将生产者-消费者模型连接起来；同时 <code>configureConsumerQueueLocked</code> 有非常多的 <code>native window</code> 配置。  </p>
<h3 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h3><p>创建会话 <code>createCaptureSession</code> 过程中，小结如下：  </p>
<ul>
<li><code>API</code> 调用时，最终通过 <code>CameraCaptureSession.StateCallback</code> 获取到 <code>CameraCaptureSessionImpl</code> 实例  </li>
<li><code>ICameraDeviceUser.createStream</code> 由输入的 <code>Surface</code> 信息，根据不同的 <code>format</code> 创建对应输出流 <code>Camera3OutputStream</code>  </li>
<li><code>ICameraDeviceUser.endConfigure</code> 最终通过 <code>CameraDeviceSession.configureStream_3_3</code> 会向 <code>HAL</code> 层发送配置信息  </li>
</ul>
<p>相机预览过程中，如果 <code>session</code> 创建成功，会出现正常的预览界面；如果 <code>session</code> 创建失败，则预览会出现黑屏。  </p>
<h2 id="预览-拍照-录像流程"><a href="#预览-拍照-录像流程" class="headerlink" title="预览/拍照/录像流程"></a>预览/拍照/录像流程</h2><h3 id="API-2"><a href="#API-2" class="headerlink" title="API"></a><code>API</code></h3><p>创建会话 <code>createCaptureSession</code> 成功后，通过拿到的 <code>CameraCaptureSession</code> 来预览、拍照、录像：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraCaptureSession.java</span></span><br><span class="line"><span class="comment">// 预览和录像使用同一个 API</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">setRepeatingRequest</span><span class="params">(@NonNull CaptureRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable CaptureCallback listener, </span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable Handler handler)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> CameraAccessException</span>;</span><br><span class="line"><span class="comment">// 拍照</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">capture</span><span class="params">(@NonNull CaptureRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable CaptureCallback listener, @Nullable Handler handler)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> CameraAccessException</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>CaptureRequest request</code><br>捕获请求，比如创建一个预览模板的请求 <code>CameraDevice.TEMPLATE_PREVIEW</code> ；拍照模板的请求 <code>CameraDevice.TEMPLATE_STILL_CAPTURE</code> ；录像模板的请求 <code>CameraDevice.TEMPLATE_RECORD</code> 。  </li>
<li><code>CameraCaptureSession.CaptureCallback listener</code><br>捕获状态的回调接口。  </li>
<li><code>Handler handler</code><br>回调接口使用哪个线程响应，如果是 <code>null</code> 表示当前线程。  </li>
</ul>
<p><code>CameraDevice</code> 请求模板是一组常量：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraDevice.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TEMPLATE_PREVIEW = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TEMPLATE_STILL_CAPTURE = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TEMPLATE_RECORD  = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TEMPLATE_VIDEO_SNAPSHOT = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TEMPLATE_ZERO_SHUTTER_LAG = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TEMPLATE_MANUAL = <span class="number">6</span>;</span><br></pre></td></tr></table></figure>

<p>各模板对应的含义：  </p>
<ul>
<li><code>TEMPLATE_PREVIEW</code><br>创建适合相机预览的窗口，高帧率优于高质量的后期处理。  </li>
<li><code>TEMPLATE_STILL_CAPTURE</code><br>创建适合拍照的请求，优先考虑帧速率的图像质量。  </li>
<li><code>TEMPLATE_RECORD</code><br>创建适合录像的请求，使用稳定的帧率。  </li>
<li><code>TEMPLATE_VIDEO_SNAPSHOT</code><br>创建录像时快照的请求，在不中断录像的前提下最大化图像质量。  </li>
<li><code>TEMPLATE_ZERO_SHUTTER_LAG</code><br>创建 <code>ZSL</code> 零延时拍照请求，也就是连拍功能，在不影响帧率的前提下最大化图像质量，并开启 <code>3A</code> 算法。  </li>
<li><code>TEMPLATE_MANUAL</code><br>手动控制模板，禁用所有的自动控制 <code>3A</code> 算法。 </li>
</ul>
<h3 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h3><p>给 <code>mTextureSurface</code> 创建预览请求 <code>TEMPLATE_PREVIEW</code> ，使用后台线程处理回调接口：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CaptureRequest.Builder previewRequestBuilder = </span><br><span class="line">    mCameraDevice.createCaptureRequest(CameraDevice.TEMPLATE_PREVIEW);</span><br><span class="line">previewRequestBuilder.addTarget(mTextureSurface);</span><br><span class="line">CameraCaptureSession.CaptureCallback captureCallback </span><br><span class="line">    = <span class="keyword">new</span> CameraCaptureSession.CaptureCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCaptureCompleted</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull CameraCaptureSession session, </span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull CaptureRequest request, </span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull TotalCaptureResult result)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//Log.d(TAG, "preview, onCaptureCompleted: ");</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line">mCameraCaptureSession.setRepeatingRequest(</span><br><span class="line">    previewRequestBuilder.build(), captureCallback, mBackHandler);</span><br></pre></td></tr></table></figure>

<p>给 <code>ImageReader</code> 创建拍照请求 <code>TEMPLATE_STILL_CAPTURE</code> ，使用后台线程处理回调：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">CaptureRequest.Builder captureRequestBuild = mCameraDevice</span><br><span class="line">    .createCaptureRequest(CameraDevice.TEMPLATE_STILL_CAPTURE);</span><br><span class="line">captureRequestBuild.addTarget(mImageReader.getSurface());</span><br><span class="line">captureRequestBuild.set(CaptureRequest.CONTROL_AF_MODE,</span><br><span class="line">    CaptureRequest.CONTROL_AF_MODE_CONTINUOUS_PICTURE);</span><br><span class="line">captureRequestBuild.set(CaptureRequest.JPEG_ORIENTATION, </span><br><span class="line">    mImageOrientation);</span><br><span class="line">CameraCaptureSession.CaptureCallback captureCallback = </span><br><span class="line">    <span class="keyword">new</span> CameraCaptureSession.CaptureCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCaptureCompleted</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull CameraCaptureSession session,</span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull CaptureRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull TotalCaptureResult result)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Log.d(TAG, "takePicture, onCaptureCompleted: ");</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line">mCameraCaptureSession.stopRepeating();</span><br><span class="line">mCameraCaptureSession.abortCaptures();</span><br><span class="line">mCameraCaptureSession.capture(captureRequestBuild.build(),</span><br><span class="line">    captureCallback, mBackHandler);</span><br></pre></td></tr></table></figure>

<p>给 <code>MediaRecorder</code> 创建录像请求 <code>TEMPLATE_RECORD</code> ，不处理回调：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CaptureRequest.Builder recordCaptureBuild = mCameraDevice</span><br><span class="line">    .createCaptureRequest(CameraDevice.TEMPLATE_RECORD);</span><br><span class="line">recordCaptureBuild.addTarget(mMediaRecorder.getSurface());</span><br><span class="line">recordCaptureBuild.set(CaptureRequest.CONTROL_MODE, </span><br><span class="line">    CameraMetadata.CONTROL_MODE_AUTO);</span><br><span class="line">mCameraCaptureSession.setRepeatingRequest(</span><br><span class="line">    recordCaptureBuild.build(), <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>

<h3 id="CameraCaptureSession-CaptureCallback-回调"><a href="#CameraCaptureSession-CaptureCallback-回调" class="headerlink" title="CameraCaptureSession.CaptureCallback 回调"></a><code>CameraCaptureSession.CaptureCallback</code> 回调</h3><p><code>CameraCaptureSession</code> 在请求预览、拍照、录像等功能时，出现的各种状态通过 <code>CameraCaptureSession.CaptureCallback</code> 回调来处理，回调是由 <code>HAL</code> 层发起向上传递的；回调接口中通常包含当前会话信息 <code>CameraCaptureSession</code> ，捕获请求 <code>CaptureRequest</code> ，捕获的结果 <code>CaptureResult</code> 等。    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraCaptureSession.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CaptureCallback</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NO_FRAMES_CAPTURED = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设备开始拍照时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCaptureStarted</span><span class="params">(@NonNull CameraCaptureSession session,</span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull CaptureRequest request, <span class="keyword">long</span> timestamp, </span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">long</span> frameNumber)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// default empty implementation</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回部分数据</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCapturePartial</span><span class="params">(CameraCaptureSession session,</span></span></span><br><span class="line"><span class="function"><span class="params">            CaptureRequest request, CaptureResult result)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// default empty implementation</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回部分数据时，表示正在捕获数据过程中</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCaptureProgressed</span><span class="params">(@NonNull CameraCaptureSession session,</span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull CaptureRequest request, </span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull CaptureResult partialResult)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// default empty implementation</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 数据捕获已经完成，回调最终总的结果集</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCaptureCompleted</span><span class="params">(@NonNull CameraCaptureSession session,</span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull CaptureRequest request, </span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull TotalCaptureResult result)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// default empty implementation</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 捕获失败</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCaptureFailed</span><span class="params">(@NonNull CameraCaptureSession session,</span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull CaptureRequest request, </span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull CaptureFailure failure)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// default empty implementation</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 所有捕获结果已经发送完毕</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCaptureSequenceCompleted</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull CameraCaptureSession session,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> sequenceId, <span class="keyword">long</span> frameNumber)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// default empty implementation</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 请求捕获被中止</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCaptureSequenceAborted</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull CameraCaptureSession session,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> sequenceId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// default empty implementation</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 捕获的 buffer 不能成功显示</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCaptureBufferLost</span><span class="params">(@NonNull CameraCaptureSession session,</span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull CaptureRequest request, </span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull Surface target, <span class="keyword">long</span> frameNumber)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// default empty implementation</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>API</code> 在发起请求 <code>CameraCaptureSession.setRepeatingRequest/capture</code> 时，用户会创建 <code>CaptureCallback</code> 的实例，这些接口都在 <code>CameraDeviceImpl</code> 中实现回调。  </p>
<ul>
<li><code>onCaptureStarted</code><br>该回调接口从 <code>HAL</code> 回调路径为：<code>CameraDeviceClient::notifyShutter -&gt; CameraDeviceImpl.onCaptureStarted -&gt; onCaptureStarted</code> 。  </li>
<li><code>onCapturePartial</code><br>该回调接口搜索整个 <code>framework</code> ，发现没有任何地方会回调它。  </li>
<li><code>onCaptureProgressed, onCaptureCompleted, onCaptureSequenceCompleted</code><br>三个接口都是在 <code>CameraDeviceImpl.onResultReceived</code> 中回调的。  </li>
<li><code>onCaptureSequenceAborted</code><br><code>CameraDeviceClient.cpp</code> 中的 <code>submitCaptureRequest, stopRepeating, flush</code> 这三个函数会回调该接口。  </li>
<li><code>onCaptureFailed, onCaptureBufferLost</code><br>从 <code>HAL</code> 回调路径为 <code>CameraDeviceClient::notifyError -&gt; CameraDeviceImpl.onDeviceError</code> ，而这两个接口在 <code>CameraDeviceImpl</code> 中的回调路径为 <code>onDeviceError -&gt; onCaptureErrorLocked -&gt; onCaptureFailed/onCaptureBufferLost</code> 。  </li>
</ul>
<h3 id="流程图-2"><a href="#流程图-2" class="headerlink" title="流程图"></a>流程图</h3><p><a href="https://upload-images.jianshu.io/upload_images/606437-bd30f964e26cced5.jpg" target="_blank" rel="noopener">创建捕获请求流程，查看原图</a>  </p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0109-android-camera-4-framework-CameraDevice_createCaptureRequest.jpg" alt="0109-android-camera-4-framework-CameraDevice_createCaptureRequest.jpg"></p>
<p>预览/拍照/录像流程基本一致，这里仅给出预览的流程图：<a href="https://upload-images.jianshu.io/upload_images/606437-869040c9408880d4.jpg" target="_blank" rel="noopener">预览流程，查看原图</a>  </p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0109-android-camera-4-framework-CameraCaptureSession_setRepeatingRequest.jpg" alt="0109-android-camera-4-framework-CameraCaptureSession_setRepeatingRequest.jpg"></p>
<h3 id="源码分析-3"><a href="#源码分析-3" class="headerlink" title="源码分析"></a>源码分析</h3><p>在分析预览、拍照、录像流程前，先回顾下打开设备 <code>openCamera</code> 时，做的一些初始化：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraDeviceClient.cpp</span></span><br><span class="line"><span class="keyword">status_t</span> CameraDeviceClient::initialize(sp&lt;CameraProviderManager&gt; manager) &#123;</span><br><span class="line">    <span class="keyword">return</span> initializeImpl(manager);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> TProviderPtr&gt;</span><br><span class="line"><span class="keyword">status_t</span> CameraDeviceClient::initializeImpl(TProviderPtr providerPtr) &#123;</span><br><span class="line">    ...</span><br><span class="line">    res = Camera2ClientBase::initialize(providerPtr);</span><br><span class="line">    <span class="keyword">if</span> (res != OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String8 threadName;</span><br><span class="line">    mFrameProcessor = <span class="keyword">new</span> FrameProcessorBase(mDevice);</span><br><span class="line">    threadName = String8::format(<span class="string">"CDU-%s-FrameProc"</span>, </span><br><span class="line">        mCameraIdStr.<span class="built_in">string</span>());</span><br><span class="line">    mFrameProcessor-&gt;run(threadName.<span class="built_in">string</span>());</span><br><span class="line"></span><br><span class="line">    mFrameProcessor-&gt;registerListener(FRAME_PROCESSOR_LISTENER_MIN_ID,</span><br><span class="line">                                      FRAME_PROCESSOR_LISTENER_MAX_ID,</span><br><span class="line">                                      <span class="comment">/*listener*/</span><span class="keyword">this</span>,</span><br><span class="line">                                      <span class="comment">/*sendPartials*/</span><span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>CameraDeviceClient::initializeImpl</code> 中，调用了 <code>Camera2ClientBase::initialize</code> 的初始化，以及实例化一个 <code>FrameProcessorBase</code> 对象；  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Camera2ClientBase.cpp</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TClientBase&gt;</span><br><span class="line"><span class="keyword">status_t</span> Camera2ClientBase&lt;TClientBase&gt;::initialize(</span><br><span class="line">        sp&lt;CameraProviderManager&gt; manager) &#123;</span><br><span class="line">    <span class="keyword">return</span> initializeImpl(manager);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TClientBase&gt;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TProviderPtr&gt;</span><br><span class="line"><span class="keyword">status_t</span> Camera2ClientBase&lt;TClientBase&gt;::initializeImpl(</span><br><span class="line">        TProviderPtr providerPtr) &#123;</span><br><span class="line">    ...</span><br><span class="line">    res = mDevice-&gt;initialize(providerPtr);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里 <code>Camera2ClientBase::initializeImpl</code> 中主要是调用了 <code>Camera3Device::initialize</code> 函数，下面只关心和捕获请求有关的代码：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Camera3Device.cpp</span></span><br><span class="line"><span class="keyword">status_t</span> Camera3Device::initialize(sp&lt;CameraProviderManager&gt; manager) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> initializeCommonLocked();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> Camera3Device::initializeCommonLocked() &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/** Start up request queue thread */</span></span><br><span class="line">    mRequestThread = <span class="keyword">new</span> RequestThread(<span class="keyword">this</span>, mStatusTracker, mInterface);</span><br><span class="line">    res = mRequestThread-&gt;run(</span><br><span class="line">        String8::format(<span class="string">"C3Dev-%s-ReqQueue"</span>, mId.<span class="built_in">string</span>()).<span class="built_in">string</span>());</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>Camera3Device::initializeCommonLocked</code> 中实例化了 <code>RequestThread</code> 对象。至此，捕获流程中的发起请求的对象 <code>RequestThread</code> 和响应回调的对象 <code>FrameProcessorBase</code> 都实例化完毕，并开始运行。他们两个都继承的是线程，参看 <code>system</code> 目录下的 <code>Thread.h/Threads.cpp</code> 源码，可以看到 <code>threadLoop</code> 是在一个 <code>while</code> 中被循环调用的。当 <code>threadLoop</code> 返回 <code>true</code> 时就会不停的循环；返回 <code>false</code> 时会退出循环：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Threads.cpp</span></span><br><span class="line"><span class="keyword">int</span> Thread::_threadLoop(<span class="keyword">void</span>* user)</span><br><span class="line">&#123;</span><br><span class="line">    Thread* <span class="keyword">const</span> self = <span class="keyword">static_cast</span>&lt;Thread*&gt;(user);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">bool</span> first = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">bool</span> result;</span><br><span class="line">        <span class="keyword">if</span> (first) &#123;</span><br><span class="line">            first = <span class="literal">false</span>;</span><br><span class="line">            self-&gt;mStatus = self-&gt;readyToRun();</span><br><span class="line">            result = (self-&gt;mStatus == NO_ERROR);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (result &amp;&amp; !self-&gt;exitPending()) &#123;</span><br><span class="line">                result = self-&gt;threadLoop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result = self-&gt;threadLoop();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="literal">false</span> || self-&gt;mExitPending) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">while</span>(strong != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先来看发送捕获请求的线程 <code>RequestThread</code> ：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Camera3Device.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestThread</span> :</span> <span class="keyword">public</span> Thread &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">protected</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">threadLoop</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Used to prepare a batch of requests.</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">NextRequest</span> &#123;</span></span><br><span class="line">        sp&lt;CaptureRequest&gt;              captureRequest;</span><br><span class="line">        <span class="keyword">camera3_capture_request_t</span>       halRequest;</span><br><span class="line">        Vector&lt;<span class="keyword">camera3_stream_buffer_t</span>&gt; outputBuffers;</span><br><span class="line">        <span class="keyword">bool</span>                            submitted;</span><br><span class="line">    &#125;;</span><br><span class="line">    Vector&lt;NextRequest&gt; mNextRequests;</span><br><span class="line">    ...</span><br><span class="line">    Condition          mRequestSignal;</span><br><span class="line">    RequestList        mRequestQueue;</span><br><span class="line">    RequestList        mRepeatingRequests;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里只关注 <code>RequestThread</code> 类中几个关键函数和变量，<code>NextRequest</code> 结构体包含了请求信息，逐个向 <code>HAL</code> 发送这些信息；类中定义了多个条件变量，重点关注 <code>mRequestSignal</code> 条件变量， <code>threadLoop</code> 运行时，会通过 <code>mRequestSignal.waitRelative</code> 阻塞等待 50 ms；直到等到捕获请求后 <code>mRequestSignal.signal</code> 发出通知，<code>threadLoop</code> 继续运行。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">// Camera3Device.cpp</span><br><span class="line">bool Camera3Device::RequestThread::threadLoop() &#123;</span><br><span class="line">    ...</span><br><span class="line">    status_t res;</span><br><span class="line"></span><br><span class="line">    // Handle paused state.</span><br><span class="line">    if (waitIfPaused()) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Wait for the next batch of requests.</span><br><span class="line">    waitForNextRequestBatch();</span><br><span class="line">    if (mNextRequests.size() == 0) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    // Prepare a batch of HAL requests and output buffers.</span><br><span class="line">    res = prepareHalRequests();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void Camera3Device::RequestThread::waitForNextRequestBatch() &#123;</span><br><span class="line">    ...</span><br><span class="line">    NextRequest nextRequest;</span><br><span class="line">    nextRequest.captureRequest = waitForNextRequestLocked();</span><br><span class="line">    if (nextRequest.captureRequest == nullptr) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sp&lt;Camera3Device::CaptureRequest&gt;</span><br><span class="line">        Camera3Device::RequestThread::waitForNextRequestLocked() &#123;</span><br><span class="line">    status_t res;</span><br><span class="line">    sp&lt;CaptureRequest&gt; nextRequest;</span><br><span class="line"></span><br><span class="line">    while (mRequestQueue.empty()) &#123;</span><br><span class="line">        if (!mRepeatingRequests.empty()) &#123;</span><br><span class="line">            const RequestList &amp;requests = mRepeatingRequests;</span><br><span class="line">            RequestList::const_iterator firstRequest =</span><br><span class="line">                    requests.begin();</span><br><span class="line">            nextRequest = *firstRequest;</span><br><span class="line">            mRequestQueue.insert(mRequestQueue.end(),</span><br><span class="line">                    ++firstRequest,</span><br><span class="line">                    requests.end());</span><br><span class="line"></span><br><span class="line">            mRepeatingLastFrameNumber = mFrameNumber+requests.size()-1;</span><br><span class="line"></span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        // 条件变量 mRequestSignal 阻塞等待 kRequestTimeout </span><br><span class="line">        res = mRequestSignal.waitRelative(mRequestLock, kRequestTimeout);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>RequestThread</code> 在没有捕获请求时，会循环调用 <code>threadLoop</code> ，并阻塞等待 <code>mRequestSignal</code> 的通知。再看响应回调的线程 <code>FrameProcessorBase</code> ：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FrameProcessorBase.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FrameProcessorBase</span>:</span> <span class="keyword">public</span> Thread &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">FilteredListener</span>:</span> <span class="keyword">virtual</span> <span class="keyword">public</span> RefBase &#123;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onResultAvailable</span><span class="params">(<span class="keyword">const</span> CaptureResult &amp;result)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">  <span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">nsecs_t</span> kWaitDuration = <span class="number">10000000</span>; <span class="comment">// 10 ms</span></span><br><span class="line">    wp&lt;CameraDeviceBase&gt; mDevice;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">threadLoop</span><span class="params">()</span></span>;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FrameProcessorBase.cpp</span></span><br><span class="line"><span class="keyword">bool</span> FrameProcessorBase::threadLoop() &#123;</span><br><span class="line">    <span class="keyword">status_t</span> res;</span><br><span class="line"></span><br><span class="line">    sp&lt;CameraDeviceBase&gt; device;</span><br><span class="line">    &#123;</span><br><span class="line">        device = mDevice.promote();</span><br><span class="line">        <span class="keyword">if</span> (device == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    res = device-&gt;waitForNextFrame(kWaitDuration);</span><br><span class="line">    <span class="keyword">if</span> (res == OK) &#123;</span><br><span class="line">        processNewFrames(device);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res != TIMED_OUT) &#123;</span><br><span class="line">        ALOGE(...);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>FrameProcessorBase::threadLoop</code> 代码非常简单，<code>device-&gt;waitForNextFrame</code> 阻塞等待 10ms ，这里 <code>CameraDeviceBase</code> 实际类型为 <code>Camera3Device</code> ：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Camera3Device.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Camera3Device</span> :</span></span><br><span class="line">    <span class="keyword">public</span> CameraDeviceBase,</span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">public</span> hardware::camera::device::V3_2::ICameraDeviceCallback,</span><br><span class="line">    <span class="keyword">private</span> camera3_callback_ops &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        List&lt;CaptureResult&gt;   mResultQueue;</span><br><span class="line">        Condition              mResultSignal;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Camera3Device.cpp</span></span><br><span class="line"><span class="keyword">status_t</span> Camera3Device::waitForNextFrame(<span class="keyword">nsecs_t</span> timeout) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">while</span> (mResultQueue.empty()) &#123;</span><br><span class="line">        res = mResultSignal.waitRelative(mOutputLock, timeout);</span><br><span class="line">        <span class="keyword">if</span> (res == TIMED_OUT) &#123;</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res != OK) &#123;</span><br><span class="line">            ALOGW(...);</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Camera3Device::waitForNextFrame</code> 代码也很简单，调用条件变量 <code>mResultSignal.waitRelative</code> 实现阻塞等待 10 ms。<br>至此初始化过程中，捕获请求线程 <code>RequestThread</code> 循环执行 <code>threadLoop</code> ，并会阻塞等待 <code>mRequestSignal</code> 的通知；回调响应线程 <code>FrameProcessorBase</code> 循环执行 <code>threadLoop</code> ，并会阻塞等待 <code>mResultSignal</code> 的通知。  </p>
<p>当用户调用 <code>API</code> 创建捕获请求时，<code>mRequestSignal</code> 会发出通知；因为预览、拍照、录像流程基本一样，一起分析：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraCaptureSessionImpl.java</span></span><br><span class="line"><span class="comment">// 预览和录像</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">setRepeatingRequest</span><span class="params">(CaptureRequest request, </span></span></span><br><span class="line"><span class="function"><span class="params">        CaptureCallback callback,</span></span></span><br><span class="line"><span class="function"><span class="params">        Handler handler)</span> </span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">synchronized</span> (mDeviceImpl.mInterfaceLock) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> addPendingSequence(mDeviceImpl.setRepeatingRequest(</span><br><span class="line">            request,</span><br><span class="line">            createCaptureCallbackProxy(handler, callback), </span><br><span class="line">            mDeviceHandler));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拍照</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">capture</span><span class="params">(CaptureRequest request, CaptureCallback callback,</span></span></span><br><span class="line"><span class="function"><span class="params">        Handler handler)</span> <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">synchronized</span> (mDeviceImpl.mInterfaceLock) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> addPendingSequence(mDeviceImpl.capture(request,</span><br><span class="line">                createCaptureCallbackProxy(handler, callback), </span><br><span class="line">                mDeviceHandler));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>createCaptureCallbackProxy</code> 创建了一个回调动态代理，通过 <code>CameraDeviceImpl.setRepeatingRequest/capture</code> 下发预览或者拍照的捕获请求：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraDeviceImpl.java</span></span><br><span class="line"><span class="comment">// 预览和录像</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">setRepeatingRequest</span><span class="params">(CaptureRequest request, </span></span></span><br><span class="line"><span class="function"><span class="params">        CaptureCallback callback,</span></span></span><br><span class="line"><span class="function"><span class="params">        Handler handler)</span> <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line">    List&lt;CaptureRequest&gt; requestList = <span class="keyword">new</span> ArrayList&lt;CaptureRequest&gt;();</span><br><span class="line">    requestList.add(request);</span><br><span class="line">    <span class="keyword">return</span> submitCaptureRequest(requestList, callback, </span><br><span class="line">        handler, <span class="comment">/*streaming*/</span><span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 拍照</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">capture</span><span class="params">(CaptureRequest request, CaptureCallback callback, </span></span></span><br><span class="line"><span class="function"><span class="params">        Handler handler)</span> <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line">    List&lt;CaptureRequest&gt; requestList = <span class="keyword">new</span> ArrayList&lt;CaptureRequest&gt;();</span><br><span class="line">    requestList.add(request);</span><br><span class="line">    <span class="keyword">return</span> submitCaptureRequest(requestList, callback, </span><br><span class="line">        handler, <span class="comment">/*streaming*/</span><span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">submitCaptureRequest</span><span class="params">(List&lt;CaptureRequest&gt; requestList, </span></span></span><br><span class="line"><span class="function"><span class="params">        CaptureCallback callback,</span></span></span><br><span class="line"><span class="function"><span class="params">        Handler handler, <span class="keyword">boolean</span> repeating)</span> </span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">synchronized</span>(mInterfaceLock) &#123;</span><br><span class="line">        checkIfCameraClosedOrInError();</span><br><span class="line">        <span class="keyword">if</span> (repeating) &#123;</span><br><span class="line">            stopRepeating();</span><br><span class="line">        &#125;</span><br><span class="line">        SubmitInfo requestInfo;</span><br><span class="line">        CaptureRequest[] requestArray = requestList.toArray(</span><br><span class="line">            <span class="keyword">new</span> CaptureRequest[requestList.size()]);</span><br><span class="line">        requestInfo = mRemoteDevice.submitRequestList(requestArray,</span><br><span class="line">            repeating);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mCaptureCallbackMap.put(requestInfo.getRequestId(),</span><br><span class="line">                    <span class="keyword">new</span> CaptureCallbackHolder(</span><br><span class="line">                        callback, requestList, handler, </span><br><span class="line">                        repeating, mNextSessionId - <span class="number">1</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (repeating) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mRepeatingRequestId != REQUEST_ID_NONE) &#123;</span><br><span class="line">                checkEarlyTriggerSequenceComplete(mRepeatingRequestId,</span><br><span class="line">                        requestInfo.getLastFrameNumber());</span><br><span class="line">            &#125;</span><br><span class="line">            mRepeatingRequestId = requestInfo.getRequestId();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mRequestLastFrameNumbersList.add(</span><br><span class="line">                <span class="keyword">new</span> RequestLastFrameNumbersHolder(requestList,</span><br><span class="line">                    requestInfo));</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从代码流程来看，预览和录像使用同一个接口；预览和拍照的主要区别是 <code>repeating</code> 的值；当为 <code>true</code> 时，表示预览/录像；当为 <code>false</code> 时，表示为拍照。通过 <code>ICameraDeviceUser.submitRequestList</code> 向下发送请求：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraDeviceClient.cpp</span></span><br><span class="line">binder::Status CameraDeviceClient::submitRequestList(</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;hardware::camera2::CaptureRequest&gt;&amp; requests,</span><br><span class="line">        <span class="keyword">bool</span> streaming,</span><br><span class="line">        <span class="comment">/*out*/</span></span><br><span class="line">        hardware::camera2::utils::SubmitInfo *submitInfo) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (streaming) &#123;</span><br><span class="line">        err = mDevice-&gt;setStreamingRequestList(metadataRequestList, </span><br><span class="line">                surfaceMapList, &amp;(submitInfo-&gt;mLastFrameNumber));</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        err = mDevice-&gt;captureList(metadataRequestList, surfaceMapList,</span><br><span class="line">                &amp;(submitInfo-&gt;mLastFrameNumber));</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果是预览/录像，则调用 <code>Camera3Device-&gt;setStreamingRequestList</code> ；如果是拍照，则调用 <code>Camera3Device-&gt;captureList</code> ：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Camera3Device.cpp</span></span><br><span class="line"><span class="comment">// 预览和录像</span></span><br><span class="line"><span class="keyword">status_t</span> Camera3Device::setStreamingRequestList(</span><br><span class="line">        <span class="keyword">const</span> List&lt;<span class="keyword">const</span> CameraMetadata&gt; &amp;requests,</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">list</span>&lt;<span class="keyword">const</span> SurfaceMap&gt; &amp;surfaceMaps,</span><br><span class="line">        <span class="keyword">int64_t</span> *lastFrameNumber) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> submitRequestsHelper(requests, surfaceMaps, </span><br><span class="line">        <span class="comment">/*repeating*/</span><span class="literal">true</span>, lastFrameNumber);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 拍照</span></span><br><span class="line"><span class="keyword">status_t</span> Camera3Device::captureList(</span><br><span class="line">        <span class="keyword">const</span> List&lt;<span class="keyword">const</span> CameraMetadata&gt; &amp;requests,</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">list</span>&lt;<span class="keyword">const</span> SurfaceMap&gt; &amp;surfaceMaps,</span><br><span class="line">        <span class="keyword">int64_t</span> *lastFrameNumber) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> submitRequestsHelper(requests, surfaceMaps, </span><br><span class="line">        <span class="comment">/*repeating*/</span><span class="literal">false</span>, lastFrameNumber);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> Camera3Device::submitRequestsHelper(</span><br><span class="line">        <span class="keyword">const</span> List&lt;<span class="keyword">const</span> CameraMetadata&gt; &amp;requests,</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">list</span>&lt;<span class="keyword">const</span> SurfaceMap&gt; &amp;surfaceMaps,</span><br><span class="line">        <span class="keyword">bool</span> repeating, <span class="comment">/*out*/</span> <span class="keyword">int64_t</span> *lastFrameNumber) &#123;</span><br><span class="line">    ...</span><br><span class="line">    RequestList requestList;</span><br><span class="line">    res = convertMetadataListToRequestListLocked(requests, surfaceMaps,</span><br><span class="line">            repeating, <span class="comment">/*out*/</span>&amp;requestList);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (repeating) &#123;</span><br><span class="line">        res = mRequestThread-&gt;setRepeatingRequests(requestList,</span><br><span class="line">            lastFrameNumber);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res = mRequestThread-&gt;queueRequestList(requestList,</span><br><span class="line">            lastFrameNumber);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样，预览/录像和拍照请求在 <code>Camera3Device</code> 中的区别也主要是 <code>repeating</code> 的值，都会调用 <code>Camera3Device::submitRequestsHelper</code> ，并通过 <code>RequestThread</code> 发起捕获请求；当预览/录像时，调用 <code>setRepeatingRequests</code> ；当拍照时，调用 <code>queueRequestList</code> ：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Camera3Device.cpp</span></span><br><span class="line"><span class="comment">// 预览和录像</span></span><br><span class="line"><span class="keyword">status_t</span> Camera3Device::RequestThread::setRepeatingRequests(</span><br><span class="line">        <span class="keyword">const</span> RequestList &amp;requests,</span><br><span class="line">        <span class="comment">/*out*/</span></span><br><span class="line">        <span class="keyword">int64_t</span> *lastFrameNumber) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (lastFrameNumber != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *lastFrameNumber = mRepeatingLastFrameNumber;</span><br><span class="line">    &#125;</span><br><span class="line">    mRepeatingRequests.clear();</span><br><span class="line">    mRepeatingRequests.insert(mRepeatingRequests.begin(),</span><br><span class="line">            requests.begin(), requests.end());</span><br><span class="line"></span><br><span class="line">    unpauseForNewRequests();</span><br><span class="line"></span><br><span class="line">    mRepeatingLastFrameNumber = </span><br><span class="line">        ...ICameraDeviceUser::NO_IN_FLIGHT_REPEATING_FRAMES;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 拍照</span></span><br><span class="line"><span class="keyword">status_t</span> Camera3Device::RequestThread::queueRequestList(</span><br><span class="line">        List&lt;sp&lt;CaptureRequest&gt; &gt; &amp;requests,</span><br><span class="line">        <span class="comment">/*out*/</span></span><br><span class="line">        <span class="keyword">int64_t</span> *lastFrameNumber) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (List&lt;sp&lt;CaptureRequest&gt; &gt;::iterator it = requests.begin();</span><br><span class="line">        it != requests.end(); ++it) &#123;</span><br><span class="line">        mRequestQueue.push_back(*it);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (lastFrameNumber != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *lastFrameNumber = mFrameNumber + mRequestQueue.size() - <span class="number">1</span>;</span><br><span class="line">        ALOGV(...);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    unpauseForNewRequests();</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Camera3Device::RequestThread::unpauseForNewRequests() &#123;</span><br><span class="line">    ...</span><br><span class="line">    mRequestSignal.signal();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>预览/录像时会将捕获请求存入 <code>mRepeatingRequests</code> 列表中；拍照时会将捕获请求存入 <code>mRequestQueue</code> 列表中；它们最终都会调用 <code>unpauseForNewRequests</code> ，而该函数的核心功能就是通过 <code>mRequestSignal.signal</code> 发出消息，通知在开启设备初始化过程中 <code>waitForNextRequestLocked</code> 的阻塞等待。我们重新进入 <code>RequestThread::threadLoop</code> 中，继续向下分析：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Camera3Device.cpp</span></span><br><span class="line"><span class="keyword">bool</span> Camera3Device::RequestThread::threadLoop() &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">status_t</span> res;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Wait for the next batch of requests.</span></span><br><span class="line">    <span class="comment">// 阻塞等待</span></span><br><span class="line">    waitForNextRequestBatch();</span><br><span class="line">    <span class="keyword">if</span> (mNextRequests.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">bool</span> submitRequestSuccess = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">nsecs_t</span> tRequestStart = systemTime(SYSTEM_TIME_MONOTONIC);</span><br><span class="line">    <span class="keyword">if</span> (mInterface-&gt;supportBatchRequest()) &#123;</span><br><span class="line">        submitRequestSuccess = sendRequestsBatch();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        submitRequestSuccess = sendRequestsOneByOne();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> submitRequestSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> Camera3Device::RequestThread::sendRequestsBatch() &#123;</span><br><span class="line">    <span class="keyword">status_t</span> res;</span><br><span class="line">    <span class="keyword">size_t</span> batchSize = mNextRequests.size();</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">camera3_capture_request_t</span>*&gt; requests(batchSize);</span><br><span class="line">    <span class="keyword">uint32_t</span> numRequestProcessed = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; batchSize; i++) &#123;</span><br><span class="line">        requests[i] = &amp;mNextRequests.editItemAt(i).halRequest;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    res = mInterface-&gt;processBatchCaptureRequests(requests, </span><br><span class="line">        &amp;numRequestProcessed);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> Camera3Device::HalInterface::processBatchCaptureRequests(</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">camera3_capture_request_t</span>*&gt;&amp; requests,</span><br><span class="line">        <span class="comment">/*out*/</span><span class="keyword">uint32_t</span>* numRequestProcessed) &#123;</span><br><span class="line">    ...</span><br><span class="line">    hardware::hidl_vec&lt;device::V3_2::CaptureRequest&gt; captureRequests;</span><br><span class="line">    <span class="keyword">size_t</span> batchSize = requests.size();</span><br><span class="line">    captureRequests.resize(batchSize);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">auto</span> err = mHidlSession-&gt;processCaptureRequest(captureRequests, </span><br><span class="line">            cachesToRemove,</span><br><span class="line">            [&amp;status, &amp;numRequestProcessed] (<span class="keyword">auto</span> s, <span class="keyword">uint32_t</span> n) &#123;</span><br><span class="line">                status = s;</span><br><span class="line">                *numRequestProcessed = n;</span><br><span class="line">            &#125;);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> CameraProviderManager::mapToStatusT(status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当 <code>waitForNextRequestBatch</code> 拿到请求通知后，会将捕获请求存入 <code>mNextRequests</code> 中，当前平台支持批量请求处理，<code>sendRequestsBatch -&gt; processBatchCaptureRequests</code> 流程，向 <code>HAL</code> 层发送捕获请求 <code>mHidlSession-&gt;processCaptureRequest</code> ，至此捕获请求从 <code>API</code> 发送到 <code>HAL</code> 整个流程全部分析完毕。  </p>
<p>当 <code>HAL</code> 拿到捕获的结果后，会从 <code>ICameraDeviceSession.processCaptureResult</code> 回调到 <code>Framework</code> 层：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Camera3Device.cpp</span></span><br><span class="line">hardware::Return&lt;<span class="keyword">void</span>&gt; Camera3Device::processCaptureResult(</span><br><span class="line">    <span class="keyword">const</span> hardware::hidl_vec&lt;</span><br><span class="line">            hardware::camera::device::V3_2::CaptureResult&gt;&amp; results) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; result : results) &#123;</span><br><span class="line">        processOneCaptureResultLocked(result);</span><br><span class="line">    &#125;</span><br><span class="line">    mProcessCaptureResultLock.unlock();</span><br><span class="line">    <span class="keyword">return</span> hardware::Void();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Camera3Device::processOneCaptureResultLocked(</span><br><span class="line">        <span class="keyword">const</span> hardware::camera::device::V3_2::CaptureResult&amp; result) &#123;</span><br><span class="line">    camera3_capture_result r;</span><br><span class="line">    ...</span><br><span class="line">    processCaptureResult(&amp;r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Camera3Device::processCaptureResult(</span><br><span class="line">        <span class="keyword">const</span> camera3_capture_result *result) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (result-&gt;partial_result != <span class="number">0</span>)</span><br><span class="line">        request.resultExtras.partialResultCount = result-&gt;partial_result;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if this result carries only partial metadata</span></span><br><span class="line">    <span class="keyword">if</span> (mUsePartialResult &amp;&amp; result-&gt;result != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (isPartialResult &amp;&amp; request.hasCallback) &#123;</span><br><span class="line">            <span class="comment">// Send partial capture result</span></span><br><span class="line">            sendPartialCaptureResult(result-&gt;result, request.resultExtras,</span><br><span class="line">                    frameNumber);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (result-&gt;result != <span class="literal">NULL</span> &amp;&amp; !isPartialResult) &#123;</span><br><span class="line">        <span class="keyword">if</span> (shutterTimestamp == <span class="number">0</span>) &#123;</span><br><span class="line">            request.pendingMetadata = result-&gt;result;</span><br><span class="line">            request.collectedPartialResult = collectedPartialResult;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (request.hasCallback) &#123;</span><br><span class="line">            CameraMetadata metadata;</span><br><span class="line">            metadata = result-&gt;result;</span><br><span class="line">            sendCaptureResult(metadata, request.resultExtras,</span><br><span class="line">                collectedPartialResult, frameNumber,</span><br><span class="line">                hasInputBufferInRequest);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Camera3Device::sendPartialCaptureResult(</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">camera_metadata_t</span> * partialResult,</span><br><span class="line">        <span class="keyword">const</span> CaptureResultExtras &amp;resultExtras, <span class="keyword">uint32_t</span> frameNumber) &#123;</span><br><span class="line">    ...</span><br><span class="line">    CaptureResult captureResult;</span><br><span class="line">    captureResult.mResultExtras = resultExtras;</span><br><span class="line">    captureResult.mMetadata = partialResult;</span><br><span class="line">    insertResultLocked(&amp;captureResult, frameNumber);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Camera3Device::sendCaptureResult(CameraMetadata &amp;pendingMetadata,</span><br><span class="line">        CaptureResultExtras &amp;resultExtras,</span><br><span class="line">        CameraMetadata &amp;collectedPartialResult,</span><br><span class="line">        <span class="keyword">uint32_t</span> frameNumber,</span><br><span class="line">        <span class="keyword">bool</span> reprocess) &#123;</span><br><span class="line">    ...</span><br><span class="line">    CaptureResult captureResult;</span><br><span class="line">    captureResult.mResultExtras = resultExtras;</span><br><span class="line">    captureResult.mMetadata = pendingMetadata;</span><br><span class="line">    ...</span><br><span class="line">    insertResultLocked(&amp;captureResult, frameNumber);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Camera3Device::insertResultLocked(CaptureResult *result,</span><br><span class="line">        <span class="keyword">uint32_t</span> frameNumber) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">camera_metadata_t</span> *meta = <span class="keyword">const_cast</span>&lt;<span class="keyword">camera_metadata_t</span> *&gt;(</span><br><span class="line">            result-&gt;mMetadata.getAndLock());</span><br><span class="line">    set_camera_metadata_vendor_id(meta, mVendorTagId);</span><br><span class="line">    result-&gt;mMetadata.unlock(meta);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Valid result, insert into queue</span></span><br><span class="line">    List&lt;CaptureResult&gt;::iterator queuedResult =</span><br><span class="line">            mResultQueue.insert(mResultQueue.end(), </span><br><span class="line">                CaptureResult(*result));</span><br><span class="line">    ...</span><br><span class="line">    mResultSignal.signal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从代码流程来看，从 <code>HAL</code> 传过来的捕获结果，不管是发回部分结果 <code>sendPartialCaptureResult</code> 还是最终结果 <code>sendCaptureResult</code> ，最终都会调用 <code>insertResultLocked</code> ，它的主要功能就是将捕获结果放入 <code>mResultQueue</code> 队列，并由 <code>mResultSignal.signal</code> 发出消息，通知在开启设备初始化过程中 <code>waitForNextFrame</code> 的阻塞等待。一旦 <code>FrameProcessorBase::threadLoop</code> 获取到捕获结果后，逐个处理：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FrameProcessorBase.cpp</span></span><br><span class="line"><span class="keyword">void</span> FrameProcessorBase::processNewFrames(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;CameraDeviceBase&gt; &amp;device) &#123;</span><br><span class="line">    <span class="keyword">status_t</span> res;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">while</span> ( (res = device-&gt;getNextResult(&amp;result)) == OK) &#123;</span><br><span class="line">        <span class="keyword">camera_metadata_entry_t</span> entry;</span><br><span class="line">        entry = result.mMetadata.find(ANDROID_REQUEST_FRAME_COUNT);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (!processSingleFrame(result, device)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> FrameProcessorBase::processSingleFrame(CaptureResult &amp;result,</span><br><span class="line">         <span class="keyword">const</span> sp&lt;CameraDeviceBase&gt; &amp;device) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> processListeners(result, device) == OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> FrameProcessorBase::processListeners(</span><br><span class="line">        <span class="keyword">const</span> CaptureResult &amp;result,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;CameraDeviceBase&gt; &amp;device) &#123;</span><br><span class="line">    ...</span><br><span class="line">    List&lt;sp&lt;FilteredListener&gt; &gt;::iterator item = listeners.begin();</span><br><span class="line">    <span class="keyword">for</span> (; item != listeners.end(); item++) &#123;</span><br><span class="line">        (*item)-&gt;onResultAvailable(result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代理流程可以看出，逐个取出 <code>CaptureResult</code> 并处理，最终调用 <code>CameraDeviceClient::onResultAvailable</code> 向 <code>API</code> 发送捕获结果：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraDeviceClient.cpp</span></span><br><span class="line"><span class="keyword">void</span> CameraDeviceClient::onResultAvailable(<span class="keyword">const</span> CaptureResult&amp; result) &#123;</span><br><span class="line">    ...</span><br><span class="line">    sp&lt;hardware::camera2::ICameraDeviceCallbacks&gt; remoteCb </span><br><span class="line">        = mRemoteCallback;</span><br><span class="line">    <span class="keyword">if</span> (remoteCb != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        remoteCb-&gt;onResultReceived(result.mMetadata, </span><br><span class="line">            result.mResultExtras);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而 <code>API</code> 中的回调是在 <code>CameraDeviceImpl.java</code> 中实现的：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraDeviceImpl.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResultReceived</span><span class="params">(CameraMetadataNative result,</span></span></span><br><span class="line"><span class="function"><span class="params">        CaptureResultExtras resultExtras)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> requestId = resultExtras.getRequestId();</span><br><span class="line">    <span class="keyword">long</span> frameNumber = resultExtras.getFrameNumber();</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">synchronized</span>(mInterfaceLock) &#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">final</span> CaptureCallbackHolder holder =</span><br><span class="line">              CameraDeviceImpl.<span class="keyword">this</span>.mCaptureCallbackMap.get(requestId);</span><br><span class="line">      <span class="keyword">final</span> CaptureRequest request = </span><br><span class="line">          holder.getRequest(resultExtras.getSubsequenceId());</span><br><span class="line">      <span class="keyword">boolean</span> isPartialResult = (resultExtras.getPartialResultCount() </span><br><span class="line">              &lt; mTotalPartialCount);</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">if</span> (isPartialResult) &#123;</span><br><span class="line">        <span class="keyword">final</span> CaptureResult resultAsCapture =</span><br><span class="line">                <span class="keyword">new</span> CaptureResult(result, request, resultExtras);</span><br><span class="line">        <span class="comment">// Partial result</span></span><br><span class="line">        resultDispatch = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (!CameraDeviceImpl.<span class="keyword">this</span>.isClosed()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (holder.hasBatchedOutputs()) &#123;</span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; holder.getRequestCount(); i++) &#123;</span><br><span class="line">                CameraMetadataNative resultLocal =</span><br><span class="line">                        <span class="keyword">new</span> CameraMetadataNative(resultCopy);</span><br><span class="line">                CaptureResult resultInBatch = <span class="keyword">new</span> CaptureResult(</span><br><span class="line">                    resultLocal, holder.getRequest(i), resultExtras);</span><br><span class="line"></span><br><span class="line">                holder.getCallback().onCaptureProgressed(</span><br><span class="line">                    CameraDeviceImpl.<span class="keyword">this</span>,</span><br><span class="line">                    holder.getRequest(i),</span><br><span class="line">                    resultInBatch);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              holder.getCallback().onCaptureProgressed(</span><br><span class="line">                  CameraDeviceImpl.<span class="keyword">this</span>,</span><br><span class="line">                  request,</span><br><span class="line">                  resultAsCapture);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        finalResult = resultAsCapture;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        List&lt;CaptureResult&gt; partialResults =</span><br><span class="line">                mFrameNumberTracker.popPartialResults(frameNumber);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> TotalCaptureResult resultAsCapture = </span><br><span class="line">                <span class="keyword">new</span> TotalCaptureResult(result, request, resultExtras,</span><br><span class="line">                partialResults, holder.getSessionId());</span><br><span class="line">        <span class="comment">// Final capture result</span></span><br><span class="line">        resultDispatch = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (!CameraDeviceImpl.<span class="keyword">this</span>.isClosed())&#123;</span><br><span class="line">            <span class="keyword">if</span> (holder.hasBatchedOutputs()) &#123;</span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; holder.getRequestCount(); i++) &#123;</span><br><span class="line">                ...</span><br><span class="line">                TotalCaptureResult resultInBatch = <span class="keyword">new</span> TotalCaptureResult(</span><br><span class="line">                    resultLocal, holder.getRequest(i), resultExtras,</span><br><span class="line">                    partialResults, holder.getSessionId());</span><br><span class="line"></span><br><span class="line">                holder.getCallback().onCaptureCompleted(</span><br><span class="line">                    CameraDeviceImpl.<span class="keyword">this</span>,</span><br><span class="line">                    holder.getRequest(i),</span><br><span class="line">                    resultInBatch);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              holder.getCallback().onCaptureCompleted(</span><br><span class="line">                  CameraDeviceImpl.<span class="keyword">this</span>,</span><br><span class="line">                  request,</span><br><span class="line">                  resultAsCapture);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        finalResult = resultAsCapture;</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">// Fire onCaptureSequenceCompleted</span></span><br><span class="line">      <span class="keyword">if</span> (!isPartialResult) &#123;</span><br><span class="line">          checkAndFireSequenceComplete();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>CameraDeviceImpl</code> 中处理 <code>CameraCaptureSession.CaptureCallback</code> 各回调结果：如果返回的是部分结果，则回调 <code>onCaptureProgressed</code> ；如果返回最终结果，则回调 <code>onCaptureCompleted</code> 。整个预览、拍照、录像流程及回调分析完毕。    </p>
<h3 id="小结-3"><a href="#小结-3" class="headerlink" title="小结"></a>小结</h3><ul>
<li><code>Camera3Device::RequestThread</code><br>这个类主要是处理预览、拍照、录像的请求 <code>CaptureRequest</code> 。  </li>
<li><code>FrameProcessorBase.cpp</code><br>这个类主要是处理请求后的回调函数，回调中会包含捕获的结果 <code>CaptureResult</code> 。  </li>
<li><code>Condition</code><br>不管是请求还是结果回调，因为是多线程处理，都涉及到条件变量的阻塞等待和通知机制。  </li>
<li><code>CameraDeviceSession.CaptureCallback</code><br>该回调接口都是在 <code>CameraDeviceImpl</code> 中实现的。  </li>
</ul>
<h3 id="三者异同"><a href="#三者异同" class="headerlink" title="三者异同"></a>三者异同</h3><p>预览、拍照、录像三者的流程基本一致，它们之间有如下异同：  </p>
<ul>
<li>预览<br>捕获请求模板为 <code>CameraDevice.TEMPLATE_PREVIEW</code> ；<code>API</code> 接口为 <code>CameraCaptureSession.setRepeatingRequest</code> ；<code>repeating</code> 值为 <code>true</code> 。  </li>
<li>拍照<br>捕获请求模板为 <code>CameraDevice.TEMPLATE_STILL_CAPTURE</code> ；<code>API</code> 接口为 <code>CameraCaptureSession.Capture</code> ；<code>repeating</code> 值为 <code>false</code> 。  </li>
<li>录像<br>捕获请求模板为 <code>CameraDevice.TEMPLATE_RECORD</code> ；<code>API</code> 接口为 <code>CameraCaptureSession.setRepeatingRequest</code> ；<code>repeating</code> 值为 <code>true</code> 。  </li>
</ul>
<p>也就是说，预览和录像仅仅是捕获请求模板不一样；而预览和拍照不管是模板，接口，<code>repeating</code> 值都不一样；但是它们三者最终在 <code>Framework</code> 中代码流程基本一致。  </p>
<h2 id="CameraServiceProxy-注册服务"><a href="#CameraServiceProxy-注册服务" class="headerlink" title="CameraServiceProxy 注册服务"></a><code>CameraServiceProxy</code> 注册服务</h2><h3 id="AIDL"><a href="#AIDL" class="headerlink" title="AIDL"></a><code>AIDL</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ICameraServiceProxy</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// CameraService 向代理服务发送消息，通知用户更新</span></span><br><span class="line">    <span class="function">oneway <span class="keyword">void</span> <span class="title">pingForUserUpdate</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> CAMERA_STATE_OPEN = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> CAMERA_STATE_ACTIVE = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> CAMERA_STATE_IDLE = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> CAMERA_STATE_CLOSED = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> CAMERA_FACING_BACK = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> CAMERA_FACING_FRONT = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> CAMERA_FACING_EXTERNAL = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CameraService 向代理服务发送消息，通知相机设备状态更新</span></span><br><span class="line">    <span class="function">oneway <span class="keyword">void</span> <span class="title">notifyCameraState</span><span class="params">(String cameraId, <span class="keyword">int</span> facing, </span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> newCameraState, String clientName)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从 <code>AIDL</code> 文件看出，<code>CameraServiceProxy</code> 主要是响应 <code>CameraService</code> 的请求，也就是向 <code>Framework Java</code> 发送消息。  </p>
<h3 id="流程图-3"><a href="#流程图-3" class="headerlink" title="流程图"></a>流程图</h3><p><code>CameraServiceProxy</code> 服务名称：<code>media.camera.proxy</code> ；<code>CameraServiceProxy</code> 继承了 <code>SystemService</code> ，注册流程如下：  </p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0109-android-camera-framework-CameraServiceProxy-addService.png" alt="0109-android-camera-framework-CameraServiceProxy-addService.png"></p>
<h3 id="源码分析-4"><a href="#源码分析-4" class="headerlink" title="源码分析"></a>源码分析</h3><p>先来看注册流程的源码，服务的标准注册流程：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraServiceProxy.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CameraServiceProxy</span> <span class="keyword">extends</span> <span class="title">SystemService</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Handler</span>.<span class="title">Callback</span>, <span class="title">IBinder</span>.<span class="title">DeathRecipient</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CAMERA_SERVICE_BINDER_NAME </span><br><span class="line">        = <span class="string">"media.camera"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CAMERA_SERVICE_PROXY_BINDER_NAME </span><br><span class="line">        = <span class="string">"media.camera.proxy"</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 构造方法中，初始化线程相关</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CameraServiceProxy</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">        mContext = context;</span><br><span class="line">        mHandlerThread = <span class="keyword">new</span> ServiceThread(TAG, </span><br><span class="line">            Process.THREAD_PRIORITY_DISPLAY, <span class="comment">/*allowTo*/</span><span class="keyword">false</span>);</span><br><span class="line">        mHandlerThread.start();</span><br><span class="line">        mHandler = <span class="keyword">new</span> Handler(mHandlerThread.getLooper(), <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        mNotifyNfc = SystemProperties.getInt(NFC_NOTIFICATION_PROP, <span class="number">0</span>)&gt;<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Slog.v(...);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// onStart 主要是注册服务，并监听 User 相关广播</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mUserManager = UserManager.get(mContext);</span><br><span class="line">        ...</span><br><span class="line">        IntentFilter filter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">        filter.addAction(Intent.ACTION_USER_ADDED);</span><br><span class="line">        filter.addAction(Intent.ACTION_USER_REMOVED);</span><br><span class="line">        filter.addAction(Intent.ACTION_USER_INFO_CHANGED);</span><br><span class="line">        filter.addAction(Intent.ACTION_MANAGED_PROFILE_ADDED);</span><br><span class="line">        filter.addAction(Intent.ACTION_MANAGED_PROFILE_REMOVED);</span><br><span class="line">        mContext.registerReceiver(mIntentReceiver, filter);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册 CameraServiceProxy 服务</span></span><br><span class="line">        publishBinderService(CAMERA_SERVICE_PROXY_BINDER_NAME, </span><br><span class="line">            mCameraServiceProxy);</span><br><span class="line">        publishLocalService(CameraServiceProxy.class, <span class="keyword">this</span>);</span><br><span class="line">        CameraStatsJobService.schedule(mContext);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类中的 <code>User</code> 指的是 <code>Android</code> 多用户；再看回调接口的实现：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CameraServiceProxy.java</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ICameraServiceProxy.Stub mCameraServiceProxy </span><br><span class="line">        = <span class="keyword">new</span> ICameraServiceProxy.Stub() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pingForUserUpdate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        notifySwitchWithRetries(<span class="number">30</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyCameraState</span><span class="params">(String cameraId, <span class="keyword">int</span> newCameraState,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> facing, String clientName)</span> </span>&#123;</span><br><span class="line">        String state = cameraStateToString(newCameraState);</span><br><span class="line">        String facingStr = cameraFacingToString(facing);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Slog.v(...);</span><br><span class="line">        updateActivityCount(cameraId, newCameraState,facing,clientName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="小结-4"><a href="#小结-4" class="headerlink" title="小结"></a>小结</h3><p>通常情况下 <code>API</code> 中，<code>CameraManager</code> 通过 <code>ICameraService.aidl</code> 向 <code>CameraService</code> 下发请求；而 <code>CameraService</code> 通过 <code>ICameraServiceListener.aidl</code> 发回回调。<br>而如果没有 <code>API</code> 请求的情况下，<code>CameraService</code> 无法向 <code>Framework Java</code> 发送信息，所以系统开机时注册了 <code>CameraServiceProxy</code> 服务，用于响应 <code>CameraService</code> 的回调。  </p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="Camera-相关声音"><a href="#Camera-相关声音" class="headerlink" title="Camera 相关声音"></a><code>Camera</code> 相关声音</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> CameraService::loadSound() &#123;</span><br><span class="line">    ATRACE_CALL();</span><br><span class="line"></span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mSoundLock)</span></span>;</span><br><span class="line">    LOG1(<span class="string">"CameraService::loadSound ref=%d"</span>, mSoundRef);</span><br><span class="line">    <span class="keyword">if</span> (mSoundRef++) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    mSoundPlayer[SOUND_SHUTTER] = newMediaPlayer(</span><br><span class="line">        <span class="string">"/system/media/audio/ui/camera_click.ogg"</span>);</span><br><span class="line">    mSoundPlayer[SOUND_RECORDING_START] = newMediaPlayer(</span><br><span class="line">        <span class="string">"/system/media/audio/ui/VideoRecord.ogg"</span>);</span><br><span class="line">    mSoundPlayer[SOUND_RECORDING_STOP] = newMediaPlayer(</span><br><span class="line">        <span class="string">"/system/media/audio/ui/VideoStop.ogg"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CameraMetadata"><a href="#CameraMetadata" class="headerlink" title="CameraMetadata"></a><code>CameraMetadata</code></h3><p><code>CameraMetadataNative</code> 和 <code>CameraMetadata</code> 是同一个类型，只是命名空间不一样。  </p>
<figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> android &#123;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CameraMetadata</span>:</span> <span class="keyword">public</span> Parcelable &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> hardware &#123;</span><br><span class="line"><span class="keyword">namespace</span> camera2 &#123;</span><br><span class="line"><span class="keyword">namespace</span> impl &#123;</span><br><span class="line"><span class="keyword">using</span> ::android::CameraMetadata;</span><br><span class="line"><span class="keyword">typedef</span> CameraMetadata CameraMetadataNative;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="API-2-HAL-1"><a href="#API-2-HAL-1" class="headerlink" title="API 2 + HAL 1"></a><code>API 2 + HAL 1</code></h3><p>平台仅支持 <code>HAL 1</code> 时，<code>API 2</code> 在 <code>openCamera</code> 时，通过 <code>CameraDeviceUserShim</code> 将 <code>API 2</code> 转换为 <code>API 1</code> ，即 <code>HAL 1 + API 1</code> 向下发起请求。<br><code>LegacyCameraDevice</code> 会将 <code>CAMERA API2</code> 转换为 <code>CAMERA API1</code> ，而 <code>CameraDeviceUserShim</code> 封装了 <code>LegacyCameraDevice</code> 。  </p>
<h3 id="AIDL-生成多类型文件"><a href="#AIDL-生成多类型文件" class="headerlink" title="AIDL 生成多类型文件"></a><code>AIDL</code> 生成多类型文件</h3><p><code>AIDL</code> 可以同时生成 <code>.java, .h, .cpp</code> 文件，编译规则在 <code>Android.bp</code> 中配置。  </p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><ul>
<li>数据传递<br><code>Binder</code> 通信机制，数据传输限制在 1M ，那整个通信机制是如何传递图片的呢？以及预览的呢？传递的是什么？<br><code>createCaptureSession</code> 创建捕获会话时，配置输出流；当 <code>setRepeatingRequest</code> 发起预览请求时，回调结果为 <code>CaptureResult</code> ，它是如何和输出流关联的呢？  </li>
<li><code>SurfaceFlinger</code> 显示相关知识  </li>
<li><code>Buffer</code> 相关管理<br>  这些都是 <code>API 1</code> 模式下的数据流，不过有参考意义。  <ul>
<li><a href="https://blog.csdn.net/gzzaigcnforever/article/details/49070703" target="_blank" rel="noopener">预览preview模式下的数据流</a>  </li>
<li><a href="https://blog.csdn.net/gzzaigcnforever/article/details/49025297" target="_blank" rel="noopener">Surface 缓存区 生产者与消费者</a>  </li>
</ul>
</li>
</ul>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul>
<li><a href="https://www.jianshu.com/p/bac0e72351e4" target="_blank" rel="noopener">木子一秋：Android Camera架构</a>  </li>
<li><a href="https://blog.csdn.net/qq_16775897/article/details/81536598" target="_blank" rel="noopener">StoneDemo：HAL3 之 Open Camera2 流程（零）—— 概览</a>  </li>
</ul>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    redspider110
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://redspider110.github.io/2018/12/06/0109-android-camera-4-framework/" title="Camera Framework 分析">http://redspider110.github.io/2018/12/06/0109-android-camera-4-framework/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
            <a href="/tags/Camera/" rel="tag"># Camera</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/11/28/0109-android-camera-3-api2/" rel="next" title="Android Camera API2 介绍">
                <i class="fa fa-chevron-left"></i> Android Camera API2 介绍
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/12/10/0109-android-camera-5-hardware/" rel="prev" title="Camera Hardware 分析">
                Camera Hardware 分析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="redspider110">
            
              <p class="site-author-name" itemprop="name">redspider110</p>
              <p class="site-description motion-element" itemprop="description">地球卫士</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">124</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">54</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          
            <div class="cc-license motion-element" itemprop="license">
              <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
                <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons">
              </a>
            </div>
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#类文件速查表"><span class="nav-number">1.</span> <span class="nav-text">类文件速查表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#类文件目录"><span class="nav-number">1.1.</span> <span class="nav-text">类文件目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JNI-相关"><span class="nav-number">1.2.</span> <span class="nav-text">JNI 相关</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AIDL-相关"><span class="nav-number">2.</span> <span class="nav-text">AIDL 相关</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#IInterface-类型文件"><span class="nav-number">2.1.</span> <span class="nav-text">IInterface 类型文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#parcelable-类型文件"><span class="nav-number">2.2.</span> <span class="nav-text">parcelable 类型文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ICameraService-相关"><span class="nav-number">2.3.</span> <span class="nav-text">ICameraService 相关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ICameraServiceProxy-aidl-文件"><span class="nav-number">2.4.</span> <span class="nav-text">ICameraServiceProxy.aidl 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ICamera-相关"><span class="nav-number">2.5.</span> <span class="nav-text">ICamera 相关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ICameraDevice-相关"><span class="nav-number">2.6.</span> <span class="nav-text">ICameraDevice 相关</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Services-目录下的文件介绍"><span class="nav-number">3.</span> <span class="nav-text">Services 目录下的文件介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#API1-API2"><span class="nav-number">3.1.</span> <span class="nav-text">API1/API2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#QTICamera2Client"><span class="nav-number">3.2.</span> <span class="nav-text">QTICamera2Client</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#device1-device3"><span class="nav-number">3.3.</span> <span class="nav-text">device1/device3</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cameraserver-进程"><span class="nav-number">4.</span> <span class="nav-text">cameraserver 进程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CameraService-服务"><span class="nav-number">5.</span> <span class="nav-text">CameraService 服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#服务名称"><span class="nav-number">5.1.</span> <span class="nav-text">服务名称</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#注册流程图"><span class="nav-number">5.2.</span> <span class="nav-text">注册流程图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码分析"><span class="nav-number">5.3.</span> <span class="nav-text">源码分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结"><span class="nav-number">5.4.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Camera-Open-流程"><span class="nav-number">6.</span> <span class="nav-text">Camera Open 流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#API"><span class="nav-number">6.1.</span> <span class="nav-text">API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例"><span class="nav-number">6.2.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CameraDevice-StateCallback-接口"><span class="nav-number">6.3.</span> <span class="nav-text">CameraDevice.StateCallback 接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#流程图"><span class="nav-number">6.4.</span> <span class="nav-text">流程图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码分析-1"><span class="nav-number">6.5.</span> <span class="nav-text">源码分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结-1"><span class="nav-number">6.6.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建会话流程"><span class="nav-number">7.</span> <span class="nav-text">创建会话流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#API-1"><span class="nav-number">7.1.</span> <span class="nav-text">API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例-1"><span class="nav-number">7.2.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CameraCaptureSession-StateCallback-回调"><span class="nav-number">7.3.</span> <span class="nav-text">CameraCaptureSession.StateCallback 回调</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#流程图-1"><span class="nav-number">7.4.</span> <span class="nav-text">流程图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码分析-2"><span class="nav-number">7.5.</span> <span class="nav-text">源码分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结-2"><span class="nav-number">7.6.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#预览-拍照-录像流程"><span class="nav-number">8.</span> <span class="nav-text">预览/拍照/录像流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#API-2"><span class="nav-number">8.1.</span> <span class="nav-text">API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例-2"><span class="nav-number">8.2.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CameraCaptureSession-CaptureCallback-回调"><span class="nav-number">8.3.</span> <span class="nav-text">CameraCaptureSession.CaptureCallback 回调</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#流程图-2"><span class="nav-number">8.4.</span> <span class="nav-text">流程图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码分析-3"><span class="nav-number">8.5.</span> <span class="nav-text">源码分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结-3"><span class="nav-number">8.6.</span> <span class="nav-text">小结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#三者异同"><span class="nav-number">8.7.</span> <span class="nav-text">三者异同</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CameraServiceProxy-注册服务"><span class="nav-number">9.</span> <span class="nav-text">CameraServiceProxy 注册服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AIDL"><span class="nav-number">9.1.</span> <span class="nav-text">AIDL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#流程图-3"><span class="nav-number">9.2.</span> <span class="nav-text">流程图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码分析-4"><span class="nav-number">9.3.</span> <span class="nav-text">源码分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结-4"><span class="nav-number">9.4.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他"><span class="nav-number">10.</span> <span class="nav-text">其他</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Camera-相关声音"><span class="nav-number">10.1.</span> <span class="nav-text">Camera 相关声音</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CameraMetadata"><span class="nav-number">10.2.</span> <span class="nav-text">CameraMetadata</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#常见问题"><span class="nav-number">11.</span> <span class="nav-text">常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#API-2-HAL-1"><span class="nav-number">11.1.</span> <span class="nav-text">API 2 + HAL 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AIDL-生成多类型文件"><span class="nav-number">11.2.</span> <span class="nav-text">AIDL 生成多类型文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">12.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#后续"><span class="nav-number">13.</span> <span class="nav-text">后续</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考文档"><span class="nav-number">14.</span> <span class="nav-text">参考文档</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">redspider110</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  

  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
