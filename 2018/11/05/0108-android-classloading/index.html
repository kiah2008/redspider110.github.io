<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Android,">










<meta name="description" content="介绍 Android 类加载机制，双亲委派模型，BaseDexClassLoader, DexClassLoader, PathClassLoader 加载 dex, jar, apk 等文件。">
<meta name="keywords" content="Android">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 类加载机制">
<meta property="og:url" content="http://redspider110.github.io/2018/11/05/0108-android-classloading/index.html">
<meta property="og:site_name" content="Earth Guardian">
<meta property="og:description" content="介绍 Android 类加载机制，双亲委派模型，BaseDexClassLoader, DexClassLoader, PathClassLoader 加载 dex, jar, apk 等文件。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-java2oat.png">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-classloader-class-diag.png">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-parent-delegation-model.png">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-find-class.png">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-prloaded-classes.png">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-create-pathclassloader.png">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-load-apk.png">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-load-application.png">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-load-activity.png">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-load-service.png">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-load-broadcast-receiver.png">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-hot-fix.png">
<meta property="og:updated_time" content="2019-09-18T09:30:13.385Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android 类加载机制">
<meta name="twitter:description" content="介绍 Android 类加载机制，双亲委派模型，BaseDexClassLoader, DexClassLoader, PathClassLoader 加载 dex, jar, apk 等文件。">
<meta name="twitter:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-java2oat.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://redspider110.github.io/2018/11/05/0108-android-classloading/">





  <title>Android 类加载机制 | Earth Guardian</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?faa79b658398065f8158bf82b6221b6d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Earth Guardian</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">You are not LATE!You are not EARLY!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://redspider110.github.io/2018/11/05/0108-android-classloading/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="redspider110">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Earth Guardian">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Android 类加载机制</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-05T09:00:00+08:00">
                2018-11-05
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-eye"></i> 阅读次数
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>介绍 <code>Android</code> 类加载机制，双亲委派模型，<code>BaseDexClassLoader, DexClassLoader, PathClassLoader</code> 加载 <code>dex, jar, apk</code> 等文件。  </p>
<a id="more"></a>

<h2 id="JVM-虚拟机"><a href="#JVM-虚拟机" class="headerlink" title="JVM 虚拟机"></a><code>JVM</code> 虚拟机</h2><h3 id="执行方式"><a href="#执行方式" class="headerlink" title="执行方式"></a>执行方式</h3><p><code>Java</code> 的口号是“一次编译，到处运行”；也就是说 <code>Java</code> 程序的可执行文件（<code>class</code> 文件，字节码），是与机器硬件平台无关的；在程序运行时，由 <code>JVM</code> 将字节码翻译成当前运行环境处理器 <code>CPU</code> 的机器指令来执行。<code>JVM</code> 中通常有两种执行方式：  </p>
<ul>
<li>解释执行<br>字节码中每一行代码，由 <code>JVM</code> 解释器解释翻译成机器码再运行，依此循环从字节码中取出下一行解释并执行，因此解释执行的速度比较慢。  </li>
<li>编译执行<br><code>JVM</code> 将字节码编译成机器码后，运行机器码的执行方式，执行效率很高。  </li>
</ul>
<p>通常情况下，<code>JVM</code> 采用混合执行的方式来运行程序的：将高频代码编译成机器码编译执行，其他代码直接解释执行。  </p>
<h3 id="编译方式"><a href="#编译方式" class="headerlink" title="编译方式"></a>编译方式</h3><p>编译执行的过程，有两种常见的编译方式：  </p>
<ul>
<li><code>JIT：Just In Time</code><br>指在运行时编译，边运行边编译，属于动态编译。在程序启动时，将字节码编译成机器码，然后运行。优点是能更好的利用 <code>Java</code> 动态行为的特性（特别是多态，只有在运行时才能确定执行哪个方法）；缺点是动态编译时间会计算在程序运行时间中，特别是会导致程序启动时间变长，以及程序运行期间编译带来的性能消耗。<code>JIT</code> 通常只会将执行频率高的热方法动态编译，获取更好的效率平衡。  </li>
<li><code>AOT：Ahead Of Time</code><br>指在运行前编译，编译完后再运行，属于静态编译。在程序运行前，将字节码编译成机器码存储到本地，程序启动时，直接启动对应的机器码。优点是不存在动态编译的内存和性能消耗，直接运行本地机器码启动速度块；缺点是 <code>Java</code> 动态特性带来的复杂性，影响了静态编译的代码质量。  </li>
</ul>
<p>编译方式对比：  </p>
<table>
<thead>
<tr>
<th></th>
<th>动态 <code>JIT</code></th>
<th>静态 <code>AOT</code></th>
</tr>
</thead>
<tbody><tr>
<td>平台无关性</td>
<td>有</td>
<td>无</td>
</tr>
<tr>
<td>代码质量</td>
<td>优秀</td>
<td>良好</td>
</tr>
<tr>
<td>利用动态行为</td>
<td>是</td>
<td>否</td>
</tr>
<tr>
<td>类和层次结构的知识</td>
<td>有</td>
<td>无</td>
</tr>
<tr>
<td>编译时间</td>
<td>有限制，有运行时成本</td>
<td>限制很少，无运行时成本</td>
</tr>
<tr>
<td>运行时性能影响</td>
<td>有</td>
<td>无</td>
</tr>
<tr>
<td>编译方式</td>
<td>需要谨慎编译，由 <code>JIT</code> 处理</td>
<td>需要谨慎编译，由开发人员处理</td>
</tr>
</tbody></table>
<p>总的来说，动态编译 <code>JIT</code> 能提供最好的系统稳定性能；而静态编译 <code>AOT</code> 能提供最好的交互性能。  </p>
<h2 id="Android-虚拟机"><a href="#Android-虚拟机" class="headerlink" title="Android 虚拟机"></a><code>Android</code> 虚拟机</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p><code>Android</code> 虚拟机实现有两个阶段：  </p>
<ul>
<li><code>Dalvik</code><br><code>Android K 4.4</code> 之前的版本都是使用的 <code>Dalvik</code> 虚拟机。<code>Java</code> 生成的 <code>class</code> 文件由 <code>dx</code> 工具转换为 <code>Dalvik</code> 字节码即 <code>dex</code> 文件，之后进行签名对齐等操作变成 <code>APK</code> 文件。而 <code>Dalvik</code> 虚拟机负责将 <code>dex</code> 字节码解释为机器码，解释执行的速度慢效率低；从 <code>Android 2.2 froyo</code> 开始引入 <code>JIT</code> 动态编译执行方式，<code>APP</code> 运行时，<code>JIT</code> 将执行次数较多的 <code>dex</code> 文件动态编译为机器码缓存起来，后续再次执行时大大提高运行速度。<code>JIT</code> 动态编译的特点是：每次打开 <code>APP</code> 运行时，都需要重新编译。    </li>
<li><code>ART: Android Runtime</code><br><code>Android K 4.4</code> 采用了 <code>Dalvik</code> 和 <code>ART</code> 共存方式，两者可以相互切换；从 <code>Android L 5.0</code> 开始彻底丢弃 <code>Dalvik</code> 全面转换为 <code>ART</code> 方式。<code>ART</code> 虚拟机采用的是 <code>AOT</code> 静态编译执行方式，<code>APP</code> 在第一次安装时，<code>dex</code> 字节码会被预先编译成机器码；之后打开 <code>APP</code> 运行时，不需要额外的解释翻译工作，直接使用本地机器码执行，提高运行速度。  </li>
</ul>
<h3 id="两者的区别"><a href="#两者的区别" class="headerlink" title="两者的区别"></a>两者的区别</h3><ul>
<li><code>Dalvik</code> 是运行时编译；<code>ART</code> 是运行前编译（安装时编译）  </li>
<li><code>Dalvik</code> 每次运行时都会将执行频繁的 <code>dex</code> 文件编译为机器码，运行启动时间加长，边运行边编译会额外销毁内存和系统性能  </li>
<li><code>ART</code> 在安装时编译，安装时间会延长；把程序代码转换成机器语言存储在本地，会消耗掉更多的存储空间，增幅通常不会超过应用代码包大小的 20%  </li>
</ul>
<h3 id="文件格式"><a href="#文件格式" class="headerlink" title="文件格式"></a>文件格式</h3><ul>
<li><code>dex</code> 文件格式<br>魔数：<code>dex</code> ，<code>Android</code> 平台可执行文件，字节码；每个 <code>APK</code> 中包含一个或多个 <code>dex</code> 文件格式的可执行文件。  </li>
<li><code>odex</code> 文件格式<br>魔数：<code>dey</code> ，<code>odex: Optimize Dex</code> 即优化后的 <code>dex</code> 文件。<code>Dalvik</code> 虚拟机从 <code>APK</code> 中将 <code>dex</code> 文件提取出来优化后生成 <code>odex</code> 文件，并存储在本地，后期运行时直接编译解释 <code>odex</code> 文件（<strong>仍然是字节码，<code>dey</code> 字节码</strong>）。而 <code>APK</code> 被提取后可以有也可以没有 <code>dex</code> 文件；在多 <code>dex</code> 文件的 <code>APK</code> 中，提取优化后只会生成一个 <code>odex</code> 文件。  </li>
<li><code>oat</code> 文件格式<br>魔数：<code>.elf</code> ，是 <code>ELF</code> 格式的可执行文件。<code>ART</code> 虚拟机在 <code>APK</code> 安装时，将 <code>dex</code> 编译为本地机器码，并生成对应的 <code>oat</code> 文件格式的文件，可以直接执行。  </li>
<li><code>vdex</code> 文件格式<br>魔数：<code>vdex</code> ，是 <code>APK</code> 中 <code>dex</code> 文件的一份拷贝，同时会将多个 <code>dex</code> 合并为一个文件。在 <code>Android O 8.0</code> 之前，<code>oat</code> 格式文件除了机器码还包含一份 <code>dex</code> 的拷贝；但在 <code>Android O</code> 之后，<code>dex2oat</code> 静态编译时会产生两个文件：<code>odex, vdex</code> ，其中 <code>odex</code> 为机器码，通常很小；而 <code>vdex</code> 则是原始 <code>dex</code> 的一份拷贝，它是一个全新格式的文件（不是 <code>ELF</code> 格式）。  </li>
<li><code>art</code> 文件格式<br>魔数：<code>art</code> ，是一个 <code>img</code> 文件，表示类对象映像；这个 <code>img</code> 文件直接被映射到 <code>ART</code> 虚拟机的堆空间中，包含了 <code>oat</code> 中的某些对象实例以及函数地址。  </li>
</ul>
<blockquote>
<p>为保证 <code>Dalvik</code> 和 <code>ART</code> 的兼容性，以及历史遗留问题，可能会使用<strong>相同文件后缀表示不同的文件格式</strong>，非常容易混淆。比如 <code>.dex</code> 后缀可以是 <code>dex, oat</code> 文件，<code>odex</code> 后缀可以是 <code>odex, oat</code> 文件等。  </p>
</blockquote>
<h3 id="转换流程图"><a href="#转换流程图" class="headerlink" title="转换流程图"></a>转换流程图</h3><p><code>Java</code> 源文件转换为 <code>oat</code> 格式文件的流程图：  </p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-java2oat.png" alt="0108-android-classloading-java2oat.png"></p>
<h3 id="文件分析工具"><a href="#文件分析工具" class="headerlink" title="文件分析工具"></a>文件分析工具</h3><ul>
<li><code>dex</code> 文件生成及分析工具<br><code>d8.bat/dx.bat</code> ：生成工具，位置路径为 <code>Windows sdk\build-tools\28.0.3</code> 。示例：<code>d8.bat --output=test.jar Test.jar test.class</code> ；其中 <code>output</code> 必须是 <code>.zip, .jar</code>，<code>input</code> 可以是 <code>.dex, .apk, .jar, .class, .zip</code> 。<br><code>dexdump/dexdump2</code> ：分析工具，在 <code>AOSP</code> 编译完后 <code>out/host$ cd linux-x86/bin/</code> 目录下会生成对应工具。  </li>
<li><code>oat</code> 文件<br>因为是 <code>ELF</code> 格式文件，所以通用工具都可以读出，如：<code>readelf</code> ，<code>AOSP</code> 编译完后生成的 <code>otadump</code> 也可以分析。  </li>
<li><code>vdex</code> 文件<br><a href="https://github.com/anestisb/vdexExtractor" target="_blank" rel="noopener">github: vdexExtractor</a> ，这款工具可以从 <code>vdex</code> 中提取出原始的 <code>dex</code> 文件。  </li>
</ul>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>如下信息手机系统为 <code>Android O 8.1</code> ：  </p>
<ul>
<li><p>系统编译 <code>framework</code> 生成文件<br>按照 <code>out</code> 目录生成文件路径，拷贝到手机对应路径中；在系统启动时，会拷贝一份到 <code>/data/dalvik-cache/arm64</code> 目录下。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">6.1M    system/framework/arm64/boot-framework.art</span><br><span class="line">25M     system/framework/arm64/boot-framework.oat</span><br><span class="line">20M     system/framework/arm64/boot-framework.vdex</span><br><span class="line">7.4M    system/framework/framework.jar</span><br><span class="line">// 系统启动后在 /data/dalvik-cache/arm64 目录下生成对应文件  </span><br><span class="line">6.0M    system@framework@boot-framework.art</span><br><span class="line">0       system@framework@boot-framework.oat -&gt; /system/framework/arm64/boot-framework.oat</span><br><span class="line">0       system@framework@boot-framework.vdex -&gt; /system/framework/arm64/boot-framework.vdex</span><br></pre></td></tr></table></figure>
</li>
<li><p>系统编译应用 <code>Email</code> 生成文件<br>系统应用在安装时同样会拷贝到 <code>/data/dalvik-cache/arm64</code> 目录下，但是会多生成一个 <code>classes.art</code> 文件。注意：在 <code>data</code> 目录生成的 <strong><code>dex</code> 后缀的文件，实际上是 <code>oat</code> 文件</strong>，<code>pull</code> 出来后魔数是 <code>.elf</code> 格式的。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">6.7M    system/app/Email/Email.apk</span><br><span class="line">76K     system/app/Email/oat/arm64/Email.odex</span><br><span class="line">4.1M    system/app/Email/oat/arm64/Email.vdex</span><br><span class="line">// 系统启动后在 /data/dalvik-cache/ 目录下生成对应文件  </span><br><span class="line">32K     /data/dalvik-cache/arm64/system@app@Email@Email.apk@classes.art</span><br><span class="line">72K     /data/dalvik-cache/arm64/system@app@Email@Email.apk@classes.dex</span><br><span class="line">4.0M    /data/dalvik-cache/arm64/system@app@Email@Email.apk@classes.vdex</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装 <code>qsbk.apk</code> 生成的文件，<code>apk</code> 中包含多个 <code>dex</code> 文件<br>第三方应用在安装时，直接安装到 <code>/data/app/</code> 目录下，并根据包名随机生成一个字符串做目录区分。注意：<strong>生成的 <code>base.odex</code> 实际上是 <code>oat</code> 文件</strong>，<code>pull</code> 出来后魔数是 <code>.elf</code> 格式的。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">32M     /data/app/qsbk.app-9P***/base.apk</span><br><span class="line">276K    /data/app/qsbk.app-9P***/oat/arm/base.odex</span><br><span class="line">15M     /data/app/qsbk.app-9P***/oat/arm/base.vdex</span><br></pre></td></tr></table></figure>
</li>
<li><p>小结<br>系统自带 <code>framework, app</code> 都会生成 <code>art, oat, vdex</code> 三种文件格式的文件；而第三方应用安装后，只会生成 <code>oat, vdex</code> 两种文件格式的文件。其中 <code>framework</code> 中后缀为 <code>.oat</code>、系统 <code>app</code> 中后缀为 <code>dex</code>、第三方 <code>app</code> 中后缀为 <code>odex</code>，<strong>这三个 <code>oat, dex, odex</code> 后缀的文件，实际上都是 <code>oat</code> 文件，注意别混淆了</strong>，仅仅是后缀不同而已。  </p>
</li>
</ul>
<h2 id="代码速查表"><a href="#代码速查表" class="headerlink" title="代码速查表"></a>代码速查表</h2><p>本文基于 <code>Android O 8.1</code> 源码分析 <code>Android</code> 平台的 <code>ClassLoader</code> ：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">libcore/ojluni/src/main/java/java/lang/Class.java</span><br><span class="line">libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span><br><span class="line">libcore/libart/src/main/java/java/lang/VMClassLoader.java</span><br><span class="line"></span><br><span class="line">libcore/dalvik</span><br><span class="line">    ./src/main/java/dalvik/system/BaseDexClassLoader.java</span><br><span class="line">    ./src/main/java/dalvik/system/InMemoryDexClassLoader.java</span><br><span class="line">    ./src/main/java/dalvik/system/DexClassLoader.java</span><br><span class="line">    ./src/main/java/dalvik/system/PathClassLoader.java</span><br><span class="line">    ./src/main/java/dalvik/system/DelegateLastClassLoader.java</span><br><span class="line">    ./src/main/java/dalvik/system/DexPathList.java</span><br><span class="line">    ./src/main/java/dalvik/system/DexFile.java</span><br><span class="line"></span><br><span class="line">art/runtime/native/dalvik_system_DexFile.cc</span><br><span class="line">art/runtime/native/java_lang_VMClassLoader.cc</span><br></pre></td></tr></table></figure>

<h2 id="Android-类加载器"><a href="#Android-类加载器" class="headerlink" title="Android 类加载器"></a><code>Android</code> 类加载器</h2><h3 id="类图结构"><a href="#类图结构" class="headerlink" title="类图结构"></a>类图结构</h3><p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-classloader-class-diag.png" alt="0108-android-classloading-classloader-class-diag.png"></p>
<p>本文不分析 <code>SecureClassLoader, URLClassLoader</code> 这两个类加载器。  </p>
<ul>
<li><code>ClassLoader</code> ：抽象类，类加载器的最终父类  </li>
<li><code>BootClassLoader</code> ：启动类加载器；在双亲委托模型中，是第一级父加载器  </li>
<li><code>BaseDexClassLoader</code> ：<code>Android</code> 平台加载 <code>dex</code> 文件的基类  </li>
<li><code>PathClassLoader</code> ：系统类加载器，也相当于应用类加载器，是用户自定义类加载器默认的父加载器；<code>APK</code> 文件都是该加载器加载的  </li>
<li><code>DexClassLoader</code> ：主要用于从包含 <code>classes.dex</code> 的 <code>.jar, .apk</code> 文件中加载类，而这些文件并没有随着应用一起安装  </li>
<li><code>InMemoryDexClassLoader</code> ：主要用于加载内存中的 <code>dex</code> 文件，而这些内存中的文件并不需要存储在本地  </li>
<li><code>DelegateLastClassLoader</code> ：最近委托查找策略类加载器，并不完全按照双亲委派模型来加载的，会提前执行 <code>findClass</code> 从加载 <code>dex</code> 文件中查找类，然后才是双亲委派模型  </li>
</ul>
<p>从各个博客看下来，<code>Classloader</code> 在 <code>Android</code> 不同大版本中不管是代码位置还是子类都在不停的变化。  </p>
<blockquote>
<p>自定义类加载器时，如果不指定父加载器，则默认其父加载器为 <code>PathClassLoader</code> ；通过 <code>Class</code> 获取加载器时，如果其加载器为空，则指定其加载器为 <code>BootClassLoader</code> 。  </p>
</blockquote>
<h3 id="双亲委派模型"><a href="#双亲委派模型" class="headerlink" title="双亲委派模型"></a>双亲委派模型</h3><p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-parent-delegation-model.png" alt="0108-android-classloading-parent-delegation-model.png"></p>
<p>类加载器的双亲委派模型：要求除了启动类加载器外，其余的类加载器都应当有自己的父加载器（父子不是继承关系，而是组合关系来复用父类代码）。双亲委派模型并不是强制要求，只是 <code>Java</code> 的推荐方式，可以通过重新加载方法来改变。<br>双亲委派模型原则：某个特定的类加载器在接到加载类的请求时，首先将加载任务委托给父加载器，依次递归，如果父加载器可以完成类加载任务，就成功返回；只有父加载器无法完成此加载任务时，才自己去加载。<br><code>Android</code> 和标准 <code>Java</code> 对比：没有扩展类加载器，启动加载器 <code>BootClassLoader</code> 也是 <code>Java</code> 实现的。  </p>
<blockquote>
<p>父加载器和父类加载器是两个不同的概念：父加载器是参考双亲委派模型在构造方法中指定的；父类加载器表示当前加载器的父类（类图结构上是继承关系）。  </p>
</blockquote>
<h3 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a><code>ClassLoader</code></h3><p><code>ClassLoader</code> 是抽象类，其他所有的类加载都是它的继承类；有以下几个特点：  </p>
<ul>
<li>标准 <code>Java</code> 中系统默认加载器为 <code>AppClassLoader</code>；而 <code>Android</code> 中系统类加载器是 <code>PathClassLoader</code>  </li>
<li>系统类加载器 <code>PathClassLoader</code> 的父加载器为启动加载器 <code>BootClassLoader</code>  </li>
<li><code>Android</code> 启动加载器 <code>BootClassLoader</code> 是 <code>ClassLoader</code> 的内部类，也是其子类；默认为顶层<strong>父加载器</strong>  </li>
<li><code>ClassLoader</code> 构造方法中指定父加载器，如果不指定：父加载器默认为系统加载器 <code>PathClassLoader</code> ；即：自定义类加载器，如果不指定父加载器，则其父加载器默认为 <code>PathClassLoader</code>  </li>
<li><code>loadClass</code> 实现了双亲委派模型  </li>
<li><code>findClass, defineClass</code> 必须在子类中实现  </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line">public abstract class ClassLoader &#123;</span><br><span class="line"></span><br><span class="line">    // 系统类加载器</span><br><span class="line">    static private class SystemClassLoader &#123;</span><br><span class="line">        public static ClassLoader loader = </span><br><span class="line">                ClassLoader.createSystemClassLoader();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 系统类加载器为 PathClassLoader</span><br><span class="line">    private static ClassLoader createSystemClassLoader() &#123;</span><br><span class="line">        String classPath = System.getProperty(&quot;java.class.path&quot;, &quot;.&quot;);</span><br><span class="line">        String librarySearchPath = </span><br><span class="line">            System.getProperty(&quot;java.library.path&quot;, &quot;&quot;);</span><br><span class="line">    </span><br><span class="line">        // String[] paths = classPath.split(&quot;:&quot;);</span><br><span class="line">        // URL[] urls = new URL[paths.length];</span><br><span class="line">        // for (int i = 0; i &lt; paths.length; i++) &#123;</span><br><span class="line">        // try &#123;</span><br><span class="line">        // urls[i] = new URL(&quot;file://&quot; + paths[i]);</span><br><span class="line">        // &#125;</span><br><span class="line">        // catch (Exception ex) &#123;</span><br><span class="line">        // ex.printStackTrace();</span><br><span class="line">        // &#125;</span><br><span class="line">        // &#125;</span><br><span class="line">        //</span><br><span class="line">        // return new java.net.URLClassLoader(urls, null);</span><br><span class="line">    </span><br><span class="line">        // TODO Make this a java.net.URLClassLoader once we have those?</span><br><span class="line">        // PathClassLoader 的父加载器为 BootClassLoader</span><br><span class="line">        return new PathClassLoader(classPath, librarySearchPath, </span><br><span class="line">            BootClassLoader.getInstance());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 系统加载器的类 PathClassLoader.class</span><br><span class="line">    protected final Class&lt;?&gt; findSystemClass(String name)</span><br><span class="line">        throws ClassNotFoundException &#123;</span><br><span class="line">        return Class.forName(name, false, getSystemClassLoader());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 系统类加载器为 PathClassLoader</span><br><span class="line">    public static ClassLoader getSystemClassLoader() &#123;</span><br><span class="line">        return SystemClassLoader.loader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // The parent class loader for delegation</span><br><span class="line">    // Note: VM hardcoded the offset of this field, thus all new fields</span><br><span class="line">    // must be added *after* it.</span><br><span class="line">    private final ClassLoader parent;</span><br><span class="line">    </span><br><span class="line">    public final ClassLoader getParent() &#123;</span><br><span class="line">        return parent;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private ClassLoader(Void unused, ClassLoader parent) &#123;</span><br><span class="line">        this.parent = parent;</span><br><span class="line">    &#125;</span><br><span class="line">    protected ClassLoader(ClassLoader parent) &#123;</span><br><span class="line">        this(checkCreateClassLoader(), parent);</span><br><span class="line">    &#125;</span><br><span class="line">    // 如果不指定父加载器，则其父加载器默认为 PathClassLoader</span><br><span class="line">    protected ClassLoader() &#123;</span><br><span class="line">        this(checkCreateClassLoader(), getSystemClassLoader());</span><br><span class="line">    &#125;</span><br><span class="line">    public Class&lt;?&gt; loadClass(String name) </span><br><span class="line">        throws ClassNotFoundException &#123;</span><br><span class="line">        return loadClass(name, false);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 实现双亲委派模型  </span><br><span class="line">    protected Class&lt;?&gt; loadClass(String name, boolean resolve)</span><br><span class="line">        throws ClassNotFoundException &#123;</span><br><span class="line">            // First, check if the class has already been loaded</span><br><span class="line">            // 1. 先确认类是否已经被加载</span><br><span class="line">            Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">            if (c == null) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (parent != null) &#123;</span><br><span class="line">                        // 2. 如果没有被加载，父加载器是否为空</span><br><span class="line">                        // 不为空则父加载器加载，依次递归</span><br><span class="line">                        c = parent.loadClass(name, false);</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        // 3. 这里沿用标准 Java 的双亲加载模型</span><br><span class="line">                        // 但是 Android 中并没有 Bootstrap</span><br><span class="line">                        c = findBootstrapClassOrNull(name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">                    // ClassNotFoundException thrown if class not found</span><br><span class="line">                    // from the non-null parent class loader</span><br><span class="line">                    // 4. 如果父加载器抛出 ClassNotFoundException</span><br><span class="line">                    // 说明父加载器无法完成类加载请求</span><br><span class="line">                &#125;</span><br><span class="line">    </span><br><span class="line">                if (c == null) &#123;</span><br><span class="line">                    // If still not found, then invoke findClass in order</span><br><span class="line">                    // to find the class.</span><br><span class="line">                    // 5. 父加载器无法完成加载或者其他原因没有加载成功</span><br><span class="line">                    // 则调用本身的 findClass 进行类加载</span><br><span class="line">                    c = findClass(name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return c;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 通过本地代码在 ART 中查找</span><br><span class="line">    protected final Class&lt;?&gt; findLoadedClass(String name) &#123;</span><br><span class="line">        ClassLoader loader;</span><br><span class="line">        if (this == BootClassLoader.getInstance())</span><br><span class="line">            loader = null;</span><br><span class="line">        else</span><br><span class="line">            loader = this;</span><br><span class="line">        return VMClassLoader.findLoadedClass(loader, name);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Android 中没有Bootstrap，直接返回 null</span><br><span class="line">    private Class&lt;?&gt; findBootstrapClassOrNull(String name) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    protected Class&lt;?&gt; findClass(String name) </span><br><span class="line">        throws ClassNotFoundException &#123;</span><br><span class="line">        throw new ClassNotFoundException(name);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    protected final Class&lt;?&gt; defineClass(...)</span><br><span class="line">        throws ClassFormatError &#123;</span><br><span class="line">        throw new UnsupportedOperationException(&quot;...&quot;);</span><br><span class="line">    &#125;    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从源码 <code>loadClass</code> 中再描述下双亲委派模型：  </p>
<ul>
<li>先确认类是否已经被加载  </li>
<li>如果没有被加载，且父加载器不为空；使用父加载器加载。依次递归  </li>
<li>父加载器为空，使用 <code>Bootstrap</code> 来加载，但是 <code>Android</code> 中并不存在该加载器，直接返回 <code>null</code>   </li>
<li>父加载器无法完成加载或者其他原因没有加载成功，则调用当前递归到的类加载器 <code>findClass</code> 进行类加载  </li>
</ul>
<h3 id="BootClassLoader"><a href="#BootClassLoader" class="headerlink" title="BootClassLoader"></a><code>BootClassLoader</code></h3><p>启动类加载器 <code>BootClassLoader</code>，是 <code>ClassLoader</code> 的成员内部类，也是 <code>ClassLoader</code> 的子类；是顶层父加载器。和 <code>JVM</code> 不一样，<code>Android</code> 的启动类加载器是 <code>Java</code> 实现的。有如下特点：  </p>
<ul>
<li>启动类加载器 <code>BootClassLoader</code> 的父加载器为 <code>null</code> ，它是最顶层的加载器  </li>
<li>因为是最顶层的父加载器，在 <code>loadClass</code> 中如果发现类没有加载，直接在这一层 <code>findClass</code>  </li>
<li><code>findClass</code> 是通过反射 <code>Class.classForName</code> （它是一个 <code>native</code> 方法，标准 <code>Java</code> 中并存在） 实现的  </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BootClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> BootClassLoader instance;</span><br><span class="line"></span><br><span class="line">    @...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> BootClassLoader <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> BootClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动类加载器的父加载器为 null</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BootClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) </span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// 通过反射加载类，classForName 是 native 方法</span></span><br><span class="line">        <span class="keyword">return</span> Class.classForName(name, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; loadClass(String className, <span class="keyword">boolean</span> resolve)</span><br><span class="line">           <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = findLoadedClass(className);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">            clazz = findClass(className);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Class"><a href="#Class" class="headerlink" title="Class"></a><code>Class</code></h3><p>因为 <code>Android</code> 修改了标准 <code>Java</code> 的类加载器，所以在 <code>Class.java</code> 中也做了对应修改。主要有以下几个特点：  </p>
<ul>
<li>默认类加载器和调用者为同一个加载器  </li>
<li>获取类加载器时，如果加载器为空，则指定其加载器为 <code>BootClassLoader</code>  </li>
<li><code>native</code> 方法 <code>classForName</code> ，从虚拟机中加载类  </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Class</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span>,</span></span><br><span class="line"><span class="class">                              <span class="title">GenericDeclaration</span>,</span></span><br><span class="line"><span class="class">                              <span class="title">Type</span>,</span></span><br><span class="line"><span class="class">                              <span class="title">AnnotatedElement</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// defining class loader, or null for the "bootstrap" system loader.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> ClassLoader classLoader;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; forName(String className)</span><br><span class="line">                <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">return</span> forName(className, <span class="keyword">true</span>, VMStack.getCallingClassLoader());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; forName(String name, <span class="keyword">boolean</span> initialize,</span><br><span class="line">                                   ClassLoader loader)</span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (loader == <span class="keyword">null</span>) &#123;</span><br><span class="line">            loader = BootClassLoader.getInstance();</span><br><span class="line">        &#125;</span><br><span class="line">        Class&lt;?&gt; result;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = classForName(name, initialize, loader);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            Throwable cause = e.getCause();</span><br><span class="line">            <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> LinkageError) &#123;</span><br><span class="line">                <span class="keyword">throw</span> (LinkageError) cause;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Called after security checks have been made. */</span></span><br><span class="line">    <span class="meta">@FastNative</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">native</span> Class&lt;?&gt; classForName(String className, </span><br><span class="line">        <span class="keyword">boolean</span> shouldInitialize, ClassLoader classLoader) </span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClassLoader <span class="title">getClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isPrimitive()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果其加载器为空，则指定其加载器为 BootClassLoader</span></span><br><span class="line">        <span class="keyword">return</span> (classLoader == <span class="keyword">null</span>) ? </span><br><span class="line">            BootClassLoader.getInstance() : classLoader;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PathClassLoader"><a href="#PathClassLoader" class="headerlink" title="PathClassLoader"></a><code>PathClassLoader</code></h3><p><code>Android</code> 的系统类加载器，也相当于应用类加载器，是用户自定义类加载器默认的父加载器；类中只有构造方法，它继承了 <code>BaseDexClassLoader</code> 。<code>APK</code> 加载时，默认使用该加载器加载到 <code>ART</code> 中。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PathClassLoader</span> <span class="keyword">extends</span> <span class="title">BaseDexClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PathClassLoader</span><span class="params">(String dexPath, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(dexPath, <span class="keyword">null</span>, <span class="keyword">null</span>, parent);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PathClassLoader</span><span class="params">(String dexPath, String librarySearchPath, </span></span></span><br><span class="line"><span class="function"><span class="params">        ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(dexPath, <span class="keyword">null</span>, librarySearchPath, parent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="DexClassLoader"><a href="#DexClassLoader" class="headerlink" title="DexClassLoader"></a><code>DexClassLoader</code></h3><p>继承了 <code>BaseDexClassLoader</code> ，只有构造方法。主要用于从包含 <code>classes.dex</code> 的 <code>.jar, .apk</code> 文件中加载类，而这些文件并没有随着应用一起安装；比如放在 <code>assert</code> 目录下等等。<br>而实际上，从构造方法传递的参数来看：<code>DexClassLoader, PathClassLoader</code> 并没有任何区别！！  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DexClassLoader</span> <span class="keyword">extends</span> <span class="title">BaseDexClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DexClassLoader</span><span class="params">(String dexPath, String optimizedDirectory,</span></span></span><br><span class="line"><span class="function"><span class="params">            String librarySearchPath, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(dexPath, <span class="keyword">null</span>, librarySearchPath, parent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="InMemoryDexClassLoader"><a href="#InMemoryDexClassLoader" class="headerlink" title="InMemoryDexClassLoader"></a><code>InMemoryDexClassLoader</code></h3><p>继承了 <code>BaseDexClassLoader</code> ，只有构造方法。主要用于加载内存中的 <code>dex</code> 文件，而这些内存中的文件并不需要存储在本地；方便网络下载并加载。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InMemoryDexClassLoader</span> <span class="keyword">extends</span> <span class="title">BaseDexClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InMemoryDexClassLoader</span><span class="params">(ByteBuffer[] dexBuffers, </span></span></span><br><span class="line"><span class="function"><span class="params">        ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(dexBuffers, parent);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InMemoryDexClassLoader</span><span class="params">(ByteBuffer dexBuffer, ClassLoader parent)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">new</span> ByteBuffer[] &#123; dexBuffer &#125;, parent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="DelegateLastClassLoader"><a href="#DelegateLastClassLoader" class="headerlink" title="DelegateLastClassLoader"></a><code>DelegateLastClassLoader</code></h3><p><code>DelegateLastClassLoader</code> 继承 <code>PathClassLoader</code>，是最近委托查找策略；它加载类和资源的策略如下（代码中也有详细注释）：  </p>
<ul>
<li>首先查看类是否已经被加载  </li>
<li>然后使用最顶层启动类加载器 <code>BootClassLoader</code> 来加载  </li>
<li>然后使用当前类加载器 <code>findClass</code> ，搜索与此类加载器的 <code>dexPath</code> 关联的 <code>dex</code> 文件列表中，是否已经加载  </li>
<li>最后才是委托父加载器加载  </li>
</ul>
<p>从代码中可以看到，<code>DelegateLastClassLoader</code> 并没有完全遵循双亲委派模型。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DelegateLastClassLoader</span> <span class="keyword">extends</span> <span class="title">PathClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DelegateLastClassLoader</span><span class="params">(String dexPath, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(dexPath, parent);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DelegateLastClassLoader</span><span class="params">(String dexPath, </span></span></span><br><span class="line"><span class="function"><span class="params">        String librarySearchPath, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(dexPath, librarySearchPath, parent);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve) </span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// First, check whether the class has already been loaded. </span></span><br><span class="line">        <span class="comment">// Return it if that's the case.</span></span><br><span class="line">        Class&lt;?&gt; cl = findLoadedClass(name);</span><br><span class="line">        <span class="keyword">if</span> (cl != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Next, check whether the class in question </span></span><br><span class="line">        <span class="comment">// is present in the boot classpath.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Object.class.getClassLoader().loadClass(name);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException ignored) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Next, check whether the class in question is present </span></span><br><span class="line">        <span class="comment">// in the dexPath that this classloader operates on.</span></span><br><span class="line">        ClassNotFoundException fromSuper = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> findClass(name);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">            fromSuper = ex;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Finally, check whether the class in question </span></span><br><span class="line">        <span class="comment">// is present in the parent classloader.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getParent().loadClass(name);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException cnfe) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">throw</span> fromSuper;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="BaseDexClassLoader"><a href="#BaseDexClassLoader" class="headerlink" title="BaseDexClassLoader"></a><code>BaseDexClassLoader</code></h3><p><code>BaseDexClassLoader</code> 是 <code>Android</code> 平台加载 <code>dex</code> 文件的基类，所有从 <code>dex</code> 文件中查找加载的类 <code>findClass</code> 都是在这里实现。<br>构造方法中各参数的含义：  </p>
<ul>
<li><code>dexPath</code> ：包含 <code>dex</code> 文件的绝对路径列表；文件可以是 <code>apk, jar</code> ，文件列表分隔符为 <code>:</code>  </li>
<li><code>optimizedDirectory</code> ：没有任何作用，为了兼容早期的版本  </li>
<li><code>librarySearchPath</code> ：<code>native</code> 库所在文件目录的绝对路径列表；文件目录分隔符默认为 <code>:</code>  </li>
<li><code>parent</code> ：当前类加载器的父加载器  </li>
<li><code>dexFiles</code> ：包含 <code>dex</code> 文件的二进制数组  </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseDexClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DexPathList pathList;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseDexClassLoader</span><span class="params">(String dexPath, File optimizedDirectory,</span></span></span><br><span class="line"><span class="function"><span class="params">            String librarySearchPath, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(parent);</span><br><span class="line">        <span class="keyword">this</span>.pathList = <span class="keyword">new</span> DexPathList(<span class="keyword">this</span>, dexPath, </span><br><span class="line">                librarySearchPath, <span class="keyword">null</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseDexClassLoader</span><span class="params">(ByteBuffer[] dexFiles, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO We should support giving this a library search path maybe.</span></span><br><span class="line">        <span class="keyword">super</span>(parent);</span><br><span class="line">        <span class="keyword">this</span>.pathList = <span class="keyword">new</span> DexPathList(<span class="keyword">this</span>, dexFiles);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) </span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        List&lt;Throwable&gt; suppressedExceptions = <span class="keyword">new</span> ArrayList&lt;Throwable&gt;();</span><br><span class="line">        Class c = pathList.findClass(name, suppressedExceptions);</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">            ClassNotFoundException cnfe = <span class="keyword">new</span> ClassNotFoundException(...);</span><br><span class="line">            <span class="keyword">for</span> (Throwable t : suppressedExceptions) &#123;</span><br><span class="line">                cnfe.addSuppressed(t);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> cnfe;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addDexPath</span><span class="params">(String dexPath)</span> </span>&#123;</span><br><span class="line">        pathList.addDexPath(dexPath, <span class="keyword">null</span> <span class="comment">/*optimizedDirectory*/</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>findClass</code> 流程图：  </p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-find-class.png" alt="0108-android-classloading-find-class.png"></p>
<h2 id="dex-文件加载与解析"><a href="#dex-文件加载与解析" class="headerlink" title="dex 文件加载与解析"></a><code>dex</code> 文件加载与解析</h2><h3 id="DexFile"><a href="#DexFile" class="headerlink" title="DexFile"></a><code>DexFile</code></h3><p>每个 <code>jar, apk, dex</code> 文件对应一个 <code>DexFile</code> 类实例，它用来将对应的文件加载到虚拟机中。  </p>
<ul>
<li>所有的 <code>dex, jar ,apk</code> 文件，最终都是通过 <code>openDexFile</code> 加载到虚拟机中的  </li>
<li>如果是通过 <code>dex</code> 来加载类，最终会走到 <code>defineClass</code> 从虚拟机中加载  </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DexFile</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * If close is called, mCookie becomes null but the internal cookie</span></span><br><span class="line"><span class="comment">   * is preserved if the close failed so that </span></span><br><span class="line"><span class="comment">   * we can free resources in the finalizer.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    <span class="keyword">private</span> Object mCookie;</span><br><span class="line">    <span class="keyword">private</span> Object mInternalCookie;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mFileName;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Class <span class="title">loadClass</span><span class="params">(String name, ClassLoader loader)</span> </span>&#123;</span><br><span class="line">        String slashName = name.replace(<span class="string">'.'</span>, <span class="string">'/'</span>);</span><br><span class="line">        <span class="keyword">return</span> loadClassBinaryName(slashName, loader, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Class <span class="title">loadClassBinaryName</span><span class="params">(String name, ClassLoader loader,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;Throwable&gt; suppressed)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> defineClass(name, loader, mCookie, <span class="keyword">this</span>, suppressed);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Class <span class="title">defineClass</span><span class="params">(String name, ClassLoader loader, </span></span></span><br><span class="line"><span class="function"><span class="params">            Object cookie, DexFile dexFile, List&lt;Throwable&gt; suppressed)</span></span>&#123;</span><br><span class="line">        Class result = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = defineClassNative(name, loader, cookie, dexFile);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoClassDefFoundError e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (suppressed != <span class="keyword">null</span>) &#123;</span><br><span class="line">                suppressed.add(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (suppressed != <span class="keyword">null</span>) &#123;</span><br><span class="line">                suppressed.add(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">openDexFile</span><span class="params">(String sourceName, </span></span></span><br><span class="line"><span class="function"><span class="params">            String outputName, <span class="keyword">int</span> flags, ClassLoader loader, </span></span></span><br><span class="line"><span class="function"><span class="params">            DexPathList.Element[] elements)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// Use absolute paths to enable the use of </span></span><br><span class="line">        <span class="comment">// relative paths when testing on host.</span></span><br><span class="line">        <span class="keyword">return</span> openDexFileNative(<span class="keyword">new</span> File(sourceName).getAbsolutePath(),</span><br><span class="line">                        (outputName == <span class="keyword">null</span>)</span><br><span class="line">                            ? <span class="keyword">null</span></span><br><span class="line">                            : <span class="keyword">new</span> File(outputName).getAbsolutePath(),</span><br><span class="line">                        flags,</span><br><span class="line">                        loader,</span><br><span class="line">                        elements);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">openInMemoryDexFile</span><span class="params">(ByteBuffer buf)</span> </span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (buf.isDirect()) &#123;</span><br><span class="line">            <span class="keyword">return</span> createCookieWithDirectBuffer(buf, </span><br><span class="line">                    buf.position(), buf.limit());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> createCookieWithArray(buf.array(), </span><br><span class="line">                    buf.position(), buf.limit());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> Class <span class="title">defineClassNative</span><span class="params">(String name, </span></span></span><br><span class="line"><span class="function"><span class="params">        ClassLoader loader, Object cookie, DexFile dexFile)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> Object <span class="title">openDexFileNative</span><span class="params">(String sourceName,</span></span></span><br><span class="line"><span class="function"><span class="params">        String outputName, <span class="keyword">int</span> flags, ClassLoader loader, </span></span></span><br><span class="line"><span class="function"><span class="params">        DexPathList.Element[] elements)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> Object <span class="title">createCookieWithDirectBuffer</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ByteBuffer buf, <span class="keyword">int</span> start, <span class="keyword">int</span> end)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> Object <span class="title">createCookieWithArray</span><span class="params">(<span class="keyword">byte</span>[] buf,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> start, <span class="keyword">int</span> end)</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="DexPathList"><a href="#DexPathList" class="headerlink" title="DexPathList"></a><code>DexPathList</code></h3><p>内部类：  </p>
<ul>
<li><code>Element</code><br>可能叫 <code>DexElement</code> 更合适，但是由于历史原因，可能会存在反射调用此类的情形。每个 <code>Element</code> 对应一个 <code>DexFile</code> 文件。  </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*package*/</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Element</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * A file denoting a zip file (in case of a resource jar or a dex jar), </span></span><br><span class="line"><span class="comment">    * or a directory (only when dexFile is null).</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> File path;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DexFile dexFile;</span><br><span class="line">    <span class="keyword">private</span> ClassPathURLStreamHandler urlHandler;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> initialized;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; findClass(String name, ClassLoader definingContext,</span><br><span class="line">            List&lt;Throwable&gt; suppressed) &#123;</span><br><span class="line">        <span class="keyword">return</span> dexFile != <span class="keyword">null</span> </span><br><span class="line">           ? dexFile.loadClassBinaryName(name, definingContext, suppressed)</span><br><span class="line">           : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> URL <span class="title">findResource</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Element element : dexElements) &#123;</span><br><span class="line">            URL url = element.findResource(name);</span><br><span class="line">            <span class="keyword">if</span> (url != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> url;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Enumeration&lt;URL&gt; <span class="title">findResources</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        ArrayList&lt;URL&gt; result = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">for</span> (Element element : dexElements) &#123;</span><br><span class="line">            URL url = element.findResource(name);</span><br><span class="line">            <span class="keyword">if</span> (url != <span class="keyword">null</span>) &#123;</span><br><span class="line">                result.add(url);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> Collections.enumeration(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>NativeLibraryElement</code><br>库文件元素，每个 <code>native lib</code> 对应一个 <code>NativeLibraryElement</code>，可能会包含系统库。  </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Element of the native library path</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/*package*/</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">NativeLibraryElement</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> File path;</span><br><span class="line">    <span class="comment">//If path denotes a zip file, this denotes a base path inside the zip.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String zipDir;</span><br><span class="line">    <span class="keyword">private</span> ClassPathURLStreamHandler urlHandler;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> initialized;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">findNativeLibrary</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        maybeInit();</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (zipDir == <span class="keyword">null</span>) &#123;</span><br><span class="line">            String entryPath = <span class="keyword">new</span> File(path, name).getPath();</span><br><span class="line">            <span class="keyword">if</span> (IoUtils.canOpenReadOnly(entryPath)) &#123;</span><br><span class="line">                <span class="keyword">return</span> entryPath;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (urlHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Having a urlHandler means the element has a zip file.</span></span><br><span class="line">            <span class="comment">// In this case Android supports loading the library iff</span></span><br><span class="line">            <span class="comment">// it is stored in the zip uncompressed.</span></span><br><span class="line">            String entryName = zipDir + <span class="string">'/'</span> + name;</span><br><span class="line">            <span class="keyword">if</span> (urlHandler.isEntryStored(entryName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> path.getPath() + zipSeparator + entryName;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>DexPathList</code> 是对两个内部类的一个封装，表示每个对象可以包含多个可执行文件 <code>dex, jar, apk</code> 等；同时每个对象可以包含多个库文件等。  </p>
<ul>
<li><code>Elements[]</code> 数组包含了所有的 <code>dex, jar, apk</code> 文件，热补丁技术通常是从这里 <code>inject</code>  </li>
<li><code>findClass</code> 最终通过 <code>DexFile</code> 从虚拟机中加载  </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*package*/</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DexPathList</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassLoader definingContext;</span><br><span class="line">    <span class="keyword">private</span> Element[] dexElements;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> NativeLibraryElement[] nativeLibraryPathElements;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DexPathList</span><span class="params">(ClassLoader definingContext, </span></span></span><br><span class="line"><span class="function"><span class="params">        ByteBuffer[] dexFiles)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">this</span>.definingContext = definingContext;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">this</span>.nativeLibraryPathElements = </span><br><span class="line">            makePathElements(<span class="keyword">this</span>.systemNativeLibraryDirectories);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">this</span>.dexElements = </span><br><span class="line">            makeInMemoryDexElements(dexFiles, suppressedExceptions);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DexPathList</span><span class="params">(ClassLoader definingContext, String dexPath,</span></span></span><br><span class="line"><span class="function"><span class="params">        String librarySearchPath, File optimizedDirectory)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">this</span>.definingContext = definingContext;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">this</span>.dexElements = makeDexElements(splitDexPath(dexPath), </span><br><span class="line">            optimizedDirectory, suppressedExceptions, definingContext);</span><br><span class="line">        ...</span><br><span class="line">        List&lt;File&gt; allNativeLibraryDirectories = </span><br><span class="line">            <span class="keyword">new</span> ArrayList&lt;&gt;(nativeLibraryDirectories);</span><br><span class="line">        allNativeLibraryDirectories.addAll(systemNativeLibraryDirectories);</span><br><span class="line">        <span class="keyword">this</span>.nativeLibraryPathElements = </span><br><span class="line">            makePathElements(allNativeLibraryDirectories);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Element[] makeInMemoryDexElements(ByteBuffer[] dexFiles,</span><br><span class="line">            List&lt;IOException&gt; suppressedExceptions) &#123;</span><br><span class="line">        Element[] elements = <span class="keyword">new</span> Element[dexFiles.length];</span><br><span class="line">        <span class="keyword">int</span> elementPos = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (ByteBuffer buf : dexFiles) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                DexFile dex = <span class="keyword">new</span> DexFile(buf);</span><br><span class="line">                elements[elementPos++] = <span class="keyword">new</span> Element(dex);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException suppressed) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (elementPos != elements.length) &#123;</span><br><span class="line">            elements = Arrays.copyOf(elements, elementPos);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> elements;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Element[] makeDexElements(List&lt;File&gt; files, </span><br><span class="line">        File optimizedDirectory, List&lt;IOException&gt; suppressedExceptions,</span><br><span class="line">        ClassLoader loader) &#123;</span><br><span class="line">      Element[] elements = <span class="keyword">new</span> Element[files.size()];</span><br><span class="line">      <span class="keyword">int</span> elementsPos = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">          <span class="keyword">if</span> (file.isDirectory()) &#123;</span><br><span class="line">            ...</span><br><span class="line">            elements[elementsPos++] = <span class="keyword">new</span> Element(file);</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (file.isFile()) &#123;</span><br><span class="line">              String name = file.getName();</span><br><span class="line">              <span class="keyword">if</span> (name.endsWith(DEX_SUFFIX)) &#123;</span><br><span class="line">                <span class="comment">// Raw dex file (not inside a zip/jar).</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    DexFile dex = loadDexFile(file, </span><br><span class="line">                        optimizedDirectory, loader, elements);</span><br><span class="line">                    <span class="keyword">if</span> (dex != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        elements[elementsPos++] = </span><br><span class="line">                            <span class="keyword">new</span> Element(dex, <span class="keyword">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException suppressed) &#123;</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  DexFile dex = <span class="keyword">null</span>;</span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                      dex = loadDexFile(file, optimizedDirectory, </span><br><span class="line">                        loader, elements);</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (IOException suppressed) &#123;</span><br><span class="line">                      ...</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">                  <span class="keyword">if</span> (dex == <span class="keyword">null</span>) &#123;</span><br><span class="line">                      elements[elementsPos++] = <span class="keyword">new</span> Element(file);</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      elements[elementsPos++] = <span class="keyword">new</span> Element(dex, file);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              ...</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">return</span> elements;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> DexFile <span class="title">loadDexFile</span><span class="params">(File file, File optimizedDirectory,</span></span></span><br><span class="line"><span class="function"><span class="params">        ClassLoader loader, Element[] elements)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (optimizedDirectory == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> DexFile(file, loader, elements);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String optimizedPath = </span><br><span class="line">                optimizedPathFor(file, optimizedDirectory);</span><br><span class="line">            <span class="keyword">return</span> DexFile.loadDex(file.getPath(), </span><br><span class="line">                optimizedPath, <span class="number">0</span>, loader, elements);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Element[] makePathElements(List&lt;File&gt; files, </span><br><span class="line">        File optimizedDirectory, List&lt;IOException&gt; suppressedExceptions) &#123;</span><br><span class="line">        <span class="keyword">return</span> makeDexElements(files, optimizedDirectory, </span><br><span class="line">            suppressedExceptions, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> NativeLibraryElement[] makePathElements(</span><br><span class="line">        List&lt;File&gt; files) &#123;</span><br><span class="line">        NativeLibraryElement[] elements = </span><br><span class="line">            <span class="keyword">new</span> NativeLibraryElement[files.size()];</span><br><span class="line">        <span class="keyword">int</span> elementsPos = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">            String path = file.getPath();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (path.contains(zipSeparator)) &#123;</span><br><span class="line">                String split[] = path.split(zipSeparator, <span class="number">2</span>);</span><br><span class="line">                File zip = <span class="keyword">new</span> File(split[<span class="number">0</span>]);</span><br><span class="line">                String dir = split[<span class="number">1</span>];</span><br><span class="line">                elements[elementsPos++] = </span><br><span class="line">                    <span class="keyword">new</span> NativeLibraryElement(zip, dir);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (file.isDirectory()) &#123;</span><br><span class="line">                elements[elementsPos++] = </span><br><span class="line">                    <span class="keyword">new</span> NativeLibraryElement(file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (elementsPos != elements.length) &#123;</span><br><span class="line">            elements = Arrays.copyOf(elements, elementsPos);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> elements;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; findClass(String name, List&lt;Throwable&gt; suppressed) &#123;</span><br><span class="line">        <span class="comment">// 类查找过程是变量 Elements 数组，只要查到了就返回</span></span><br><span class="line">        <span class="comment">// 热补丁正是利用这个特性，将 patch 插入 Elements 数组的第一个中</span></span><br><span class="line">        <span class="comment">// 即使原先包内有 bug 但不会被加载</span></span><br><span class="line">        <span class="keyword">for</span> (Element element : dexElements) &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = element.findClass(name, </span><br><span class="line">                definingContext, suppressed);</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dexElementsSuppressedExceptions != <span class="keyword">null</span>) &#123;</span><br><span class="line">            suppressed.addAll(Arrays.asList(</span><br><span class="line">                dexElementsSuppressedExceptions));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Android-预加载"><a href="#Android-预加载" class="headerlink" title="Android 预加载"></a><code>Android</code> 预加载</h2><p>系统开机启动会在 <code>ZygoteInit</code> 进程创建 <code>Java</code> 环境，预加载系统常用类，并创建系统的类加载器 <code>PathClassLoader</code> 。  </p>
<h3 id="启动路径和系统服务路径"><a href="#启动路径和系统服务路径" class="headerlink" title="启动路径和系统服务路径"></a>启动路径和系统服务路径</h3><p>启动路径 <code>BOOTCLASSPATH</code> 和系统服务路径 <code>SYSTEMSERVERCLASSPATH</code> 最终都是写入 <code>./root/init.environ.rc</code> 文件的。  </p>
<ul>
<li><p><code>BOOTCLASSPATH</code><br>编译系统中 <code>PRODUCT_BOOT_JARS</code> 中添加的 <code>jar</code> 包名和路径对应生成的，包含所有 <code>framework</code> 相关 <code>jar</code> 包路径。<code>PRODUCT_BOOT_JARS</code> 最终被编译添加到 <code>BOOTCLASSPATH</code> 变量中，组建过程：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./device/qcom/common/base.mk</span><br><span class="line">./build/make/core/envsetup.mk</span><br><span class="line">./build/make/target/product/core_minimal.mk</span><br><span class="line">./device/qcom/common/common.mk</span><br><span class="line">./device/qcom/custom/custom.mk</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>SYSTEMSERVERCLASSPATH</code><br>在 <code>build/make/target/product/core_minimal.mk</code> 文件中定义的 <code>PRODUCT_SYSTEM_SERVER_JARS</code> 变量，会在 <code>system/core/rootdir/Android.mk</code> 中生成 <code>SYSTEMSERVERCLASSPATH</code> 变量。</p>
</li>
</ul>
<p><code>./root/init.environ.rc</code> 文件中这两个变量的内容为：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export BOOTCLASSPATH /system/framework/com.qualcomm.qti.camera.jar:/system/framework/QPerformance.jar:/system/framework/core-oj.jar:/system/framework/core-libart.jar:/system/framework/conscrypt.jar:/system/framework/okhttp.jar:/system/framework/bouncycastle.jar:/system/framework/apache-xml.jar:/system/framework/legacy-test.jar:/system/framework/ext.jar:/system/framework/framework.jar:/system/framework/telephony-common.jar:/system/framework/voip-common.jar:/system/framework/ims-common.jar:/system/framework/org.apache.http.legacy.boot.jar:/system/framework/android.hidl.base-V1.0-java.jar:/system/framework/android.hidl.manager-V1.0-java.jar:/system/framework/qcrilhook.jar:/system/framework/hiqmi.jar:/system/framework/qcnvitems.jar:/system/framework/telephony-qmi.jar:/system/framework/tcmiface.jar:/system/framework/WfdCommon.jar:/system/framework/oem-services.jar:/system/framework/qcom.fmradio.jar:/system/framework/telephony-ext.jar</span><br><span class="line">export SYSTEMSERVERCLASSPATH /system/framework/services.jar:/system/framework/ethernet-service.jar:/system/framework/wifi-service.jar:/system/framework/com.android.location.provider.jar</span><br></pre></td></tr></table></figure>

<h3 id="预加载类-preloadClasses"><a href="#预加载类-preloadClasses" class="headerlink" title="预加载类 preloadClasses"></a>预加载类 <code>preloadClasses</code></h3><p>预加载的类大概有 4500+ 个系统常用类，采用的是空间换时间的策略：系统开机时就将常用类加载，后续应用使用时不用重复加载，提高应用运行速度。<br>设置预加载的文件为 <code>preloaded-classes</code> ：<br> <code>AOSP</code> 源码路径为：<code>preloaded-classes: frameworks/base/config/preloaded-classes</code><br>编译完后会被拷贝到：<code>./system/etc/preloaded-classes</code> ；文件中指定需要加载的常见系统类：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">android.app.Activity$HostCallbacks</span><br><span class="line">android.app.ActivityManager</span><br><span class="line">android.app.ActivityManager$1</span><br><span class="line">android.app.ActivityManager$AppTask</span><br><span class="line">...</span><br><span class="line">android.app.ActivityManager$TaskDescription$1</span><br><span class="line">android.app.ActivityOptions</span><br><span class="line">android.app.ActivityThread</span><br><span class="line">android.app.ActivityThread$1</span><br><span class="line">...</span><br><span class="line">android.app.ContentProviderHolder$1</span><br><span class="line">android.app.ContextImpl</span><br><span class="line">android.app.ContextImpl$1</span><br><span class="line">...</span><br><span class="line">android.app.DexLoadReporter</span><br><span class="line">android.app.Dialog</span><br><span class="line">android.app.Dialog$ListenersHandler</span><br><span class="line">android.app.DialogFragment</span><br><span class="line">android.app.DownloadManager</span><br><span class="line">android.app.Fragment</span><br><span class="line">android.app.Fragment$1</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>预加载类流程图：  </p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-prloaded-classes.png" alt="0108-android-classloading-prloaded-classes.png"></p>
<h3 id="创建系统类加载器"><a href="#创建系统类加载器" class="headerlink" title="创建系统类加载器"></a>创建系统类加载器</h3><p><code>Android</code> 默认的系统类加载器为 <code>PathClassLoader</code> ，也是在系统启动阶段 <code>ZygoteInit</code> 中创建的，并加载系统服务的 <code>jar</code> 。<br>创建系统类加载器 <code>PathClassLoader</code> ，并加载系统服务 <code>jar</code> 文件流程图：  </p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-create-pathclassloader.png" alt="0108-android-classloading-create-pathclassloader.png"></p>
<p><code>ZygoteInit</code> 处理系统服务进程中，除了生成系统类加载器 <code>PathClassLoader</code> ，并会通过该加载器反射调用 <code>SystemServer.main</code> 方法，启动系统服务进程 <code>system_server</code> 进程，管理整个系统的所有服务。  </p>
<h2 id="APK-及四大组件加载过程"><a href="#APK-及四大组件加载过程" class="headerlink" title="APK 及四大组件加载过程"></a><code>APK</code> 及四大组件加载过程</h2><h3 id="APK-加载过程"><a href="#APK-加载过程" class="headerlink" title="APK 加载过程"></a><code>APK</code> 加载过程</h3><p><code>LoadedApk</code> 类是整个应用 <code>APK</code> 加载的入口类，最终在类加载器工厂中 <code>ClassLoaderFactory.java</code> 创建具体的加载器 <code>PathClassLoader</code> 。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ClassLoaderFactory.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ClassLoader <span class="title">createClassLoader</span><span class="params">(String dexPath,</span></span></span><br><span class="line"><span class="function"><span class="params">      String librarySearchPath, ClassLoader parent, String classloaderName)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isPathClassLoaderName(classloaderName)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PathClassLoader(dexPath, librarySearchPath, parent);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDelegateLastClassLoaderName(classloaderName)) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> DelegateLastClassLoader(dexPath,librarySearchPath,parent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Invalid classLoaderName: "</span> + classloaderName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用序列图：  </p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-load-apk.png" alt="0108-android-classloading-load-apk.png"></p>
<p>部分 <code>Log</code> 打印：  </p>
<ul>
<li><code>ZygoteInit</code> 新建应用进程  </li>
<li><code>ActivityThread</code> 线程启动进入 <code>main</code> 入口：<code>AMS.attachApplication</code> 启动应用以及进入 <code>Looper.loop()</code> 循环接受主线程消息  </li>
<li><code>AMS.attachApplication</code> 会调用 <code>ActivityThread.bindApplication</code> 启动并绑定该应用  </li>
<li><code>ContextImpl</code> 第一次加载应用时，调用 <code>PathClassLoader</code> 加载整个应用 <code>APK</code>  </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. AMS.attachApplication</span></span><br><span class="line">*: V/ActivityManager(<span class="number">1696</span>): New app record ProcessRecord&#123;<span class="number">5515589</span> <span class="number">3528</span>:com.*.knowledge/u0a76&#125; thread=android.os.BinderProxy<span class="meta">@ca</span>7598e pid=<span class="number">3528</span>, processName = com.*.knowledge, appInfo = ApplicationInfo&#123;<span class="number">8</span>c27ebf com.*.knowledge&#125;</span><br><span class="line">*: V/ActivityManager(<span class="number">1696</span>): java.lang.RuntimeException</span><br><span class="line">*: V/ActivityManager(<span class="number">1696</span>): 	at com.android.server.am.ActivityManagerService.attachApplicationLocked(ActivityManagerService.java:<span class="number">7258</span>)</span><br><span class="line">*: V/ActivityManager(<span class="number">1696</span>): 	at com.android.server.am.ActivityManagerService.attachApplication(ActivityManagerService.java:<span class="number">7377</span>)</span><br><span class="line">*: V/ActivityManager(<span class="number">1696</span>): 	at android.app.IActivityManager$Stub.onTransact(IActivityManager.java:<span class="number">291</span>)</span><br><span class="line">*: V/ActivityManager(<span class="number">1696</span>): 	at com.android.server.am.ActivityManagerService.onTransact(ActivityManagerService.java:<span class="number">2971</span>)</span><br><span class="line">*: V/ActivityManager(<span class="number">1696</span>): 	at android.os.Binder.execTransact(Binder.java:<span class="number">697</span>)</span><br><span class="line"><span class="comment">// 2. AMS.bindApplication</span></span><br><span class="line">*: V/ActivityThread(<span class="number">3528</span>): bindApplication: processName = com.*.knowledge, instrumentationName =  <span class="keyword">null</span>, appInfo = ApplicationInfo&#123;<span class="number">159</span>d166 com.*.knowledge&#125;</span><br><span class="line">*: V/ActivityThread(<span class="number">3528</span>): java.lang.RuntimeException</span><br><span class="line">*: V/ActivityThread(<span class="number">3528</span>): 	at android.app.ActivityThread$ApplicationThread.bindApplication(ActivityThread.java:<span class="number">919</span>)</span><br><span class="line">*: V/ActivityThread(<span class="number">3528</span>): 	at android.app.IApplicationThread$Stub.onTransact(IApplicationThread.java:<span class="number">374</span>)</span><br><span class="line">*: V/ActivityThread(<span class="number">3528</span>): 	at android.os.Binder.execTransact(Binder.java:<span class="number">697</span>)</span><br><span class="line">...</span><br><span class="line">*: W/ActivityManager(<span class="number">1696</span>): Slow operation: <span class="number">133</span>ms so far, now at attachApplicationLocked: after mServices.attachApplicationLocked</span><br><span class="line">*: W/Looper(<span class="number">1696</span>): Dispatch took <span class="number">135</span>ms on android.ui, h=Handler (com.android.server.am.ActivityManagerService$UiHandler) &#123;<span class="number">782</span>d25f&#125; cb=<span class="keyword">null</span> msg=<span class="number">53</span></span><br><span class="line"><span class="comment">// 3. ActivityThread.handleBindApplication 处理应用绑定</span></span><br><span class="line">*: V/ActivityThread(<span class="number">3528</span>): Class path: /data/app/com.*.knowledge-kLwif9bg7jNq6haatwl4ZQ==/base.apk, JNI path: /data/app/com.*.knowledge-kLwif9bg7jNq6haatwl4ZQ==/lib/arm64</span><br><span class="line"><span class="comment">// 4. PathClassLoader 调用过程堆栈</span></span><br><span class="line">*: E/System(<span class="number">3528</span>): XMT, sourceName = /data/app/com.*.knowledge-kLwif9bg7jNq6haatwl4ZQ==/base.apk, outputName = <span class="keyword">null</span>, classloader = dalvik.system.PathClassLoader[<span class="keyword">null</span>]</span><br><span class="line">*: E/System(<span class="number">3528</span>): java.lang.Exception</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at dalvik.system.DexFile.openDexFile(DexFile.java:<span class="number">354</span>)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at dalvik.system.DexFile.&lt;init&gt;(DexFile.java:<span class="number">100</span>)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at dalvik.system.DexFile.&lt;init&gt;(DexFile.java:<span class="number">74</span>)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at dalvik.system.DexPathList.loadDexFile(DexPathList.java:<span class="number">374</span>)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at dalvik.system.DexPathList.makeDexElements(DexPathList.java:<span class="number">337</span>)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at dalvik.system.DexPathList.&lt;init&gt;(DexPathList.java:<span class="number">157</span>)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at dalvik.system.BaseDexClassLoader.&lt;init&gt;(BaseDexClassLoader.java:<span class="number">65</span>)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at dalvik.system.PathClassLoader.&lt;init&gt;(PathClassLoader.java:<span class="number">64</span>)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at com.android.internal.os.ClassLoaderFactory.createClassLoader(ClassLoaderFactory.java:<span class="number">73</span>)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at com.android.internal.os.ClassLoaderFactory.createClassLoader(ClassLoaderFactory.java:<span class="number">88</span>)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at android.app.ApplicationLoaders.getClassLoader(ApplicationLoaders.java:<span class="number">69</span>)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at android.app.ApplicationLoaders.getClassLoader(ApplicationLoaders.java:<span class="number">35</span>)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at android.app.LoadedApk.createOrUpdateClassLoaderLocked(LoadedApk.java:<span class="number">693</span>)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at android.app.LoadedApk.getClassLoader(LoadedApk.java:<span class="number">727</span>)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at android.app.LoadedApk.getResources(LoadedApk.java:<span class="number">954</span>)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at android.app.ContextImpl.createAppContext(ContextImpl.java:<span class="number">2270</span>)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at android.app.ActivityThread.handleBindApplication(ActivityThread.java:<span class="number">5658</span>)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at android.app.ActivityThread.-wrap1(Unknown Source:<span class="number">0</span>)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at android.app.ActivityThread$H.handleMessage(ActivityThread.java:<span class="number">1663</span>)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at android.os.Handler.dispatchMessage(Handler.java:<span class="number">106</span>)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at android.os.Looper.loop(Looper.java:<span class="number">164</span>)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at android.app.ActivityThread.main(ActivityThread.java:<span class="number">6522</span>)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:<span class="number">438</span>)</span><br><span class="line">*: E/System(<span class="number">3528</span>): 	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:<span class="number">807</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Application-类加载过程"><a href="#Application-类加载过程" class="headerlink" title="Application 类加载过程"></a><code>Application</code> 类加载过程</h3><p>在 <code>ActivityThread.handleBindApplication</code> 除了加载 <code>APK</code> 外，还加载了 <code>Application</code> 类并启动这个应用；最终调用 <code>Instrumentation.newApplication</code> 来加载 <code>Application</code> 类的：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Instrumentation.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Application <span class="title">newApplication</span><span class="params">(ClassLoader cl, String className, </span></span></span><br><span class="line"><span class="function"><span class="params">        Context context)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InstantiationException, IllegalAccessException, </span></span><br><span class="line"><span class="function">        ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> newApplication(cl.loadClass(className), context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用序列图：  </p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-load-application.png" alt="0108-android-classloading-load-application.png"></p>
<p>部分 <code>Log</code> 打印：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// Application 类加载过程</span><br><span class="line">*: E/System(23352): XMT, ClassLoader.loadClass, name = com.*.knowledge.KnowledgeApplication, resolve = false</span><br><span class="line">*: E/System(23352): XMT, ClassLoader.findLoadedClass, name = com.*.knowledge.KnowledgeApplication, this = dalvik.system.PathClassLoader[DexPathList[[zip file &quot;/data/app/com.*.knowledge-kLwif9bg7jNq6haatwl4ZQ==/base.apk&quot;],nativeLibraryDirectories=[/data/app/com.*.knowledge-kLwif9bg7jNq6haatwl4ZQ==/lib/arm64, /system/lib64, /vendor/lib64]]]</span><br><span class="line">*: E/System(23352): java.lang.Exception</span><br><span class="line">*: E/System(23352): 	at java.lang.ClassLoader.findLoadedClass(ClassLoader.java:735)</span><br><span class="line">*: E/System(23352): 	at java.lang.ClassLoader.loadClass(ClassLoader.java:364)</span><br><span class="line">*: E/System(23352): 	at java.lang.ClassLoader.loadClass(ClassLoader.java:312)</span><br><span class="line">*: E/System(23352): 	at android.app.Instrumentation.newApplication(Instrumentation.java:1088)</span><br><span class="line">*: E/System(23352): 	at android.app.LoadedApk.makeApplication(LoadedApk.java:983)</span><br><span class="line">*: E/System(23352): 	at android.app.ActivityThread.handleBindApplication(ActivityThread.java:5734)</span><br><span class="line">*: E/System(23352): 	at android.app.ActivityThread.-wrap1(Unknown Source:0)</span><br><span class="line">*: E/System(23352): 	at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1663)</span><br><span class="line">*: E/System(23352): 	at android.os.Handler.dispatchMessage(Handler.java:106)</span><br><span class="line">*: E/System(23352): 	at android.os.Looper.loop(Looper.java:164)</span><br><span class="line">*: E/System(23352): 	at android.app.ActivityThread.main(ActivityThread.java:6522)</span><br><span class="line">*: E/System(23352): 	at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">*: E/System(23352): 	at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:438)</span><br><span class="line">*: E/System(23352): 	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:807)</span><br><span class="line">*: E/System(23352): XMT, ClassLoader.loadClass, c = class com.*.knowledge.KnowledgeApplication, parent = java.lang.BootClassLoader@b40a08c</span><br></pre></td></tr></table></figure>

<h3 id="Activity-类加载过程"><a href="#Activity-类加载过程" class="headerlink" title="Activity 类加载过程"></a><code>Activity</code> 类加载过程</h3><p>不管是在启动应用时启动主 <code>Activity</code> ，还是当前 <code>Activity</code> 打开另一个 <code>Activity</code> 时，最终都是通过 <code>ActivityStackSupervisor.realStartActivityLocked</code> 来调用 <code>Activity.scheduleLaunchActivity</code> 来启动指定 <code>Activity</code> ；而每个 <code>Activity</code> 是在 <code>Instrumentation.newActivity</code> 中来加载的：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Instrumentation.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Activity <span class="title">newActivity</span><span class="params">(ClassLoader cl, String className,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InstantiationException, IllegalAccessException,</span></span><br><span class="line"><span class="function">        ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (Activity)cl.loadClass(className).newInstance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用序列图：  </p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-load-activity.png" alt="0108-android-classloading-load-activity.png"></p>
<p>部分 <code>Log</code> 打印：  </p>
<ul>
<li>上半部分为启动主 <code>Activity</code>  </li>
<li>下半部分为打开另一个 <code>Activity</code>  </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">// 1. 启动主 Activity</span><br><span class="line">*: V/ActivityManager(1508): realStartActivityLocked, r = ActivityRecord&#123;4d4a239 u0 com.*.knowledge/.MainActivity t57&#125;</span><br><span class="line">*: V/ActivityManager(1508): java.lang.RuntimeException</span><br><span class="line">*: V/ActivityManager(1508): 	at com.android.server.am.ActivityStackSupervisor.realStartActivityLocked(ActivityStackSupervisor.java:1466)</span><br><span class="line">*: V/ActivityManager(1508): 	at com.android.server.am.ActivityStackSupervisor.attachApplicationLocked(ActivityStackSupervisor.java:983)</span><br><span class="line">*: V/ActivityManager(1508): 	at com.android.server.am.ActivityManagerService.attachApplicationLocked(ActivityManagerService.java:7310)</span><br><span class="line">*: V/ActivityManager(1508): 	at com.android.server.am.ActivityManagerService.attachApplication(ActivityManagerService.java:7377)</span><br><span class="line">*: V/ActivityManager(1508): 	at android.app.IActivityManager$Stub.onTransact(IActivityManager.java:291)</span><br><span class="line">*: V/ActivityManager(1508): 	at com.android.server.am.ActivityManagerService.onTransact(ActivityManagerService.java:2971)</span><br><span class="line">*: V/ActivityManager(1508): 	at android.os.Binder.execTransact(Binder.java:697)</span><br><span class="line">...</span><br><span class="line">// Activity 类加载过程</span><br><span class="line">*: V/ActivityThread(4162): scheduleLaunchActivity, info = ActivityInfo&#123;a9454ac com.*.knowledge.MainActivity&#125;</span><br><span class="line">*: D/:XMT:KnowApplication:(4162): onCreate: </span><br><span class="line">*: E/System(4162): XMT, ClassLoader.loadClass, name = com.*.knowledge.MainActivity, resolve = false</span><br><span class="line">*: E/System(4162): XMT, ClassLoader.findLoadedClass, name = com.*.knowledge.MainActivity, this = dalvik.system.PathClassLoader[DexPathList[[zip file &quot;/data/app/com.*.knowledge-kLwif9bg7jNq6haatwl4ZQ==/base.apk&quot;],nativeLibraryDirectories=[/data/app/com.*.knowledge-kLwif9bg7jNq6haatwl4ZQ==/lib/arm64, /system/lib64, /vendor/lib64]]]</span><br><span class="line">*: E/System(4162): java.lang.Exception</span><br><span class="line">*: E/System(4162): 	at java.lang.ClassLoader.findLoadedClass(ClassLoader.java:735)</span><br><span class="line">*: E/System(4162): 	at java.lang.ClassLoader.loadClass(ClassLoader.java:364)</span><br><span class="line">*: E/System(4162): 	at java.lang.ClassLoader.loadClass(ClassLoader.java:312)</span><br><span class="line">*: E/System(4162): 	at android.app.Instrumentation.newActivity(Instrumentation.java:1175)</span><br><span class="line">*: E/System(4162): 	at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2678)</span><br><span class="line">*: E/System(4162): 	at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2865)</span><br><span class="line">*: E/System(4162): 	at android.app.ActivityThread.-wrap11(Unknown Source:0)</span><br><span class="line">*: E/System(4162): 	at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1598)</span><br><span class="line">*: E/System(4162): 	at android.os.Handler.dispatchMessage(Handler.java:106)</span><br><span class="line">*: E/System(4162): 	at android.os.Looper.loop(Looper.java:164)</span><br><span class="line">*: E/System(4162): 	at android.app.ActivityThread.main(ActivityThread.java:6524)</span><br><span class="line">*: E/System(4162): 	at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">*: E/System(4162): 	at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:438)</span><br><span class="line">*: E/System(4162): 	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:807)</span><br><span class="line">*: E/System(4162): XMT, ClassLoader.loadClass, c = class com.*.knowledge.MainActivity, parent = java.lang.BootClassLoader@11b61a</span><br><span class="line">...</span><br><span class="line">// 2. 应用已经启动后，打开其他 Activity 流程  </span><br><span class="line">*: V/ActivityManager(1508): realStartActivityLocked, r = ActivityRecord&#123;6a96a51 u0 com.*.knowledge/.fourcomponents.ShowService t57&#125;</span><br><span class="line">*: V/ActivityManager(1508): java.lang.RuntimeException</span><br><span class="line">*: V/ActivityManager(1508): 	at com.android.server.am.ActivityStackSupervisor.realStartActivityLocked(ActivityStackSupervisor.java:1466)</span><br><span class="line">*: V/ActivityManager(1508): 	at com.android.server.am.ActivityStackSupervisor.startSpecificActivityLocked(ActivityStackSupervisor.java:1589)</span><br><span class="line">*: V/ActivityManager(1508): 	at com.android.server.am.ActivityStack.resumeTopActivityInnerLocked(ActivityStack.java:2752)</span><br><span class="line">*: V/ActivityManager(1508): 	at com.android.server.am.ActivityStack.resumeTopActivityUncheckedLocked(ActivityStack.java:2265)</span><br><span class="line">*: V/ActivityManager(1508): 	at com.android.server.am.ActivityStackSupervisor.resumeFocusedStackTopActivityLocked(ActivityStackSupervisor.java:2103)</span><br><span class="line">*: V/ActivityManager(1508): 	at com.android.server.am.ActivityStack.completePauseLocked(ActivityStack.java:1496)</span><br><span class="line">*: V/ActivityManager(1508): 	at com.android.server.am.ActivityStack.activityPausedLocked(ActivityStack.java:1423)</span><br><span class="line">*: V/ActivityManager(1508): 	at com.android.server.am.ActivityManagerService.activityPaused(ActivityManagerService.java:7634)</span><br><span class="line">*: V/ActivityManager(1508): 	at android.app.IActivityManager$Stub.onTransact(IActivityManager.java:317)</span><br><span class="line">*: V/ActivityManager(1508): 	at com.android.server.am.ActivityManagerService.onTransact(ActivityManagerService.java:2971)</span><br><span class="line">*: V/ActivityManager(1508): 	at android.os.Binder.execTransact(Binder.java:697)</span><br><span class="line">*: V/ActivityThread(4162): scheduleLaunchActivity, info = ActivityInfo&#123;59de479 com.*.knowledge.fourcomponents.ShowService&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Service-类加载过程"><a href="#Service-类加载过程" class="headerlink" title="Service 类加载过程"></a><code>Service</code> 类加载过程</h3><p>不管 <code>Service</code> 是否设置新进程，也不管是 <code>startService</code> 还是 <code>bindService</code> ，系统都是在 <code>ActivityThread.handleCreateService</code> 中加载 <code>Service</code> 类的。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityThread.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCreateService</span><span class="params">(CreateServiceData data)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    LoadedApk packageInfo = getPackageInfoNoCheck(</span><br><span class="line">            data.info.applicationInfo, data.compatInfo);</span><br><span class="line">    Service service = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        java.lang.ClassLoader cl = packageInfo.getClassLoader();</span><br><span class="line">        service = (Service) cl.loadClass(data.info.name).newInstance();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>bindService</code> 的调用序列图：  </p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-load-service.png" alt="0108-android-classloading-load-service.png"></p>
<p>部分 <code>Log</code> 打印：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// 1. ComtextImpl.bindService 开始进入 AMS</span><br><span class="line">*: V/ActivityManager(1508): requestServiceBindingLocked</span><br><span class="line">*: V/ActivityManager(1508): java.lang.RuntimeException</span><br><span class="line">*: V/ActivityManager(1508): 	at com.android.server.am.ActiveServices.requestServiceBindingLocked(ActiveServices.java:1856)</span><br><span class="line">*: V/ActivityManager(1508): 	at com.android.server.am.ActiveServices.requestServiceBindingsLocked(ActiveServices.java:2260)</span><br><span class="line">*: V/ActivityManager(1508): 	at com.android.server.am.ActiveServices.realStartServiceLocked(ActiveServices.java:2335)</span><br><span class="line">*: V/ActivityManager(1508): 	at com.android.server.am.ActiveServices.bringUpServiceLocked(ActiveServices.java:2187)</span><br><span class="line">*: V/ActivityManager(1508): 	at com.android.server.am.ActiveServices.bindServiceLocked(ActiveServices.java:1442)</span><br><span class="line">*: V/ActivityManager(1508): 	at com.android.server.am.ActivityManagerService.bindService(ActivityManagerService.java:18625)</span><br><span class="line">*: V/ActivityManager(1508): 	at android.app.IActivityManager$Stub.onTransact(IActivityManager.java:584)</span><br><span class="line">*: V/ActivityManager(1508): 	at com.android.server.am.ActivityManagerService.onTransact(ActivityManagerService.java:2971)</span><br><span class="line">*: V/ActivityManager(1508): 	at android.os.Binder.execTransact(Binder.java:697)</span><br><span class="line">// 2. 调用 ActivityThread.scheduleBindService </span><br><span class="line">*: V/ActivityThread(4162): scheduleBindService</span><br><span class="line">*: V/ActivityThread(4162): java.lang.RuntimeException</span><br><span class="line">*: V/ActivityThread(4162): 	at android.app.ActivityThread$ApplicationThread.scheduleBindService(ActivityThread.java:863)</span><br><span class="line">*: V/ActivityThread(4162): 	at android.app.IApplicationThread$Stub.onTransact(IApplicationThread.java:439)</span><br><span class="line">*: V/ActivityThread(4162): 	at android.os.Binder.execTransact(Binder.java:697)</span><br><span class="line">// 3. Service 类加载过程</span><br><span class="line">*: E/System(4162): XMT, ClassLoader.loadClass, name = com.*.knowledge.fourcomponents.BindService, resolve = false</span><br><span class="line">*: E/System(4162): XMT, ClassLoader.findLoadedClass, name = com.*.knowledge.fourcomponents.BindService, this = dalvik.system.PathClassLoader[DexPathList[[zip file &quot;/data/app/com.*.knowledge-kLwif9bg7jNq6haatwl4ZQ==/base.apk&quot;],nativeLibraryDirectories=[/data/app/com.*.knowledge-kLwif9bg7jNq6haatwl4ZQ==/lib/arm64, /system/lib64, /vendor/lib64]]]</span><br><span class="line">*: E/System(4162): java.lang.Exception</span><br><span class="line">*: E/System(4162): 	at java.lang.ClassLoader.findLoadedClass(ClassLoader.java:735)</span><br><span class="line">*: E/System(4162): 	at java.lang.ClassLoader.loadClass(ClassLoader.java:364)</span><br><span class="line">*: E/System(4162): 	at java.lang.ClassLoader.loadClass(ClassLoader.java:312)</span><br><span class="line">*: E/System(4162): 	at android.app.ActivityThread.handleCreateService(ActivityThread.java:3330)</span><br><span class="line">*: E/System(4162): 	at android.app.ActivityThread.-wrap4(Unknown Source:0)</span><br><span class="line">*: E/System(4162): 	at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1686)</span><br><span class="line">*: E/System(4162): 	at android.os.Handler.dispatchMessage(Handler.java:106)</span><br><span class="line">*: E/System(4162): 	at android.os.Looper.loop(Looper.java:164)</span><br><span class="line">*: E/System(4162): 	at android.app.ActivityThread.main(ActivityThread.java:6524)</span><br><span class="line">*: E/System(4162): 	at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">*: E/System(4162): 	at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:438)</span><br><span class="line">*: E/System(4162): 	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:807)</span><br><span class="line">*: E/System(4162): XMT, ClassLoader.loadClass, c = class com.*.knowledge.fourcomponents.BindService, parent = java.lang.BootClassLoader@11b61a</span><br><span class="line">*: D/:XMT:BindService:(4162): onCreate: </span><br><span class="line">*: D/:XMT:BindService:(4162): onBind:</span><br></pre></td></tr></table></figure>

<h3 id="静态注册-BroadcastReceiver-类加载过程"><a href="#静态注册-BroadcastReceiver-类加载过程" class="headerlink" title="静态注册 BroadcastReceiver 类加载过程"></a>静态注册 <code>BroadcastReceiver</code> 类加载过程</h3><p>静态注册的广播接收器是在 <code>ActivityThread.handleReceiver</code> 中响应广播事件，并加载对应的 <code>BroadcastReceiver</code> 类的：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityThread.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleReceiver</span><span class="params">(ReceiverData data)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    String component = data.intent.getComponent().getClassName();</span><br><span class="line">    LoadedApk packageInfo = getPackageInfoNoCheck(</span><br><span class="line">            data.info.applicationInfo, data.compatInfo);</span><br><span class="line">    IActivityManager mgr = ActivityManager.getService();</span><br><span class="line">    Application app;</span><br><span class="line">    BroadcastReceiver receiver;</span><br><span class="line">    ContextImpl context;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        app = packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line">        context = (ContextImpl) app.getBaseContext();</span><br><span class="line">        <span class="keyword">if</span> (data.info.splitName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            context = (ContextImpl) context.createContextForSplit(</span><br><span class="line">                data.info.splitName);</span><br><span class="line">        &#125;</span><br><span class="line">        java.lang.ClassLoader cl = context.getClassLoader();</span><br><span class="line">        data.intent.setExtrasClassLoader(cl);</span><br><span class="line">        data.intent.prepareToEnterProcess();</span><br><span class="line">        data.setExtrasClassLoader(cl);</span><br><span class="line">        receiver=(BroadcastReceiver)cl.loadClass(component).newInstance();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完整版本可以参考 <a href="https://redspider110.github.io/2017/11/27/0021-broadcast/">四大组件 – Broadcast</a> ，简化后的调用序列图：  </p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-load-broadcast-receiver.png" alt="0108-android-classloading-load-broadcast-receiver.png"></p>
<p>部分 <code>Log</code> 打印：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">06-23 10:47:50.276: E/System(19446): XMT, ClassLoader.loadClass, name = com.staqu.essentials.notifications.NotificationActivationReceiver, resolve = false</span><br><span class="line">06-23 10:47:50.276: E/System(19446): XMT, ClassLoader.findLoadedClass, name = com.staqu.essentials.notifications.NotificationActivationReceiver, this = dalvik.system.PathClassLoader[DexPathList[[zip file &quot;/system/priv-app/SalesTracker/SalesTracker.apk&quot;],nativeLibraryDirectories=[/system/priv-app/SalesTracker/lib/arm, /system/fake-libs, /system/priv-app/SalesTracker/SalesTracker.apk!/lib/armeabi-v7a, /system/lib, /vendor/lib, /system/lib, /vendor/lib]]]</span><br><span class="line">06-23 10:47:50.277: E/System(19446): java.lang.Exception</span><br><span class="line">06-23 10:47:50.277: E/System(19446): 	at java.lang.ClassLoader.findLoadedClass(ClassLoader.java:735)</span><br><span class="line">06-23 10:47:50.277: E/System(19446): 	at java.lang.ClassLoader.loadClass(ClassLoader.java:364)</span><br><span class="line">06-23 10:47:50.277: E/System(19446): 	at java.lang.ClassLoader.loadClass(ClassLoader.java:312)</span><br><span class="line">06-23 10:47:50.277: E/System(19446): 	at android.app.ActivityThread.handleReceiver(ActivityThread.java:3173)</span><br><span class="line">06-23 10:47:50.277: E/System(19446): 	at android.app.ActivityThread.-wrap17(Unknown Source:0)</span><br><span class="line">06-23 10:47:50.277: E/System(19446): 	at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1679)</span><br><span class="line">06-23 10:47:50.277: E/System(19446): 	at android.os.Handler.dispatchMessage(Handler.java:106)</span><br><span class="line">06-23 10:47:50.277: E/System(19446): 	at android.os.Looper.loop(Looper.java:164)</span><br><span class="line">06-23 10:47:50.277: E/System(19446): 	at android.app.ActivityThread.main(ActivityThread.java:6522)</span><br><span class="line">06-23 10:47:50.277: E/System(19446): 	at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">06-23 10:47:50.277: E/System(19446): 	at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:438)</span><br><span class="line">06-23 10:47:50.277: E/System(19446): 	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:807)</span><br><span class="line">06-23 10:47:50.277: E/System(19446): XMT, ClassLoader.loadClass, c = class com.staqu.essentials.notifications.NotificationActivationReceiver, parent = java.lang.BootClassLoader@b40a08c</span><br></pre></td></tr></table></figure>

<h2 id="Android-动态类加载"><a href="#Android-动态类加载" class="headerlink" title="Android 动态类加载"></a><code>Android</code> 动态类加载</h2><p>示例：动态加载 <code>assets</code> 目录下的 <code>dex</code> 文件，并反射调用指定类中的某个方法，返回值在当前 <code>Activity</code> 中显示。  </p>
<h3 id="生成-dex-文件"><a href="#生成-dex-文件" class="headerlink" title="生成 dex 文件"></a>生成 <code>dex</code> 文件</h3><p>在 <code>AS</code> 中新建 <code>Test.java</code> 文件，编译生成对应的 <code>Test.class</code>，使用工具生成对应的 <code>test.jar</code> 文件：<code>d8.bat --output=test.jar Test.class</code> 。<br>将 <code>Test.java, Test.class, test.jar</code> 三个文件剪切到 <code>assets</code> 目录下，避免将 <code>Test.java</code> 打包到当前 <code>APK</code> 中了。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.*.knowledge.classloading;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Test: from other dex file, classLoader: "</span> </span><br><span class="line">            + Test.class.getClassLoader();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="当前-Activity-动态加载"><a href="#当前-Activity-动态加载" class="headerlink" title="当前 Activity 动态加载"></a>当前 <code>Activity</code> 动态加载</h3><ul>
<li>使用异步任务 <code>AsyncTask</code> 实现动态加载  </li>
<li>避免内存泄露，定义静态内部类 <code>LoaderAsyncTask</code> ，并使用弱引用指向当前 <code>Activity</code>  </li>
<li>将 <code>assets</code> 目录下的 <code>dex</code> 文件，拷贝到 <code>cache</code> 目录下，方便动态加载  </li>
<li>使用 <code>DexClassLoader</code> 动态加载 <code>cache</code> 目录下的 <code>dex</code> 文件，指定父加载器为 <code>null</code>  </li>
<li>使用反射调用 <code>test</code> 方法，并在当前 <code>Activity</code> 中显示结果  </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.*.knowledge.classloading;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoadingActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 避免内存泄露，定义静态内部类</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LoaderAsyncTask</span> <span class="keyword">extends</span> </span></span><br><span class="line"><span class="class">        <span class="title">AsyncTask</span>&lt;<span class="title">String</span>, <span class="title">Void</span>, <span class="title">String</span>&gt;</span>&#123;</span><br><span class="line">        <span class="comment">// 使用弱引用指向当前 Activity</span></span><br><span class="line">        <span class="keyword">private</span> WeakReference&lt;ClassLoadingActivity&gt; mActivity;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LoaderAsyncTask</span><span class="params">(ClassLoadingActivity activity)</span></span>&#123;</span><br><span class="line">            mActivity = <span class="keyword">new</span> WeakReference&lt;ClassLoadingActivity&gt;(activity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPreExecute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.onPreExecute();</span><br><span class="line">            mActivity.get().mTvResult.setText(<span class="string">"..."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> String <span class="title">doInBackground</span><span class="params">(String... strings)</span> </span>&#123;</span><br><span class="line">            ...</span><br><span class="line">            String destFilePath = </span><br><span class="line">                    mActivity.get().getCacheDir().getAbsolutePath()</span><br><span class="line">                    + File.separator + strings[<span class="number">0</span>];</span><br><span class="line">            File destFile = <span class="keyword">new</span> File(destFilePath);</span><br><span class="line">            <span class="keyword">if</span> (!destFile.exists()) &#123;</span><br><span class="line">                copyFile(mActivity.get().getApplicationContext(), </span><br><span class="line">                    strings[<span class="number">0</span>], destFile);</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">            Log.d(TAG, <span class="string">"doInBackground: destFilePath = "</span> + destFilePath);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 动态加载 dex 文件，父加载器为 null</span></span><br><span class="line">                DexClassLoader dcl = <span class="keyword">new</span> DexClassLoader(destFilePath, <span class="keyword">null</span>,</span><br><span class="line">                        <span class="keyword">null</span>, <span class="comment">/*mActivity.get().getClassLoader()*/</span> <span class="keyword">null</span>);</span><br><span class="line">                <span class="comment">// 反射加载类，并实例化</span></span><br><span class="line">                Class&lt;?&gt; clazz = </span><br><span class="line">                    dcl.loadClass(<span class="string">"com.*.knowledge.classloading.Test"</span>);</span><br><span class="line">                Object object = clazz.newInstance();</span><br><span class="line">                Method testMethod = clazz.getMethod(<span class="string">"test"</span>);</span><br><span class="line">                <span class="comment">// 反射调用指定方法</span></span><br><span class="line">                Object result = testMethod.invoke(object, <span class="keyword">null</span>);</span><br><span class="line">                Log.d(TAG, <span class="string">"doInBackground: result="</span> + result.toString());</span><br><span class="line">                <span class="keyword">return</span> result.toString();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (...)&#123;...&#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 拷贝 assets 下指定文件到内存中指定目标文件</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyFile</span><span class="params">(Context context, </span></span></span><br><span class="line"><span class="function"><span class="params">        String fileName, File destFile)</span></span>&#123;</span><br><span class="line">        InputStream in=<span class="keyword">null</span>;</span><br><span class="line">        OutputStream out=<span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            context = context.getApplicationContext();</span><br><span class="line">            in=context.getAssets().open(fileName);</span><br><span class="line">            out=<span class="keyword">new</span> FileOutputStream(destFile.getAbsolutePath());</span><br><span class="line">            <span class="keyword">byte</span>[] bytes=<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">int</span> len=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> ((len=in.read(bytes))!=-<span class="number">1</span>)</span><br><span class="line">                out.write(bytes,<span class="number">0</span>,len);</span><br><span class="line">            out.flush();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (in!=<span class="keyword">null</span>)</span><br><span class="line">                    in.close();</span><br><span class="line">                <span class="keyword">if</span> (out!=<span class="keyword">null</span>)</span><br><span class="line">                    out.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里需要注意下：<code>DexClassLoader</code> 动态加载时，指定父加载器为 <code>null</code>；依据双亲委派模型，只有父加载器加载失败时，才会使用当前加载器加载。<br>这里假定： <code>Test.java</code> 在当前 <code>APK</code> 存在，并且父加载器使用的是 <code>PathClassLoader</code> 。依据双亲委派模型会优先使用 <code>PathClassLoader</code> 加载 <code>Test</code> 类，而我们指定的 <code>DexClassLoader</code> 并不能动态加载 <code>assets</code> 目录下的 <code>Test</code> 。  </p>
<h3 id="示例-Log"><a href="#示例-Log" class="headerlink" title="示例 Log"></a>示例 <code>Log</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">*: I/mmid(518): select timeout: wait for receiving msg</span><br><span class="line">*: D/XMT:ClassLoadingAct(16046): doInBackground: </span><br><span class="line">// 1. 将 assets 目录下的 dex 文件，拷贝到 cache 目录下</span><br><span class="line">*: D/XMT:ClassLoadingAct(16046): copyFile: fileName = test.jar</span><br><span class="line">*: D/XMT:ClassLoadingAct(16046): doInBackground: destFilePath = /data/user/0/com.*.knowledge/cache/test.jar</span><br><span class="line">// 2. 动态加载 dex 文件  </span><br><span class="line">*: E/System(16046): XMT, openDexFile, sourceName = /data/user/0/com.*.knowledge/cache/test.jar, outputName = null, flags = 0, classloader = dalvik.system.DexClassLoader[null]</span><br><span class="line">*: E/System(16046): java.lang.Exception</span><br><span class="line">*: E/System(16046): 	at dalvik.system.DexFile.openDexFile(DexFile.java:356)</span><br><span class="line">*: E/System(16046): 	at dalvik.system.DexFile.&lt;init&gt;(DexFile.java:100)</span><br><span class="line">*: E/System(16046): 	at dalvik.system.DexFile.&lt;init&gt;(DexFile.java:74)</span><br><span class="line">*: E/System(16046): 	at dalvik.system.DexPathList.loadDexFile(DexPathList.java:374)</span><br><span class="line">*: E/System(16046): 	at dalvik.system.DexPathList.makeDexElements(DexPathList.java:337)</span><br><span class="line">*: E/System(16046): 	at dalvik.system.DexPathList.&lt;init&gt;(DexPathList.java:157)</span><br><span class="line">*: E/System(16046): 	at dalvik.system.BaseDexClassLoader.&lt;init&gt;(BaseDexClassLoader.java:65)</span><br><span class="line">*: E/System(16046): 	at dalvik.system.DexClassLoader.&lt;init&gt;(DexClassLoader.java:54)</span><br><span class="line">*: E/System(16046): 	at com.*.knowledge.classloading.ClassLoadingActivity$LoaderAsyncTask.doInBackground(ClassLoadingActivity.java:85)</span><br><span class="line">*: E/System(16046): 	at com.*.knowledge.classloading.ClassLoadingActivity$LoaderAsyncTask.doInBackground(ClassLoadingActivity.java:53)</span><br><span class="line">*: E/System(16046): 	at android.os.AsyncTask$2.call(AsyncTask.java:333)</span><br><span class="line">*: E/System(16046): 	at java.util.concurrent.FutureTask.run(FutureTask.java:266)</span><br><span class="line">*: E/System(16046): 	at android.os.AsyncTask$SerialExecutor$1.run(AsyncTask.java:245)</span><br><span class="line">*: E/System(16046): 	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1162)</span><br><span class="line">*: E/System(16046): 	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:636)</span><br><span class="line">*: E/System(16046): 	at java.lang.Thread.run(Thread.java:764)</span><br><span class="line">*: E/System(16046): XMT, element: null</span><br><span class="line">*: I/dex2oat(16078): The ClassLoaderContext is a special shared library.</span><br><span class="line">*: I/dex2oat(16078): /system/bin/dex2oat --debuggable --debuggable --dex-file=/data/data/com.*.knowledge/cache/test.jar --output-vdex-fd=64 --oat-fd=65 --oat-location=/data/data/com.*.knowledge/cache/oat/arm64/test.odex --compiler-filter=quicken --class-loader-context=&amp;</span><br><span class="line">*: I/InputReader(1509): Reconfiguring input devices.  changes=0x00000010</span><br><span class="line">*: I/Telecom(1509): DefaultDialerCache: Refreshing default dialer for user 0: now com.android.dialer: DDC.oR@AGc</span><br><span class="line">*: W/VoiceInteractionManagerService(1509): no available voice interaction services found for user 0</span><br><span class="line">*: D/CarrierSvcBindHelper(2041): No carrier app for: 0</span><br><span class="line">*: D/CarrierSvcBindHelper(2041): No carrier app for: 1</span><br><span class="line">*: D/ImsResolver(2041): maybeAddedImsService, packageName: com.*.knowledge</span><br><span class="line">*: I/dex2oat(16078): dex2oat took 934.000ms (1.609s cpu) (threads: 1000) arena alloc=1432B (1432B) java alloc=16KB (16400B) native alloc=492KB (504744B) free=2MB (2116696B)</span><br><span class="line">*: I/zygote64(16046): The ClassLoaderContext is a special shared library.</span><br><span class="line">// 3. 加载指定类 Test</span><br><span class="line">*: E/System(16046): XMT, ClassLoader.loadClass, name = com.*.knowledge.classloading.Test, resolve = false</span><br><span class="line">*: E/System(16046): XMT, ClassLoader.findLoadedClass, name = com.*.knowledge.classloading.Test, this = dalvik.system.DexClassLoader[DexPathList[[zip file &quot;/data/user/0/com.*.knowledge/cache/test.jar&quot;],nativeLibraryDirectories=[/system/lib64, /vendor/lib64]]]</span><br><span class="line">*: E/System(16046): java.lang.Exception</span><br><span class="line">*: E/System(16046): 	at java.lang.ClassLoader.findLoadedClass(ClassLoader.java:735)</span><br><span class="line">*: E/System(16046): 	at java.lang.ClassLoader.loadClass(ClassLoader.java:364)</span><br><span class="line">*: E/System(16046): 	at java.lang.ClassLoader.loadClass(ClassLoader.java:312)</span><br><span class="line">*: E/System(16046): 	at com.*.knowledge.classloading.ClassLoadingActivity$LoaderAsyncTask.doInBackground(ClassLoadingActivity.java:86)</span><br><span class="line">*: E/System(16046): 	at com.*.knowledge.classloading.ClassLoadingActivity$LoaderAsyncTask.doInBackground(ClassLoadingActivity.java:53)</span><br><span class="line">*: E/System(16046): 	at android.os.AsyncTask$2.call(AsyncTask.java:333)</span><br><span class="line">*: E/System(16046): 	at java.util.concurrent.FutureTask.run(FutureTask.java:266)</span><br><span class="line">*: E/System(16046): 	at android.os.AsyncTask$SerialExecutor$1.run(AsyncTask.java:245)</span><br><span class="line">*: E/System(16046): 	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1162)</span><br><span class="line">*: E/System(16046): 	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:636)</span><br><span class="line">*: E/System(16046): 	at java.lang.Thread.run(Thread.java:764)</span><br><span class="line">*: E/System(16046): XMT, ClassLoader.loadClass, c = class com.*.knowledge.classloading.Test, parent = dalvik.system.PathClassLoader[DexPathList[[zip file &quot;/data/app/com.*.knowledge-8K_G8HZhGrHEo_X_5AJuhg==/base.apk&quot;],nativeLibraryDirectories=[/data/app/com.*.knowledge-8K_G8HZhGrHEo_X_5AJuhg==/lib/arm64, /system/lib64, /vendor/lib64]]]</span><br><span class="line">// 4. 反射调用指定方法 test</span><br><span class="line">*: D/XMT:ClassLoadingAct(16046): doInBackground: result = Test: from other dex file, classLoader: dalvik.system.DexClassLoader[DexPathList[[zip file &quot;/data/user/0/com.*.knowledge/cache/test.jar&quot;],nativeLibraryDirectories=[/system/lib64, /vendor/lib64]]]</span><br></pre></td></tr></table></figure>

<p>从 <code>Log</code> 中可以看出，<code>Test.test</code> 方法是 <code>DexClassLoader</code> 加载的，对应路径为 <code>/data/user/0/com.*.knowledge/cache/test.jar</code> 。  </p>
<h2 id="Android-热补丁"><a href="#Android-热补丁" class="headerlink" title="Android 热补丁"></a><code>Android</code> 热补丁</h2><p>在 <code>Android</code> 动态加载中，我们把 <code>Test.java</code> 从源码中删除了，也就是说 <code>APK</code> 中并不包含这个类，所以通过反射来访问的。接下来我们介绍 <code>Android</code> 热补丁，也就是 <code>Test.java</code> 在 <code>APK</code> 中存在，我们需要使用 <code>assets</code> 中的补丁替换它。  </p>
<h3 id="热补丁原理"><a href="#热补丁原理" class="headerlink" title="热补丁原理"></a>热补丁原理</h3><p><code>Android</code> 的类加载器在加载一个类时，先从当前加载器的 <code>DexPathList</code> 对象中的 <code>Element[] dexElements</code> 数组中，获取对应的类并加载。采用的是数组遍历的方式，遍历每一个 <code>dex</code> 文件；先遍历出来的是 <code>dex</code> 文件，先加载 <code>class</code>，成功加载后就不再遍历后续 <code>dex</code> 文件。<br>热修复的原理就是：将补丁 <code>class</code> 打包成 <code>dex</code> 文件后，放到 <code>Element</code> 数组的<strong>第一个元素</strong>，这样就能保证获取到的 <code>class</code> 是最新修复好的 <code>class</code>了。  </p>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0108-android-classloading-hot-fix.png" alt="0108-android-classloading-hot-fix.png"></p>
<blockquote>
<p>参考 <a href="https://redspider110.github.io/2018/05/02/0078-java-classloading/">Java 类加载机制</a> ，对于 <code>new TestClass()</code> 这个语句，会触发类初始化过程。而初始化分为两部分：类初始化过程 <code>&lt;cinit&gt;</code> ，即类加载过程的初始化阶段；类实例化过程 <code>&lt;init&gt;</code> 。而类一旦初始化后，后续再 <code>new</code> 只会执行实例化过程，也就是常说的类只会被加载一次，但是会实例化多次。所以热补丁必须要在类初始化 <code>&lt;cinit&gt;</code> 之前合入，否则不会生效。  </p>
</blockquote>
<h3 id="Test-类"><a href="#Test-类" class="headerlink" title="Test 类"></a><code>Test</code> 类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.*.knowledge.classloading;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Test: from current APK, classLoader: "</span> </span><br><span class="line">            + Test.class.getClassLoader();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个 <code>Test.java</code> 跟随其他代码一起编译到 <code>APK</code> 中，而我们 <code>assets</code> 中的 <code>Test.java</code> 的方法中，返回值不一样 <code>return &quot;Test: from other dex file, classLoader: &quot; ...</code> ，后续通过 <code>Log</code> 和界面显示出来。<br>如果最终热加载成功，将显示 <code>... from other dex ...</code> 而不是 <code>... from current APK ...</code> 。  </p>
<h3 id="当前-Activity-合入热补丁"><a href="#当前-Activity-合入热补丁" class="headerlink" title="当前 Activity 合入热补丁"></a>当前 <code>Activity</code> 合入热补丁</h3><p>因为 <code>DexPathList, Element</code> 等都是包内可见，所以只能通过反射将补丁包插入到 <code>Element[]</code> 数组的第一个元素中。  </p>
<ul>
<li>获取系统加载器 <code>PathClassLoader, DexPathList, Elements</code>  </li>
<li>获取补丁包中的 <code>DexClassLoader, DexPathList, Elements</code>  </li>
<li>将补丁包的 <code>Elements</code> 插入到当前系统加载器的 <code>Elements</code> 中  </li>
<li>后续加载修复类时，会优先从补丁包中获取  </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HotFixActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getTestResult</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Test test = <span class="keyword">new</span> Test();</span><br><span class="line">        String result = test.test();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleHotFix</span><span class="params">()</span></span>&#123;</span><br><span class="line">        HotFixAsyncTask hotFixAsyncTask = <span class="keyword">new</span> HotFixAsyncTask(<span class="keyword">this</span>);</span><br><span class="line">        hotFixAsyncTask.execute();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HotFixAsyncTask</span> <span class="keyword">extends</span> </span></span><br><span class="line"><span class="class">        <span class="title">AsyncTask</span>&lt;<span class="title">String</span>, <span class="title">Void</span>, <span class="title">String</span>&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> WeakReference&lt;HotFixActivity&gt; mActivity;</span><br><span class="line">        <span class="keyword">private</span> String mDexFilePath;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">HotFixAsyncTask</span><span class="params">(HotFixActivity activity)</span></span>&#123;</span><br><span class="line">            mActivity = <span class="keyword">new</span> WeakReference&lt;HotFixActivity&gt;(activity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> String <span class="title">doInBackground</span><span class="params">(String... strings)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (isDexFileExist()) &#123;</span><br><span class="line">                <span class="comment">//hotFix();</span></span><br><span class="line">                <span class="keyword">return</span> mActivity.get().getTestResult();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Hot Fix Error!"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.onPostExecute(s);</span><br><span class="line">            mActivity.get().mBtnHotFix.setEnabled(<span class="keyword">true</span>);</span><br><span class="line">            mActivity.get().mTvNew.setText(s);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isDexFileExist</span><span class="params">()</span></span>&#123;</span><br><span class="line">            String dexFileName = <span class="string">"test.jar"</span>;</span><br><span class="line">            mDexFilePath = mActivity.get().getCacheDir().getAbsolutePath()</span><br><span class="line">                    + File.separator + dexFileName;</span><br><span class="line">            File destFile = <span class="keyword">new</span> File(mDexFilePath);</span><br><span class="line">            <span class="keyword">if</span> (!destFile.exists()) &#123;</span><br><span class="line">                copyFile(mActivity.get().getApplicationContext(),</span><br><span class="line">                    dexFileName, destFile);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!destFile.exists())&#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"isDexFileExist: copy error!"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">hotFix</span><span class="params">()</span></span>&#123;</span><br><span class="line">            Log.d(TAG, <span class="string">"hotFix: "</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 1.1 获取系统加载器  </span></span><br><span class="line">                PathClassLoader pcl = (PathClassLoader) </span><br><span class="line">                    mActivity.get().getClassLoader();</span><br><span class="line">                <span class="comment">// 1.2 使用 DexClassLoader 加载补丁包</span></span><br><span class="line">                DexClassLoader dcl = <span class="keyword">new</span> DexClassLoader(mDexFilePath, </span><br><span class="line">                    <span class="keyword">null</span>, <span class="keyword">null</span>, pcl);</span><br><span class="line">                <span class="comment">// 2.1 获取当前已经加载的 DexPathList</span></span><br><span class="line">                Object origDexPathList = getPathList(pcl);</span><br><span class="line">                <span class="comment">// 2.2 获取当前加载器的 Elements 数组</span></span><br><span class="line">                Object origElements = getDexElements(origDexPathList);</span><br><span class="line">                <span class="comment">// 3.1 获取补丁包中的 DexPathList</span></span><br><span class="line">                Object patchDexPathList = getPathList(dcl);</span><br><span class="line">                <span class="comment">// 3.2 获取补丁包中的 Elements 数组  </span></span><br><span class="line">                Object patchElements = getDexElements(patchDexPathList);</span><br><span class="line">                <span class="comment">// 4 将补丁包插入到当前 Elements 数组前面</span></span><br><span class="line">                Object patchedElements = </span><br><span class="line">                    combineArray(patchElements, origElements);</span><br><span class="line">                setDexElements(origDexPathList, patchedElements);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (...)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object object, Class&lt;?&gt; clazz, </span></span></span><br><span class="line"><span class="function"><span class="params">                String fieldName, Object value)</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">            Field field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            field.set(object, value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">getField</span><span class="params">(Object object, Class&lt;?&gt; clazz, </span></span></span><br><span class="line"><span class="function"><span class="params">                String fieldName)</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">            Field field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> field.get(object);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">private</span> Object <span class="title">getPathList</span><span class="params">(ClassLoader cl)</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> getField(cl, cl.getClass().getSuperclass(),</span><br><span class="line">                <span class="string">"pathList"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> Object <span class="title">getDexElements</span><span class="params">(Object dexPathList)</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">            Log.d(TAG, <span class="string">"getDexElements: "</span>);</span><br><span class="line">            <span class="keyword">return</span> getField(dexPathList, dexPathList.getClass(),</span><br><span class="line">                <span class="string">"dexElements"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setDexElements</span><span class="params">(Object dexPathList, Object elements)</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">            Log.d(TAG, <span class="string">"setDexElements: "</span>);</span><br><span class="line">            setField(dexPathList, dexPathList.getClass(), </span><br><span class="line">                <span class="string">"dexElements"</span>, elements);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">combineArray</span><span class="params">(Object array1, Object array2)</span> </span>&#123;</span><br><span class="line">            Log.d(TAG, <span class="string">"combineArray: "</span>);</span><br><span class="line">            <span class="keyword">if</span> (array1 == <span class="keyword">null</span> || !array1.getClass().isArray()</span><br><span class="line">                    || array2 == <span class="keyword">null</span> || !array2.getClass().isArray()) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"combineArray: array is null."</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Class&lt;?&gt; clazz = array1.getClass().getComponentType();</span><br><span class="line">            <span class="keyword">int</span> length1 = Array.getLength(array1);</span><br><span class="line">            <span class="keyword">int</span> length2 = Array.getLength(array2);</span><br><span class="line">            <span class="keyword">int</span> length = length1 + length2;</span><br><span class="line">            Object combineArray = Array.newInstance(clazz, length);</span><br><span class="line">            System.arraycopy(array1, <span class="number">0</span>, combineArray, <span class="number">0</span>, length1);</span><br><span class="line">            System.arraycopy(array2, <span class="number">0</span>, combineArray, length1, length2);</span><br><span class="line">            <span class="keyword">return</span> combineArray;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="示例-Log-1"><a href="#示例-Log-1" class="headerlink" title="示例 Log"></a>示例 <code>Log</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">* I/mmid: select timeout: wait <span class="keyword">for</span> receiving msg</span><br><span class="line">*/com.*.knowledge D/XMT:HotFixAct: hotFix: </span><br><span class="line">*/com.*.knowledge E/System: XMT, openDexFile, sourceName = /data/user/<span class="number">0</span>/com.*.knowledge/cache/test.jar, outputName = <span class="keyword">null</span>, flags = <span class="number">0</span>, classloader = dalvik.system.DexClassLoader[<span class="keyword">null</span>]</span><br><span class="line">*/com.*.knowledge E/System: java.lang.Exception</span><br><span class="line">        at dalvik.system.DexFile.openDexFile(DexFile.java:<span class="number">356</span>)</span><br><span class="line">        at dalvik.system.DexFile.&lt;init&gt;(DexFile.java:<span class="number">100</span>)</span><br><span class="line">        at dalvik.system.DexFile.&lt;init&gt;(DexFile.java:<span class="number">74</span>)</span><br><span class="line">        at dalvik.system.DexPathList.loadDexFile(DexPathList.java:<span class="number">374</span>)</span><br><span class="line">        at dalvik.system.DexPathList.makeDexElements(DexPathList.java:<span class="number">337</span>)</span><br><span class="line">        at dalvik.system.DexPathList.&lt;init&gt;(DexPathList.java:<span class="number">157</span>)</span><br><span class="line">        at dalvik.system.BaseDexClassLoader.&lt;init&gt;(BaseDexClassLoader.java:<span class="number">65</span>)</span><br><span class="line">        at dalvik.system.DexClassLoader.&lt;init&gt;(DexClassLoader.java:<span class="number">54</span>)</span><br><span class="line">        at com.*.knowledge.classloading.HotFixActivity$HotFixAsyncTask.hotFix(HotFixActivity.java:<span class="number">108</span>)</span><br><span class="line">        at com.*.knowledge.classloading.HotFixActivity$HotFixAsyncTask.doInBackground(HotFixActivity.java:<span class="number">76</span>)</span><br><span class="line">        at com.*.knowledge.classloading.HotFixActivity$HotFixAsyncTask.doInBackground(HotFixActivity.java:<span class="number">60</span>)</span><br><span class="line">        at android.os.AsyncTask$<span class="number">2</span>.call(AsyncTask.java:<span class="number">333</span>)</span><br><span class="line">        at java.util.concurrent.FutureTask.run(FutureTask.java:<span class="number">266</span>)</span><br><span class="line">        at android.os.AsyncTask$SerialExecutor$<span class="number">1</span>.run(AsyncTask.java:<span class="number">245</span>)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1162</span>)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">636</span>)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:<span class="number">764</span>)</span><br><span class="line">* /com.*.knowledge E/System: XMT, element: <span class="keyword">null</span></span><br><span class="line">* /com.*.knowledge I/zygote64: The ClassLoaderContext is a special shared library.</span><br><span class="line">* /com.*.knowledge D/XMT:HotFixAct: getPathList: </span><br><span class="line">* /com.*.knowledge D/XMT:HotFixAct: getDexElements: </span><br><span class="line">* /com.*.knowledge D/XMT:HotFixAct: getPathList: </span><br><span class="line">* /com.*.knowledge D/XMT:HotFixAct: getDexElements: </span><br><span class="line">* /com.*.knowledge D/XMT:HotFixAct: combineArray: </span><br><span class="line">* /com.*.knowledge D/XMT:HotFixAct: setDexElements: </span><br><span class="line">* /com.*.knowledge D/XMT:HotFixAct: getTestResult: result = Test: from other dex file, classLoader: dalvik.system.PathClassLoader[DexPathList[[zip file <span class="string">"/data/user/0/com.*.knowledge/cache/test.jar"</span>, zip file <span class="string">"/data/app/com.*.knowledge-0dRhS8t5SzW66qvx7ecm8w==/base.apk"</span>],nativeLibraryDirectories=[/data/app/com.*.knowledge-<span class="number">0</span>dRhS8t5SzW66qvx7ecm8w==/lib/arm64, /system/lib64, /vendor/lib64]]]</span><br></pre></td></tr></table></figure>

<p>从结果可以看出 <code>Test</code> 类是从补丁包中加载的:  </p>
<ul>
<li>类加载器为系统加载器 <code>PathClassLoader</code>，也就是它的 <code>Elements</code> 数组已经通过反射合入了热补丁  </li>
<li><code>DexPathList</code> 中包含两个文件：补丁包 <code>/data/user/0/com.*.knowledge/cache/test.jar</code> 和原始的 <code>APK: /data/app/com.*.knowledge-0dRhS8t5SzW66qvx7ecm8w==/base.apk</code>  </li>
</ul>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="dalvikvm"><a href="#dalvikvm" class="headerlink" title="dalvikvm"></a><code>dalvikvm</code></h3><p>类似 <code>PC</code> 端的 <code>java</code> 工具，用来指执行 <code>apk,dex,jar</code> 等 <code>Android</code> 可执行文件的，常用参数为：  </p>
<ul>
<li><code>-cp</code> ：指定可执行文件绝对路径  </li>
<li><code>-verbose:class</code> ：在 <code>logcat</code> 中输出类加载过程  </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">xmt@server005:~/$ dalvikvm --help</span><br><span class="line">Unknown argument: --help</span><br><span class="line">dalvikvm: [options] class [argument ...]</span><br><span class="line"></span><br><span class="line">The following standard options are supported:</span><br><span class="line">  -classpath classpath (-cp classpath)</span><br><span class="line">  -Dproperty=value</span><br><span class="line">  -verbose:tag (&apos;gc&apos;, &apos;jit&apos;, &apos;jni&apos;, or &apos;class&apos;)</span><br><span class="line">  -showversion</span><br><span class="line">  -help</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>下面是一个调试过程，可以看到 <code>Android</code> 类加载过程  </p>
<ul>
<li><p><code>java</code> 文件编写  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DalvikvmTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"This is DalvikvmTest."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>class</code> 文件生成<br><code>javac -bootclasspath C:\Users\xmt\sdk\platforms\android-28\android.jar DalvikvmTest.java</code> ，这里可以省略 <code>-bootclasspath</code> ，只有在调用了 <code>android</code> 代码时才需要。  </p>
</li>
<li><p><code>dex, jar</code> 文件生成  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\xmt\sdk\build-tools\28.0.3\d8.bat --classpath C:\Users\xmt\sdk\platforms\android-28\android.jar --output=DalvikvmTest.jar DalvikvmTest.class</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>这里同样可以省略 <code>--classpath</code> 。  </p>
<ul>
<li><p><code>push</code> 到手机中，<code>dalvikvm</code> 执行  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adb push DalvikvmTest.jar /storage/emulated/0/test</span><br><span class="line">adb shell</span><br><span class="line">dalvikvm -verbose:class -cp /storage/emulated/0/test/DalvikvmTest.jar  DalvikvmTest</span><br></pre></td></tr></table></figure>
</li>
<li><p>对应 <code>log</code><br>从 <code>Log</code> 中可以清晰的看到类的加载和类初始化两个过程，默认使用的是 <code>PathClassLoader</code> 类加载器。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">/? I/dalvikvm: Adding image space took 153.906us</span><br><span class="line">/? I/dalvikvm: Adding image space took 57.448us</span><br><span class="line">/? I/dalvikvm: Adding image space took 71.718us</span><br><span class="line">...</span><br><span class="line">/? W/ADebug: Failed to get property persist.sys.media.traces</span><br><span class="line">/? I/dalvikvm: Initialized class Landroid/system/OsConstants; from /system/framework/core-libart.jar</span><br><span class="line">/? I/dalvikvm: Initialized class Ljava/io/FileDescriptor; from /system/framework/core-oj.jar</span><br><span class="line">/? I/dalvikvm: Initialized class Ljava/net/Inet4Address; from /system/framework/core-oj.jar</span><br><span class="line">/? I/dalvikvm: Initialized class Ljava/lang/System; from /system/framework/core-oj.jar</span><br><span class="line">/? I/dalvikvm: Initialized class Ljava/net/Inet6Address; from /system/framework/core-oj.jar</span><br><span class="line">/? I/dalvikvm: Initialized class Ljava/io/UnixFileSystem; from /system/framework/core-oj.jar</span><br><span class="line">/? I/dalvikvm: Initialized class Ljava/io/File; from /system/framework/core-oj.jar</span><br><span class="line">/? I/dalvikvm: Initialized class Ljava/util/regex/Pattern; from /system/framework/core-oj.jar</span><br><span class="line">/? I/dalvikvm: Loaded class [Ljava/lang/ThreadLocal$ThreadLocalMap$Entry;</span><br><span class="line">/? E/System: XMT, openDexFile, sourceName = /storage/emulated/0/test/DalvikvmTest.jar, outputName = null, flags = 0, classloader = dalvik.system.PathClassLoader[null]</span><br><span class="line">/? E/System: java.lang.Exception</span><br><span class="line">        at dalvik.system.DexFile.openDexFile(DexFile.java:356)</span><br><span class="line">        at dalvik.system.DexFile.&lt;init&gt;(DexFile.java:100)</span><br><span class="line">        at dalvik.system.DexFile.&lt;init&gt;(DexFile.java:74)</span><br><span class="line">        at dalvik.system.DexPathList.loadDexFile(DexPathList.java:374)</span><br><span class="line">        at dalvik.system.DexPathList.makeDexElements(DexPathList.java:337)</span><br><span class="line">        at dalvik.system.DexPathList.&lt;init&gt;(DexPathList.java:157)</span><br><span class="line">        at dalvik.system.BaseDexClassLoader.&lt;init&gt;(BaseDexClassLoader.java:65)</span><br><span class="line">        at dalvik.system.PathClassLoader.&lt;init&gt;(PathClassLoader.java:64)</span><br><span class="line">        at java.lang.ClassLoader.createSystemClassLoader(ClassLoader.java:224)</span><br><span class="line">        at java.lang.ClassLoader.-wrap0(Unknown Source:0)</span><br><span class="line">        at java.lang.ClassLoader$SystemClassLoader.&lt;clinit&gt;(ClassLoader.java:183)</span><br><span class="line">        at java.lang.ClassLoader.getSystemClassLoader(ClassLoader.java:1110)</span><br><span class="line">/? E/System: XMT, element: null</span><br><span class="line">/? I/dalvikvm: The ClassLoaderContext is a special shared library.</span><br><span class="line">/? I/dalvikvm: Registering /storage/emulated/0/test/oat/arm64/DalvikvmTest.odex</span><br><span class="line">/? I/dalvikvm: Initialized class Ljava/lang/ClassLoader$SystemClassLoader; from /system/framework/core-oj.jar</span><br><span class="line">// 加载 DalvikvmTest 类</span><br><span class="line">/? I/dalvikvm: Loaded class LDalvikvmTest; from /storage/emulated/0/test/DalvikvmTest.jar</span><br><span class="line">/? I/dalvikvm: Beginning verification for class: DalvikvmTest in /storage/emulated/0/test/DalvikvmTest.jar</span><br><span class="line">/? I/dalvikvm: Class preverified status for class DalvikvmTest in /storage/emulated/0/test/DalvikvmTest.jar: 1</span><br><span class="line">// DalvikvmTest 类初始化</span><br><span class="line">/? I/dalvikvm: Initialized class LDalvikvmTest; from /storage/emulated/0/test/DalvikvmTest.jar</span><br><span class="line">/? I/dalvikvm: Initialized class Llibcore/icu/NativeConverter; from /system/framework/core-libart.jar</span><br><span class="line">/? I/dalvikvm: Initialized class Ljava/nio/charset/StandardCharsets; from /system/framework/core-oj.jar</span><br><span class="line">/? I/dalvikvm: Loaded class Ljava/io/BufferedWriter; from /system/framework/core-oj.jar</span><br><span class="line">/? I/dalvikvm: Beginning verification for class: java.io.BufferedWriter in /system/framework/core-oj.jar</span><br><span class="line">/? I/dalvikvm: Class preverified status for class java.io.BufferedWriter in /system/framework/core-oj.jar: 1</span><br><span class="line">/? I/dalvikvm: Initialized class Ljava/io/BufferedWriter; from /system/framework/core-oj.jar</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="AOSP-libcore-编译"><a href="#AOSP-libcore-编译" class="headerlink" title="AOSP libcore 编译"></a><code>AOSP libcore</code> 编译</h3><p>在调试时，希望打出类加载堆栈中调用关系，在 <code>DexFile.java</code> 中增加了一个 <code>Log</code> 打印：<code>System.logE(&quot;XMT, ***&quot; , new Exception());</code> 。修改完代码后，在 <code>libcore</code> 目录下编译 <code>mm</code> ，但是总是会出错并打印如下信息：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ninja: error: &apos;out/host/common/obj/JAVA_LIBRARIES/junit-hostdex_intermediates/classes.jack&apos;, needed by &apos;out/host/common/obj/JAVA_LIBRARIES/core-test-rules-hostdex_intermediates/classes.jack&apos;, missing and no known rule to make it</span><br><span class="line">11:21:10 ninja failed with: exit status 1</span><br></pre></td></tr></table></figure>

<p>根据错误信息，需要编译 <code>core-test-rules</code> 模块，其实我们并不需要。在 <code>libcore/JavaLibrary.mk</code> 中看到这个模块是宏 <code>LIBCORE_SKIP_TESTS</code> 控制的，我们在 <code>libcore/Android.mk</code> 中注释掉这个宏，<code>export LIBCORE_SKIP_TESTS = false</code> ，重新编译。<code>Java</code> 代码的改动会更新：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">out/***/system/framework/core-libart.jar</span><br><span class="line">out/***/system/framework/boot-core-libart.vdex</span><br><span class="line">out/***/system/framework/boot-core-libart.oat</span><br><span class="line">out/***/system/framework/boot-core-libart.art</span><br></pre></td></tr></table></figure>

<p>将这几个文件 <code>push</code> 到手机后重启生效。  </p>
<p>小结：  </p>
<ul>
<li>打印 <code>log</code> 方式：使用 <code>System.logE()</code>  </li>
<li>编译方式：设置 <code>export LIBCORE_SKIP_TESTS = false</code> ，在 <code>libcore/</code> 目录下 <code>mm</code>  </li>
</ul>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="APK-加载过程-1"><a href="#APK-加载过程-1" class="headerlink" title="APK 加载过程"></a><code>APK</code> 加载过程</h3><p>应用中的四大组件和自定义类，编译工具会先将 <code>Java</code> 文件生成 <code>.class</code> ，然后合并成 <code>.dex</code> 文件，最终打包成 <code>APK</code> 。<code>Android</code> 启动 <code>APP</code> 时，会加载对应的 <code>APK</code> 文件，并将整个 <code>APK</code> 中相关类信息加载到虚拟机中，参考 <code>APK</code> 加载过程章节中的序列图。  </p>
<h3 id="Android-类加载时机"><a href="#Android-类加载时机" class="headerlink" title="Android 类加载时机"></a><code>Android</code> 类加载时机</h3><p><code>APK</code> 加载后，并不会将拥有的类全部加载，只有在类初始化时才会加载，类加载时机参考 <a href="https://redspider110.github.io/2018/05/02/0078-java-classloading/">Java 类加载机制</a> ，大概有 5 种情况会触发。  </p>
<ul>
<li><code>APK</code> 中的四大组件是主动调用 <code>ClassLoader</code> 来加载，通过反射来实例化的  </li>
<li><code>APK</code> 中普通自定义类通过 <code>new</code> 来加载和实例化；这个过程并没有出现 <code>ClassLoader</code> 类加载器相关调用关系，怀疑是虚拟机 <code>ART</code> 中直接实现（没有看虚拟机的实现代码只是猜测）  </li>
<li><code>APK</code> 中如果遇到了 <code>framework</code> 中的类，会通过双亲委派模型从系统中 <code>ClassLoader.findLoadedClass</code> 查找已经加载的类  </li>
<li>虚拟机 <code>ART</code> 中的底层代码，在加载应用中的类时，会在 <code>Java DexPathList.Elements</code> 数组中查找对应的 <code>apk, dex, jar</code> 等文件，并加载对应类（并没有搞清楚底层代码是怎么实现的，但是从热补丁的测试结果来看是这样的）  </li>
</ul>
<h3 id="打印类加载过程"><a href="#打印类加载过程" class="headerlink" title="打印类加载过程"></a>打印类加载过程</h3><p>可以通过 <code>dalvikvm -verbose:class</code> 简单了解类加载过程。  </p>
<h3 id="几个重要的-native-方法"><a href="#几个重要的-native-方法" class="headerlink" title="几个重要的 native 方法"></a>几个重要的 <code>native</code> 方法</h3><ul>
<li><code>DexFile.openDexFile -&gt; openDexFileNative</code>  </li>
<li><code>DexFile.defineClass -&gt; defineClassNative</code>  </li>
<li><code>Class.classForName</code>  </li>
<li><code>ClassLoader.findLoadedClass -&gt; VMClassLoader.findLoadedClass</code>  </li>
</ul>
<h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><ul>
<li>热加载，插件化详细分析  </li>
<li><code>ART</code> 底层代码分析  </li>
</ul>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul>
<li><a href="https://www.ibm.com/developerworks/cn/java/j-rtj2/" target="_blank" rel="noopener">JIT和AOT的比较</a>  </li>
<li><a href="https://www.cnblogs.com/chengdabelief/p/6576320.html" target="_blank" rel="noopener">JVM解释器</a>  </li>
<li><a href="https://www.cnblogs.com/lyhero11/p/5080306.html" target="_blank" rel="noopener">JIT与JVM的三种执行模式</a>  </li>
<li><a href="https://www.cnblogs.com/sjm19910902/p/6386472.html" target="_blank" rel="noopener">ART、JIT、AOT、Dalvik之间的关系</a>  </li>
<li><a href="https://www.jianshu.com/p/389911e2cdfb" target="_blank" rel="noopener">odex文件在Dalvik和ART中不同的含义</a>  </li>
<li><a href="https://lief.quarkslab.com/doc/latest/tutorials/10_android_formats.html" target="_blank" rel="noopener">android 文件格式</a>  </li>
<li><a href="https://blog.csdn.net/luoshengyang/article/details/39256813" target="_blank" rel="noopener">ELF格式的oat文件图解</a>  </li>
<li><a href="https://blog.csdn.net/feglass/article/details/51469511" target="_blank" rel="noopener">ELF文件格式解析</a>  </li>
<li><a href="https://source.android.com/source/jack.html" target="_blank" rel="noopener">jack：字节码生成工具</a>  </li>
<li><a href="https://developer.android.com/reference/dalvik/system/PathClassLoader" target="_blank" rel="noopener">API Reference: PathClassLoader</a>  </li>
<li><a href="https://developer.android.com/reference/dalvik/system/DexClassLoader" target="_blank" rel="noopener">API Reference: DexClassLoader</a>  </li>
<li><a href="https://developer.android.com/reference/dalvik/system/InMemoryDexClassLoader" target="_blank" rel="noopener">API Reference: InMemoryDexClassLoader</a>  </li>
<li><a href="https://developer.android.com/reference/dalvik/system/DelegateLastClassLoader" target="_blank" rel="noopener">API Reference: DelegateLastClassLoader</a>  </li>
<li><a href="https://developer.android.com/reference/dalvik/system/BaseDexClassLoader" target="_blank" rel="noopener">API Reference: BaseDexClassLoader</a>  </li>
<li><a href="https://blog.csdn.net/a2923790861/article/details/80539862" target="_blank" rel="noopener">Android动态加载Dex过程</a>  </li>
<li><a href="https://juejin.im/post/5a0ad2b551882531ba1077a2" target="_blank" rel="noopener">热修复——深入浅出原理与实现</a>  </li>
<li><a href="https://source.android.com/devices/tech/dalvik/configure.html" target="_blank" rel="noopener">ART配置</a>  </li>
<li><a href="https://www.jianshu.com/p/3afa47e9112e" target="_blank" rel="noopener">Android类加载机制的细枝末节</a>  </li>
<li><a href="http://www.iloveandroid.net/2015/12/19/AndroidART-4/" target="_blank" rel="noopener">ART运行普通java程序</a>  </li>
<li><a href="https://segmentfault.com/a/1190000004062880" target="_blank" rel="noopener">Android动态加载基础 ClassLoader工作机制</a>  </li>
<li><a href="https://blog.csdn.net/zhu929033262/article/details/76999996" target="_blank" rel="noopener">ART系统类的编译解析加载探究</a>  </li>
<li><a href="https://blog.csdn.net/luoshengyang/article/details/39256813" target="_blank" rel="noopener">老罗：Android运行时ART简要介绍和学习计划</a>  </li>
<li><a href="https://blog.csdn.net/jiangwei0910410003/article/details/17679823" target="_blank" rel="noopener">尼古拉斯_赵四:Android中的动态加载机制</a>  </li>
<li><a href="https://techblog.toutiao.com/2018/06/01/untitled-35/" target="_blank" rel="noopener">Android自定义ClassLoader耗时问题追查</a>  </li>
<li><a href="https://blog.csdn.net/csm_qz/article/details/50444933" target="_blank" rel="noopener">Android Dalvikvm的使用</a>  </li>
</ul>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    redspider110
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://redspider110.github.io/2018/11/05/0108-android-classloading/" title="Android 类加载机制">http://redspider110.github.io/2018/11/05/0108-android-classloading/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/10/08/0107-linux-shell/" rel="next" title="Linux Shell 命令及相关知识">
                <i class="fa fa-chevron-left"></i> Linux Shell 命令及相关知识
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/11/22/0109-android-camera-1-simple-use/" rel="prev" title="Android Camera 简单使用">
                Android Camera 简单使用 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="redspider110">
            
              <p class="site-author-name" itemprop="name">redspider110</p>
              <p class="site-description motion-element" itemprop="description">地球卫士</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">124</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">54</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          
            <div class="cc-license motion-element" itemprop="license">
              <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
                <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons">
              </a>
            </div>
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#JVM-虚拟机"><span class="nav-number">1.</span> <span class="nav-text">JVM 虚拟机</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#执行方式"><span class="nav-number">1.1.</span> <span class="nav-text">执行方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编译方式"><span class="nav-number">1.2.</span> <span class="nav-text">编译方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android-虚拟机"><span class="nav-number">2.</span> <span class="nav-text">Android 虚拟机</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#概念"><span class="nav-number">2.1.</span> <span class="nav-text">概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#两者的区别"><span class="nav-number">2.2.</span> <span class="nav-text">两者的区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件格式"><span class="nav-number">2.3.</span> <span class="nav-text">文件格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#转换流程图"><span class="nav-number">2.4.</span> <span class="nav-text">转换流程图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件分析工具"><span class="nav-number">2.5.</span> <span class="nav-text">文件分析工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例"><span class="nav-number">2.6.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#代码速查表"><span class="nav-number">3.</span> <span class="nav-text">代码速查表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android-类加载器"><span class="nav-number">4.</span> <span class="nav-text">Android 类加载器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#类图结构"><span class="nav-number">4.1.</span> <span class="nav-text">类图结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#双亲委派模型"><span class="nav-number">4.2.</span> <span class="nav-text">双亲委派模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ClassLoader"><span class="nav-number">4.3.</span> <span class="nav-text">ClassLoader</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BootClassLoader"><span class="nav-number">4.4.</span> <span class="nav-text">BootClassLoader</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Class"><span class="nav-number">4.5.</span> <span class="nav-text">Class</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PathClassLoader"><span class="nav-number">4.6.</span> <span class="nav-text">PathClassLoader</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DexClassLoader"><span class="nav-number">4.7.</span> <span class="nav-text">DexClassLoader</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#InMemoryDexClassLoader"><span class="nav-number">4.8.</span> <span class="nav-text">InMemoryDexClassLoader</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DelegateLastClassLoader"><span class="nav-number">4.9.</span> <span class="nav-text">DelegateLastClassLoader</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BaseDexClassLoader"><span class="nav-number">4.10.</span> <span class="nav-text">BaseDexClassLoader</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dex-文件加载与解析"><span class="nav-number">5.</span> <span class="nav-text">dex 文件加载与解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#DexFile"><span class="nav-number">5.1.</span> <span class="nav-text">DexFile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DexPathList"><span class="nav-number">5.2.</span> <span class="nav-text">DexPathList</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android-预加载"><span class="nav-number">6.</span> <span class="nav-text">Android 预加载</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#启动路径和系统服务路径"><span class="nav-number">6.1.</span> <span class="nav-text">启动路径和系统服务路径</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#预加载类-preloadClasses"><span class="nav-number">6.2.</span> <span class="nav-text">预加载类 preloadClasses</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建系统类加载器"><span class="nav-number">6.3.</span> <span class="nav-text">创建系统类加载器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#APK-及四大组件加载过程"><span class="nav-number">7.</span> <span class="nav-text">APK 及四大组件加载过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#APK-加载过程"><span class="nav-number">7.1.</span> <span class="nav-text">APK 加载过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Application-类加载过程"><span class="nav-number">7.2.</span> <span class="nav-text">Application 类加载过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Activity-类加载过程"><span class="nav-number">7.3.</span> <span class="nav-text">Activity 类加载过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Service-类加载过程"><span class="nav-number">7.4.</span> <span class="nav-text">Service 类加载过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#静态注册-BroadcastReceiver-类加载过程"><span class="nav-number">7.5.</span> <span class="nav-text">静态注册 BroadcastReceiver 类加载过程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android-动态类加载"><span class="nav-number">8.</span> <span class="nav-text">Android 动态类加载</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#生成-dex-文件"><span class="nav-number">8.1.</span> <span class="nav-text">生成 dex 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#当前-Activity-动态加载"><span class="nav-number">8.2.</span> <span class="nav-text">当前 Activity 动态加载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例-Log"><span class="nav-number">8.3.</span> <span class="nav-text">示例 Log</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android-热补丁"><span class="nav-number">9.</span> <span class="nav-text">Android 热补丁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#热补丁原理"><span class="nav-number">9.1.</span> <span class="nav-text">热补丁原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Test-类"><span class="nav-number">9.2.</span> <span class="nav-text">Test 类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#当前-Activity-合入热补丁"><span class="nav-number">9.3.</span> <span class="nav-text">当前 Activity 合入热补丁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例-Log-1"><span class="nav-number">9.4.</span> <span class="nav-text">示例 Log</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他"><span class="nav-number">10.</span> <span class="nav-text">其他</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dalvikvm"><span class="nav-number">10.1.</span> <span class="nav-text">dalvikvm</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AOSP-libcore-编译"><span class="nav-number">10.2.</span> <span class="nav-text">AOSP libcore 编译</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#常见问题"><span class="nav-number">11.</span> <span class="nav-text">常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#APK-加载过程-1"><span class="nav-number">11.1.</span> <span class="nav-text">APK 加载过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Android-类加载时机"><span class="nav-number">11.2.</span> <span class="nav-text">Android 类加载时机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#打印类加载过程"><span class="nav-number">11.3.</span> <span class="nav-text">打印类加载过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#几个重要的-native-方法"><span class="nav-number">11.4.</span> <span class="nav-text">几个重要的 native 方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#后续"><span class="nav-number">12.</span> <span class="nav-text">后续</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考文档"><span class="nav-number">13.</span> <span class="nav-text">参考文档</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">redspider110</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  

  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
