<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Android,FourComponents,">










<meta name="description" content="广播 Broadcast 属于 Android 四大组件之一，通过观察者模式，用于实现进程间的异步通信。">
<meta name="keywords" content="Android,FourComponents">
<meta property="og:type" content="article">
<meta property="og:title" content="四大组件 -- Broadcast">
<meta property="og:url" content="http://redspider110.github.io/2017/11/27/0021-broadcast/index.html">
<meta property="og:site_name" content="Earth Guardian">
<meta property="og:description" content="广播 Broadcast 属于 Android 四大组件之一，通过观察者模式，用于实现进程间的异步通信。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0021-broadcast-manifest-declare-receiver.png">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0021-broadcast-register-receiver.png">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0021-broadcast-sendbroadcast-1.png">
<meta property="og:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0021-broadcast-sendbroadcast-2.png">
<meta property="og:updated_time" content="2019-09-18T09:30:13.342Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="四大组件 -- Broadcast">
<meta name="twitter:description" content="广播 Broadcast 属于 Android 四大组件之一，通过观察者模式，用于实现进程间的异步通信。">
<meta name="twitter:image" content="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0021-broadcast-manifest-declare-receiver.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://redspider110.github.io/2017/11/27/0021-broadcast/">





  <title>四大组件 -- Broadcast | Earth Guardian</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?faa79b658398065f8158bf82b6221b6d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Earth Guardian</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">You are not LATE!You are not EARLY!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://redspider110.github.io/2017/11/27/0021-broadcast/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="redspider110">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Earth Guardian">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">四大组件 -- Broadcast</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-27T12:00:00+08:00">
                2017-11-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-eye"></i> 阅读次数
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>广播 <code>Broadcast</code> 属于 <code>Android</code> 四大组件之一，通过观察者模式，用于实现进程间的异步通信。  </p>
<a id="more"></a>

<p>广播的实现机制是观察者模式；消息发布/订阅模式的事件驱动模型，消息的生产者发布事件，而使用者订阅感兴趣的事件。<code>Broadcast</code> 机制和 <code>Binder</code> 机制不一样的地方在于：广播的发送者和接收者事先是不需要知道对方的存在的，这也是观察者模式的特点，显而易见的优点是系统的各个组件可以松耦合地组织在一起，所有的广播发送和接收都是通过系统 <code>AMS</code> 来调度的，它充当了广播总线的功能。  </p>
<h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><p>广播实现进程间异步交互：进程间通信时通过 <code>Binder</code> 来实现的，异步通信是通过 <code>Handler</code> 实现。  </p>
<h3 id="广播接收器的分类"><a href="#广播接收器的分类" class="headerlink" title="广播接收器的分类"></a>广播接收器的分类</h3><ul>
<li>静态注册广播接收器：<code>Manifest-declared receivers</code><br>在 <code>AndroidManifest.xml</code> 文件中通过 <code>&lt;receiver&gt;</code> 声明的广播接收器。  </li>
<li>动态注册广播接收器：<code>Context-registered receivers</code><br>通过 <code>registerReceiver</code> 注册的广播接收器。</li>
</ul>
<h3 id="广播的分类"><a href="#广播的分类" class="headerlink" title="广播的分类"></a>广播的分类</h3><ul>
<li>普通广播<br>通过 <code>sendBroadcast</code> 发出的广播。  </li>
<li>有序广播<br>通过 <code>sendOrderedBroadcast</code> 发出的广播；有序广播对应的广播接收器存在优先级关系，优先级越高越先收到广播。有序广播还可以有回调广播接收器，即广播匹配的所有广播接收器处理完毕后，系统会再向广播发送者，发回这个回调。  </li>
<li>粘性广播<br>通过 <code>sendStickyBroadcast</code> 发出的广播。粘性广播发送后，系统会把代表这个广播的 <code>Intent</code> 保存下来，如果后面在动态注册相同 <code>Action</code> 的广播接收器时，系统就将最后发出的粘性广播重新发送给这个广播接收器。也就是说，尽管广播早就发送处理完毕了，但是后续如果有新注册的广播接收器能匹配这个广播，还是会响应广播事件的。但是粘性广播从 <code>Android 5.0</code> 开始就将相关系统接口全部标注为 <code>@Deprecated</code>。它们不提供安全性（任何人都可以访问它们），没有保护（任何人都可以修改它们）以及许多其他问题。所以 <code>Android</code> 平台已经弃用，本文也不做介绍。  </li>
</ul>
<h3 id="广播的标记"><a href="#广播的标记" class="headerlink" title="广播的标记"></a>广播的标记</h3><p>根据发送广播 <code>Intent</code> 设置的标记来区分：  </p>
<ul>
<li><code>FLAG_RECEIVER_FOREGROUND</code><br>表示广播为<strong>前台广播</strong>，允许接收者以前台的优先级运行，有更短的时间间隔。<strong>默认情况下广播都是后台广播</strong>  </li>
<li><code>FLAG_RECEIVER_REPLACE_PENDING</code><br>表示新的广播会替换掉那些已存在的相同广播。相同的定义是通过 <code>Intent.filterEquals</code> 方法对两个广播的 <code>Intent</code> 比较，当匹配到相同的，新的广播和对应的接收器会将待发送的广播列表中已存在的替换掉，在列表中保留同样的位置。这个标志通常被粘性广播使用，只保证将最新的广播的值传递给接收器。  </li>
</ul>
<h3 id="广播的-ANR"><a href="#广播的-ANR" class="headerlink" title="广播的 ANR"></a>广播的 <code>ANR</code></h3><p>前台广播的 <code>ANR</code> 时间是 10 秒，后台广播是 60 秒。因为默认为后台广播，所以通常情况下，需要在 60 秒内处理完所有的广播事件。<strong>广播的 <code>ANR</code> 只会出现在有序处理的广播队列中（包含有序广播和静态注册的广播接收器匹配的普通广播）中</strong>。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityManagerService.java</span></span><br><span class="line"><span class="comment">// How long we allow a receiver to run before giving up on it.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BROADCAST_FG_TIMEOUT = <span class="number">10</span>*<span class="number">1000</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BROADCAST_BG_TIMEOUT = <span class="number">60</span>*<span class="number">1000</span>;</span><br></pre></td></tr></table></figure>

<h2 id="相关类文件"><a href="#相关类文件" class="headerlink" title="相关类文件"></a>相关类文件</h2><h3 id="速查表"><a href="#速查表" class="headerlink" title="速查表"></a>速查表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">framework/base</span><br><span class="line">    ./core/java/android/app/ContextImpl.java</span><br><span class="line">    ./core/java/android/app/ActivityThread.java</span><br><span class="line">    ./core/java/android/app/LoadedApk.java</span><br><span class="line">    ./core/java/android/app/BroadcastOptions.java</span><br><span class="line">    ./core/java/android/content/IIntentReceiver.aidl</span><br><span class="line">    ./core/java/android/content/pm/PackageParser.java</span><br><span class="line">    ./core/java/android/content/BroadcastReceiver.java</span><br><span class="line">    ./services/core/java/com/android/server/am/BroadcastRecord.java</span><br><span class="line">    ./services/core/java/com/android/server/am/ReceiverList.java</span><br><span class="line">    ./services/core/java/com/android/server/am/BroadcastFilter.java</span><br><span class="line">    ./services/core/java/com/android/server/am/BroadcastQueue.java</span><br><span class="line">    ./services/core/java/com/android/server/am/ActivityManagerService.java</span><br><span class="line">    ./services/core/java/com/android/server/pm/PackageManagerService.java</span><br></pre></td></tr></table></figure>

<h3 id="类简介"><a href="#类简介" class="headerlink" title="类简介"></a>类简介</h3><ul>
<li><code>BroadCastReceiver</code><br>广播接收器，用于处理接收的每个广播事件。  </li>
<li><code>IIntentReceiver</code><br>是 <code>AIDL</code> 文件，每个 <code>BroadCastReceiver</code> 都会转换为一个 <code>IIntentReceiver</code>，用来跨进程传递数据。  </li>
<li><code>LoadedApk.ReceiverDispatcher</code><br>广播接收发布器，<code>BroadCastReceiver</code> 都是在这转换为 <code>IIntentReceiver</code> 的。每个动态注册的广播接收器 <code>BroadcastReceiver</code> 都对应一个 <code>LoadedApk.ReceiverDispatcher</code> ，最终都是在这进行响应调用 <code>onReceive</code> 的。  </li>
<li><code>BroadcastFilter</code><br>是 <code>IntentFilter</code> 的子类，广播过滤器，用于匹配广播 <code>Intent</code>；包含广播接收者相关信息，权限等。只有动态注册广播广播接收器会用到。  </li>
<li><code>ReceiverList</code><br>是 <code>ArrayList</code> 的子类，是一个集合用来存储 <code>BroadcastFilter</code> 。记录广播接收器相关信息等，只有动态注册的广播接收器会用到，每个 <code>BroadCastReceiver</code> 对应一个 <code>ReceiverList</code> ，而每个 <code>ReceiverList</code> 可以包含多个 <code>BroadcastFilter</code> ，表示能够监听多个广播。  </li>
<li><code>BroadcastRecord</code><br>继承了 <code>Binder</code>，用来跨进程传递数据。发送的每个广播 <code>Intent</code> ，最后都会对应一个 <code>BroadcastRecord</code> ；它记录了广播的发送时间，发送者，<strong>接受者</strong>，广播携带的数据，回调，所在 <code>BroadcastQueue</code> 等等。  </li>
<li><code>BroadcastQueue</code><br>广播队列，有两个 <code>ArrayList&lt;BroadcastRecord&gt;</code> 用于存储 <code>BroadcastRecord</code> 分别是：<code>mParallelBroadcasts</code> 存储并行处理的广播；<code>mOrderedBroadcasts</code> 存储有序处理的广播。  </li>
<li><code>ContextImpl</code><br>广播发送，广播接收器动态注册的入口。  </li>
<li><code>ActivityThread</code><br>应用主线程，广播发送过程都是由它进入系统进程 <code>AMS</code>，广播接收器响应事件是有系统 <code>AMS</code> 进入它。  </li>
<li><code>ActivityManagerService</code><br><code>AMS</code> 系统四大组件大管家，类似广播总线：管理广播接收器的注册，管理广播的发送到匹配的广播接收器中处理。  </li>
<li><code>PackageParser</code><br>包解析类，会从 <code>AndroidManifest.xml</code> 中解析出静态注册的广播接收器。  </li>
<li><code>PackageManagerService</code><br><code>PMS</code> 系统包管家，负责静态注册广播接收器的存储，查询。  </li>
</ul>
<h2 id="BroadcastFilter-类详解"><a href="#BroadcastFilter-类详解" class="headerlink" title="BroadcastFilter 类详解"></a><code>BroadcastFilter</code> 类详解</h2><p><code>BroadcastFilter</code> 继承了 <code>IntentFilter</code> 类，广播信息过滤器，即动态注册广播接收器时，注册的是哪个广播过滤器。  </p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BroadcastFilter</span> <span class="keyword">extends</span> <span class="title">IntentFilter</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Back-pointer to the list this filter is in.</span></span><br><span class="line">    <span class="keyword">final</span> ReceiverList receiverList;</span><br><span class="line">    <span class="keyword">final</span> String packageName;</span><br><span class="line">    <span class="keyword">final</span> String requiredPermission;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> owningUid;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> owningUserId;</span><br><span class="line"></span><br><span class="line">    BroadcastFilter(IntentFilter _filter, ReceiverList _receiverList,</span><br><span class="line">            String _packageName, String _requiredPermission, </span><br><span class="line">            <span class="keyword">int</span> _owningUid, <span class="keyword">int</span> _userId) &#123;</span><br><span class="line">        <span class="keyword">super</span>(_filter);</span><br><span class="line">        receiverList = _receiverList;</span><br><span class="line">        packageName = _packageName;</span><br><span class="line">        requiredPermission = _requiredPermission;</span><br><span class="line">        owningUid = _owningUid;</span><br><span class="line">        owningUserId = _userId;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dump</span><span class="params">(PrintWriter pw, String prefix)</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dumpBrief</span><span class="params">(PrintWriter pw, String prefix)</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dumpInReceiverList</span><span class="params">(PrintWriter pw, Printer pr, </span></span></span><br><span class="line"><span class="function"><span class="params">        String prefix)</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dumpBroadcastFilterState</span><span class="params">(PrintWriter pw, String prefix)</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>

<h3 id="成员变量"><a href="#成员变量" class="headerlink" title="成员变量"></a>成员变量</h3><ul>
<li><code>receiverList</code> ：当前对象属于哪个接收列表  </li>
<li><code>packageName</code> ：动态注册广播发起者的包名  </li>
<li><code>requiredPermission</code> ：设置发送广播时需要的权限  </li>
<li><code>owningUid</code> ：动态注册广播发起者 <code>Uid</code>  </li>
<li><code>owningUserId</code> ：动态注册广播发起者 <code>UserId</code>   </li>
</ul>
<p>这里简单介绍下 <code>uid, userId</code> 的区别：  </p>
<ul>
<li><code>uid</code><br>是 <code>Linux</code> 下的概念，表示 <code>Linux</code> 系统下的用户 <code>ID</code> 。  </li>
<li><code>userId</code><br>是 <code>Android</code> 的多用户概念，从 4.2 开始系统支持多用户登录，记录登录用户的 <code>ID</code> ；不支持多用户登录的系统上，这个值是唯一的。多用户支持是在 <code>frameworks/base/core/res/res/values/config.xml</code> 文件中，<code>config_multiuserMaximumUsers</code> 值来决定的。  </li>
</ul>
<h2 id="ReceiverList-类详解"><a href="#ReceiverList-类详解" class="headerlink" title="ReceiverList 类详解"></a><code>ReceiverList</code> 类详解</h2><p><code>ReceiverList</code> 继承了 <code>ArrayList</code> ，本质上是一个数据集合，数据类型为 <code>BroadcastFilter</code>。动态注册广播接收器时，每个广播接收器 <code>BroadCastReceiver</code> 对应一个 <code>ReceiverList</code> ，记录了一系列 <code>BroadcastFilter</code> 的列表，表示这个广播接收器注册了一个或多个广播过滤器。  </p>
<h3 id="源码分析-1"><a href="#源码分析-1" class="headerlink" title="源码分析"></a>源码分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ReceiverList</span> <span class="keyword">extends</span> <span class="title">ArrayList</span>&lt;<span class="title">BroadcastFilter</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">IBinder</span>.<span class="title">DeathRecipient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ActivityManagerService owner;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> IIntentReceiver receiver;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ProcessRecord app;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> pid;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> uid;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> userId;</span><br><span class="line">    BroadcastRecord curBroadcast = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> linkedToDeath = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    String stringName;</span><br><span class="line">    </span><br><span class="line">    ReceiverList(ActivityManagerService _owner, ProcessRecord _app,</span><br><span class="line">            <span class="keyword">int</span> _pid, <span class="keyword">int</span> _uid, <span class="keyword">int</span> _userId, IIntentReceiver _receiver) &#123;</span><br><span class="line">        owner = _owner;</span><br><span class="line">        receiver = _receiver;</span><br><span class="line">        app = _app;</span><br><span class="line">        pid = _pid;</span><br><span class="line">        uid = _uid;</span><br><span class="line">        userId = _userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Want object identity, not the array identity we are inheriting.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;<span class="keyword">return</span> <span class="keyword">this</span> == o;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> System.identityHashCode(<span class="keyword">this</span>);&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">binderDied</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        linkedToDeath = <span class="keyword">false</span>;</span><br><span class="line">        owner.unregisterReceiver(receiver);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dumpLocal</span><span class="params">(PrintWriter pw, String prefix)</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dump</span><span class="params">(PrintWriter pw, String prefix)</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>

<h3 id="成员变量-1"><a href="#成员变量-1" class="headerlink" title="成员变量"></a>成员变量</h3><ul>
<li><code>ActivityManagerService owner</code> ： <code>AMS</code> 对象  </li>
<li><code>IIntentReceiver receiver</code> ：当前 <code>ReceiverList</code> 对应的 <code>IIntentReceiver</code>  </li>
<li><code>ProcessRecord app</code> ：动态注册广播发起者进程相关信息  </li>
<li><code>pid</code> ：动态注册广播发起者进程 <code>Id</code>  </li>
<li><code>uid</code> ：动态注册广播发起者 <code>uid</code>  </li>
<li><code>userId</code> ：动态注册广播发起者 <code>userId</code>  </li>
<li><code>BroadcastRecord curBroadcast</code> ：动态注册的广播，其详细信息  </li>
<li><code>linkedToDeath</code> ：<code>Binder</code> 通信机制是否断开  </li>
<li><code>stringName</code> ：<code>ReceiverList</code> 转换成的字符串  </li>
</ul>
<h2 id="BroadCastReceiver-类详解"><a href="#BroadCastReceiver-类详解" class="headerlink" title="BroadCastReceiver 类详解"></a><code>BroadCastReceiver</code> 类详解</h2><p><code>BroadCastReceiver</code> 广播接收器，用来处理监听的广播事件。<code>BroadcastReceiver</code> 是抽象类，抽象方法为 <code>onReceive</code> ，注册广播接收器前，需要在其子类中实现。  </p>
<h3 id="PendingResult-类"><a href="#PendingResult-类" class="headerlink" title="PendingResult 类"></a><code>PendingResult</code> 类</h3><p><code>PendingResult</code> 是广播接收器待处理的结果类，是异步结果类；简要介绍下这个类存在的意义：<br>通常情况下，<code>UI</code> 主线程阻塞超过 5 秒就会产生 <code>ANR</code>，更不用说卡顿现象 <code>UI Jank</code>；所以广播接收器中如果有耗时工作（比如磁盘读写，网络下载等），需要及时切换到后台工作线程中执行；而 <code>PendingResult</code> 就存储了广播处理器接收到广播所有相关信息，将 <code>PendingResult</code> 对象传递到后台工作线程完成广播处理，处理完后需要调用 <code>PendingResult.finish()</code> 通过系统该广播接收器已经处理完毕。 <code>PendingResult</code> 类有两个注意事项：  </p>
<ul>
<li><strong><code>PendingResult</code> 类中的状态不是线程安全的</strong>，使用时将整个对象交给后台工作线程，避免并发竞争，该线程将负责设置结果并最终调用 <code>finish()</code>  </li>
<li>系统中关于广播接收器的 <code>ANR</code> ：前台广播接收器允许运行时间大概是 10 秒，后台广播是 60 秒，如果广播处理器没有处理完毕就会产生 <code>ANR</code> 。注意这个过程的计算时间是：从广播分发到广播处理器，直到广播处理器通知系统处理完毕的总时间。即使通过 <code>PendingResult</code> 切换到后台工作线程，直到调用 <code>PendingResult.finish()</code> ，这整个过程都受到了这个 <code>ANR</code> 时间的限制。所以长时间的工作是不能放到 <code>BroadCastReceiver</code> 中来实现的，<code>PendingResult</code> 仅仅是多争取到了几秒钟  </li>
</ul>
<h3 id="PendingResult-类的两个子类"><a href="#PendingResult-类的两个子类" class="headerlink" title="PendingResult 类的两个子类"></a><code>PendingResult</code> 类的两个子类</h3><p><code>PendingResult</code> 类的构造方法是 <code>@hide</code> 隐藏的，通常在 <code>BroadcastReceiver.onReceive()</code> 中调用 <code>goAsync()</code> 返回得到；而实际构造是在其子类中，静态注册广播和动态注册广播对应不同的子类：  </p>
<ul>
<li><p><code>ActivityThread.ReceiverData</code> 对应静态注册广播  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ReceiverData</span> <span class="keyword">extends</span> </span></span><br><span class="line"><span class="class">    <span class="title">BroadcastReceiver</span>.<span class="title">PendingResult</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReceiverData</span><span class="params">(Intent intent,<span class="keyword">int</span> resultCode,String resultData,</span></span></span><br><span class="line"><span class="function"><span class="params">        Bundle resultExtras,  <span class="keyword">boolean</span> ordered, <span class="keyword">boolean</span> sticky, </span></span></span><br><span class="line"><span class="function"><span class="params">        IBinder token, <span class="keyword">int</span> sendingUser)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(resultCode, resultData, resultExtras, TYPE_COMPONENT, </span><br><span class="line">            ordered, sticky,token, sendingUser, intent.getFlags());</span><br><span class="line">        <span class="keyword">this</span>.intent = intent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Intent intent;</span><br><span class="line">    ActivityInfo info;</span><br><span class="line">    CompatibilityInfo compatInfo;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>LoadedApk.ReceiverDispatcher.Args</code> 对应动态注册广播  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Args</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span>.<span class="title">PendingResult</span> </span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Intent mCurIntent;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> mOrdered;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mDispatched;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Args</span><span class="params">(Intent intent, <span class="keyword">int</span> resultCode, String resultData, </span></span></span><br><span class="line"><span class="function"><span class="params">        Bundle resultExtras, <span class="keyword">boolean</span> ordered, </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> sendingUser)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(resultCode, resultData, resultExtras,</span><br><span class="line">                mRegistered ? TYPE_REGISTERED : TYPE_UNREGISTERED, </span><br><span class="line">                ordered, sticky, mIIntentReceiver.asBinder(), </span><br><span class="line">                sendingUser, intent.getFlags());</span><br><span class="line">        mCurIntent = intent;</span><br><span class="line">        mOrdered = ordered;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="PendingResult-类源码分析"><a href="#PendingResult-类源码分析" class="headerlink" title="PendingResult 类源码分析"></a><code>PendingResult</code> 类源码分析</h3><p><code>PendingResult</code> 对应的广播类型有三种：  </p>
<ul>
<li><code>TYPE_COMPONENT</code> ：静态注册广播  </li>
<li><code>TYPE_REGISTERED</code> ：动态注册广播  </li>
<li><code>TYPE_UNREGISTERED</code> ：取消广播注册  </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PendingResult</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 广播类型：静态注册，动态注册，解除注册</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_COMPONENT = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_REGISTERED = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_UNREGISTERED = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mType;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> mOrderedHint;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> mInitialStickyHint;</span><br><span class="line">    <span class="keyword">final</span> IBinder mToken;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mSendingUser;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mFlags;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> mResultCode;</span><br><span class="line">    String mResultData;</span><br><span class="line">    Bundle mResultExtras;</span><br><span class="line">    <span class="keyword">boolean</span> mAbortBroadcast;</span><br><span class="line">    <span class="keyword">boolean</span> mFinished;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PendingResult</span><span class="params">(<span class="keyword">int</span> resultCode, String resultData, </span></span></span><br><span class="line"><span class="function"><span class="params">            Bundle resultExtras, <span class="keyword">int</span> type, <span class="keyword">boolean</span> ordered, </span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> sticky, IBinder token, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">        mResultCode = resultCode;</span><br><span class="line">        mResultData = resultData;</span><br><span class="line">        mResultExtras = resultExtras;</span><br><span class="line">        mType = type;</span><br><span class="line">        mOrderedHint = ordered;</span><br><span class="line">        mInitialStickyHint = sticky;</span><br><span class="line">        mToken = token;</span><br><span class="line">        mSendingUser = userId;</span><br><span class="line">        mFlags = flags;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取和保存广播相关信息</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setResultCode</span><span class="params">(<span class="keyword">int</span> code)</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getResultCode</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setResultData</span><span class="params">(String data)</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">getResultData</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setResultExtras</span><span class="params">(Bundle extras)</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Bundle <span class="title">getResultExtras</span><span class="params">(<span class="keyword">boolean</span> makeMap)</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setResult</span><span class="params">(<span class="keyword">int</span> code, String data, </span></span></span><br><span class="line"><span class="function"><span class="params">        Bundle extras)</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSendingUserId</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 终止有序广播</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">getAbortBroadcast</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> mAbortBroadcast;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">abortBroadcast</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        checkSynchronousHint();</span><br><span class="line">        mAbortBroadcast = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">clearAbortBroadcast</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mAbortBroadcast = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mType == TYPE_COMPONENT) &#123;</span><br><span class="line">            <span class="comment">// 如果是静态注册广播</span></span><br><span class="line">            <span class="keyword">final</span> IActivityManager mgr = ActivityManager.getService();</span><br><span class="line">            <span class="keyword">if</span> (QueuedWork.hasPendingWork()) &#123;</span><br><span class="line">                <span class="comment">// 如果还有任务没有执行完，将任务加入队列排队执行</span></span><br><span class="line">                QueuedWork.queue(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        ...</span><br><span class="line">                        sendFinished(mgr);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="keyword">false</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ...</span><br><span class="line">                sendFinished(mgr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mOrderedHint &amp;&amp; mType != TYPE_UNREGISTERED) &#123;</span><br><span class="line">            <span class="comment">// 如果是有序广播</span></span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">final</span> IActivityManager mgr = ActivityManager.getService();</span><br><span class="line">            sendFinished(mgr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置类加载器</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExtrasClassLoader</span><span class="params">(ClassLoader cl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mResultExtras != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mResultExtras.setClassLoader(cl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendFinished</span><span class="params">(IActivityManager am)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mFinished) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"..."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mFinished = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mResultExtras != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mResultExtras.setAllowFds(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mOrderedHint) &#123;</span><br><span class="line">                am.finishReceiver(mToken, mResultCode, mResultData, </span><br><span class="line">                    mResultExtras, mAbortBroadcast, mFlags);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                am.finishReceiver(mToken, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>, mFlags);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="BroadcastReceiver-源码分析"><a href="#BroadcastReceiver-源码分析" class="headerlink" title="BroadcastReceiver 源码分析"></a><code>BroadcastReceiver</code> 源码分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BroadcastReceiver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> PendingResult mPendingResult;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PendingResult</span> </span>&#123;...&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BroadcastReceiver</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> PendingResult <span class="title">goAsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        PendingResult res = mPendingResult;</span><br><span class="line">        mPendingResult = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">peekService</span><span class="params">(Context myContext, Intent service)</span> </span>&#123;...&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置 PendingResult 实例，存储获取相关结果</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setPendingResult</span><span class="params">(PendingResult result)</span> </span>&#123;</span><br><span class="line">        mPendingResult = result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> PendingResult <span class="title">getPendingResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mPendingResult;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">getResultData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mPendingResult != <span class="keyword">null</span> ? mPendingResult.mResultData : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setResultExtras</span><span class="params">(Bundle extras)</span> </span>&#123;</span><br><span class="line">        checkSynchronousHint();</span><br><span class="line">        mPendingResult.mResultExtras = extras;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setResultCode</span><span class="params">(<span class="keyword">int</span> code)</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getResultCode</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Bundle <span class="title">getResultExtras</span><span class="params">(<span class="keyword">boolean</span> makeMap)</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setResult</span><span class="params">(<span class="keyword">int</span> code, String data, </span></span></span><br><span class="line"><span class="function"><span class="params">        Bundle extras)</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSendingUserId</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 终止有序广播</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">getAbortBroadcast</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mPendingResult != <span class="keyword">null</span> ? </span><br><span class="line">            mPendingResult.mAbortBroadcast : <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">abortBroadcast</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        checkSynchronousHint();</span><br><span class="line">        mPendingResult.mAbortBroadcast = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">clearAbortBroadcast</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mPendingResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mPendingResult.mAbortBroadcast = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isOrderedBroadcast</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isInitialStickyBroadcast</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="BroadcastReceiver-重要方法"><a href="#BroadcastReceiver-重要方法" class="headerlink" title="BroadcastReceiver 重要方法"></a><code>BroadcastReceiver</code> 重要方法</h3><p><code>BroadcastReceiver</code> 大部分数据存储都是通过 <code>PendingResult</code> 实例来保存的。  </p>
<ul>
<li><code>onReceive</code><br>抽象方法，子类必须实现；广播接收器处理的入口。  </li>
<li><code>goAsync</code><br>异步广播，返回 <code>PendingResult</code> 实例，进入后台线程处理；处理完毕后必须调用 <code>PendingResult.finish()</code> 结束。  </li>
<li><code>abortBroadcast</code><br>如果广播接收器收到的是有序广播，则终止有序广播继续向下传递。  </li>
</ul>
<h2 id="IIntentReceiver-详解"><a href="#IIntentReceiver-详解" class="headerlink" title="IIntentReceiver 详解"></a><code>IIntentReceiver</code> 详解</h2><p><code>IIntentReceiver</code> 是一个 <code>AIDL</code> 文件，所以 <code>IIntentReceiver</code> 接口继承了 <code>Binder</code> 机制中的 <code>IInterface</code> ，表示服务端拥有的能力或者说能提供的功能。 <code>IIntentReceiver</code> 声明的方法，是在 <code>LoadedApk.ReceiverDispatcher.InnerReceiver</code> 中实现的。<code>IIntentReceiver.aidl</code> 源码如下：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// frameworks/base/core/java/android/content/IIntentReceiver.aidl</span><br><span class="line">/**</span><br><span class="line"> * System private API for dispatching intent broadcasts.  </span><br><span class="line"> * This is given to the activity manager as part of registering for </span><br><span class="line"> * an intent broadcasts, and is called when it receives intents.</span><br><span class="line"> *</span><br><span class="line"> * &#123;@hide&#125;</span><br><span class="line"> */</span><br><span class="line">oneway interface IIntentReceiver &#123;</span><br><span class="line">    void performReceive(in Intent intent, int resultCode, String data,</span><br><span class="line">            in Bundle extras, boolean ordered, </span><br><span class="line">            boolean sticky, int sendingUser);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>BroadCastReceiver</code> 是系统组件，并不支持跨进程传输，<code>Android Broadcast</code> 机制使用 <code>IIntentReceiver</code> 来进行代替 <code>BroadCastReceiver</code> 来进行跨进程传输。<br>可以看出 <code>IIntentReceiver</code> 只提供了一个方法 <code>performReceive</code> ，该方法仅仅在动态注册的广播接收器中会触发调用（静态注册广播接收器在 <code>ActivityThread</code> 中通过反射直接调用 <code>onReceive</code> 回调）；系统进程 <code>AMS</code> 在分发广播处理事件时，会向注册了广播接收的应用进程调用该方法，最终调用 <code>BroadcastReceiver.onReceive</code> 触发回调。注意：<strong>方法使用了 <code>oneway</code> 关键字</strong>，表示非阻塞调用；即 <code>AMS</code> 进程分发广播事件时，不需要等待每个应用接收者执行完 <code>onReceive</code> 。  </p>
<h2 id="LoadedApk-类"><a href="#LoadedApk-类" class="headerlink" title="LoadedApk 类"></a><code>LoadedApk</code> 类</h2><p><code>LoadedApk</code> 类存储了当前加载的 <code>Apk</code> 相关信息，包括主线程，文件所在路径，类加载器，注册的广播列表，启动的服务列表等等；<code>LoadedApk</code> 类是在每个应用加载初始化进程、主线程时实例化的，每个应用对应一个 <code>LoadedApk</code> 实例。<br>本文只分析和广播 <code>Broadcast</code> 相关内容，<code>LoadedApk</code> 中存储了当前 <code>Apk</code> 中所有的普通广播接收器 <code>BroadCastReceiver</code> ，即通过 <code>registerReceiver</code> 注册到系统中的广播接收器。<br>而<strong>有序广播中的回调广播接收器</strong>，即广播发送出去后，等待所有广播接收器处理完毕，最后产生一个回调给广播发送者，作用类似 <code>startActivityForResult</code> 。回调 <code>BroadCastReceiver</code> 不需要通过 <code>registerReceiver</code> 注册到系统中，是以参数的形式在 <code>sendOrderedBroadcast()</code> 发送广播时传递出去，这类广播不会存储到 <code>LoadedApk</code> 中。  </p>
<p>在 <code>ContextImpl</code> 代码中可以看到：<code>LoadedApk</code> 对这两类广播接收器的处理过程：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ContextImpl.java  </span></span><br><span class="line"><span class="comment">// 1. 普通广播接收器：注册广播接收器时，在 LoadedApk 中保存下来</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Intent <span class="title">registerReceiverInternal</span><span class="params">(BroadcastReceiver receiver, </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> userId, IntentFilter filter, String broadcastPermission,</span></span></span><br><span class="line"><span class="function"><span class="params">        Handler scheduler, Context context)</span> </span>&#123;</span><br><span class="line">    IIntentReceiver rd = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (receiver != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPackageInfo != <span class="keyword">null</span> &amp;&amp; context != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (scheduler == <span class="keyword">null</span>) &#123;</span><br><span class="line">                scheduler = mMainThread.getHandler();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 获取广播接收器对应的 IIntentReceiver</span></span><br><span class="line">            <span class="comment">// register 变量值为 true, LoadedApk 保存该广播接收器</span></span><br><span class="line">            rd = mPackageInfo.getReceiverDispatcher(</span><br><span class="line">                receiver, context, scheduler,</span><br><span class="line">                mMainThread.getInstrumentation(), <span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (scheduler == <span class="keyword">null</span>) &#123;</span><br><span class="line">                scheduler = mMainThread.getHandler();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果 LoadedApk 没有加载，则新建一个 IIntentReceiver 对象  </span></span><br><span class="line">            rd = <span class="keyword">new</span> LoadedApk.ReceiverDispatcher(receiver, context, </span><br><span class="line">                scheduler, <span class="keyword">null</span>, <span class="keyword">true</span>).getIIntentReceiver();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 有序广播接收器：不注册广播，所以也不会保存</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendOrderedBroadcastAsUser</span><span class="params">(Intent intent, UserHandle user,</span></span></span><br><span class="line"><span class="function"><span class="params">        String receiverPermission, <span class="keyword">int</span> appOp, Bundle options, </span></span></span><br><span class="line"><span class="function"><span class="params">        BroadcastReceiver resultReceiver, Handler scheduler, </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> initialCode, String initialData, Bundle initialExtras)</span> </span>&#123;</span><br><span class="line">    IIntentReceiver rd = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (resultReceiver != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPackageInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (scheduler == <span class="keyword">null</span>) &#123;</span><br><span class="line">                scheduler = mMainThread.getHandler();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 获取广播接收器对应的 IIntentReceiver</span></span><br><span class="line">            <span class="comment">// register 变量值为 false，不做保存</span></span><br><span class="line">            rd = mPackageInfo.getReceiverDispatcher(</span><br><span class="line">                resultReceiver, getOuterContext(), scheduler,</span><br><span class="line">                mMainThread.getInstrumentation(), <span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (scheduler == <span class="keyword">null</span>) &#123;</span><br><span class="line">                scheduler = mMainThread.getHandler();</span><br><span class="line">            &#125;</span><br><span class="line">            rd = <span class="keyword">new</span> LoadedApk.ReceiverDispatcher(resultReceiver, </span><br><span class="line">                getOuterContext(), scheduler, <span class="keyword">null</span>, <span class="keyword">false</span>)</span><br><span class="line">                .getIIntentReceiver();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="部分源码分析"><a href="#部分源码分析" class="headerlink" title="部分源码分析"></a>部分源码分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadedApk</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 保存所有通过 registerReceiver 注册的广播接收器</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayMap&lt;Context, </span><br><span class="line">            ArrayMap&lt;BroadcastReceiver, ReceiverDispatcher&gt;&gt; mReceivers</span><br><span class="line">        = <span class="keyword">new</span> ArrayMap&lt;Context, </span><br><span class="line">            ArrayMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayMap&lt;Context, </span><br><span class="line">            ArrayMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt;&gt; </span><br><span class="line">            mUnregisteredReceivers</span><br><span class="line">        = <span class="keyword">new</span> ArrayMap&lt;Context, </span><br><span class="line">            ArrayMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IIntentReceiver <span class="title">getReceiverDispatcher</span><span class="params">(BroadcastReceiver r,</span></span></span><br><span class="line"><span class="function"><span class="params">            Context context, Handler handler,</span></span></span><br><span class="line"><span class="function"><span class="params">            Instrumentation instrumentation, <span class="keyword">boolean</span> registered)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (mReceivers) &#123;</span><br><span class="line">        LoadedApk.ReceiverDispatcher rd = <span class="keyword">null</span>;</span><br><span class="line">        ArrayMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt; map=<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (registered) &#123;</span><br><span class="line">            map = mReceivers.get(context);</span><br><span class="line">            <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</span><br><span class="line">                rd = map.get(r);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (rd == <span class="keyword">null</span>) &#123;</span><br><span class="line">            rd = <span class="keyword">new</span> ReceiverDispatcher(r, context, handler,</span><br><span class="line">                    instrumentation, registered);</span><br><span class="line">            <span class="comment">// 如果是通过 registerReceiver 注册的，保存到 mReceivers 中</span></span><br><span class="line">            <span class="keyword">if</span> (registered) &#123;</span><br><span class="line">                <span class="keyword">if</span> (map == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    map = <span class="keyword">new</span> ArrayMap&lt;BroadcastReceiver, </span><br><span class="line">                        LoadedApk.ReceiverDispatcher&gt;();</span><br><span class="line">                    mReceivers.put(context, map);</span><br><span class="line">                &#125;</span><br><span class="line">                map.put(r, rd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            rd.validate(context, handler);</span><br><span class="line">        &#125;</span><br><span class="line">        rd.mForgotten = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> rd.getIIntentReceiver();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> IIntentReceiver <span class="title">forgetReceiverDispatcher</span><span class="params">(Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">            BroadcastReceiver r)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (mReceivers) &#123;</span><br><span class="line">        ArrayMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt; </span><br><span class="line">            map = mReceivers.get(context);</span><br><span class="line">        LoadedApk.ReceiverDispatcher rd = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</span><br><span class="line">          rd = map.get(r);</span><br><span class="line">          <span class="keyword">if</span> (rd != <span class="keyword">null</span>) &#123;</span><br><span class="line">            map.remove(r);</span><br><span class="line">            <span class="keyword">if</span> (map.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                mReceivers.remove(context);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (r.getDebugUnregister()) &#123;</span><br><span class="line">                ArrayMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt;</span><br><span class="line">                  holder = mUnregisteredReceivers.get(context);</span><br><span class="line">                <span class="keyword">if</span> (holder == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    holder = <span class="keyword">new</span> ArrayMap&lt;BroadcastReceiver, </span><br><span class="line">                        LoadedApk.ReceiverDispatcher&gt;();</span><br><span class="line">                    mUnregisteredReceivers.put(context, holder);</span><br><span class="line">                &#125;</span><br><span class="line">                ...</span><br><span class="line">                holder.put(r, rd);</span><br><span class="line">            &#125;</span><br><span class="line">            rd.mForgotten = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">return</span> rd.getIIntentReceiver();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">throw</span> ...</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ReceiverDispatcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 静态内部类 InnerReceiver </span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerReceiver</span> <span class="keyword">extends</span> <span class="title">IIntentReceiver</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">          ...</span><br><span class="line">          InnerReceiver(LoadedApk.ReceiverDispatcher rd, <span class="keyword">boolean</span> strong) &#123;</span><br><span class="line">            mDispatcher=<span class="keyword">new</span> WeakReference&lt;LoadedApk.ReceiverDispatcher&gt;(rd);</span><br><span class="line">            mStrongRef = strong ? rd : <span class="keyword">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 最终调用的是外部类的 performReceive</span></span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performReceive</span><span class="params">(Intent intent, <span class="keyword">int</span> resultCode, </span></span></span><br><span class="line"><span class="function"><span class="params">            String data, Bundle extras, <span class="keyword">boolean</span> ordered, </span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> sendingUser)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> LoadedApk.ReceiverDispatcher rd;</span><br><span class="line">            <span class="keyword">if</span> (intent == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Log.wtf(TAG, <span class="string">"Null intent received"</span>);</span><br><span class="line">                rd = <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                rd = mDispatcher.get();</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">if</span> (rd != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 调用外部类的 performReceive </span></span><br><span class="line">                rd.performReceive(intent, resultCode, data, extras,</span><br><span class="line">                        ordered, sticky, sendingUser);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ...</span><br><span class="line">                IActivityManager mgr = ActivityManagerNative.getDefault();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (extras != <span class="keyword">null</span>) &#123;</span><br><span class="line">                      extras.setAllowFds(<span class="keyword">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 广播接收器已经处理完这条广播</span></span><br><span class="line">                    mgr.finishReceiver(<span class="keyword">this</span>, resultCode, data, </span><br><span class="line">                        extras, <span class="keyword">false</span>, intent.getFlags());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> IIntentReceiver.Stub mIIntentReceiver;</span><br><span class="line">        <span class="keyword">final</span> BroadcastReceiver mReceiver;</span><br><span class="line">        <span class="keyword">final</span> Context mContext;</span><br><span class="line">        <span class="keyword">final</span> Handler mActivityThread;</span><br><span class="line">        <span class="keyword">final</span> Instrumentation mInstrumentation;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> mRegistered;</span><br><span class="line">        <span class="keyword">final</span> IntentReceiverLeaked mLocation;</span><br><span class="line">        RuntimeException mUnregisterLocation;</span><br><span class="line">        <span class="keyword">boolean</span> mForgotten;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 成员内部类 Args</span></span><br><span class="line">        <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Args</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span>.<span class="title">PendingResult</span> </span></span><br><span class="line"><span class="class">            <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">            <span class="keyword">private</span> Intent mCurIntent;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> mOrdered;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">boolean</span> mDispatched;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">Args</span><span class="params">(Intent intent, <span class="keyword">int</span> resultCode, String resultData, </span></span></span><br><span class="line"><span class="function"><span class="params">                Bundle resultExtras, <span class="keyword">boolean</span> ordered, </span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> sendingUser)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>(resultCode, resultData, resultExtras,</span><br><span class="line">                        mRegistered ? TYPE_REGISTERED : TYPE_UNREGISTERED, </span><br><span class="line">                        ordered, sticky, mIIntentReceiver.asBinder(), </span><br><span class="line">                        sendingUser, intent.getFlags());</span><br><span class="line">                mCurIntent = intent;</span><br><span class="line">                mOrdered = ordered;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 执行当前广播接收器 BroadCastReceiver.onReceive</span></span><br><span class="line">            <span class="comment">// 并告诉系统广播接收器处理完毕</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">              <span class="keyword">final</span> BroadcastReceiver receiver = mReceiver;</span><br><span class="line">              <span class="keyword">final</span> <span class="keyword">boolean</span> ordered = mOrdered;</span><br><span class="line">              ...</span><br><span class="line">              <span class="keyword">final</span> IActivityManager mgr=ActivityManagerNative.getDefault();</span><br><span class="line">              ...</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  ClassLoader cl =  mReceiver.getClass().getClassLoader();</span><br><span class="line">                  intent.setExtrasClassLoader(cl);</span><br><span class="line">                  intent.prepareToEnterProcess();</span><br><span class="line">                  setExtrasClassLoader(cl);</span><br><span class="line">                  receiver.setPendingResult(<span class="keyword">this</span>);</span><br><span class="line">                  receiver.onReceive(mContext, intent);</span><br><span class="line">              &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (mRegistered &amp;&amp; ordered) &#123;</span><br><span class="line">                      ...</span><br><span class="line">                      sendFinished(mgr);</span><br><span class="line">                  &#125;</span><br><span class="line">                  ...</span><br><span class="line">              &#125;</span><br><span class="line">              </span><br><span class="line">              <span class="comment">// 如果没有 PendingResult，调用 finish 开始处理下一个广播接收器</span></span><br><span class="line">              <span class="keyword">if</span> (receiver.getPendingResult() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  finish();</span><br><span class="line">              &#125;</span><br><span class="line">              ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ReceiverDispatcher(BroadcastReceiver receiver, Context context,</span><br><span class="line">                Handler activityThread, Instrumentation instrumentation,</span><br><span class="line">                <span class="keyword">boolean</span> registered) &#123;</span><br><span class="line">            <span class="keyword">if</span> (activityThread == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Handler must not be null"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mIIntentReceiver = <span class="keyword">new</span> InnerReceiver(<span class="keyword">this</span>, !registered);</span><br><span class="line">            mReceiver = receiver;</span><br><span class="line">            mContext = context;</span><br><span class="line">            mActivityThread = activityThread;</span><br><span class="line">            mInstrumentation = instrumentation;</span><br><span class="line">            mRegistered = registered;</span><br><span class="line">            mLocation = <span class="keyword">new</span> IntentReceiverLeaked(<span class="keyword">null</span>);</span><br><span class="line">            mLocation.fillInStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        <span class="function">BroadcastReceiver <span class="title">getIntentReceiver</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> mReceiver;&#125;</span><br><span class="line">        <span class="function">IIntentReceiver <span class="title">getIIntentReceiver</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> mIIntentReceiver;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performReceive</span><span class="params">(Intent intent, <span class="keyword">int</span> resultCode, </span></span></span><br><span class="line"><span class="function"><span class="params">            String data, Bundle extras, <span class="keyword">boolean</span> ordered,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> sendingUser)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Args args = <span class="keyword">new</span> Args(intent, resultCode, data, </span><br><span class="line">                extras, ordered, sticky, sendingUser);</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// 当前线程发布任务 Args </span></span><br><span class="line">            <span class="keyword">if</span> (intent == <span class="keyword">null</span> || !mActivityThread.post(args)) &#123;</span><br><span class="line">              <span class="keyword">if</span> (mRegistered &amp;&amp; ordered) &#123;</span><br><span class="line">                IActivityManager mgr=ActivityManagerNative.getDefault();</span><br><span class="line">                <span class="keyword">if</span> (ActivityThread.DEBUG_BROADCAST) Slog.i(...);</span><br><span class="line">                args.sendFinished(mgr);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="成员变量-2"><a href="#成员变量-2" class="headerlink" title="成员变量"></a>成员变量</h3><ul>
<li><code>mReceivers</code> ：当前 <code>Apk</code> 注册的广播列表  </li>
<li><code>mUnregisteredReceivers</code> ：当前 <code>Apk</code> 取消广播注册的列表  </li>
</ul>
<p>这两个成员变量都是 <code>Map</code> 结构，<code>Key</code> 值都是 <code>Context</code>，<code>Value</code> 仍然是一个 <code>Map</code> 结构：  </p>
<ul>
<li><code>Key: Context</code><br>每个 <code>Activity</code> 或者每个 <code>Service</code> 注册的广播分开记录，方便快速查找某个 <code>Context</code> 实例注册的所有广播。  </li>
<li><code>Value: ArrayMap&lt;BroadcastReceiver, ReceiverDispatcher&gt;</code>  </li>
</ul>
<p><strong><code>BroadcastReceiver</code> 和 <code>ReceiverDispatcher</code> 是一一对应的，每个广播接收器都会对应一个广播接收分发器</strong>。<code>ContextImpl.sendOrderedBroadcast, ContextImpl.registerReceiver</code> 会对每个广播接收器 <code>BroadCastReceiver</code> ，通过 <code>LoadedApk</code> 找到或者生成对应的 <code>ReceiverDispatcher</code> ；在发送有序广播或者注册广播接收器，等到广播接收者开始执行时，<code>AMS</code> 通过 <code>ReceiverDispatcher.InnerReceiver</code> 来触发回调，即调用 <code>BroadCastReceiver.onReceive</code> 。  </p>
<h3 id="ReceiverDispatcher-静态内部类"><a href="#ReceiverDispatcher-静态内部类" class="headerlink" title="ReceiverDispatcher 静态内部类"></a><code>ReceiverDispatcher</code> 静态内部类</h3><p><code>ReceiverDispatcher</code> 是 <code>LoadedApk</code> 的静态内部类，同时它自己还包含两个内部类：  </p>
<ul>
<li>静态内部类 <code>InnerReceiver</code><br>实现了 <code>IIntentReceiver.performReceive</code> 方法，实际最终调用的是外部类 <code>ReceiverDispatcher.performReceive</code> 方法。  </li>
<li>成员内部类 <code>Args</code><br>继承了 <code>BroadCastReceiver.PendingResult</code> 类，可以执行部分异步操作；同时实现了 <code>Runnable</code> ，通过传入的 <code>Handler</code> 发布这个任务，并调用 <code>BroadCastReceiver.onReceive</code> ，处理广播接收器回调事件。处理完后，通知系统该广播接收器处理完毕。  </li>
<li>成员变量<br><code>mRegistered</code> ：记录该广播接收器是否通过 <code>registerReceiver</code> 注册的，即是否为动态注册的广播接收器。  </li>
</ul>
<p><code>ReceiverDispatcher</code> 的几个重要方法：  </p>
<ul>
<li><code>getIIntentReceiver</code> ：返回广播接收器 <code>BroadCastReceiver</code> 对应的 <code>IIntentReceiver</code> 对象  </li>
<li><code>performReceive</code> ：使用当前线程 <code>Handler</code> 发送 <code>Args</code> 对象并执行；<strong>所有动态注册的广播接收器，都是在这里回调 <code>onReceive</code> 方法</strong>  </li>
</ul>
<h3 id="广播相关方法"><a href="#广播相关方法" class="headerlink" title="广播相关方法"></a>广播相关方法</h3><ul>
<li><code>getReceiverDispatcher</code><br>根据广播接收器获取广播接收分发器的 <code>IIntentReceiver</code> ，用于跨进程传递。主要是从 <code>mReceivers</code> 中获取；如果不存在则新建。  </li>
<li><code>forgetReceiverDispatcher</code><br>从 <code>mReceivers</code> 中移除指定回调广播接收器，并放入 <code>mUnregisteredReceivers</code> 中，返回值也是该广播接收器对应的 <code>IIntentReceiver</code> 。  </li>
</ul>
<h2 id="BroadcastRecord-类详解"><a href="#BroadcastRecord-类详解" class="headerlink" title="BroadcastRecord 类详解"></a><code>BroadcastRecord</code> 类详解</h2><p><code>BroadcastRecord</code> 继承了 <code>Binder</code> ，表明该对象作为数据容器，能被跨进程通信。<code>BroadcastRecord</code> 保存了广播发送者相关信息，包含发送者的：包名，进程信息，广播是否有序，请求的权限等等。  </p>
<h3 id="源码分析-2"><a href="#源码分析-2" class="headerlink" title="源码分析"></a>源码分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * An active intent broadcast.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BroadcastRecord</span> <span class="keyword">extends</span> <span class="title">Binder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Intent intent;    <span class="comment">// the original intent that generated us</span></span><br><span class="line">    <span class="comment">// original component name set on the intent</span></span><br><span class="line">    <span class="keyword">final</span> ComponentName targetComp; </span><br><span class="line">    <span class="keyword">final</span> ProcessRecord callerApp; <span class="comment">// process that sent this</span></span><br><span class="line">    <span class="keyword">final</span> String callerPackage; <span class="comment">// who sent this</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callingPid;   <span class="comment">// the pid of who sent this</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callingUid;   <span class="comment">// the uid of who sent this</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> ordered;  <span class="comment">// serialize the send to receivers?</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> sticky;   <span class="comment">// originated from existing sticky data?</span></span><br><span class="line">    <span class="comment">// initial broadcast from register to sticky?</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> initialSticky; </span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId;       <span class="comment">// user id this broadcast was for</span></span><br><span class="line">    <span class="keyword">final</span> String resolvedType; <span class="comment">// the resolved data type</span></span><br><span class="line">    <span class="comment">// permissions the caller has required</span></span><br><span class="line">    <span class="keyword">final</span> String[] requiredPermissions; </span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> appOp;   <span class="comment">// an app op that is associated with this broadcast</span></span><br><span class="line">    <span class="keyword">final</span> BroadcastOptions options; <span class="comment">// BroadcastOptions supplied by caller</span></span><br><span class="line">    <span class="keyword">final</span> List receivers;   <span class="comment">// contains BroadcastFilter and ResolveInfo</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span>[] delivery;   <span class="comment">// delivery state of each receiver</span></span><br><span class="line">    IIntentReceiver resultTo; <span class="comment">// who receives final result if non-null</span></span><br><span class="line">    <span class="keyword">long</span> enqueueClockTime;  <span class="comment">// the clock time the broadcast was enqueued</span></span><br><span class="line">    <span class="keyword">long</span> dispatchTime;   <span class="comment">// when dispatch started on this set of receivers</span></span><br><span class="line">    <span class="keyword">long</span> dispatchClockTime; <span class="comment">// the clock time the dispatch started</span></span><br><span class="line">    <span class="keyword">long</span> receiverTime;      <span class="comment">// when current receiver started for timeouts.</span></span><br><span class="line">    <span class="keyword">long</span> finishTime;        <span class="comment">// when we finished the broadcast.</span></span><br><span class="line">    <span class="keyword">int</span> resultCode;         <span class="comment">// current result code value.</span></span><br><span class="line">    String resultData;      <span class="comment">// current result data value.</span></span><br><span class="line">    Bundle resultExtras;    <span class="comment">// current result extra data values.</span></span><br><span class="line">    <span class="keyword">boolean</span> resultAbort;    <span class="comment">// current result abortBroadcast value.</span></span><br><span class="line">    <span class="keyword">int</span> nextReceiver;       <span class="comment">// next receiver to be executed.</span></span><br><span class="line">    IBinder receiver;       <span class="comment">// who is currently running, null if none.</span></span><br><span class="line">    <span class="keyword">int</span> state;</span><br><span class="line">    <span class="keyword">int</span> anrCount;           <span class="comment">// has this broadcast record hit any ANRs?</span></span><br><span class="line">    <span class="keyword">int</span> manifestCount;      <span class="comment">// number of manifest receivers dispatched.</span></span><br><span class="line">    <span class="keyword">int</span> manifestSkipCount;  <span class="comment">// number of manifest receivers skipped.</span></span><br><span class="line">    BroadcastQueue queue;   <span class="comment">// the outbound queue handling this broadcast</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 广播的五种状态</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IDLE = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> APP_RECEIVE = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CALL_IN_RECEIVE = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CALL_DONE_RECEIVE = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WAITING_SERVICES = <span class="number">4</span>;</span><br><span class="line">    <span class="comment">// 四种投递状态</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DELIVERY_PENDING = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DELIVERY_DELIVERED = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DELIVERY_SKIPPED = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DELIVERY_TIMEOUT = <span class="number">3</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// The following are set when we are calling a receiver (one that</span></span><br><span class="line">    <span class="comment">// was found in our list of registered receivers).</span></span><br><span class="line">    BroadcastFilter curFilter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The following are set only when we are launching a receiver (one</span></span><br><span class="line">    <span class="comment">// that was found by querying the package manager).</span></span><br><span class="line">    ProcessRecord curApp;       <span class="comment">// hosting application of current receiver.</span></span><br><span class="line">    <span class="comment">// the receiver class that is currently running.</span></span><br><span class="line">    ComponentName curComponent; </span><br><span class="line">    <span class="comment">// info about the receiver that is currently running.</span></span><br><span class="line">    ActivityInfo curReceiver;   </span><br><span class="line"></span><br><span class="line">    BroadcastRecord(BroadcastQueue _queue,</span><br><span class="line">            Intent _intent, ProcessRecord _callerApp, </span><br><span class="line">            String _callerPackage, <span class="keyword">int</span> _callingPid, <span class="keyword">int</span> _callingUid, </span><br><span class="line">            String _resolvedType, String[] _requiredPermissions, </span><br><span class="line">            <span class="keyword">int</span> _appOp, BroadcastOptions _options, List _receivers, </span><br><span class="line">            IIntentReceiver _resultTo, <span class="keyword">int</span> _resultCode, </span><br><span class="line">            String _resultData, Bundle _resultExtras, </span><br><span class="line">            <span class="keyword">boolean</span> _serialized, <span class="keyword">boolean</span> _sticky, </span><br><span class="line">            <span class="keyword">boolean</span> _initialSticky, <span class="keyword">int</span> _userId) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_intent == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"</span></span><br><span class="line"><span class="string">                Can't construct with a null intent"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        queue = _queue;</span><br><span class="line">        intent = _intent;</span><br><span class="line">        targetComp = _intent.getComponent();</span><br><span class="line">        callerApp = _callerApp;</span><br><span class="line">        callerPackage = _callerPackage;</span><br><span class="line">        callingPid = _callingPid;</span><br><span class="line">        callingUid = _callingUid;</span><br><span class="line">        resolvedType = _resolvedType;</span><br><span class="line">        requiredPermissions = _requiredPermissions;</span><br><span class="line">        appOp = _appOp;</span><br><span class="line">        options = _options;</span><br><span class="line">        receivers = _receivers;</span><br><span class="line">        delivery = <span class="keyword">new</span> <span class="keyword">int</span>[_receivers != <span class="keyword">null</span> ? _receivers.size() : <span class="number">0</span>];</span><br><span class="line">        resultTo = _resultTo;</span><br><span class="line">        resultCode = _resultCode;</span><br><span class="line">        resultData = _resultData;</span><br><span class="line">        resultExtras = _resultExtras;</span><br><span class="line">        ordered = _serialized;</span><br><span class="line">        sticky = _sticky;</span><br><span class="line">        initialSticky = _initialSticky;</span><br><span class="line">        userId = _userId;</span><br><span class="line">        nextReceiver = <span class="number">0</span>;</span><br><span class="line">        state = IDLE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">cleanupDisabledPackageReceiversLocked</span><span class="params">(String packageName, </span></span></span><br><span class="line"><span class="function"><span class="params">        Set&lt;String&gt; filterByClasses, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> doit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((userId != UserHandle.USER_ALL &amp;&amp; <span class="keyword">this</span>.userId != userId) </span><br><span class="line">            || receivers == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</span><br><span class="line">        Object o;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = receivers.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            o = receivers.get(i);</span><br><span class="line">            <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> ResolveInfo)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ActivityInfo info = ((ResolveInfo)o).activityInfo;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> sameComponent = packageName == <span class="keyword">null</span></span><br><span class="line">                || (info.applicationInfo.packageName.equals(packageName)</span><br><span class="line">                &amp;&amp; (filterByClasses == <span class="keyword">null</span> </span><br><span class="line">                        || filterByClasses.contains(info.name)));</span><br><span class="line">            <span class="keyword">if</span> (sameComponent) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!doit) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                didSomething = <span class="keyword">true</span>;</span><br><span class="line">                receivers.remove(i);</span><br><span class="line">                <span class="keyword">if</span> (i &lt; nextReceiver) &#123;</span><br><span class="line">                    nextReceiver--;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        nextReceiver = Math.min(nextReceiver, receivers.size());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> didSomething;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dump</span><span class="params">(PrintWriter pw, String prefix, SimpleDateFormat sdf)</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="重要成员变量"><a href="#重要成员变量" class="headerlink" title="重要成员变量"></a>重要成员变量</h3><ul>
<li><code>Intent intent</code> ：广播发送时的 <code>Intent</code>  </li>
<li><code>ComponentName targetComp</code> ：广播发送者组件名称  </li>
<li><code>ProcessRecord callerApp</code> ：广播发送者进程记录  </li>
<li><code>String callerPackage</code> ：广播发送者包名  </li>
<li><code>callingPid</code> ：广播发送者 <code>Pid</code>  </li>
<li><code>callingUid</code> ：广播发送者 <code>Uid</code>  </li>
<li><code>userId</code> ：广播发送者 <code>userId</code>  </li>
<li><code>ordered</code> ：广播是否有序发送</li>
<li><code>sticky</code> ：广播是否为粘性广播  </li>
<li><code>initialSticky</code> ：广播是否一开始就设置为粘性广播  </li>
<li><code>resolvedType</code> ：<code>Intent</code> 的类型  </li>
<li><code>String[] requiredPermissions</code> ：广播发送者拥有的广播权限  </li>
<li><code>appOp</code> ：广播对应的应用管理权限  </li>
<li><code>BroadcastOptions options</code> ：广播发送者设定的选项  </li>
<li><code>List receivers</code> ：广播接收者列表，特别需要注意的是：它包含了两种类型数据 <code>ResolveInfo, BroadcastFilter</code>，分别对应静态注册广播接收器和动态注册广播接收器，取出时需要做类型判断  </li>
<li><code>int[] delivery</code> ：每个广播接收者的投递状态，状态分为四种  </li>
<li><code>IIntentReceiver resultTo</code> ：有序广播中回调的广播接收器，它也是有序广播的最后一个接收者  </li>
<li><code>enqueueClockTime</code> ：广播进入队列的时间  </li>
<li><code>dispatchTime</code> ：开始分派广播的开机时间  </li>
<li><code>dispatchClockTime</code> ：开始分派广播的系统绝对时间  </li>
<li><code>receiverTime</code> ：广播接收者接收到的时间  </li>
<li><code>finishTime</code> ：广播接收者处理完广播的完成时间  </li>
<li><code>resultCode</code> ：广播处理完毕的结果码  </li>
<li><code>resultData</code> ：广播处理完毕的简单数据  </li>
<li><code>resultExtras</code> ：广播处理完毕的复杂数据  </li>
<li><code>resultAbort</code> ：广播是否被终止  </li>
<li><code>int nextReceiver</code> ：下一个广播接收者索引  </li>
<li><code>IBinder receiver</code> ：广播当前接收者  </li>
<li><code>int state</code> ：广播的当前状态，状态分为五种  </li>
<li><code>anrCount</code> ：当前广播出现的 <code>ANR</code> 次数  </li>
<li><code>manifestCount</code> ：分发给静态注册广播接收者的次数  </li>
<li><code>manifestSkipCount</code> ：分发给静态注册广播接收者跳过的次数  </li>
<li><code>BroadcastQueue queue</code> ：处理当前广播所在队列  </li>
<li><code>BroadcastFilter curFilter</code> ：处理广播时当前广播过滤器  </li>
<li><code>ProcessRecord curApp</code> ：广播当前接收者的进程信息  </li>
<li><code>ComponentName curComponent</code> ：广播当前接收者的组件信息  </li>
<li><code>ActivityInfo curReceiver</code> ：广播当前接收者的信息  </li>
</ul>
<h3 id="cleanupDisabledPackageReceiversLocked-方法"><a href="#cleanupDisabledPackageReceiversLocked-方法" class="headerlink" title="cleanupDisabledPackageReceiversLocked 方法"></a><code>cleanupDisabledPackageReceiversLocked</code> 方法</h3><p><code>BroadcastRecord</code> 中只有一个包内可见的方法 <code>cleanupDisabledPackageReceiversLocked</code> ，该方法功能是从 <code>List receivers</code> 清理掉已经取消注册的广播注册接收者。  </p>
<h2 id="BroadcastQueue-类详解"><a href="#BroadcastQueue-类详解" class="headerlink" title="BroadcastQueue 类详解"></a><code>BroadcastQueue</code> 类详解</h2><p><code>BroadcastQueue</code> 用来保存系统和应用发出的广播信息；通常使用两个广播队列 <code>BroadcastQueue</code> ：一个用来保存前台广播，一个用来保存后台广播；而每个广播队列 <code>BroadcastQueue</code> 包含两个列表：一个用来并行处理；一个用来有序处理。  </p>
<h3 id="重要成员变量-1"><a href="#重要成员变量-1" class="headerlink" title="重要成员变量"></a>重要成员变量</h3><ul>
<li><code>ArrayList&lt;BroadcastRecord&gt; mParallelBroadcasts</code><br>存储并行处理的广播：首先它是普通广播，其次这些广播匹配的广播接收器必须是动态注册的。  </li>
<li><code>ArrayList&lt;BroadcastRecord&gt; mOrderedBroadcasts</code><br>存储有序处理的广播：包含有序广播和普通广播（<strong>匹配的广播接收器时静态注册的</strong>）。  </li>
<li><code>mTimeoutPeriod</code><br>广播接收器 <code>ANR</code> 超时时间阀值。前台广播是 10 秒，后台广播是 60 秒。  </li>
</ul>
<h3 id="BroadcastHandler-类"><a href="#BroadcastHandler-类" class="headerlink" title="BroadcastHandler 类"></a><code>BroadcastHandler</code> 类</h3><p><code>BroadcastHandler</code> 是成员内部类，用来处理下一条广播，或者处理广播超时 <code>ANR</code> 。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BROADCAST_INTENT_MSG = </span><br><span class="line">    ActivityManagerService.FIRST_BROADCAST_QUEUE_MSG;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BROADCAST_TIMEOUT_MSG = </span><br><span class="line">    ActivityManagerService.FIRST_BROADCAST_QUEUE_MSG + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> BroadcastHandler mHandler;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BroadcastHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BroadcastHandler</span><span class="params">(Looper looper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(looper, <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> BROADCAST_INTENT_MSG: &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_BROADCAST) Slog.v(</span><br><span class="line">                        TAG_BROADCAST, <span class="string">"Received BROADCAST_INTENT_MSG"</span>);</span><br><span class="line">                processNextBroadcast(<span class="keyword">true</span>);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> BROADCAST_TIMEOUT_MSG: &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (mService) &#123;</span><br><span class="line">                    broadcastTimeoutLocked(<span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="AppNotResponding-类"><a href="#AppNotResponding-类" class="headerlink" title="AppNotResponding 类"></a><code>AppNotResponding</code> 类</h3><p><code>AppNotResponding</code> 成员内部类，广播接收器处理广播事件时发生 <code>ANR</code> 。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AppNotResponding</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ProcessRecord mApp;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mAnnotation;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AppNotResponding</span><span class="params">(ProcessRecord app, String annotation)</span> </span>&#123;</span><br><span class="line">        mApp = app;</span><br><span class="line">        mAnnotation = annotation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mService.mAppErrors.appNotResponding(mApp, </span><br><span class="line">            <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>, mAnnotation);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="静态注册广播接收器流程分析"><a href="#静态注册广播接收器流程分析" class="headerlink" title="静态注册广播接收器流程分析"></a>静态注册广播接收器流程分析</h2><p>静态注册的广播接收器，又称为 <code>Manifest</code> 文件声明广播接收器，是在 <code>PMS</code> 扫描 <code>AndroidManifest.xml</code> 信息时解析的；所有静态注册的广播接收器，统一由 <code>PMS</code> 保存，广播在发送过程中，查找匹配的静态注册广播接收器也是在 <code>PMS</code> 中查询。  </p>
<h3 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h3><p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0021-broadcast-manifest-declare-receiver.png" alt="0021-broadcast-manifest-declare-receiver.png"></p>
<h3 id="PackageParser-parseBaseApplication-详解"><a href="#PackageParser-parseBaseApplication-详解" class="headerlink" title="PackageParser.parseBaseApplication 详解"></a><code>PackageParser.parseBaseApplication</code> 详解</h3><p><code>PackageParser</code> 主要用于详细解析包内相关信息，而 <code>parseBaseApplication</code> 主要解析 <code>AndroidManifest.xml</code> ，将每个 <code>TAG</code> 都解析并保存，其中静态注册的广播接收器存储到 <code>receivers</code> 中，而 <code>PMS</code> 会根据每个包解析的数据，保存整个系统全部的静态注册广播接收器（当然也保存其他 <code>Activity, Services, ContentProvider</code> 等信息）。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PackageParser.java</span></span><br><span class="line"><span class="comment">// 保存当前 Package 中所有的 BroadCastReceiver</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> ArrayList&lt;Activity&gt; receivers = <span class="keyword">new</span> ArrayList&lt;Activity&gt;(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseBaseApplication</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError)</span></span></span><br><span class="line"><span class="function">    ...</span></span><br><span class="line"><span class="function">    <span class="title">while</span> <span class="params">((type = parser.next()</span>) !</span>= XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG </span><br><span class="line">                || parser.getDepth() &gt; innerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG </span><br><span class="line">            || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(<span class="string">"activity"</span>)) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"receiver"</span>)) &#123;</span><br><span class="line">            <span class="comment">// 解析到是静态注册的广播接收器，添加到 receivers 中</span></span><br><span class="line">            Activity a = parseActivity(owner, res, parser, flags, </span><br><span class="line">                    outError, cachedArgs, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = </span><br><span class="line">                    PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            owner.receivers.add(a);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PMS-静态注册广播接收器"><a href="#PMS-静态注册广播接收器" class="headerlink" title="PMS 静态注册广播接收器"></a><code>PMS</code> 静态注册广播接收器</h3><p><code>PMS</code> 在调用完 <code>PackageParser.parsePackage</code> 解析完指定包名信息后，将存储在 <code>PackageParser.Package.receivers</code> 的静态广播接收器信息，再保存到 <code>PMS.mReceivers</code> 中，方便后续全局查询。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PackageManageServices.java</span></span><br><span class="line"><span class="comment">// All available receivers, for your resolving pleasure.</span></span><br><span class="line"><span class="comment">// 存储整个系统所有的静态注册广播接收器</span></span><br><span class="line"><span class="keyword">final</span> ActivityIntentResolver mReceivers =</span><br><span class="line">        <span class="keyword">new</span> ActivityIntentResolver();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Adds a scanned package to the system. When this method is finished,</span></span><br><span class="line"><span class="comment"> * the package will be available for query, resolution, etc...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">commitPackageSettings</span><span class="params">(PackageParser.Package pkg, </span></span></span><br><span class="line"><span class="function"><span class="params">        PackageSetting pkgSetting, UserHandle user, <span class="keyword">int</span> scanFlags, </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> chatty)</span> <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String pkgName = pkg.packageName;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// PackageParser 解析到静态注册广播接收器</span></span><br><span class="line">    N = pkg.receivers.size();</span><br><span class="line">    r = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        PackageParser.Activity a = pkg.receivers.get(i);</span><br><span class="line">        a.info.processName=fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                a.info.processName);</span><br><span class="line">        <span class="comment">// 将广播接收器存储到 PMS 的 mReceivers 中</span></span><br><span class="line">        mReceivers.addActivity(a, <span class="string">"receiver"</span>);</span><br><span class="line">        <span class="keyword">if</span> (chatty) &#123;</span><br><span class="line">            <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                r.append(<span class="string">' '</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            r.append(a.info.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Receivers: "</span> + r);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PMS-查询静态注册广播接收器"><a href="#PMS-查询静态注册广播接收器" class="headerlink" title="PMS 查询静态注册广播接收器"></a><code>PMS</code> 查询静态注册广播接收器</h3><p><code>AMS</code> 在发送广播时，会从 <code>PMS</code> 中查询匹配的静态广播接收器；<code>PMS.queryIntentReceiversInternal</code> 根据广播 <code>Intent</code> ，从 <code>mReceivers</code> 中查询匹配的 <code>ResolveInfo</code>，而 <code>ResolveInfo.activityInfo</code> 存储了对应的广播接收器。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PackageManageServices.java</span></span><br><span class="line"><span class="comment">// PMS.queryIntentReceivers --&gt; queryIntentReceiversInternal</span></span><br><span class="line"><span class="keyword">private</span> <span class="meta">@NonNull</span> <span class="function">List&lt;ResolveInfo&gt; <span class="title">queryIntentReceiversInternal</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent, String resolvedType, <span class="keyword">int</span> flags, <span class="keyword">int</span> userId, </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> allowDynamicSplits)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        String pkgName = intent.getPackage();</span><br><span class="line">        <span class="keyword">if</span> (pkgName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 从 mReceivers 中查询匹配的静态注册广播接收器</span></span><br><span class="line">            <span class="keyword">final</span> List&lt;ResolveInfo&gt; result = mReceivers.queryIntent(</span><br><span class="line">                    intent, resolvedType, flags, userId);</span><br><span class="line">            <span class="keyword">return</span> applyPostResolutionFilter(result, instantAppPkgName,</span><br><span class="line">                    allowDynamicSplits, callingUid, userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package pkg = mPackages.get(pkgName);</span><br><span class="line">        <span class="keyword">if</span> (pkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// 从 mReceivers 中查询匹配的静态注册广播接收器</span></span><br><span class="line">          <span class="keyword">final</span> List&lt;ResolveInfo&gt; result=mReceivers.queryIntentForPackage(</span><br><span class="line">                  intent, resolvedType, flags, pkg.receivers, userId);</span><br><span class="line">          <span class="keyword">return</span> applyPostResolutionFilter(result, instantAppPkgName, </span><br><span class="line">                allowDynamicSplits, callingUid, userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义类，根据广播 Intent ，查询匹配的 ResolveInfo</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityIntentResolver</span>  <span class="keyword">extends</span> <span class="title">IntentResolver</span>&lt;</span></span><br><span class="line"><span class="class">        <span class="title">PackageParser</span>.<span class="title">ActivityIntentInfo</span>, <span class="title">ResolveInfo</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ResolveInfo&gt; <span class="title">queryIntent</span><span class="params">(Intent intent, </span></span></span><br><span class="line"><span class="function"><span class="params">            String resolvedType, <span class="keyword">boolean</span> defaultOnly, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!sUserManager.exists(userId)) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        mFlags = (defaultOnly ? PackageManager.MATCH_DEFAULT_ONLY : <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.queryIntent(intent, resolvedType, </span><br><span class="line">            defaultOnly, userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ResolveInfo&gt; <span class="title">queryIntent</span><span class="params">(Intent intent, </span></span></span><br><span class="line"><span class="function"><span class="params">            String resolvedType, <span class="keyword">int</span> flags, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!sUserManager.exists(userId)) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        mFlags = flags;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.queryIntent(intent, resolvedType,</span><br><span class="line">                (flags &amp; PackageManager.MATCH_DEFAULT_ONLY) != <span class="number">0</span>,</span><br><span class="line">                userId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ResolveInfo&gt; <span class="title">queryIntentForPackage</span><span class="params">(Intent intent, </span></span></span><br><span class="line"><span class="function"><span class="params">            String resolvedType, <span class="keyword">int</span> flags, </span></span></span><br><span class="line"><span class="function"><span class="params">            ArrayList&lt;PackageParser.Activity&gt; packageActivities, </span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> userId)</span> </span>&#123;...&#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="protected-broadcast-受保护的广播"><a href="#protected-broadcast-受保护的广播" class="headerlink" title="protected-broadcast 受保护的广播"></a><code>protected-broadcast</code> 受保护的广播</h3><p>在 <code>AndroidManifest.xml</code> 中声明的 <code>protected-broadcast</code> 受保护广播 <code>ACTION</code> ，表示它们只能被有系统权限的广播接收器接收。在 <code>PackageParser.Package.protectedBroadcasts</code> 中保存，同时 <code>PMS.mProtectedBroadcasts</code> 会做系统全局保存， <code>AMS</code> 发送广播时会查询 <code>PMS</code> 做权限检查，如果没有权限则不会分发给该广播接收器。  </p>
<h2 id="动态注册-取消广播接收器流程分析"><a href="#动态注册-取消广播接收器流程分析" class="headerlink" title="动态注册/取消广播接收器流程分析"></a>动态注册/取消广播接收器流程分析</h2><h3 id="流程图-1"><a href="#流程图-1" class="headerlink" title="流程图"></a>流程图</h3><p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0021-broadcast-register-receiver.png" alt="0021-broadcast-register-receiver.png"></p>
<h3 id="动态注册-ContextImpl-LoadedApk"><a href="#动态注册-ContextImpl-LoadedApk" class="headerlink" title="动态注册 ContextImpl/LoadedApk"></a>动态注册 <code>ContextImpl/LoadedApk</code></h3><p>动态注册时统一由 <code>ContextImpl.registerReceiverInternal</code> 向系统注册广播接收器。这个过程主要功能：  </p>
<ul>
<li>将 <code>BroadCastReceiver</code> 转换为对应的 <code>IIntentReceiver</code> ，用于跨进程通信  </li>
<li><code>LoadedApk.getReceiverDispatcher</code> 会将当前 <code>Apk</code> 注册的每个广播接收器保存到 <code>mReceivers</code> 中；如果是有序广播的回调广播接收器则不保存  </li>
<li>向 <code>AMS</code> 中注册 <code>IIntentReceiver</code>  </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LoadedApk.java </span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Intent <span class="title">registerReceiverInternal</span><span class="params">(BroadcastReceiver receiver, </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> userId, IntentFilter filter, String broadcastPermission,</span></span></span><br><span class="line"><span class="function"><span class="params">        Handler scheduler, Context context, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    IIntentReceiver rd = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (receiver != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPackageInfo != <span class="keyword">null</span> &amp;&amp; context != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (scheduler == <span class="keyword">null</span>) &#123;</span><br><span class="line">                scheduler = mMainThread.getHandler();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// BroadCastReceiver 转换为 IIntentReceiver </span></span><br><span class="line">            rd = mPackageInfo.getReceiverDispatcher(</span><br><span class="line">                receiver, context, scheduler,</span><br><span class="line">                mMainThread.getInstrumentation(), <span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (scheduler == <span class="keyword">null</span>) &#123;</span><br><span class="line">                scheduler = mMainThread.getHandler();</span><br><span class="line">            &#125;</span><br><span class="line">            rd = <span class="keyword">new</span> LoadedApk.ReceiverDispatcher(receiver, context,</span><br><span class="line">                    scheduler, <span class="keyword">null</span>, <span class="keyword">true</span>).getIIntentReceiver();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 向 AMS 中注册 IIntentReceiver </span></span><br><span class="line">        <span class="keyword">final</span> Intent intent = ActivityManager.getService()</span><br><span class="line">                .registerReceiver(mMainThread.getApplicationThread(), </span><br><span class="line">                mBasePackageName, rd, filter, broadcastPermission, </span><br><span class="line">                userId, flags);</span><br><span class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            intent.setExtrasClassLoader(getClassLoader());</span><br><span class="line">            intent.prepareToEnterProcess();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> intent;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LoadedApk.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IIntentReceiver <span class="title">getReceiverDispatcher</span><span class="params">(BroadcastReceiver r,</span></span></span><br><span class="line"><span class="function"><span class="params">        Context context, Handler handler,</span></span></span><br><span class="line"><span class="function"><span class="params">        Instrumentation instrumentation, <span class="keyword">boolean</span> registered)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mReceivers) &#123;</span><br><span class="line">        LoadedApk.ReceiverDispatcher rd = <span class="keyword">null</span>;</span><br><span class="line">        ArrayMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt;</span><br><span class="line">            map = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (registered) &#123;</span><br><span class="line">            map = mReceivers.get(context);</span><br><span class="line">            <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</span><br><span class="line">                rd = map.get(r);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (rd == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 新建 ReceiverDispatcher 对象</span></span><br><span class="line">            rd = <span class="keyword">new</span> ReceiverDispatcher(r, context, handler,</span><br><span class="line">                    instrumentation, registered);</span><br><span class="line">            <span class="keyword">if</span> (registered) &#123;</span><br><span class="line">            <span class="comment">// 注册的广播接收器都保存到 mReceivers 中  </span></span><br><span class="line">            <span class="comment">// 如果是有序广播的回调广播接收器则不保存</span></span><br><span class="line">                <span class="keyword">if</span> (map == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    map = <span class="keyword">new</span> ArrayMap&lt;BroadcastReceiver, </span><br><span class="line">                        LoadedApk.ReceiverDispatcher&gt;();</span><br><span class="line">                    mReceivers.put(context, map);</span><br><span class="line">                &#125;</span><br><span class="line">                map.put(r, rd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            rd.validate(context, handler);</span><br><span class="line">        &#125;</span><br><span class="line">        rd.mForgotten = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> rd.getIIntentReceiver();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="动态注册-AMS"><a href="#动态注册-AMS" class="headerlink" title="动态注册 AMS"></a>动态注册 <code>AMS</code></h3><p>广播接收器动态注册时，广播接收器的相关信息保存在 <code>AMS</code> 中：  </p>
<ul>
<li><code>mRegisteredReceivers</code><br>保存所有动态注册的广播接收器对应的 <code>ReceiverList</code> 。<code>mRegisteredReceivers</code> 并没有太多作用，注册保存信息，取消注册时从这里删除。  </li>
<li><code>mReceiverResolver</code><br>保存所有所有动态注册广播接收器时对应的广播过滤器 <code>BroadcastFilter</code> 。广播发送过程中，会根据 <code>Intent</code> 从 <code>mReceiverResolver</code> 中查找 <code>BroadcastFilter</code> ；每个 <code>BroadcastFilter</code> 都保存了它所属的 <code>ReceiverList</code> ；而 <code>ReceiverList</code> 保存了 <code>BroadCastReceiver</code> 对应的 <code>IIntentReceiver</code> ；动态注册广播接收器事件处理时，使用 <code>IIntentReceiver</code> 处理 <code>onReceive</code> 回调。  </li>
</ul>
<p>主要功能：  </p>
<ul>
<li>获取动态注册广播接收器，应用进程相关信息  </li>
<li>处理粘性广播事件  </li>
<li><code>BroadCastReceiver</code> 生成对应的 <code>ReceiverList</code> 和 <code>BroadcastFilter</code>  </li>
<li>将 <code>ReceiverList</code> 添加到 <code>mRegisteredReceivers</code> 中  </li>
<li>将 <code>BroadcastFilter</code> 添加到 <code>mReceiverResolver</code> 中  </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityManagerService.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span><span class="params">(IApplicationThread caller, </span></span></span><br><span class="line"><span class="function"><span class="params">        String callerPackage, IIntentReceiver receiver, </span></span></span><br><span class="line"><span class="function"><span class="params">        IntentFilter filter, String permission, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"registerReceiver"</span>);</span><br><span class="line">    ArrayList&lt;Intent&gt; stickyIntents = <span class="keyword">null</span>;</span><br><span class="line">    ProcessRecord callerApp = <span class="keyword">null</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">int</span> callingUid;</span><br><span class="line">    <span class="keyword">int</span> callingPid;</span><br><span class="line">    ...</span><br><span class="line">    Intent sticky = allSticky != <span class="keyword">null</span> ? allSticky.get(<span class="number">0</span>) : <span class="keyword">null</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (callerApp != <span class="keyword">null</span> &amp;&amp; (callerApp.thread == <span class="keyword">null</span></span><br><span class="line">                || callerApp.thread.asBinder() != caller.asBinder())) &#123;</span><br><span class="line">            <span class="comment">// Original caller already died</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ReceiverList rl = mRegisteredReceivers.get(receiver.asBinder());</span><br><span class="line">        <span class="keyword">if</span> (rl == <span class="keyword">null</span>) &#123;</span><br><span class="line">            rl = <span class="keyword">new</span> ReceiverList(<span class="keyword">this</span>, callerApp, callingPid, </span><br><span class="line">                    callingUid, userId, receiver);</span><br><span class="line">            <span class="keyword">if</span> (rl.app != <span class="keyword">null</span>) &#123;</span><br><span class="line">                rl.app.receivers.add(rl);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">            mRegisteredReceivers.put(receiver.asBinder(), rl);</span><br><span class="line">        &#125; <span class="keyword">else</span> ...</span><br><span class="line">        BroadcastFilter bf = <span class="keyword">new</span> BroadcastFilter(filter, rl, </span><br><span class="line">                callerPackage, permission, callingUid, userId,</span><br><span class="line">                instantApp, visibleToInstantApps);</span><br><span class="line">        rl.add(bf);</span><br><span class="line">        ...</span><br><span class="line">        mReceiverResolver.addFilter(bf);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> sticky;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="取消注册-ContextImpl-LoadedApk"><a href="#取消注册-ContextImpl-LoadedApk" class="headerlink" title="取消注册 ContextImpl/LoadedApk"></a>取消注册 <code>ContextImpl/LoadedApk</code></h3><p>取消注册时统一由 <code>ContextImpl.unregisterReceiver</code> 向系统取消注册广播接收器。这个过程主要功能：  </p>
<ul>
<li>将 <code>BroadCastReceiver</code> 转换为对应的 <code>IIntentReceiver</code> ，用于跨进程通信  </li>
<li><code>LoadedApk.forgetReceiverDispatcher</code> 会将当前需要取消注册的广播接收器，从 <code>mReceivers</code> 中移除；如果需要调试，会同时将它加入 <code>mUnregisteredReceivers</code> 中  </li>
<li>向 <code>AMS</code> 中取消注册 <code>IIntentReceiver</code>  </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregisterReceiver</span><span class="params">(BroadcastReceiver receiver)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mPackageInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// BroadCastReceiver 转换为 IIntentReceiver</span></span><br><span class="line">        <span class="comment">// 在 LoadedApk 中从 mReceivers 中移除</span></span><br><span class="line">        IIntentReceiver rd = mPackageInfo.forgetReceiverDispatcher(</span><br><span class="line">                getOuterContext(), receiver);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 向 AMS 中取消广播接收器的注册  </span></span><br><span class="line">            ActivityManager.getService().unregisterReceiver(rd);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Not supported in system context"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> IIntentReceiver <span class="title">forgetReceiverDispatcher</span><span class="params">(Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">        BroadcastReceiver r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mReceivers) &#123;</span><br><span class="line">        ArrayMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt; </span><br><span class="line">            map = mReceivers.get(context);</span><br><span class="line">        LoadedApk.ReceiverDispatcher rd = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</span><br><span class="line">            rd = map.get(r);</span><br><span class="line">            <span class="keyword">if</span> (rd != <span class="keyword">null</span>) &#123;</span><br><span class="line">                map.remove(r);</span><br><span class="line">                <span class="comment">// 从 mReceivers 中移除</span></span><br><span class="line">                <span class="keyword">if</span> (map.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                    mReceivers.remove(context);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (r.getDebugUnregister()) &#123;</span><br><span class="line">                    ...</span><br><span class="line">                    <span class="comment">// 如果需要调试，存入 mUnregisteredReceivers 中</span></span><br><span class="line">                    mUnregisteredReceivers.put(context, holder);</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">                rd.mForgotten = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">return</span> rd.getIIntentReceiver();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="取消注册-AMS"><a href="#取消注册-AMS" class="headerlink" title="取消注册 AMS"></a>取消注册 <code>AMS</code></h3><p>广播接收器取消注册时，从 <code>AMS</code> 中移除对应的数据，主要功能为：  </p>
<ul>
<li>从 <code>mRegisteredReceivers</code> 中移除 <code>ReceiverList</code>  </li>
<li>从 <code>mReceiverResolver</code> 中移除 <code>ReceiverList</code> 中所有的 <code>BroadcastFilter</code>  </li>
<li>如果还存在没有处理完的广播接收器，触发 <code>BroadcastQueue.processNextBroadcast</code> 继续处理  </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityManagerService.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregisterReceiver</span><span class="params">(IIntentReceiver receiver)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">boolean</span> doTrim = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        ReceiverList rl = mRegisteredReceivers.get(receiver.asBinder());</span><br><span class="line">        <span class="keyword">if</span> (rl != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">final</span> BroadcastRecord r = rl.curBroadcast;</span><br><span class="line">          <span class="comment">// 还存在没有处理完的广播接收器</span></span><br><span class="line">          <span class="keyword">if</span> (r != <span class="keyword">null</span> &amp;&amp; r == r.queue.getMatchingOrderedReceiver(r)) &#123;</span><br><span class="line">              <span class="keyword">final</span> <span class="keyword">boolean</span> doNext = r.queue.finishReceiverLocked(</span><br><span class="line">                      r, r.resultCode, r.resultData, r.resultExtras,</span><br><span class="line">                      r.resultAbort, <span class="keyword">false</span>);</span><br><span class="line">              <span class="keyword">if</span> (doNext) &#123;</span><br><span class="line">                  doTrim = <span class="keyword">true</span>;</span><br><span class="line">                  r.queue.processNextBroadcast(<span class="keyword">false</span>);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (rl.app != <span class="keyword">null</span>) &#123;</span><br><span class="line">              rl.app.receivers.remove(rl);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 移除当前广播接收器对应的所有信息</span></span><br><span class="line">          removeReceiverLocked(rl);</span><br><span class="line">          ...</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除当前广播接收器对应的所有信息</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">removeReceiverLocked</span><span class="params">(ReceiverList rl)</span> </span>&#123;</span><br><span class="line">    mRegisteredReceivers.remove(rl.receiver.asBinder());</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = rl.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        mReceiverResolver.removeFilter(rl.get(i));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="广播发送流程分析"><a href="#广播发送流程分析" class="headerlink" title="广播发送流程分析"></a>广播发送流程分析</h2><p>先回顾下基础概念，广播的类型：  </p>
<ul>
<li>普通广播：通过 <code>sendBroadcast</code> 发送的广播  </li>
<li>有序广播：通过 <code>sendOrderedBroadcast</code> 发送的广播  </li>
</ul>
<p>系统对广播响应并处理的方式分为：  </p>
<ul>
<li>并行处理<br>广播存储位置：<code>BroadcastQueue.mParallelBroadcasts</code> ；并行处理的广播为：普通广播，且它对应的广播接收器一定是动态注册的。  </li>
<li>有序处理<br>广播存储位置：<code>BroadcastQueue.mOrderedBroadcasts</code> ；有序处理的广播为：有序广播和普通广播（对应的广播接收器是静态注册的）。<br><code>mOrderedBroadcasts</code> 中处理普通广播（对应的广播接收器时静态注册的）非常费解，初看代码时很容易搞错，存储逻辑是在 <code>AMS</code> 调度时决定的。  </li>
</ul>
<h3 id="流程图-2"><a href="#流程图-2" class="headerlink" title="流程图"></a>流程图</h3><ul>
<li>广播发送过程，从广播发送所在应用进程进入系统进程 <code>Context -&gt; AMS -&gt; BroadcastQueue</code>  </li>
</ul>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0021-broadcast-sendbroadcast-1.png" alt="0021-broadcast-sendbroadcast-1.png"></p>
<ul>
<li>广播发送过程，从系统进程进入广播接收器应用所在进程 <code>BroadcastQueue -&gt; ActivityThread -&gt; BroadCastReceiver.onReceive</code>  </li>
</ul>
<p><img src="https://raw.githubusercontent.com/redspider110/blog-images/master/_images/0021-broadcast-sendbroadcast-2.png" alt="0021-broadcast-sendbroadcast-2.png"></p>
<h3 id="ContextImpl-sendBroadcast-发送普通广播"><a href="#ContextImpl-sendBroadcast-发送普通广播" class="headerlink" title="ContextImpl.sendBroadcast 发送普通广播"></a><code>ContextImpl.sendBroadcast</code> 发送普通广播</h3><p><code>ContextImpl</code> 对于普通广播并不做特别处理，比较简单，直接将 <code>Intent</code> 和广播发送应用相关信息传递给 <code>AMS</code> ，进入系统来处理分发流程。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendBroadcast</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">    warnIfCallingFromSystemProcess();</span><br><span class="line">    String resolvedType=intent.resolveTypeIfNeeded(getContentResolver());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        intent.prepareToLeaveProcess(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// 进入 AMS 处理具体的广播发送流程</span></span><br><span class="line">        ActivityManager.getService().broadcastIntent(</span><br><span class="line">                mMainThread.getApplicationThread(), intent, resolvedType, </span><br><span class="line">                <span class="keyword">null</span>, Activity.RESULT_OK, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, </span><br><span class="line">                AppOpsManager.OP_NONE, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, getUserId());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ContextImpl-sendOrderedBroadcast-发送有序广播"><a href="#ContextImpl-sendOrderedBroadcast-发送有序广播" class="headerlink" title="ContextImpl.sendOrderedBroadcast 发送有序广播"></a><code>ContextImpl.sendOrderedBroadcast</code> 发送有序广播</h3><p>有序广播支持广播接收器回调，所以进入系统 <code>AMS</code> 处理前，会先将 <code>BroadCastReceiver</code> 转换为 <code>IIntentReceiver</code> ，回调广播接收器在 <code>LoadedApk</code> 中不做保存。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sendOrderedBroadcast</span><span class="params">(Intent intent, String receiverPermission,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> appOp, BroadcastReceiver resultReceiver,</span></span></span><br><span class="line"><span class="function"><span class="params">        Handler scheduler, <span class="keyword">int</span> initialCode, String initialData,</span></span></span><br><span class="line"><span class="function"><span class="params">        Bundle initialExtras, Bundle options)</span> </span>&#123;</span><br><span class="line">    warnIfCallingFromSystemProcess();</span><br><span class="line">    IIntentReceiver rd = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (resultReceiver != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPackageInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (scheduler == <span class="keyword">null</span>) &#123;</span><br><span class="line">                scheduler = mMainThread.getHandler();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将 BroadCastReceiver 转换为 IIntentReceiver</span></span><br><span class="line">            <span class="comment">// 回调广播接收器在 LoadedApk 中不做保存</span></span><br><span class="line">            rd = mPackageInfo.getReceiverDispatcher(</span><br><span class="line">                resultReceiver, getOuterContext(), scheduler,</span><br><span class="line">                mMainThread.getInstrumentation(), <span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (scheduler == <span class="keyword">null</span>) &#123;</span><br><span class="line">                scheduler = mMainThread.getHandler();</span><br><span class="line">            &#125;</span><br><span class="line">            rd = <span class="keyword">new</span> LoadedApk.ReceiverDispatcher(</span><br><span class="line">                    resultReceiver, getOuterContext(), scheduler, </span><br><span class="line">                    <span class="keyword">null</span>, <span class="keyword">false</span>).getIIntentReceiver();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    String resolvedType=intent.resolveTypeIfNeeded(getContentResolver());</span><br><span class="line">    String[] receiverPermissions = receiverPermission == <span class="keyword">null</span> ? <span class="keyword">null</span></span><br><span class="line">            : <span class="keyword">new</span> String[] &#123;receiverPermission&#125;;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        intent.prepareToLeaveProcess(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// 进入 AMS 处理具体的有序广播发送流程</span></span><br><span class="line">        ActivityManager.getService().broadcastIntent(</span><br><span class="line">            mMainThread.getApplicationThread(), intent, resolvedType, rd,</span><br><span class="line">            initialCode, initialData, initialExtras, receiverPermissions, </span><br><span class="line">            appOp, options, <span class="keyword">true</span>, <span class="keyword">false</span>, getUserId());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="AMS-broadcastIntentLocked-广播发送解析"><a href="#AMS-broadcastIntentLocked-广播发送解析" class="headerlink" title="AMS.broadcastIntentLocked 广播发送解析"></a><code>AMS.broadcastIntentLocked</code> 广播发送解析</h3><p>不管是普通广播还是有序广播，在 <code>AMS</code> 中都是进入了 <code>broadcastIntentLocked(Intent, ...)</code> 方法来调度处理的。这个方法中会处理很多系统级广播，比如 <code>Intent.ACTION_PACKAGE_ADDED, Intent.ACTION_PACKAGE_REMOVED, Intent.ACTION_TIME_CHANGED</code> 等等，在 <code>AMS</code> 做预处理或者直接处理完毕。该方法主要功能：  </p>
<ul>
<li>各种权限检查  </li>
<li>系统广播处理  </li>
<li>收集该广播匹配的所有动态注册广播接收器  </li>
<li>收集该广播匹配的所有静态注册广播接收器  </li>
<li>将广播对应的广播记录存入广播队列（如果是有序广播，会按照优先级先排序再存入）  </li>
</ul>
<p>代码分析（代码有简化和调整位置）如下：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityManagerService.java</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">broadcastIntentLocked</span><span class="params">(ProcessRecord callerApp,</span></span></span><br><span class="line"><span class="function"><span class="params">        String callerPackage, Intent intent, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">        IIntentReceiver resultTo, <span class="keyword">int</span> resultCode, String resultData,</span></span></span><br><span class="line"><span class="function"><span class="params">        Bundle resultExtras, String[] requiredPermissions, <span class="keyword">int</span> appOp, </span></span></span><br><span class="line"><span class="function"><span class="params">        Bundle bOptions, <span class="keyword">boolean</span> ordered, <span class="keyword">boolean</span> sticky, </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    intent = <span class="keyword">new</span> Intent(intent);</span><br><span class="line">    <span class="comment">// 各种权限检查，系统广播处理</span></span><br><span class="line">    ...</span><br><span class="line">    List receivers = <span class="keyword">null</span>;</span><br><span class="line">    List&lt;BroadcastFilter&gt; registeredReceivers = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 1. 查询广播对应的所有静态注册的广播接收器</span></span><br><span class="line">    receivers = collectReceiverComponents(intent, resolvedType, </span><br><span class="line">                    callingUid, users);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 2. 查询广播对应的所有动态注册的广播接收器</span></span><br><span class="line">    registeredReceivers = mReceiverResolver.queryIntent(intent, </span><br><span class="line">                    resolvedType, <span class="keyword">false</span> <span class="comment">/*defaultOnly*/</span>, users[i]);</span><br><span class="line">    <span class="keyword">int</span> NR = registeredReceivers != <span class="keyword">null</span> ? registeredReceivers.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 3. 普通广播对应的动态注册广播接收器列表，新建广播记录对象</span></span><br><span class="line">    <span class="comment">// 加入到 mParallelBroadcasts 广播队列</span></span><br><span class="line">    <span class="keyword">if</span> (!ordered &amp;&amp; NR &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> BroadcastQueue queue = broadcastQueueForIntent(intent);</span><br><span class="line">        BroadcastRecord r = <span class="keyword">new</span> BroadcastRecord(queue, intent, callerApp,</span><br><span class="line">                callerPackage, callingPid, callingUid, callerInstantApp, </span><br><span class="line">                resolvedType, requiredPermissions, appOp, brOptions, </span><br><span class="line">                registeredReceivers, resultTo, resultCode, resultData, </span><br><span class="line">                resultExtras, ordered, sticky, <span class="keyword">false</span>, userId);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_BROADCAST) </span><br><span class="line">            Slog.v(TAG_BROADCAST, <span class="string">"Enqueueing parallel broadcast "</span> + r);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> replaced = replacePending</span><br><span class="line">                &amp;&amp; (queue.replaceParallelBroadcastLocked(r) != <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// Note: We assume resultTo is null for non-ordered broadcasts.</span></span><br><span class="line">        <span class="keyword">if</span> (!replaced) &#123;</span><br><span class="line">            <span class="comment">// 加入到 mParallelBroadcasts 广播队列</span></span><br><span class="line">            queue.enqueueParallelBroadcastLocked(r);</span><br><span class="line">            queue.scheduleBroadcastsLocked();</span><br><span class="line">        &#125;</span><br><span class="line">        registeredReceivers = <span class="keyword">null</span>;</span><br><span class="line">        NR = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 其他情况时，合并两个广播接收器列表：</span></span><br><span class="line">    <span class="comment">// 即有序广播对应的动态注册广播接收器，</span></span><br><span class="line">    <span class="comment">// 和普通广播对应的静态注册广播接收器。</span></span><br><span class="line">    <span class="comment">// Merge into one list.</span></span><br><span class="line">    <span class="keyword">int</span> ir = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 有序广播对应的广播接收器排序</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">while</span> (ir &lt; NR) &#123;</span><br><span class="line">        <span class="keyword">if</span> (receivers == <span class="keyword">null</span>) &#123;</span><br><span class="line">            receivers = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        &#125;</span><br><span class="line">        receivers.add(registeredReceivers.get(ir));</span><br><span class="line">        ir++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// resultTo 是有序广播的回调广播接收器</span></span><br><span class="line">    <span class="comment">// 4. 将合并的广播接收器列表，新建广播记录对象，</span></span><br><span class="line">    <span class="comment">// 加入到 mOrderedBroadcasts 广播队列</span></span><br><span class="line">    <span class="keyword">if</span> ((receivers != <span class="keyword">null</span> &amp;&amp; receivers.size() &gt; <span class="number">0</span>)</span><br><span class="line">            || resultTo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        BroadcastQueue queue = broadcastQueueForIntent(intent);</span><br><span class="line">        BroadcastRecord r = <span class="keyword">new</span> BroadcastRecord(queue, intent, callerApp,</span><br><span class="line">                callerPackage, callingPid, callingUid, callerInstantApp, </span><br><span class="line">                resolvedType, requiredPermissions, appOp, brOptions, </span><br><span class="line">                receivers, resultTo, resultCode, resultData, </span><br><span class="line">                resultExtras, ordered, sticky, <span class="keyword">false</span>, userId);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 加入到 mOrderedBroadcasts 广播队列</span></span><br><span class="line">        queue.enqueueOrderedBroadcastLocked(r);</span><br><span class="line">        queue.scheduleBroadcastsLocked();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> ActivityManager.BROADCAST_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="BroadcastQueue-processNextBroadcast-广播发送解析"><a href="#BroadcastQueue-processNextBroadcast-广播发送解析" class="headerlink" title="BroadcastQueue.processNextBroadcast 广播发送解析"></a><code>BroadcastQueue.processNextBroadcast</code> 广播发送解析</h3><p>不管是并行处理还是有序处理，在 <code>BroadcastQueue</code> 中都是进入 <code>processNextBroadcast(boolean fromMsg)</code> 方法处理的。该方法主要功能：  </p>
<ul>
<li>并行处理的广播接收器，一次全部处理完  </li>
<li>有序广播处理完毕后，处理回调广播接收器  </li>
<li>各种权限检查  </li>
<li>调用 <code>deliverToRegisteredReceiverLocked</code> 处理所有动态注册的广播接收器  </li>
<li>如果是静态广播接收器，开启对应的应用进程  </li>
<li>调用 <code>processCurBroadcastLocked</code> 处理所有静态注册的广播接收器  </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BroadcastQueue.java</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">processNextBroadcast</span><span class="params">(<span class="keyword">boolean</span> fromMsg)</span> </span>&#123;</span><br><span class="line">    BroadcastRecord r = <span class="keyword">null</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 1. mParallelBroadcasts 广播队列中，处理普通广播对应的动态注册的广播接收器</span></span><br><span class="line">    <span class="comment">// 特点是：一次调用整个队列全部处理完</span></span><br><span class="line">    <span class="keyword">while</span> (mParallelBroadcasts.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        r = mParallelBroadcasts.remove(<span class="number">0</span>);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = r.receivers.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            Object target = r.receivers.get(i);</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// 动态注册的广播接收器： target 可以直接强制转换为 BroadcastFilter</span></span><br><span class="line">            deliverToRegisteredReceiverLocked(r, (BroadcastFilter)target, </span><br><span class="line">                <span class="keyword">false</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// mOrderedBroadcasts 队列中，找到下一个需要处理的广播接收器</span></span><br><span class="line">    <span class="keyword">boolean</span> looped = <span class="keyword">false</span>;  </span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// mOrderedBroadcasts 广播队列处理完毕退出</span></span><br><span class="line">        <span class="keyword">if</span> (mOrderedBroadcasts.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        r = mOrderedBroadcasts.get(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">boolean</span> forceReceive = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">int</span> numReceivers = (r.receivers != <span class="keyword">null</span>) ? r.receivers.size() : <span class="number">0</span>;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (r.receivers == <span class="keyword">null</span> || r.nextReceiver &gt;= numReceivers</span><br><span class="line">                || r.resultAbort || forceReceive) &#123;</span><br><span class="line">            <span class="comment">// No more receivers for this broadcast!  Send the final</span></span><br><span class="line">            <span class="comment">// result if requested...</span></span><br><span class="line">            <span class="comment">// 有序广播全部处理完毕，执行回调 BroadCastReceiver</span></span><br><span class="line">            <span class="keyword">if</span> (r.resultTo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_BROADCAST) Slog.i(TAG_BROADCAST,</span><br><span class="line">                        <span class="string">"Finishing broadcast ["</span> + mQueueName + <span class="string">"] "</span></span><br><span class="line">                        + r.intent.getAction() + <span class="string">" app="</span> + r.callerApp);</span><br><span class="line">                    performReceiveLocked(r.callerApp, r.resultTo,</span><br><span class="line">                        <span class="keyword">new</span> Intent(r.intent), r.resultCode, r.resultData,</span><br><span class="line">                        r.resultExtras, <span class="keyword">false</span>, <span class="keyword">false</span>, r.userId);</span><br><span class="line">                    r.resultTo = <span class="keyword">null</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_BROADCAST_LIGHT) Slog.v(TAG_BROADCAST,</span><br><span class="line">                    <span class="string">"Finished with ordered broadcast "</span> + r);</span><br><span class="line">            ...</span><br><span class="line">            mOrderedBroadcasts.remove(<span class="number">0</span>);</span><br><span class="line">            r = <span class="keyword">null</span>;</span><br><span class="line">            looped = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (r == <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get the next receiver...</span></span><br><span class="line">    <span class="keyword">int</span> recIdx = r.nextReceiver++;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> Object nextReceiver = r.receivers.get(recIdx);</span><br><span class="line">    <span class="comment">// 2. mOrderedBroadcasts 队列中，下一个广播接收器是动态注册的</span></span><br><span class="line">    <span class="comment">// 类型检查，它对应的一定是有序广播，处理完后返回</span></span><br><span class="line">    <span class="keyword">if</span> (nextReceiver <span class="keyword">instanceof</span> BroadcastFilter) &#123;</span><br><span class="line">        <span class="comment">// Simple case: this is a registered receiver who gets</span></span><br><span class="line">        <span class="comment">// a direct call.</span></span><br><span class="line">        BroadcastFilter filter = (BroadcastFilter)nextReceiver;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_BROADCAST)  Slog.v(TAG_BROADCAST,</span><br><span class="line">                <span class="string">"Delivering ordered ["</span></span><br><span class="line">                + mQueueName + <span class="string">"] to registered "</span></span><br><span class="line">                + filter + <span class="string">": "</span> + r);</span><br><span class="line">        deliverToRegisteredReceiverLocked(r, filter, r.ordered, recIdx);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. mOrderedBroadcasts 队列中，下一个广播接收器是静态注册的</span></span><br><span class="line">    <span class="comment">// Hard case: need to instantiate the receiver, possibly</span></span><br><span class="line">    <span class="comment">// starting its application process to host it.</span></span><br><span class="line">    ResolveInfo info =</span><br><span class="line">        (ResolveInfo)nextReceiver;</span><br><span class="line">    ComponentName component = <span class="keyword">new</span> ComponentName(</span><br><span class="line">            info.activityInfo.applicationInfo.packageName,</span><br><span class="line">            info.activityInfo.name);</span><br><span class="line">    ...</span><br><span class="line">    String targetProcess = info.activityInfo.processName;</span><br><span class="line">    ProcessRecord app = mService.getProcessRecordLocked(targetProcess,</span><br><span class="line">            info.activityInfo.applicationInfo.uid, <span class="keyword">false</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Is this receiver's application already running?</span></span><br><span class="line">    <span class="comment">// 3.1 如果对应 app 已经在运行，处理广播接收器事件</span></span><br><span class="line">    <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span> &amp;&amp; !app.killed) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            app.addPackage(info.activityInfo.packageName,</span><br><span class="line">                    info.activityInfo.applicationInfo.versionCode, </span><br><span class="line">                    mService.mProcessStats);</span><br><span class="line">            processCurBroadcastLocked(r, app);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Not running--get it started, to be executed when the app comes up.</span></span><br><span class="line">    <span class="comment">// 3.2 如果 app 没有运行，启动该应用进程</span></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_BROADCAST)  Slog.v(TAG_BROADCAST,</span><br><span class="line">            <span class="string">"Need to start app ["</span></span><br><span class="line">            + mQueueName + <span class="string">"] "</span> + targetProcess + <span class="string">" for broadcast "</span> + r);</span><br><span class="line">    <span class="keyword">if</span> ((r.curApp=mService.startProcessLocked(targetProcess,</span><br><span class="line">            info.activityInfo.applicationInfo, <span class="keyword">true</span>,</span><br><span class="line">            r.intent.getFlags() | Intent.FLAG_FROM_BACKGROUND,</span><br><span class="line">            <span class="string">"broadcast"</span>, r.curComponent,</span><br><span class="line">            (r.intent.getFlags()&amp;Intent.FLAG_RECEIVER_BOOT_UPGRADE) != <span class="number">0</span>, </span><br><span class="line">            <span class="keyword">false</span>, <span class="keyword">false</span>))</span><br><span class="line">                    == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 启动失败</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.2 将广播设置为 pending 状态，等到应用启动后 </span></span><br><span class="line">    <span class="comment">// AMS 会调用 sendPendingBroadcastsLocked 执行该广播接收器事件</span></span><br><span class="line">    mPendingBroadcast = r;</span><br><span class="line">    mPendingBroadcastRecvIndex = recIdx;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="deliverToRegisteredReceiverLocked-方法解析"><a href="#deliverToRegisteredReceiverLocked-方法解析" class="headerlink" title="deliverToRegisteredReceiverLocked 方法解析"></a><code>deliverToRegisteredReceiverLocked</code> 方法解析</h3><p><code>BroadcastQueue.deliverToRegisteredReceiverLocked</code> 专门用来处理动态注册的广播接收器，最终是在 <code>performReceiveLocked</code> 方法中调用了 <code>ActivityThread.scheduleRegisteredReceiver</code> ，进入广播接收器所在进程处理具体的回调 <code>onReceive</code>。这个阶段主要功能：  </p>
<ul>
<li>各种权限检查  </li>
<li>添加完善广播记录  </li>
<li>跨进程进入广播接收器所在应用进程，调用 <code>onReceive</code>  </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">deliverToRegisteredReceiverLocked</span><span class="params">(BroadcastRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">        BroadcastFilter filter, <span class="keyword">boolean</span> ordered, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> skip = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// 各种权限检查等等</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 如果忽略该广播直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (skip) &#123;</span><br><span class="line">        r.delivery[index] = BroadcastRecord.DELIVERY_SKIPPED;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// If this is not being sent as an ordered broadcast, then we</span></span><br><span class="line">    <span class="comment">// don't want to touch the fields that keep track of the current</span></span><br><span class="line">    <span class="comment">// state of ordered broadcasts.</span></span><br><span class="line">    <span class="comment">// 有序广播相关处理</span></span><br><span class="line">    <span class="keyword">if</span> (ordered) &#123;</span><br><span class="line">        r.receiver = filter.receiverList.receiver.asBinder();</span><br><span class="line">        r.curFilter = filter;</span><br><span class="line">        filter.receiverList.curBroadcast = r;</span><br><span class="line">        r.state = BroadcastRecord.CALL_IN_RECEIVE;</span><br><span class="line">        <span class="keyword">if</span> (filter.receiverList.app != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Bump hosting application to no longer be in background</span></span><br><span class="line">            <span class="comment">// scheduling class.  Note that we can't do that if there</span></span><br><span class="line">            <span class="comment">// isn't an app...  but we can only be in that case for</span></span><br><span class="line">            <span class="comment">// things that directly call the IActivityManager API, which</span></span><br><span class="line">            <span class="comment">// are already core system stuff so don't matter for this.</span></span><br><span class="line">            r.curApp = filter.receiverList.app;</span><br><span class="line">            filter.receiverList.app.curReceivers.add(r);</span><br><span class="line">            mService.updateOomAdjLocked(r.curApp, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_BROADCAST_LIGHT) Slog.i(TAG_BROADCAST,</span><br><span class="line">                <span class="string">"Delivering to "</span> + filter + <span class="string">" : "</span> + r);</span><br><span class="line">        <span class="keyword">if</span> (filter.receiverList.app != <span class="keyword">null</span> </span><br><span class="line">            &amp;&amp; filter.receiverList.app.inFullBackup) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 处理动态注册的广播接收器</span></span><br><span class="line">            performReceiveLocked(filter.receiverList.app, </span><br><span class="line">                    filter.receiverList.receiver, <span class="keyword">new</span> Intent(r.intent),</span><br><span class="line">                    r.resultCode, r.resultData, r.resultExtras, </span><br><span class="line">                    r.ordered, r.initialSticky, r.userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ordered) &#123;</span><br><span class="line">            r.state = BroadcastRecord.CALL_DONE_RECEIVE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Failure sending broadcast "</span> + r.intent, e);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">performReceiveLocked</span><span class="params">(ProcessRecord app, IIntentReceiver receiver,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent, <span class="keyword">int</span> resultCode, String data, Bundle extras,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> ordered, <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> sendingUser)</span> </span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="comment">// Send the intent to the receiver asynchronously </span></span><br><span class="line">    <span class="comment">// using one-way binder calls.</span></span><br><span class="line">    <span class="keyword">if</span> (app != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// If we have an app thread, do the call through that so it is</span></span><br><span class="line">            <span class="comment">// correctly ordered with other one-way calls.</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 跨进程通信，进入应用所在进程处理动态注册的广播接收器</span></span><br><span class="line">                app.thread.scheduleRegisteredReceiver(receiver, intent,</span><br><span class="line">                        resultCode, data, extras, ordered, sticky, </span><br><span class="line">                        sendingUser, app.repProcState);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Application has died. Receiver doesn't exist.</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RemoteException(<span class="string">"app.thread must not be null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        receiver.performReceive(intent, resultCode, data, extras, </span><br><span class="line">                ordered, sticky, sendingUser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ActivityThread-scheduleRegisteredReceiver-方法解析"><a href="#ActivityThread-scheduleRegisteredReceiver-方法解析" class="headerlink" title="ActivityThread.scheduleRegisteredReceiver 方法解析"></a><code>ActivityThread.scheduleRegisteredReceiver</code> 方法解析</h3><p>每个应用的主线程中 <code>ActivityThread.scheduleRegisteredReceiver</code> 来执行广播处理事件，<code>performReceive</code> 对应的是 <code>LoadedApk.ReceiverDispatcher.InnerReceiver.performReceive</code> 方法。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleRegisteredReceiver</span><span class="params">(IIntentReceiver receiver, </span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent, <span class="keyword">int</span> resultCode, String dataStr, </span></span></span><br><span class="line"><span class="function"><span class="params">        Bundle extras, <span class="keyword">boolean</span> ordered, <span class="keyword">boolean</span> sticky, </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> sendingUser, <span class="keyword">int</span> processState)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    updateProcessState(processState, <span class="keyword">false</span>);</span><br><span class="line">    receiver.performReceive(intent, resultCode, dataStr, extras, </span><br><span class="line">            ordered, sticky, sendingUser);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="processCurBroadcastLocked-方法解析"><a href="#processCurBroadcastLocked-方法解析" class="headerlink" title="processCurBroadcastLocked 方法解析"></a><code>processCurBroadcastLocked</code> 方法解析</h3><p><code>BroadcastQueue.processCurBroadcastLocked</code> 专门处理静态注册的广播接收器。该方法主要功能：  </p>
<ul>
<li>将 <code>BroadCastReceiver</code> 子类存储到 <code>intent</code> 中  </li>
<li>跨进程进入静态广播接收器所在进程，通过反射调用 <code>onReceive</code>  </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">processCurBroadcastLocked</span><span class="params">(BroadcastRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">        ProcessRecord app)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_BROADCAST)  Slog.v(TAG_BROADCAST,</span><br><span class="line">            <span class="string">"Process cur broadcast "</span> + r + <span class="string">" for app "</span> + app);</span><br><span class="line">    ...</span><br><span class="line">    r.receiver = app.thread.asBinder();</span><br><span class="line">    r.curApp = app;</span><br><span class="line">    app.curReceivers.add(r);</span><br><span class="line">    app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_RECEIVER);</span><br><span class="line">    mService.updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">    mService.updateOomAdjLocked();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tell the application to launch this receiver.</span></span><br><span class="line">    <span class="comment">// 将 BroadCastReceiver 子类存储到 intent 中</span></span><br><span class="line">    r.intent.setComponent(r.curComponent);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 跨进程通信，进入应用所在进程处理静态注册的广播接收器</span></span><br><span class="line">        app.thread.scheduleReceiver(<span class="keyword">new</span> Intent(r.intent), </span><br><span class="line">                r.curReceiver,</span><br><span class="line">                mService.compatibilityInfoForPackageLocked(</span><br><span class="line">                r.curReceiver.applicationInfo),</span><br><span class="line">                r.resultCode, r.resultData, r.resultExtras, </span><br><span class="line">                r.ordered, r.userId, app.repProcState);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_BROADCAST)  Slog.v(TAG_BROADCAST,</span><br><span class="line">                <span class="string">"Process cur broadcast "</span> + r </span><br><span class="line">                + <span class="string">" DELIVERED for app "</span> + app);</span><br><span class="line">        started = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!started) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ActivityThread-scheduleReceiver-方法解析"><a href="#ActivityThread-scheduleReceiver-方法解析" class="headerlink" title="ActivityThread.scheduleReceiver 方法解析"></a><code>ActivityThread.scheduleReceiver</code> 方法解析</h3><p><code>ActivityThread.scheduleReceiver</code> 处理静态注册的广播接收器，从 <code>intent</code> 中获取具体的广播接收器子类组件名，在 <code>handleReceiver</code> 中使用反射技术生成对应的实例对象，并调用其 <code>onReceive</code> 方法。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleReceiver</span><span class="params">(Intent intent, ActivityInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">        CompatibilityInfo compatInfo, <span class="keyword">int</span> resultCode, String data, </span></span></span><br><span class="line"><span class="function"><span class="params">        Bundle extras, <span class="keyword">boolean</span> sync, <span class="keyword">int</span> sendingUser, <span class="keyword">int</span> processState)</span></span>&#123;</span><br><span class="line">    updateProcessState(processState, <span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// 新建 ReceiverData 对象</span></span><br><span class="line">    ReceiverData r = <span class="keyword">new</span> ReceiverData(intent, resultCode, data, extras,</span><br><span class="line">            sync, <span class="keyword">false</span>, mAppThread.asBinder(), sendingUser);</span><br><span class="line">    r.info = info;</span><br><span class="line">    r.compatInfo = compatInfo;</span><br><span class="line">    sendMessage(H.RECEIVER, r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleReceiver</span><span class="params">(ReceiverData data)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 从 intent 中取出 BroadCastReceiver 子类的组件名</span></span><br><span class="line">    String component = data.intent.getComponent().getClassName();</span><br><span class="line">    LoadedApk packageInfo = getPackageInfoNoCheck(</span><br><span class="line">            data.info.applicationInfo, data.compatInfo);</span><br><span class="line">    IActivityManager mgr = ActivityManager.getService();</span><br><span class="line">    Application app;</span><br><span class="line">    BroadcastReceiver receiver;</span><br><span class="line">    ContextImpl context;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        app = packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line">        context = (ContextImpl) app.getBaseContext();</span><br><span class="line">        <span class="keyword">if</span> (data.info.splitName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            context = (ContextImpl) context.</span><br><span class="line">                createContextForSplit(data.info.splitName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 反射，生成对应的 BroadCastReceiver 子类实例对象</span></span><br><span class="line">        java.lang.ClassLoader cl = context.getClassLoader();</span><br><span class="line">        data.intent.setExtrasClassLoader(cl);</span><br><span class="line">        data.intent.prepareToEnterProcess();</span><br><span class="line">        data.setExtrasClassLoader(cl);</span><br><span class="line">        receiver = (BroadcastReceiver)cl.loadClass(component)</span><br><span class="line">                    .newInstance();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_BROADCAST) Slog.i(...);</span><br><span class="line">        data.sendFinished(mgr);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(...);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 调用 onReceive 方法</span></span><br><span class="line">        sCurrentBroadcastIntent.set(data.intent);</span><br><span class="line">        receiver.setPendingResult(data);</span><br><span class="line">        receiver.onReceive(context.getReceiverRestrictedContext(),</span><br><span class="line">                data.intent);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_BROADCAST) Slog.i(...);</span><br><span class="line">        data.sendFinished(mgr);</span><br><span class="line">        <span class="keyword">if</span> (!mInstrumentation.onException(receiver, e)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(...);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        sCurrentBroadcastIntent.set(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (receiver.getPendingResult() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        data.finish();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="AMS-finishReceiver-结束广播"><a href="#AMS-finishReceiver-结束广播" class="headerlink" title="AMS.finishReceiver 结束广播"></a><code>AMS.finishReceiver</code> 结束广播</h3><p>所有的广播接收器处理完毕后，最终会调用系统 <code>ActivityManagerService.finishReceiver</code> 结束整个流程。结束流程前会再次检查确认，是否还有广播接收器没有处理完（静态注册的广播接收器，如果应用没有启动，会先启动应用进程），存在的话就触发 <code>BroadcastQueue.processNextBroadcast</code> 继续分发。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityManagerService.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">finishReceiver</span><span class="params">(IBinder who, <span class="keyword">int</span> resultCode, </span></span></span><br><span class="line"><span class="function"><span class="params">        String resultData, Bundle resultExtras, </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> resultAbort, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> doNext = <span class="keyword">false</span>;</span><br><span class="line">        BroadcastRecord r;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 再次检查，如果还存在没有处理完的广播接收器</span></span><br><span class="line">        <span class="comment">// 触发 processNextBroadcast 继续分发广播</span></span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">            BroadcastQueue queue = </span><br><span class="line">                    (flags &amp; Intent.FLAG_RECEIVER_FOREGROUND) != <span class="number">0</span></span><br><span class="line">                    ? mFgBroadcastQueue : mBgBroadcastQueue;</span><br><span class="line">            r = queue.getMatchingOrderedReceiver(who);</span><br><span class="line">            <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">                doNext = r.queue.finishReceiverLocked(r, resultCode,</span><br><span class="line">                    resultData, resultExtras, resultAbort, <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (doNext) &#123;</span><br><span class="line">            r.queue.processNextBroadcast(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        trimApplications();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="广播-ANR"><a href="#广播-ANR" class="headerlink" title="广播 ANR"></a>广播 <code>ANR</code></h3><p><code>processNextBroadcast</code> 中可以看到，广播的 <code>ANR</code> 只会出现在有序处理的广播队列 <code>mOrderedBroadcasts</code> 中，也就是普通广播匹配的动态注册的广播接收器不会出现 <code>ANR</code> 。  </p>
<ul>
<li><code>setBroadcastTimeoutLocked</code> ：设置广播超时延时消息  </li>
<li><code>broadcastTimeoutLocked</code> ：当广播接收者等待时间过长，触发 <code>ANR</code> 机制  </li>
<li><code>cancelBroadcastTimeoutLocked</code> ：当广播正常执行完毕清除  </li>
</ul>
<p>超时时间计算方式：从队列中取出有效广播开始计时，直到所有的广播接收器处理完毕，才取消计时。<br>示例：发送一个有序广播，<code>AndroidManifest.xml</code> 中静态注册的广播接收器和一个动态注册的广播接收器都能匹配到，同时有序广播带有回调广播接收器，也就是说该广播一共会有三个 <code>BroadCastReceiver.onReceive</code> 响应处理。看对应的 <code>Log</code> 文件：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">// 1. AMS.broadcastIntent 发送广播</span><br><span class="line">06-17*.163: D/XMT(1485): ***********AMS: broadcastIntent##########</span><br><span class="line">06-17*.163: V/ActivityManager(1485): Broadcast: Intent &#123; act=broadcast.service.order flg=0x10 (has extras) &#125; ordered=true userid=0</span><br><span class="line">06-17*.163: V/ActivityManager(1485): Enqueueing broadcast: broadcast.service.order replacePending=false</span><br><span class="line">// 2. 广播是后台广播</span><br><span class="line">06-17*.163: I/ActivityManager(1485): Broadcast intent Intent &#123; act=broadcast.service.order flg=0x10 (has extras) &#125; on background queue</span><br><span class="line">// 3. 存入 BroadcastQueue.mOrderedBroadcasts 中</span><br><span class="line">06-17*.163: V/ActivityManager(1485): Enqueueing ordered broadcast BroadcastRecord&#123;46a4f31 u0 broadcast.service.order&#125;: prev had 0</span><br><span class="line">06-17*.163: I/ActivityManager(1485): Enqueueing broadcast broadcast.service.order</span><br><span class="line">06-17*.164: V/BroadcastQueue(1485): Schedule broadcasts [background]: current=false</span><br><span class="line">06-17*.164: V/BroadcastQueue(1485): Received BROADCAST_INTENT_MSG</span><br><span class="line">// 4. 进入 BroadcastQueue.processNextBroadcast 处理具体的广播， mOrderedBroadcasts 中只有一个广播</span><br><span class="line">06-17*.164: V/BroadcastQueue(1485): processNextBroadcast [background]: 0 parallel broadcasts, 1 ordered broadcasts</span><br><span class="line">// 5. 从 mOrderedBroadcasts 中取出有效广播  </span><br><span class="line">06-17*.164: V/BroadcastQueue(1485): Processing ordered broadcast [background] BroadcastRecord&#123;46a4f31 u0 broadcast.service.order&#125;</span><br><span class="line">// 6. 有序处理广播 ANR 开始计时</span><br><span class="line">06-17*.164: V/BroadcastQueue(1485): Submitting BROADCAST_TIMEOUT_MSG [background] for BroadcastRecord&#123;46a4f31 u0 broadcast.service.order&#125; at 40095097</span><br><span class="line">// 7. deliverToRegisteredReceiverLocked 开始处理动态注册的广播接收器</span><br><span class="line">06-17*.164: V/BroadcastQueue(1485): Delivering ordered [background] to registered BroadcastFilter&#123;d73ca43 u0 ReceiverList&#123;a3cf3f2 9397 com.ymzs.androidbasicknowledge:broadcast/10076/u0 remote:550afd&#125;&#125;: BroadcastRecord&#123;46a4f31 u0 broadcast.service.order&#125;</span><br><span class="line">06-17*.165: I/BroadcastQueue(1485): Delivering to BroadcastFilter&#123;d73ca43 u0 ReceiverList&#123;a3cf3f2 9397 com.ymzs.androidbasicknowledge:broadcast/10076/u0 remote:550afd&#125;&#125; : BroadcastRecord&#123;46a4f31 u0 broadcast.service.order&#125;</span><br><span class="line">// 8. 动态注册的广播接收器响应 onReceive</span><br><span class="line">06-17*.168: D/XMT:BroadcastService(9397): mActionOrderBroadcastReceiver: onReceive = order</span><br><span class="line">// 9. 动态注册广播接收器响应完毕后，调用 finishReceiver 结束广播流程</span><br><span class="line">06-17*.169: V/ActivityManager(1485): Finish receiver: android.os.BinderProxy@550afd</span><br><span class="line">// 10. 结束广播流程时，发现 mOrderedBroadcasts 中还有广播没有处理完毕</span><br><span class="line">// 触发 processNextBroadcast 继续分发广播</span><br><span class="line">06-17*.169: V/BroadcastQueue(1485): processNextBroadcast [background]: 0 parallel broadcasts, 1 ordered broadcasts</span><br><span class="line">// 11. processCurBroadcastLocked 开始处理静态注册的广播接收器</span><br><span class="line">06-17*.169: V/BroadcastQueue(1485): Process cur broadcast BroadcastRecord&#123;46a4f31 u0 broadcast.service.order&#125; for app ProcessRecord&#123;64ad616 9368:com.ymzs.androidbasicknowledge/u0a76&#125;</span><br><span class="line">06-17*.170: V/BroadcastQueue(1485): Delivering to component ComponentInfo&#123;com.ymzs.androidbasicknowledge/com.ymzs.androidbasicknowledge.ipc.BroadcastReceiverMy&#125;: BroadcastRecord&#123;46a4f31 u0 broadcast.service.order&#125;</span><br><span class="line">06-17*.171: V/BroadcastQueue(1485): Process cur broadcast BroadcastRecord&#123;46a4f31 u0 broadcast.service.order&#125; DELIVERED for app ProcessRecord&#123;64ad616 9368:com.ymzs.androidbasicknowledge/u0a76&#125;</span><br><span class="line">// 12. 静态注册的广播接收器响应 onReceive</span><br><span class="line">06-17*.175: D/XMT:BroadcastReceiverMy(9368): BroadcastReceiverMy: onReceive = order</span><br><span class="line">// 13. 静态注册广播接收器响应完毕后，调用 finishReceiver 结束广播流程</span><br><span class="line">06-17*.176: V/ActivityManager(1485): Finish receiver: android.os.BinderProxy@61c0b97</span><br><span class="line">// 14. 结束广播流程时，发现 mOrderedBroadcasts 中还有广播没有处理完毕</span><br><span class="line">// 触发 processNextBroadcast 继续分发广播，处理有序广播的回调</span><br><span class="line">06-17*.176: V/BroadcastQueue(1485): processNextBroadcast [background]: 0 parallel broadcasts, 1 ordered broadcasts</span><br><span class="line">// 15. 有序广播的回调广播接收器响应 onReceive</span><br><span class="line">06-17*.176: D/XMT:BroadcastActivity(9397): mResultBroadcastReceiver: onReceive = order</span><br><span class="line">06-17*.176: I/BroadcastQueue(1485): Finishing broadcast [background] broadcast.service.order app=ProcessRecord&#123;64ad616 9368:com.ymzs.androidbasicknowledge/u0a76&#125;</span><br><span class="line">// 17. 有序处理广播 ANR 计时取消</span><br><span class="line">06-17*.177: V/BroadcastQueue(1485): Cancelling BROADCAST_TIMEOUT_MSG</span><br><span class="line">06-17*.177: V/BroadcastQueue(1485): Finished with ordered broadcast BroadcastRecord&#123;46a4f31 u0 broadcast.service.order&#125;</span><br></pre></td></tr></table></figure>

<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><h3 id="静态注册广播接收器"><a href="#静态注册广播接收器" class="headerlink" title="静态注册广播接收器"></a>静态注册广播接收器</h3><ul>
<li><p><code>BroadCastReceiver</code> 子类文件  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BroadcastReceiverMy</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"XMT:BroadcastReceiverMy"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="comment">// broadcast ANR 60s</span></span><br><span class="line">            <span class="comment">//Log.d(TAG, "BroadcastReceiverMy: sleep...");</span></span><br><span class="line">            <span class="comment">//try&#123;</span></span><br><span class="line">            <span class="comment">//    Thread.sleep(65*1000);</span></span><br><span class="line">            <span class="comment">//&#125; catch(Exception e)&#123;&#125;</span></span><br><span class="line">            </span><br><span class="line">            String value = intent.getStringExtra(<span class="string">"key"</span>);</span><br><span class="line">            Log.d(TAG, <span class="string">"BroadcastReceiverMy: onReceive = "</span> + value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 <code>AndroidManifest.xml</code> 中声明  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;receiver</span><br><span class="line">    android:name=<span class="string">".ipc.BroadcastReceiverMy"</span></span><br><span class="line">    android:enabled=<span class="string">"true"</span></span><br><span class="line">    android:exported=<span class="string">"true"</span>&gt;</span><br><span class="line">    &lt;intent-filter&gt;</span><br><span class="line">        &lt;action android:name="broadcast.service.normal"&gt;&lt;/action&gt;</span><br><span class="line">    &lt;/intent-filter&gt;</span><br><span class="line">    &lt;intent-filter&gt;</span><br><span class="line">        &lt;action android:name="broadcast.service.order"&gt;&lt;/action&gt;</span><br><span class="line">    &lt;/intent-filter&gt;</span><br><span class="line">&lt;/receiver&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="动态注册广播接收器"><a href="#动态注册广播接收器" class="headerlink" title="动态注册广播接收器"></a>动态注册广播接收器</h3><p>动态注册和取消注册广播必须在生命周期中成对出现，比如在 <code>onCreate/onDestroy, onResume/onPause, onStart/onStop</code> 对应出现。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> registeredOrder;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> registeredNormal;</span><br><span class="line"><span class="keyword">private</span> BroadcastReceiver mActionOrderBroadcastReceiver </span><br><span class="line">    = <span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String value = intent.getStringExtra(<span class="string">"key"</span>);</span><br><span class="line">            Log.d(TAG, <span class="string">"mActionOrderBroadcastReceiver: onReceive = "</span></span><br><span class="line">                + value);</span><br><span class="line">            setResultData(<span class="string">"mActionOrderBroadcastReceiver:From Service"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> BroadcastReceiver mActionNormalBroadcastReceiver </span><br><span class="line">    = <span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span>)&#123;</span><br><span class="line">            String value = intent.getStringExtra(<span class="string">"key"</span>);</span><br><span class="line">            Log.d(TAG, <span class="string">"mActionNormalBroadcastReceiver: onReceive = "</span></span><br><span class="line">                + value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate();</span><br><span class="line">    Log.d(TAG, <span class="string">"onCreate: "</span>);</span><br><span class="line">    IntentFilter intentFilter = </span><br><span class="line">        <span class="keyword">new</span> IntentFilter(BroadcastActivity.BROADCAST_ACTION_ORDER);</span><br><span class="line">    registerReceiver(mActionOrderBroadcastReceiver, intentFilter);</span><br><span class="line">    registeredOrder = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    intentFilter = </span><br><span class="line">        <span class="keyword">new</span> IntentFilter(BroadcastActivity.BROADCAST_ACTION_NORMAL);</span><br><span class="line">    registerReceiver(mActionNormalBroadcastReceiver, intentFilter);</span><br><span class="line">    registeredNormal = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">    doLongWork();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    Log.d(TAG, <span class="string">"onDestroy: "</span>);</span><br><span class="line">    <span class="keyword">if</span> (registeredOrder)&#123;</span><br><span class="line">        unregisterReceiver(mActionOrderBroadcastReceiver);</span><br><span class="line">        mActionOrderBroadcastReceiver = <span class="keyword">null</span>;</span><br><span class="line">        registeredOrder = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (registeredNormal)&#123;</span><br><span class="line">        unregisterReceiver(mActionNormalBroadcastReceiver);</span><br><span class="line">        mActionNormalBroadcastReceiver = <span class="keyword">null</span>;</span><br><span class="line">        registeredNormal = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="广播发送"><a href="#广播发送" class="headerlink" title="广播发送"></a>广播发送</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 发送有序广播，并包含回调广播接收器</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendOrderBroadcast</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Log.d(TAG, <span class="string">"sendOrderBroadcast: "</span>);</span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(BROADCAST_ACTION_ORDER);</span><br><span class="line">    intent.putExtra(<span class="string">"key"</span>, <span class="string">"order"</span>);</span><br><span class="line">    sendOrderedBroadcast(intent, <span class="keyword">null</span>, mResultBroadcastReceiver, </span><br><span class="line">        <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> BroadcastReceiver mResultBroadcastReceiver </span><br><span class="line">    = <span class="keyword">new</span> BroadcastReceiver()&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        String result = getResultData();</span><br><span class="line">        mTvResultReceiver.setText(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送普通广播</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendNormalBroadcast</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Log.d(TAG, <span class="string">"sendNormalBroadcast: sendNormalBroadcast"</span>);</span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(BROADCAST_ACTION_NORMAL);</span><br><span class="line">    intent.putExtra(<span class="string">"key"</span>, <span class="string">"normal"</span>);</span><br><span class="line">    sendBroadcast(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><h3 id="广播接收器静态注册过程"><a href="#广播接收器静态注册过程" class="headerlink" title="广播接收器静态注册过程"></a>广播接收器静态注册过程</h3><p>静态注册的广播接收器，是开机时 <code>PMS</code> 启动后解析扫描所有包时注册的，保存在每个包的 <code>PackageParser.Package.receivers</code> 中，系统 <code>PMS.mReceivers</code> 会全局保存所有静态注册的广播接收器。 <code>AMS</code> 中并不会保存静态注册的广播接收器信息，而是直接向 <code>PMS</code> 中查询。    </p>
<h3 id="AMS-中存储的广播相关信息"><a href="#AMS-中存储的广播相关信息" class="headerlink" title="AMS 中存储的广播相关信息"></a><code>AMS</code> 中存储的广播相关信息</h3><ul>
<li>广播队列：前台广播队列 <code>mFgBroadcastQueue</code> 和后台广播队列 <code>mBgBroadcastQueue</code>  </li>
<li>广播接收器哈希表 <code>mRegisteredReceivers</code>：所有动态注册的广播接收器  </li>
<li>广播过滤器符号表 <code>mReceiverResolver</code>：所有动态注册的广播过滤器</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BroadcastQueue mFgBroadcastQueue;</span><br><span class="line">BroadcastQueue mBgBroadcastQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> HashMap&lt;IBinder, ReceiverList&gt; mRegisteredReceivers = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">final</span> IntentResolver&lt;BroadcastFilter, BroadcastFilter&gt; mReceiverResolver</span><br><span class="line">    = <span class="keyword">new</span> IntentResolver&lt;BroadcastFilter, BroadcastFilter&gt;() &#123;...&#125;</span><br></pre></td></tr></table></figure>

<h3 id="权限检查"><a href="#权限检查" class="headerlink" title="权限检查"></a>权限检查</h3><p>广播在发送的过程中，会有大量的权限检查，比如 <code>AMS.broadcastIntentLocked, BroadcastQueue.processNextBroadcast, BroadcastQueue.deliverToRegisteredReceiverLocked</code> 都会反复做权限检查。  </p>
<h3 id="广播接收器优先级"><a href="#广播接收器优先级" class="headerlink" title="广播接收器优先级"></a>广播接收器优先级</h3><p>数字越大表示优先级越高，接收有序广播时优先级高的先接收到。  </p>
<ul>
<li><p>静态注册广播接收器  </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">".smsReceiver"</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">intent-filter</span> <span class="attr">android:priority</span>=<span class="string">"1000"</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.provider.Telephony.SMS_RECEIVED"</span>/&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>动态注册广播接收器  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">IntentFilter intentFilter = <span class="keyword">new</span> IntentFilter(</span><br><span class="line">    <span class="string">"android.provider.Telephony.SMS_RECEIVED"</span>);</span><br><span class="line">intentFilter.setPriority(<span class="number">1000</span>);</span><br><span class="line">registerReceiver(broadcastReceiver, intentFilter);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="广播接收器响应"><a href="#广播接收器响应" class="headerlink" title="广播接收器响应"></a>广播接收器响应</h3><p>广播接收器回调 <code>onReceive</code> 触发响应的位置  </p>
<ul>
<li>静态注册的广播接收器<br><code>ActivityThread.handleReceiver</code> 中使用反射，触发 <code>onReceive</code> 方法。静态注册的广播接收器并不会对应 <code>ReceiverDispatcher</code> 。  </li>
<li>动态注册的广播接收器<br>动态注册的广播接收器对应一个 <code>ReceiverDispatcher</code> ，通过它找到 <code>LoadedApk.Args</code> ，在 <code>Runnable.run</code> 中触发 <code>onReceive</code> 方法。  </li>
</ul>
<h3 id="前后台广播及-ANR"><a href="#前后台广播及-ANR" class="headerlink" title="前后台广播及 ANR"></a>前后台广播及 <code>ANR</code></h3><p>广播发送时，通过 <code>Intent</code> 是否设置 <code>FLAG_RECEIVER_FOREGROUND</code> 来区分，如果设置了表示前台广播，对应 <code>ANR</code> 超时为 10 秒；默认为后台广播，对应超时为 60 秒。<br>广播的 <code>ANR</code> 是会出现在有序处理广播队列中，在 <code>BroadcastQueue.processNextBroadcast</code> 中计算的，从有序队列 <code>mOrderedBroadcasts</code> 取出有效广播后开始计时，直到有序广播匹配的所有广播接收器包括有序广播的回调广播接收器，全部处理完毕才会取消计时。具体可以看“广播 <code>ANR</code>” 这一节的 <code>Log</code> 分析。<br>注意：如果广播接收器的 <code>onReceive</code> 是在主线程中处理，同时还会受到 <code>Activity</code> 超时 5 秒产生 <code>ANR</code> 的限制！也就是说等不到 60 秒，可能 <code>Activity</code> 就出现 <code>ANR</code> 了。如果 <code>onReceive</code> 有耗时任务，请新开线程处理。  </p>
<h3 id="有序广播"><a href="#有序广播" class="headerlink" title="有序广播"></a>有序广播</h3><ul>
<li>可以被终止<br>优先级高的广播接收者接收到后，可以通过 <code>abortBroadcast</code> 来终止继续向下传递广播。  </li>
<li>可以有回调 <code>BroadCastReceiver</code><br>广播接收器回调，发送有序广播时，可以同时指定一个 <code>BroadCastReceiver</code> 回调；当有序广播全部被执行完后，会触发这个回调。也就是说有序广播，在顺序接收过程中，每个广播接收者都可以在回调 <code>BroadCastReceiver</code> 中向发送者写回数据。  </li>
</ul>
<h3 id="广播发送过程"><a href="#广播发送过程" class="headerlink" title="广播发送过程"></a>广播发送过程</h3><ul>
<li>整个广播发送及响应过程都是异步的，大量使用 <code>Handler</code> 异步处理  </li>
<li>源码中可以看到大量 <code>synchronized</code> 关键字，而且大多使用 <code>AMS</code> 作为对象锁，所以系统处理广播的过程有大量同步过程  </li>
</ul>
<h3 id="并行处理和有序处理"><a href="#并行处理和有序处理" class="headerlink" title="并行处理和有序处理"></a>并行处理和有序处理</h3><ul>
<li><code>mParallelBroadcasts</code> 广播队列<br>存储的广播为普通广播（对应的广播接收器是动态注册的），该队列的所有广播都是并行处理的，在 <code>processNextBroadcast</code> 中一次全部处理完。  </li>
<li><code>mOrderedBroadcasts</code> 广播队列<br>存储的广播为有序广播和普通广播（对应的广播接收器时静态注册的）该队列的所有广播都是有序处理的，在 <code>processNextBroadcast</code> 中从队列中取出一个有效广播，处理完一个广播接收器后，会触发 <code>AMS.finishReceiver</code> 结束整个广播过程。但是 <code>finishReceiver</code> 方法每次都会调用 <code>BroadcastQueue.finishReceiverLocked</code> 检查 <code>mOrderedBroadcasts</code> 是否全部处理完毕。如果没有，调用 <code>processNextBroadcast</code> 继续从有序队列中取出广播处理。具体可以参考“广播 <code>ANR</code>” 中的 <code>Log</code> 分析。  </li>
</ul>
<h3 id="进程和线程间交互"><a href="#进程和线程间交互" class="headerlink" title="进程和线程间交互"></a>进程和线程间交互</h3><ul>
<li><code>Handler</code> 线程间异步通信  </li>
<li><code>LocalBroadcastManager</code> 同一个应用相同进程内异步通信，本质上仍然是通过 <code>Handler</code> 实现的  </li>
<li><code>BroadCastReceiver</code> 进程间异步通信，不同应用不同进程间的通信，通过系统广播总线统一管理广播，用户使用很简单方便  </li>
<li><code>Messenger</code> 进程间异步通信，相同应用不同进程间的通信，常用于 <code>Activity, Service</code> 不在同一进程时使用  </li>
<li><code>AIDL</code> 进程间同步通信  </li>
</ul>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul>
<li><a href="https://developer.android.com/guide/components/broadcasts#java" target="_blank" rel="noopener">Android developer: Broadcast</a>  </li>
<li><a href="https://developer.android.com/reference/android/content/BroadcastReceiver" target="_blank" rel="noopener">BroadcastReceiver API</a>  </li>
<li><a href="https://blog.csdn.net/luoshengyang/article/details/6730748" target="_blank" rel="noopener">老罗：广播机制 Broadcast</a>  </li>
<li><a href="https://blog.csdn.net/zhangyongfeiyong/article/details/52022935" target="_blank" rel="noopener">Android广播之发送广播的源码分析</a>  </li>
<li><a href="https://blog.csdn.net/zhangyongfeiyong/article/details/51980348" target="_blank" rel="noopener">Android广播之注册广播源码分析</a>  </li>
<li><a href="http://gityuan.com/2016/06/04/broadcast-receiver/" target="_blank" rel="noopener">gityuan: Android Broadcast广播机制分析</a>  </li>
<li><a href="http://gityuan.com/2017/06/03/broadcast_record/" target="_blank" rel="noopener">gityuan: BroadcastRecord</a>  </li>
<li><a href="http://blog.csdn.net/jiangwei0910410003/article/details/19150705" target="_blank" rel="noopener">Android中的广播Broadcast详解 </a>  </li>
<li><a href="https://blog.csdn.net/codefly/article/details/42322695" target="_blank" rel="noopener">品茗论道说广播-上</a>  </li>
<li><a href="https://blog.csdn.net/codefly/article/details/42323235" target="_blank" rel="noopener">品茗论道说广播-下</a>  </li>
<li><a href="http://www.jianshu.com/p/ca3d87a4cdf3" target="_blank" rel="noopener">Android四大组件：BroadcastReceiver</a>  </li>
<li><a href="https://blog.csdn.net/u013553529/article/details/78409382" target="_blank" rel="noopener">protected-broadcast 的一些细节</a>  </li>
</ul>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    redspider110
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://redspider110.github.io/2017/11/27/0021-broadcast/" title="四大组件 -- Broadcast">http://redspider110.github.io/2017/11/27/0021-broadcast/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
            <a href="/tags/FourComponents/" rel="tag"># FourComponents</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/11/27/0020-service/" rel="next" title="四大组件 -- Service">
                <i class="fa fa-chevron-left"></i> 四大组件 -- Service
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/11/27/0021-local-broadcast/" rel="prev" title="四大组件 -- LocalBroadcastManager">
                四大组件 -- LocalBroadcastManager <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="redspider110">
            
              <p class="site-author-name" itemprop="name">redspider110</p>
              <p class="site-description motion-element" itemprop="description">地球卫士</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">124</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">54</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          
            <div class="cc-license motion-element" itemprop="license">
              <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
                <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons">
              </a>
            </div>
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#基础"><span class="nav-number">1.</span> <span class="nav-text">基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#广播接收器的分类"><span class="nav-number">1.1.</span> <span class="nav-text">广播接收器的分类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#广播的分类"><span class="nav-number">1.2.</span> <span class="nav-text">广播的分类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#广播的标记"><span class="nav-number">1.3.</span> <span class="nav-text">广播的标记</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#广播的-ANR"><span class="nav-number">1.4.</span> <span class="nav-text">广播的 ANR</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#相关类文件"><span class="nav-number">2.</span> <span class="nav-text">相关类文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#速查表"><span class="nav-number">2.1.</span> <span class="nav-text">速查表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#类简介"><span class="nav-number">2.2.</span> <span class="nav-text">类简介</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BroadcastFilter-类详解"><span class="nav-number">3.</span> <span class="nav-text">BroadcastFilter 类详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#源码分析"><span class="nav-number">3.1.</span> <span class="nav-text">源码分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#成员变量"><span class="nav-number">3.2.</span> <span class="nav-text">成员变量</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ReceiverList-类详解"><span class="nav-number">4.</span> <span class="nav-text">ReceiverList 类详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#源码分析-1"><span class="nav-number">4.1.</span> <span class="nav-text">源码分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#成员变量-1"><span class="nav-number">4.2.</span> <span class="nav-text">成员变量</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BroadCastReceiver-类详解"><span class="nav-number">5.</span> <span class="nav-text">BroadCastReceiver 类详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PendingResult-类"><span class="nav-number">5.1.</span> <span class="nav-text">PendingResult 类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PendingResult-类的两个子类"><span class="nav-number">5.2.</span> <span class="nav-text">PendingResult 类的两个子类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PendingResult-类源码分析"><span class="nav-number">5.3.</span> <span class="nav-text">PendingResult 类源码分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BroadcastReceiver-源码分析"><span class="nav-number">5.4.</span> <span class="nav-text">BroadcastReceiver 源码分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BroadcastReceiver-重要方法"><span class="nav-number">5.5.</span> <span class="nav-text">BroadcastReceiver 重要方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IIntentReceiver-详解"><span class="nav-number">6.</span> <span class="nav-text">IIntentReceiver 详解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LoadedApk-类"><span class="nav-number">7.</span> <span class="nav-text">LoadedApk 类</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#部分源码分析"><span class="nav-number">7.1.</span> <span class="nav-text">部分源码分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#成员变量-2"><span class="nav-number">7.2.</span> <span class="nav-text">成员变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ReceiverDispatcher-静态内部类"><span class="nav-number">7.3.</span> <span class="nav-text">ReceiverDispatcher 静态内部类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#广播相关方法"><span class="nav-number">7.4.</span> <span class="nav-text">广播相关方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BroadcastRecord-类详解"><span class="nav-number">8.</span> <span class="nav-text">BroadcastRecord 类详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#源码分析-2"><span class="nav-number">8.1.</span> <span class="nav-text">源码分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重要成员变量"><span class="nav-number">8.2.</span> <span class="nav-text">重要成员变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cleanupDisabledPackageReceiversLocked-方法"><span class="nav-number">8.3.</span> <span class="nav-text">cleanupDisabledPackageReceiversLocked 方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BroadcastQueue-类详解"><span class="nav-number">9.</span> <span class="nav-text">BroadcastQueue 类详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#重要成员变量-1"><span class="nav-number">9.1.</span> <span class="nav-text">重要成员变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BroadcastHandler-类"><span class="nav-number">9.2.</span> <span class="nav-text">BroadcastHandler 类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AppNotResponding-类"><span class="nav-number">9.3.</span> <span class="nav-text">AppNotResponding 类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#静态注册广播接收器流程分析"><span class="nav-number">10.</span> <span class="nav-text">静态注册广播接收器流程分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#流程图"><span class="nav-number">10.1.</span> <span class="nav-text">流程图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PackageParser-parseBaseApplication-详解"><span class="nav-number">10.2.</span> <span class="nav-text">PackageParser.parseBaseApplication 详解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PMS-静态注册广播接收器"><span class="nav-number">10.3.</span> <span class="nav-text">PMS 静态注册广播接收器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PMS-查询静态注册广播接收器"><span class="nav-number">10.4.</span> <span class="nav-text">PMS 查询静态注册广播接收器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#protected-broadcast-受保护的广播"><span class="nav-number">10.5.</span> <span class="nav-text">protected-broadcast 受保护的广播</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#动态注册-取消广播接收器流程分析"><span class="nav-number">11.</span> <span class="nav-text">动态注册/取消广播接收器流程分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#流程图-1"><span class="nav-number">11.1.</span> <span class="nav-text">流程图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动态注册-ContextImpl-LoadedApk"><span class="nav-number">11.2.</span> <span class="nav-text">动态注册 ContextImpl/LoadedApk</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动态注册-AMS"><span class="nav-number">11.3.</span> <span class="nav-text">动态注册 AMS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#取消注册-ContextImpl-LoadedApk"><span class="nav-number">11.4.</span> <span class="nav-text">取消注册 ContextImpl/LoadedApk</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#取消注册-AMS"><span class="nav-number">11.5.</span> <span class="nav-text">取消注册 AMS</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#广播发送流程分析"><span class="nav-number">12.</span> <span class="nav-text">广播发送流程分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#流程图-2"><span class="nav-number">12.1.</span> <span class="nav-text">流程图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ContextImpl-sendBroadcast-发送普通广播"><span class="nav-number">12.2.</span> <span class="nav-text">ContextImpl.sendBroadcast 发送普通广播</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ContextImpl-sendOrderedBroadcast-发送有序广播"><span class="nav-number">12.3.</span> <span class="nav-text">ContextImpl.sendOrderedBroadcast 发送有序广播</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AMS-broadcastIntentLocked-广播发送解析"><span class="nav-number">12.4.</span> <span class="nav-text">AMS.broadcastIntentLocked 广播发送解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BroadcastQueue-processNextBroadcast-广播发送解析"><span class="nav-number">12.5.</span> <span class="nav-text">BroadcastQueue.processNextBroadcast 广播发送解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#deliverToRegisteredReceiverLocked-方法解析"><span class="nav-number">12.6.</span> <span class="nav-text">deliverToRegisteredReceiverLocked 方法解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ActivityThread-scheduleRegisteredReceiver-方法解析"><span class="nav-number">12.7.</span> <span class="nav-text">ActivityThread.scheduleRegisteredReceiver 方法解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#processCurBroadcastLocked-方法解析"><span class="nav-number">12.8.</span> <span class="nav-text">processCurBroadcastLocked 方法解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ActivityThread-scheduleReceiver-方法解析"><span class="nav-number">12.9.</span> <span class="nav-text">ActivityThread.scheduleReceiver 方法解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AMS-finishReceiver-结束广播"><span class="nav-number">12.10.</span> <span class="nav-text">AMS.finishReceiver 结束广播</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#广播-ANR"><span class="nav-number">12.11.</span> <span class="nav-text">广播 ANR</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#示例"><span class="nav-number">13.</span> <span class="nav-text">示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#静态注册广播接收器"><span class="nav-number">13.1.</span> <span class="nav-text">静态注册广播接收器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动态注册广播接收器"><span class="nav-number">13.2.</span> <span class="nav-text">动态注册广播接收器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#广播发送"><span class="nav-number">13.3.</span> <span class="nav-text">广播发送</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小结"><span class="nav-number">14.</span> <span class="nav-text">小结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#广播接收器静态注册过程"><span class="nav-number">14.1.</span> <span class="nav-text">广播接收器静态注册过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AMS-中存储的广播相关信息"><span class="nav-number">14.2.</span> <span class="nav-text">AMS 中存储的广播相关信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#权限检查"><span class="nav-number">14.3.</span> <span class="nav-text">权限检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#广播接收器优先级"><span class="nav-number">14.4.</span> <span class="nav-text">广播接收器优先级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#广播接收器响应"><span class="nav-number">14.5.</span> <span class="nav-text">广播接收器响应</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#前后台广播及-ANR"><span class="nav-number">14.6.</span> <span class="nav-text">前后台广播及 ANR</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#有序广播"><span class="nav-number">14.7.</span> <span class="nav-text">有序广播</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#广播发送过程"><span class="nav-number">14.8.</span> <span class="nav-text">广播发送过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#并行处理和有序处理"><span class="nav-number">14.9.</span> <span class="nav-text">并行处理和有序处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#进程和线程间交互"><span class="nav-number">14.10.</span> <span class="nav-text">进程和线程间交互</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考文档"><span class="nav-number">15.</span> <span class="nav-text">参考文档</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">redspider110</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  

  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
